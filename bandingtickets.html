<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banding Ticket Generator</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cascadia+Mono:wght@400;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cascadia Mono', 'Courier New', monospace;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .control-panel {
            background: white;
            padding: 35px;
            border-radius: 16px;
            max-width: 650px;
            margin: 0 auto 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .control-panel h1 {
            margin-bottom: 10px;
            color: #2d3748;
            text-align: center;
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .subtitle {
            text-align: center;
            color: #718096;
            font-size: 13px;
            margin-bottom: 30px;
            font-weight: 400;
        }

        .current-serial {
            text-align: center;
            padding: 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            margin-bottom: 25px;
            font-size: 15px;
            font-weight: 600;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .current-serial strong {
            display: block;
            font-size: 20px;
            letter-spacing: 2px;
            margin-top: 6px;
        }

        .form-group {
            margin-bottom: 22px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #2d3748;
            font-size: 14px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 15px;
            font-family: 'Cascadia Mono', monospace;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group small {
            color: #718096;
            display: block;
            margin-top: 6px;
            font-size: 12px;
        }

        .color-selector {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .color-option {
            padding: 18px;
            border: 3px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            font-weight: 700;
            font-size: 13px;
            transition: all 0.3s;
            letter-spacing: 0.5px;
        }

        .color-option:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }

        .color-option.selected {
            border-color: #2d3748;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            transform: scale(1.05);
        }

        .color-red { background: #ff6b6b; color: white; }
        .color-blue { background: #4dabf7; color: white; }
        .color-green { background: #51cf66; color: white; }
        .color-yellow { background: #ffd43b; color: #2d3748; }

        .btn-generate {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Cascadia Mono', monospace;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-generate:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .btn-generate:active {
            transform: translateY(0);
        }

        .btn-reset {
            width: 100%;
            margin-top: 12px;
            padding: 14px;
            background: white;
            color: #4c51bf;
            border: 2px dashed #4c51bf;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Cascadia Mono', monospace;
            letter-spacing: 0.5px;
        }

        .btn-reset:hover {
            background: #edf2f7;
            transform: translateY(-1px);
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }
            .control-panel {
                display: none;
            }
            .print-container {
                display: block !important;
            }
        }

        .print-container {
            display: none;
        }

        @page {
            size: A4;
            margin: 5mm;
        }

        .page {
            width: 210mm;
            height: 297mm;
            page-break-after: always;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .page:last-child {
            page-break-after: auto;
        }

        .ticket-row {
            display: flex;
            flex: 1;
            min-height: 74.25mm;
            border-bottom: 1px dashed #aaa;
        }

        .ticket-row:last-child {
            border-bottom: none;
        }

        .ticket-column {
            width: 50%;
            border-right: 2px dashed #666;
            position: relative;
        }

        .ticket-column:last-child {
            border-right: none;
        }

        .ticket {
            position: relative;
            height: 100%;
            padding: 3.6mm;
            display: flex;
            flex-direction: column;
            border: 3px solid;
            font-family: 'Cascadia Mono', 'Courier New', monospace;
        }

        .ticket.red { border-color: #ff6b6b; }
        .ticket.blue { border-color: #4dabf7; }
        .ticket.green { border-color: #51cf66; }
        .ticket.yellow { border-color: #ffd43b; }

        .ticket.duplicate {
            background: rgba(45, 55, 72, 0.06);
        }

        .ticket-header {
            text-align: center;
            font-weight: 700;
            font-size: 11px;
            padding-bottom: 1.8mm;
            margin-bottom: 2.6mm;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .serial-wrapper {
            display: flex;
            align-items: stretch;
            gap: 1.6mm;
            margin-bottom: 1.8mm;
        }

        .serial-number {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            padding: 2mm 1.4mm;
            background: #edf2f7;
            border: 1.2px solid #cbd5e0;
            border-radius: 3px;
            letter-spacing: 1.3px;
            font-size: 10.5px;
        }

        .ticket-qr {
            width: 20mm;
            min-width: 20mm;
            height: 20mm;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #ffffff;
            border: 1.2px solid #cbd5e0;
            border-radius: 3px;
            padding: 1.2mm;
        }

        .ticket-qr canvas,
        .ticket-qr img {
            width: 100%;
            height: 100%;
        }

        .ticket-body {
            flex: 1;
            font-size: 8px;
            display: flex;
            flex-direction: column;
            gap: 1.6mm;
        }

        .field-row {
            display: flex;
            gap: 2mm;
            margin-bottom: 1.6mm;
        }

        .field-group {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 2mm;
        }

        .field-label {
            font-weight: 600;
            white-space: nowrap;
            color: #2d3748;
        }

        .checkbox-columns {
            display: flex;
            gap: 2mm;
            margin-top: 1mm;
        }

        .checkbox-column {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1mm;
            padding: 1.6mm;
            border-radius: 3px;
            border: 1px solid #cbd5e0;
            background: #f7fafc;
        }

        .checkbox-column.pallet {
            background: #edf2f7;
        }

        .checkbox-column.pallet .checkbox-items {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 0.8mm;
        }

        .checkbox-column-title {
            font-weight: 700;
            font-size: 7px;
            letter-spacing: 0.4px;
            text-transform: uppercase;
            color: #4a5568;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 1.2mm;
            font-weight: 500;
            font-size: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 3.4mm;
            height: 3.4mm;
        }

        .ticket-footer {
            text-align: center;
            font-size: 7.2px;
            padding: 2mm 1mm;
            color: #2d3748;
            font-weight: 600;
            letter-spacing: 0.4px;
            background: rgba(226, 232, 240, 0.95);
            border-top: 1.4px solid rgba(45, 55, 72, 0.65);
            border-bottom-left-radius: 2px;
            border-bottom-right-radius: 2px;
            margin-top: auto;
        }

        .duplicate-label {
            font-size: 8px;
            color: #e53e3e;
            font-weight: 700;
            letter-spacing: 0.8px;
            text-transform: uppercase;
        }

        .field-value {
            flex: 1;
            border-bottom: 1.3px solid #2d3748;
            min-height: 12px;
            display: flex;
            align-items: flex-end;
        }

        .field-value.filled {
            align-items: center;
            color: #1a202c;
            font-weight: 600;
        }

        .field-value.filled span {
            width: 100%;
            word-break: break-word;
        }

        body.fill-mode-active {
            background: linear-gradient(135deg, #edf2f7 0%, #e2e8f0 100%);
        }

        body.fill-mode-active .control-panel,
        body.fill-mode-active .print-container {
            display: none !important;
        }

        .fill-mode {
            display: none;
            max-width: 1180px;
            margin: 0 auto;
            padding: 20px 20px 60px;
            gap: 24px;
        }

        .fill-mode.visible {
            display: grid;
            grid-template-columns: minmax(360px, 1fr) minmax(360px, 1fr);
        }

        .fill-card,
        .fill-preview {
            background: white;
            border-radius: 18px;
            padding: 28px;
            box-shadow: 0 18px 45px rgba(15, 23, 42, 0.18);
        }

        .fill-card h2,
        .fill-preview h2 {
            font-size: 20px;
            margin-bottom: 12px;
            font-weight: 700;
            color: #2d3748;
        }

        .logged-in-banner {
            display: none;
            margin-bottom: 16px;
            padding: 14px 16px;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(56,189,248,0.15), rgba(14,165,233,0.15));
            border: 1px solid rgba(14,165,233,0.3);
            color: #0f172a;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .logged-in-banner small {
            display: block;
            font-weight: 400;
            color: #0369a1;
            margin-top: 4px;
        }

        .login-status {
            margin-top: 12px;
            font-size: 14px;
            color: #475569;
        }

        .login-status.error {
            color: #c53030;
        }

        .login-status.success {
            color: #2f855a;
        }

        .fill-intro {
            font-size: 13px;
            color: #4a5568;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .fill-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .fill-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 18px;
        }

        .fill-form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .fill-form-group label,
        .fill-group-label {
            font-size: 13px;
            font-weight: 600;
            color: #2d3748;
            letter-spacing: 0.2px;
        }

        .fill-form-group input[type="text"],
        .fill-form-group input[type="number"],
        .fill-form-group input[type="date"],
        .fill-form-group input[type="time"],
        .fill-form-group select,
        .fill-form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1.6px solid #cbd5e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Cascadia Mono', monospace;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .fill-form-group textarea {
            resize: vertical;
        }

        .fill-form-group input:focus,
        .fill-form-group select:focus,
        .fill-form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.18);
        }

        .fill-checkbox-group {
            padding: 16px;
            border: 1.5px dashed #cbd5e0;
            border-radius: 10px;
            background: #f8fafc;
            gap: 10px;
        }

        .fill-checkbox-group label {
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #2d3748;
        }

        .fill-checkbox-group input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }

        .fill-notes-group textarea {
            min-height: 100px;
        }

        .fill-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .fill-status {
            font-size: 13px;
            color: #2d3748;
            margin-top: 10px;
            min-height: 18px;
        }

        .fill-preview-note {
            font-size: 13px;
            color: #4a5568;
            margin-bottom: 16px;
        }

        .fill-preview-stage {
            background: #f7fafc;
            border-radius: 14px;
            padding: 16px;
            min-height: 420px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: auto;
        }

        .fill-preview-stage .page {
            transform: scale(0.9);
            transform-origin: top left;
        }

        .movement-toggle {
            max-width: 1200px;
            margin: 30px auto 0;
            text-align: center;
        }

        .movement-panel {
            display: none;
                max-width: 1200px;
                margin: 20px auto 60px;
                background: white;
                border-radius: 18px;
                padding: 28px;
                box-shadow: 0 25px 60px rgba(15, 23, 42, 0.15);
        }

        .movement-panel.active {
            display: block;
        }

        .movement-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 16px;
        }

        .movement-panel-header h2 {
            margin: 0;
            font-size: 24px;
            color: #1f2937;
        }

        .movement-panel-header p {
            margin: 6px 0 0;
            color: #475569;
            font-size: 14px;
        }

        .movement-grid {
            margin-top: 25px;
            display: grid;
            grid-template-columns: 1.2fr 1fr;
            gap: 24px;
        }

        .movement-column {
            background: #f8fafc;
            border-radius: 14px;
            padding: 18px;
        }

        .movement-section h3 {
            margin-top: 0;
            color: #1f2937;
        }

        .movement-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            align-items: end;
            margin-bottom: 16px;
        }

        .movement-controls label {
            display: block;
            font-size: 12px;
            color: #475569;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .movement-controls select,
        .movement-controls input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-family: 'Cascadia Mono', monospace;
        }

        .movement-zone-meta {
            font-size: 13px;
            color: #475569;
            margin-bottom: 12px;
            border-left: 4px solid #6366f1;
            padding-left: 10px;
        }

        .movement-pallet-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 520px;
            overflow-y: auto;
        }

        .movement-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .movement-card:hover {
            border-color: #6366f1;
            box-shadow: 0 10px 25px rgba(79, 70, 229, 0.12);
        }

        .movement-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }

        .movement-card-header strong {
            font-size: 16px;
            color: #1e1e2f;
        }

        .movement-card .badge {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .movement-card-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 8px;
            font-size: 13px;
            color: #475569;
        }

        .movement-card-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 6px;
        }

        .movement-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .movement-form-grid input,
        .movement-form-grid select,
        .movement-form-grid textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #cbd5e0;
            border-radius: 8px;
            font-family: 'Cascadia Mono', monospace;
        }

        .movement-form-grid textarea {
            resize: vertical;
            min-height: 100px;
        }

        .movement-form-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .movement-status {
            margin-top: 12px;
            font-size: 13px;
        }

        .movement-status.error {
            color: #c53030;
        }

        .movement-status.success {
            color: #2f855a;
        }

        @media (max-width: 1024px) {
            .movement-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="control-panel">
        <h1>üé´ Banding Ticket Generator</h1>
        <div class="subtitle">NexGridCore DataLabs Production System</div>
        
        <div class="current-serial">
            <span>Next Serial</span>
            <strong id="nextSerial">FG-BL-00001</strong>
        </div>

        <div class="form-group">
            <label>üìä Number of Tickets (per side)</label>
            <input type="number" id="ticketCount" value="4" min="4" step="4">
            <small>Each A4 page prints 4 ticket pairs (8 total tickets)</small>
        </div>

        <div class="form-group">
            <label>üé® Select Group Color</label>
            <div class="color-selector">
                <div class="color-option color-red" data-color="red">RED</div>
                <div class="color-option color-blue selected" data-color="blue">BLUE</div>
                <div class="color-option color-green" data-color="green">GREEN</div>
                <div class="color-option color-yellow" data-color="yellow">YELLOW</div>
            </div>
        </div>

        <button class="btn-generate" onclick="generateTickets()">
            üñ®Ô∏è GENERATE & PRINT TICKETS
        </button>
        <button class="btn-generate" onclick="generateAllColorTicketsPDF()" style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); margin-top: 10px;">
            üì• DOWNLOAD PDF (52 Tickets √ó 4 Colors)
        </button>
        <button class="btn-reset" type="button" onclick="resetSerial()">
            ‚ôªÔ∏è Reset Serial Number
        </button>
        
        <div class="form-group" style="margin-top: 25px; padding-top: 25px; border-top: 2px solid #e2e8f0;">
            <label>‚öôÔ∏è Google Sheets Configuration</label>
            <input type="text" id="googleSheetId" placeholder="Enter Google Sheet ID" style="margin-bottom: 10px;">
            <input type="text" id="googleApiKey" placeholder="Enter Google API Key">
            <small>Get these from the setup instructions. Required for data tracking.</small>
            <button type="button" class="btn-reset" onclick="saveGoogleConfig()" style="margin-top: 10px; width: 100%;">üíæ Save Configuration</button>
            <button type="button" class="btn-reset" onclick="testGoogleSheetsConnection()" style="margin-top: 10px; width: 100%; background: #667eea; color: white;">üîç Test Connection</button>
            <div id="testResults" style="margin-top: 10px; padding: 10px; border-radius: 5px; display: none; font-size: 12px;"></div>
        </div>
        
        <div class="form-group" style="margin-top: 25px; padding-top: 25px; border-top: 2px solid #e2e8f0;">
            <label>üì± QR Code URL Configuration</label>
            <input type="text" id="scanBaseUrl" placeholder="https://nexgridcoredatalabs.github.io/Nexers-Banding-Tickets/" style="margin-bottom: 10px;">
            <small>Enter your network IP address and port (not localhost). This is what QR codes will link to. Find your IP with: ipconfig (Windows) or ifconfig (Mac/Linux)</small>
            <button type="button" class="btn-reset" onclick="saveScanUrlConfig()" style="margin-top: 10px; width: 100%;">üíæ Save QR URL</button>
        </div>
        
        <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
            <p style="color: #718096; font-size: 12px; font-weight: 500; letter-spacing: 0.5px;">
                Powered by <strong style="color: #667eea; font-weight: 700;">NexGridCore DataLabs</strong>
            </p>
        </div>
    </div>

    <div class="print-container" id="printContainer"></div>

    <div class="fill-mode" id="fillContainer">
        <div class="fill-card" id="viewCard" style="display: none;">
            <h2>Viewing Ticket</h2>
            <p class="fill-intro">Viewing ticket: <strong id="viewSerialDisplay"></strong></p>
            <div id="viewContent" class="fill-form">
                <div id="viewLoading" style="text-align: center; padding: 40px;">Loading ticket data...</div>
                <div id="viewData" style="display: none;"></div>
            </div>
            <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                <p style="color: #718096; font-size: 12px; font-weight: 500; letter-spacing: 0.5px;">
                    Powered by <strong style="color: #667eea; font-weight: 700;">NexGridCore DataLabs</strong>
                </p>
            </div>
        </div>

        <div class="fill-card" id="loginCard" style="display: none;">
            <h2>Authorized User Login</h2>
            <p class="fill-intro">Only authorized production leads can edit tickets from this workstation. Please sign in to continue.</p>
            <form id="loginForm" class="fill-form">
                <div class="fill-form-group">
                    <label for="loginUser">Select User</label>
                    <select id="loginUser" required>
                        <option value="">Loading authorized users...</option>
                    </select>
                </div>
                <div class="fill-form-group">
                    <label for="loginPasscode">Passcode</label>
                    <input type="password" id="loginPasscode" required placeholder="Enter your secure passcode">
                </div>
                <div class="fill-actions">
                    <button type="submit" class="btn-generate" id="loginSubmit">Unlock Editor</button>
                    <button type="button" class="btn-reset" id="loginResetAccess">Reset Access</button>
                </div>
                <div id="loginStatus" class="login-status"></div>
            </form>
            <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                <p style="color: #718096; font-size: 12px; font-weight: 500; letter-spacing: 0.5px;">
                    Powered by <strong style="color: #667eea; font-weight: 700;">NexGridCore DataLabs</strong>
                </p>
            </div>
        </div>
        
        <div class="fill-card" id="editCard">
            <h2>Fill/Edit Ticket Details</h2>
            <p class="fill-intro">Enter the captured information for serial <strong id="fillSerialDisplay"></strong>. When you submit, data is saved to Google Sheets and a finished ticket downloads as a PNG.</p>
            <div class="logged-in-banner" id="loggedInUserBanner">
                <div>
                    <span id="loggedInUserText"></span>
                    <small>Session locked to this user. All edits are tracked.</small>
                </div>
                <button type="button" class="btn-reset" id="logoutUserButton">Log out</button>
            </div>
            <form id="ticketForm" class="fill-form">
                <div class="fill-form-grid">
                    <div class="fill-form-group">
                        <label for="fillSerial">Ticket Serial</label>
                        <input type="text" id="fillSerial" name="serial" required>
                    </div>
                    <div class="fill-form-group">
                        <label for="fillColor">Ticket Colour</label>
                        <select id="fillColor" name="color">
                            <option value="blue">Blue</option>
                            <option value="red">Red</option>
                            <option value="green">Green</option>
                            <option value="yellow">Yellow</option>
                        </select>
                    </div>
                    <div class="fill-form-group">
                        <label for="fillDate">Date</label>
                        <input type="date" id="fillDate" name="date">
                    </div>
                    <div class="fill-form-group">
                        <label for="fillTime">Time</label>
                        <input type="time" id="fillTime" name="time">
                    </div>
                    <div class="fill-form-group">
                        <label for="fillSku">SKU</label>
                        <select id="fillSku" name="sku" style="width: 100%; padding: 10px; border: 2px solid #cbd5e0; border-radius: 6px; font-size: 14px; background: white;">
                            <option value="">Select or type SKU...</option>
                        </select>
                        <input type="text" id="fillSkuCustom" name="skuCustom" placeholder="Or enter custom SKU..." style="width: 100%; padding: 10px; border: 2px solid #cbd5e0; border-radius: 6px; font-size: 14px; margin-top: 8px; display: none;">
                        <small style="display: block; margin-top: 5px; color: #718096; font-size: 12px;">Select from list or type custom SKU</small>
                    </div>
                    <div class="fill-form-group">
                        <label for="fillQty">Quantity</label>
                        <input type="number" id="fillQty" name="qty" min="0" step="1">
                    </div>
                    <div class="fill-form-group">
                        <label for="fillLayers">Layers</label>
                        <input type="number" id="fillLayers" name="layers" min="0" step="1">
                    </div>
                    <div class="fill-form-group fill-checkbox-group">
                        <span class="fill-group-label">Banding Type</span>
                        <label><input type="checkbox" name="bandingType" value="online"> Online</label>
                        <label><input type="checkbox" name="bandingType" value="offline"> Offline</label>
                    </div>
                    <div class="fill-form-group fill-checkbox-group">
                        <span class="fill-group-label">Product Type</span>
                        <label><input type="checkbox" name="productType" value="1kg"> 1kg</label>
                        <label><input type="checkbox" name="productType" value="0.5kg"> 0.5kg</label>
                    </div>
                    <div class="fill-form-group fill-checkbox-group">
                        <span class="fill-group-label">Pallet Size</span>
                        <label><input type="checkbox" name="palletSize" value="78"> 78</label>
                        <label><input type="checkbox" name="palletSize" value="105"> 105</label>
                        <label><input type="checkbox" name="palletSize" value="64"> 64</label>
                        <label><input type="checkbox" name="palletSize" value="100"> 100</label>
                    </div>
                    <div class="fill-form-group fill-notes-group">
                        <label for="fillNotes">Notes / References</label>
                        <textarea id="fillNotes" name="notes" rows="4" placeholder="Additional remarks..."></textarea>
                    </div>
                    
                    <div class="fill-form-group" style="grid-column: 1 / -1; margin-top: 10px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                        <label style="font-size: 15px; font-weight: 700; margin-bottom: 15px;">Sachet & Tablet Information</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div class="fill-form-group">
                                <label for="sachetType">Sachet Type</label>
                                <select id="sachetType" name="sachetType" style="width: 100%; padding: 10px; border: 2px solid #cbd5e0; border-radius: 6px; font-size: 14px; background: white;">
                                    <option value="">Select sachet type...</option>
                                </select>
                            </div>
                            <div class="fill-form-group">
                                <label for="tabletType">Tablet Type</label>
                                <select id="tabletType" name="tabletType" style="width: 100%; padding: 10px; border: 2px solid #cbd5e0; border-radius: 6px; font-size: 14px; background: white;">
                                    <option value="">Select tablet type...</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="fill-form-group" style="grid-column: 1 / -1; margin-top: 10px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                        <label style="font-size: 15px; font-weight: 700; margin-bottom: 15px;">Quality Issues</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div class="fill-form-group">
                                <label for="qualityIssueType">Issue Type</label>
                                <select id="qualityIssueType" name="qualityIssueType">
                                    <option value="">Select type...</option>
                                    <option value="banding">Banding Quality Frailties</option>
                                    <option value="production">Production Quality Frailties</option>
                                </select>
                            </div>
                            <div class="fill-form-group">
                                <label for="groupLeader">Group Leader</label>
                                <select id="groupLeader" name="groupLeader">
                                    <option value="">Select leader...</option>
                                </select>
                            </div>
                        </div>
                        <div class="fill-form-group">
                            <label for="qualityIssueDesc">Issue Description</label>
                            <textarea id="qualityIssueDesc" name="qualityIssueDesc" rows="3" placeholder="Describe the quality issue..."></textarea>
                        </div>
                    </div>
                    
                    <div class="fill-form-group" style="grid-column: 1 / -1; margin-top: 10px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                        <label style="font-size: 15px; font-weight: 700; margin-bottom: 15px;">Merchandise History</label>
                        <div id="merchHistoryContainer">
                            <div class="merch-history-entry" style="display: grid; grid-template-columns: 1fr 1fr 2fr; gap: 10px; margin-bottom: 10px; align-items: end;">
                                <div class="fill-form-group">
                                    <label>Date</label>
                                    <input type="date" class="merch-history-date" name="merchHistoryDate[]">
                                </div>
                                <div class="fill-form-group">
                                    <label>User</label>
                                    <select class="merch-history-user" name="merchHistoryUser[]">
                                        <option value="">Select user...</option>
                                    </select>
                                </div>
                                <div class="fill-form-group">
                                    <label>Note</label>
                                    <input type="text" class="merch-history-note" name="merchHistoryNote[]" placeholder="Enter note...">
                                </div>
                            </div>
                        </div>
                        <button type="button" onclick="addMerchHistoryEntry()" class="btn-reset" style="width: 100%; margin-top: 10px;">+ Add History Entry</button>
                    </div>
                </div>
                <div class="fill-actions">
                    <button type="submit" class="btn-generate">üíæ Save to Google Sheets & Download Ticket</button>
                    <button type="button" id="fillBack" class="btn-reset">‚Üê Back to Ticket Generator</button>
                </div>
                <div id="fillStatus" class="fill-status"></div>
            </form>
            <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                <p style="color: #718096; font-size: 12px; font-weight: 500; letter-spacing: 0.5px;">
                    Powered by <strong style="color: #667eea; font-weight: 700;">NexGridCore DataLabs</strong>
                </p>
            </div>
        </div>
        <div class="fill-preview">
            <h2>Live Preview</h2>
            <div class="fill-preview-note">Preview updates on submit before the download starts.</div>
            <div class="fill-preview-stage" id="fillPreview"></div>
            <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                <p style="color: #718096; font-size: 12px; font-weight: 500; letter-spacing: 0.5px;">
                    Powered by <strong style="color: #667eea; font-weight: 700;">NexGridCore DataLabs</strong>
                </p>
            </div>
        </div>

        <div id="movementSection" style="display: none;">
            <div class="movement-toggle">
                <button type="button" class="btn-generate" id="movementToggleBtn" onclick="toggleMovementPanel()">
                    üöö Open Stock Movement Control
                </button>
            </div>

            <div class="movement-panel" id="movementPanel">
                <div class="movement-panel-header">
                    <div>
                        <h2>üì¶ Stock Movement Control</h2>
                        <p>Monitor pallets per zone, enforce FIFO, and log movements in real time.</p>
                    </div>
                    <button type="button" class="btn-reset" onclick="toggleMovementPanel(false)">Close</button>
                </div>

                <div class="movement-grid">
                    <div class="movement-column">
                        <div class="movement-section">
                            <h3>Zone Monitor</h3>
                            <div class="movement-controls">
                                <div>
                                    <label for="movementZoneSelect">Zone</label>
                                    <select id="movementZoneSelect"></select>
                                </div>
                                <div>
                                    <label for="movementStatusFilter">Status</label>
                                    <select id="movementStatusFilter">
                                        <option value="">Any status</option>
                                        <option value="Active">Active</option>
                                        <option value="Hold">Hold</option>
                                        <option value="Rework">Rework</option>
                                        <option value="Dispatch">Dispatch</option>
                                        <option value="Shipped">Shipped</option>
                                    </select>
                                </div>
                                <button type="button" class="btn-generate" onclick="refreshMovementZone()">üîÑ Refresh</button>
                            </div>
                            <div id="movementZoneMeta" class="movement-zone-meta"></div>
                            <div id="movementPalletList" class="movement-pallet-list">
                                <div style="color:#94a3b8;">Select a zone to view pallets.</div>
                            </div>
                        </div>
                    </div>
                    <div class="movement-column movement-column-form">
                        <div class="movement-section">
                            <h3>Move Pallet</h3>
                            <form id="movementForm" onsubmit="event.preventDefault(); submitMovementForm();">
                                <div class="movement-form-grid">
                                    <div>
                                        <label for="movementPalletId">Pallet ID</label>
                                        <input type="text" id="movementPalletId" placeholder="FG-DET-00001" required>
                                    </div>
                                    <div>
                                        <label for="movementCurrentZone">Current Zone</label>
                                        <input type="text" id="movementCurrentZone" placeholder="Auto-detected" readonly>
                                    </div>
                                    <div>
                                        <label for="movementToZoneSelect">Move To</label>
                                        <select id="movementToZoneSelect" required></select>
                                    </div>
                                    <div>
                                        <label for="movementMovedBy">Moved By</label>
                                        <input type="text" id="movementMovedBy" placeholder="Clerk name / badge" required>
                                    </div>
                            <div id="movementQuantityWrapper">
                                <label for="movementQuantity">Quantity (optional)</label>
                                <input type="number" id="movementQuantity" min="0" step="1" placeholder="Leave blank to keep full qty">
                            </div>
                                    <div>
                                        <label for="movementOrderRef">Order Reference (optional)</label>
                                        <input type="text" id="movementOrderRef" placeholder="MT/Dispatch reference">
                                    </div>
                                    <div style="grid-column: 1 / -1;">
                                        <label for="movementReason">Reason / Notes</label>
                                        <textarea id="movementReason" rows="3" placeholder="Reason for movement, QA notes, etc."></textarea>
                                    </div>
                                    <div style="grid-column: 1 / -1;">
                                        <label for="movementOverrideReason">Override Reason (required when bypassing FIFO)</label>
                                        <textarea id="movementOverrideReason" rows="2" placeholder="Explain why FIFO is bypassed. Leave blank to enforce FIFO."></textarea>
                                    </div>
                                </div>
                        <div class="movement-form-actions">
                            <button type="button" class="btn-reset" id="toggleChildModeBtn" onclick="toggleMovementMode()">‚ú® Create Child Pallet</button>
                            <button type="submit" class="btn-generate" id="movementSubmitBtn">Move Pallet</button>
                            <button type="button" class_name="btn-reset" onclick="resetMovementForm()">Clear</button>
                        </div>
                                <div id="movementStatusMessage" class="movement-status"></div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>

    <script>
        const SERIES_PREFIX = 'BND';
        let selectedColor = 'blue';
        let currentSerial = 1;
        let movementPanelInitialized = false;
        let movementZones = [];
        let movementLastPallets = [];
        let movementSelectedPallet = null;
        
        // HARDCODED: GitHub Pages URL - Update this with your actual GitHub Pages URL
        const DEFAULT_SCAN_BASE_URL = 'https://nexgridcoredatalabs.github.io/Nexers-Banding-Tickets/bandingtickets.html';
        
        // Load saved scan URL or use hardcoded default
        let SCAN_BASE_URL = localStorage.getItem('scanBaseUrl') || DEFAULT_SCAN_BASE_URL;
        
        // Auto-detect the current page URL if no saved URL exists
        if (!localStorage.getItem('scanBaseUrl')) {
            const { protocol, origin, pathname, hostname } = window.location;
            
            // If accessing via file:// protocol, warn user
            if (protocol === 'file:') {
                console.warn('‚ö†Ô∏è Accessing via file:// protocol. QR codes will not work from phones.');
                console.warn('üí° Solution: Use a local web server (e.g., Python: python -m http.server 8000)');
                console.warn('üí° Then access via: http://localhost:8000/bandingtickets.html');
                // Don't set URL for file:// - user must configure manually
            } else if (hostname === 'localhost' || hostname === '127.0.0.1') {
                // Local server - use it but warn about phone access
                SCAN_BASE_URL = `${origin}${pathname}`;
                localStorage.setItem('scanBaseUrl', SCAN_BASE_URL);
                console.warn('‚ö†Ô∏è Using localhost URL. QR codes will only work if phone is on same network.');
                console.warn('üí° For phone access, use your computer IP: http://YOUR-IP:PORT/bandingtickets.html');
            } else {
                // Web server (GitHub Pages, etc.) - use current URL
                SCAN_BASE_URL = `${origin}${pathname}`;
                localStorage.setItem('scanBaseUrl', SCAN_BASE_URL);
                console.log('‚úÖ Auto-detected URL:', SCAN_BASE_URL);
            }
        }
        
        // Load saved config into input field
        if (document.getElementById('scanBaseUrl')) {
            document.getElementById('scanBaseUrl').value = SCAN_BASE_URL;
        }
        
        function saveScanUrlConfig() {
            const url = document.getElementById('scanBaseUrl').value.trim();
            if (url) {
                // Basic validation
                if (!url.startsWith('http://') && !url.startsWith('https://')) {
                    alert('URL must start with http:// or https://');
                    return;
                }
                if (url.includes('localhost') || url.includes('127.0.0.1')) {
                    if (!confirm('Warning: Using localhost will not work when scanning from phones. Continue anyway?')) {
                        return;
                    }
                }
                SCAN_BASE_URL = url;
                localStorage.setItem('scanBaseUrl', url);
                alert('QR URL saved! Regenerate tickets for the new URL to take effect.');
            } else {
                alert('Please enter a URL');
            }
        }
        const urlParams = new URLSearchParams(window.location.search);
        const currentMode = urlParams.get('mode');
        const initialSerialParam = urlParams.get('serial');
        const urlColorParam = urlParams.get('color');

        const savedSerial = localStorage.getItem('bandingSerial');
        if (savedSerial) {
            currentSerial = parseInt(savedSerial, 10);
        }
        updateSerialDisplay();

        const loginFormEl = document.getElementById('loginForm');
        if (loginFormEl) {
            loginFormEl.addEventListener('submit', handleLoginSubmit);
        }

        const loginResetButton = document.getElementById('loginResetAccess');
        if (loginResetButton) {
            loginResetButton.addEventListener('click', () => {
                clearLoggedInUserSession();
                localStorage.removeItem(GENERATOR_ACCESS_TOKEN);
                localStorage.removeItem(USER_SESSION_KEY);
                alert('Access has been reset. Please reload the page and authenticate again.');
                showLoginCard();
            });
        }

        const logoutButton = document.getElementById('logoutUserButton');
        if (logoutButton) {
            logoutButton.addEventListener('click', () => {
                clearLoggedInUserSession();
                showLoginCard();
            });
        }

        function escapeHtml(value) {
            if (value === null || value === undefined) {
                return '';
            }
            return String(value).replace(/[&<>"']/g, (char) => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[char]));
        }

        document.querySelectorAll('.color-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.color-option').forEach(opt => 
                    opt.classList.remove('selected'));
                this.classList.add('selected');
                selectedColor = this.dataset.color;
                updateSerialDisplay();
            });
        });

        // Google Sheets Configuration - HARDCODED DEFAULTS
        // Set these values once, and they'll be used for all users
        const DEFAULT_GOOGLE_SHEET_ID = '1QXkL2K5hAfyvHKQ6mCFckmIu73lLw_XyENKSuqyFQgE';
        const DEFAULT_GOOGLE_API_KEY = 'AIzaSyBUSYg78PSD47OWJkzEa4kMQknjROGulLI';
        const DEFAULT_GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxbujRsVW-vVwt34GVCOlCm145mjgp4uV11-YhSy1CQtXPKiqdlPycfTj7q8GvIHg0a0g/exec';
        
        const USER_SESSION_KEY = 'bandingUserSession';
        let loggedInUser = getStoredUser();
        
        function getStoredUser() {
            try {
                return JSON.parse(localStorage.getItem(USER_SESSION_KEY)) || null;
            } catch (error) {
                return null;
            }
        }
        
        function isUserLoggedIn() {
            return !!(loggedInUser && loggedInUser.id);
        }
        
        function setLoggedInUser(user) {
            loggedInUser = user;
            localStorage.setItem(USER_SESSION_KEY, JSON.stringify(user));
            updateLoggedInUserBanner();
        }
        
        function clearLoggedInUserSession() {
            loggedInUser = null;
            localStorage.removeItem(USER_SESSION_KEY);
            updateLoggedInUserBanner();
        }
        
        function updateLoggedInUserBanner() {
            const banner = document.getElementById('loggedInUserBanner');
            const text = document.getElementById('loggedInUserText');
            if (!banner || !text) return;
            if (isUserLoggedIn()) {
                banner.style.display = 'flex';
                text.textContent = `Signed in as ${loggedInUser.name || loggedInUser.id}`;
            } else {
                banner.style.display = 'none';
                text.textContent = '';
            }
            const movementMovedByInput = document.getElementById('movementMovedBy');
            if (movementMovedByInput && isUserLoggedIn() && !movementMovedByInput.value) {
                movementMovedByInput.value = loggedInUser.name || loggedInUser.id || '';
            }
        }

        updateLoggedInUserBanner();
        
        // Load configuration: Use hardcoded defaults, or localStorage override, or user input
        let GOOGLE_SHEET_ID = DEFAULT_GOOGLE_SHEET_ID || localStorage.getItem('googleSheetId') || '';
        let GOOGLE_API_KEY = DEFAULT_GOOGLE_API_KEY || localStorage.getItem('googleApiKey') || '';
        let GOOGLE_APPS_SCRIPT_URL = DEFAULT_GOOGLE_APPS_SCRIPT_URL || localStorage.getItem('googleAppsScriptUrl') || '';
        
        // Auto-save hardcoded values to localStorage if they exist
        if (DEFAULT_GOOGLE_SHEET_ID && DEFAULT_GOOGLE_API_KEY) {
            localStorage.setItem('googleSheetId', DEFAULT_GOOGLE_SHEET_ID);
            localStorage.setItem('googleApiKey', DEFAULT_GOOGLE_API_KEY);
            GOOGLE_SHEET_ID = DEFAULT_GOOGLE_SHEET_ID;
            GOOGLE_API_KEY = DEFAULT_GOOGLE_API_KEY;
        }
        if (DEFAULT_GOOGLE_APPS_SCRIPT_URL) {
            localStorage.setItem('googleAppsScriptUrl', DEFAULT_GOOGLE_APPS_SCRIPT_URL);
            GOOGLE_APPS_SCRIPT_URL = DEFAULT_GOOGLE_APPS_SCRIPT_URL;
        }
        
        // Load saved config into input fields (for display/override)
        if (document.getElementById('googleSheetId')) {
            document.getElementById('googleSheetId').value = GOOGLE_SHEET_ID;
        }
        if (document.getElementById('googleApiKey')) {
            document.getElementById('googleApiKey').value = GOOGLE_API_KEY;
        }
        
        function saveGoogleConfig() {
            const sheetId = document.getElementById('googleSheetId').value.trim();
            const apiKey = document.getElementById('googleApiKey').value.trim();
            if (sheetId && apiKey) {
                GOOGLE_SHEET_ID = sheetId;
                GOOGLE_API_KEY = apiKey;
                localStorage.setItem('googleSheetId', sheetId);
                localStorage.setItem('googleApiKey', apiKey);
                alert('Configuration saved!');
            } else {
                alert('Please enter both Sheet ID and API Key');
            }
        }
        
        // Generator access control - only accessible from this PC
        const GENERATOR_ACCESS_TOKEN = 'generator_access_granted';
        const GENERATOR_PASSWORD = 'NEXGRID2025'; // Change this to your desired password
        
        function checkGeneratorAccess() {
            const accessGranted = localStorage.getItem(GENERATOR_ACCESS_TOKEN);
            if (accessGranted === 'true') {
                return true;
            }
            
            // Show password prompt
            const password = prompt('üîê Generator Access Required\n\nEnter password to access ticket generator:');
            if (password === GENERATOR_PASSWORD) {
                localStorage.setItem(GENERATOR_ACCESS_TOKEN, 'true');
                return true;
            } else if (password !== null) {
                alert('‚ùå Incorrect password. Access denied.');
            }
            return false;
        }
        
        // Protect main generator page - only allow access via QR codes (mode=view or mode=fill/edit) OR with password
        if (!currentMode) {
            // No mode parameter means direct access to generator - require password
            if (!checkGeneratorAccess()) {
                document.body.innerHTML = `
                    <div style="display: flex; justify-content: center; align-items: center; min-height: 100vh; background: #f7fafc; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                        <div style="text-align: center; padding: 40px; background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 500px;">
                            <h1 style="color: #e53e3e; margin-bottom: 20px;">‚ö†Ô∏è Access Denied</h1>
                            <p style="color: #4a5568; font-size: 16px; line-height: 1.6;">
                                Generator access is restricted to authorized devices only. Please scan a ticket QR code to view or edit ticket details.
                            </p>
                            <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                                <p style="color: #718096; font-size: 12px; font-weight: 500; letter-spacing: 0.5px;">
                                    Powered by <strong style="color: #667eea; font-weight: 700;">NexGridCore DataLabs</strong>
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            }
            // If access granted, continue with normal page load (generator will show)
        } else if (currentMode === 'view') {
            initViewMode(initialSerialParam);
        } else if (currentMode === 'edit' || currentMode === 'fill') {
            initFillMode(initialSerialParam);
        }

        function formatSerial(serialNumber) {
            return `FG-${SERIES_PREFIX}-${String(serialNumber).padStart(5, '0')}`;
        }

        function updateSerialDisplay() {
            const formatted = formatSerial(currentSerial);
            const nextSerialEl = document.getElementById('nextSerial');
            if (nextSerialEl) {
                nextSerialEl.textContent = formatted;
            }
        }

        function resetSerial() {
            // Require password validation
            const password = prompt('üîê Serial Reset - Password Required\n\nEnter password to reset serial number:');
            if (password !== GENERATOR_PASSWORD) {
                if (password !== null) {
                    alert('‚ùå Incorrect password. Reset cancelled.');
                }
                return;
            }

            // Prompt for new serial number
            const newSerialInput = prompt(`üî¢ Reset Serial Number\n\nCurrent serial: ${formatSerial(currentSerial)}\n\nEnter the serial number to reset to (e.g., 1085):`);
            
            if (newSerialInput === null) {
                // User cancelled
                return;
            }

            // Validate input
            const newSerial = parseInt(newSerialInput, 10);
            if (isNaN(newSerial) || newSerial < 1) {
                alert('‚ùå Invalid serial number. Please enter a positive number.');
                return;
            }

            // Confirm reset
            const confirmReset = confirm(`‚ö†Ô∏è Confirm Serial Reset\n\nCurrent: ${formatSerial(currentSerial)}\nNew: ${formatSerial(newSerial)}\n\nThis action cannot be undone. Continue?`);
            
            if (!confirmReset) {
                return;
            }

            // Perform reset
            currentSerial = newSerial;
            localStorage.setItem('bandingSerial', currentSerial);
            updateSerialDisplay();
            
            alert(`‚úÖ Serial number reset successfully!\n\nNew serial: ${formatSerial(currentSerial)}`);
        }

        function generateTickets() {
            const ticketCount = parseInt(document.getElementById('ticketCount').value, 10);
            
            if (ticketCount % 4 !== 0) {
                alert('Number of tickets must be a multiple of 4');
                return;
            }

            const container = document.getElementById('printContainer');
            container.innerHTML = '';

            const ticketsPerPage = 4;
            const pages = Math.ceil(ticketCount / ticketsPerPage);

            for (let page = 0; page < pages; page++) {
                const pageDiv = document.createElement('div');
                pageDiv.className = 'page';

                const ticketsOnThisPage = Math.min(ticketsPerPage, ticketCount - (page * ticketsPerPage));
                
                for (let i = 0; i < ticketsOnThisPage; i++) {
                    const serialNum = currentSerial + (page * ticketsPerPage) + i;

                    const rowDiv = document.createElement('div');
                    rowDiv.className = 'ticket-row';

                    rowDiv.innerHTML += createTicketHTML(serialNum, selectedColor, false, {}, 'view');
                    rowDiv.innerHTML += createTicketHTML(serialNum, selectedColor, true, {}, 'edit');

                    pageDiv.appendChild(rowDiv);
                }

                container.appendChild(pageDiv);
            }

            currentSerial += ticketCount;
            localStorage.setItem('bandingSerial', currentSerial);
            updateSerialDisplay();

            renderTicketQRCodes(container);

            setTimeout(() => window.print(), 100);
        }

        async function generateAllColorTicketsPDF() {
            if (typeof html2canvas === 'undefined' || typeof window.jspdf === 'undefined') {
                alert('PDF libraries not loaded. Please refresh the page.');
                return;
            }

            const ticketCount = 52;
            const colors = ['red', 'blue', 'green', 'yellow'];
            const ticketsPerPage = 4; // 4 ticket pairs per page (8 tickets total)
            
            // Show loading message
            const originalButton = event.target;
            const originalText = originalButton.innerHTML;
            originalButton.innerHTML = '‚è≥ Generating PDF...';
            originalButton.disabled = true;

            try {
                const container = document.getElementById('printContainer');
                container.innerHTML = '';
                container.style.display = 'block';

                // Generate all tickets: 52 serials per color √ó 4 colors = 208 unique serials total
                // Serial 1-52: RED
                // Serial 53-104: GREEN
                // Serial 105-156: BLUE
                // Serial 157-208: YELLOW
                let allTicketPairs = [];
                
                // Generate 52 serials for each color (208 total unique serials)
                colors.forEach((color, colorIndex) => {
                    for (let ticketNum = 0; ticketNum < ticketCount; ticketNum++) {
                        const serialNum = currentSerial + (colorIndex * ticketCount) + ticketNum;
                        allTicketPairs.push({
                            serial: serialNum,
                            color: color
                        });
                    }
                });

                // Group into pages: 4 ticket pairs per page (each pair = view + edit)
                const pairsPerPage = 4;
                const totalPagesCount = Math.ceil(allTicketPairs.length / pairsPerPage);

                // Create pages in the container
                for (let pageIdx = 0; pageIdx < totalPagesCount; pageIdx++) {
                    const pageDiv = document.createElement('div');
                    pageDiv.className = 'page';
                    pageDiv.style.width = '210mm';
                    pageDiv.style.height = '297mm';
                    pageDiv.style.pageBreakAfter = 'always';

                    const startIdx = pageIdx * pairsPerPage;
                    const endIdx = Math.min(startIdx + pairsPerPage, allTicketPairs.length);
                    const pairsOnPage = allTicketPairs.slice(startIdx, endIdx);

                    // Create a row for each ticket pair (view + edit)
                    pairsOnPage.forEach(ticket => {
                        const rowDiv = document.createElement('div');
                        rowDiv.className = 'ticket-row';
                        rowDiv.innerHTML += createTicketHTML(ticket.serial, ticket.color, false, {}, 'view');
                        rowDiv.innerHTML += createTicketHTML(ticket.serial, ticket.color, true, {}, 'edit');
                        pageDiv.appendChild(rowDiv);
                    });

                    container.appendChild(pageDiv);
                }

                // Render QR codes
                await new Promise((resolve) => {
                    renderTicketQRCodes(container);
                    // Wait for QR codes to render (they're async)
                    setTimeout(resolve, 2000);
                });

                // Initialize PDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                const pageWidth = 210; // A4 width in mm
                const pageHeight = 297; // A4 height in mm

                // Get all pages
                const pages = Array.from(container.querySelectorAll('.page'));
                const totalPages = pages.length;
                
                // Optimized: Process and add pages incrementally to avoid memory issues
                const BATCH_SIZE = 2; // Process 2 pages at a time to reduce memory usage
                
                originalButton.innerHTML = `‚è≥ Rendering ${totalPages} pages (optimized)...`;

                // Process pages in batches and add to PDF incrementally
                for (let batchStart = 0; batchStart < totalPages; batchStart += BATCH_SIZE) {
                    const batchEnd = Math.min(batchStart + BATCH_SIZE, totalPages);
                    const batch = pages.slice(batchStart, batchEnd);
                    
                    // Update progress
                    originalButton.innerHTML = `‚è≥ Rendering pages ${batchStart + 1}-${batchEnd} of ${totalPages}...`;
                    
                    // Process batch in parallel
                    const batchPromises = batch.map((pageElement, batchIdx) => {
                        return html2canvas(pageElement, {
                            scale: 1.2, // Reduced scale to prevent memory issues
                            backgroundColor: '#ffffff',
                            useCORS: true,
                            logging: false,
                            width: pageElement.scrollWidth,
                            height: pageElement.scrollHeight,
                            removeContainer: false,
                            allowTaint: false
                        }).then(canvas => {
                            // Use JPEG with compression instead of PNG to reduce size
                            const imgData = canvas.toDataURL('image/jpeg', 0.85); // JPEG at 85% quality
                            return {
                                index: batchStart + batchIdx,
                                data: imgData,
                                width: pageWidth,
                                height: (canvas.height * pageWidth) / canvas.width
                            };
                        });
                    });
                    
                    // Wait for batch to complete
                    const batchResults = await Promise.all(batchPromises);
                    
                    // Sort batch by index
                    batchResults.sort((a, b) => a.index - b.index);
                    
                    // Add pages to PDF immediately (incremental approach)
                    originalButton.innerHTML = `‚è≥ Adding pages ${batchStart + 1}-${batchEnd} to PDF...`;
                    batchResults.forEach((pageImg, batchIdx) => {
                        const pageIndex = batchStart + batchIdx;
                        if (pageIndex > 0) {
                            pdf.addPage();
                        }
                        // Use JPEG format
                        pdf.addImage(pageImg.data, 'JPEG', 0, 0, pageImg.width, pageImg.height, undefined, 'FAST');
                    });
                    
                    // Clear batch results from memory
                    batchResults.length = 0;
                }

                // Download PDF
                const fileName = `Banding_Tickets_${ticketCount}_AllColors_${new Date().toISOString().split('T')[0]}.pdf`;
                pdf.save(fileName);

                // Update serial number (208 unique serials were used: 52 per color)
                currentSerial += (ticketCount * colors.length);
                localStorage.setItem('bandingSerial', currentSerial);
                updateSerialDisplay();

                // Hide container
                container.style.display = 'none';
                container.innerHTML = '';

                originalButton.innerHTML = originalText;
                originalButton.disabled = false;

                const firstSerial = formatSerial(currentSerial - (ticketCount * colors.length));
                const lastSerial = formatSerial(currentSerial - 1);
                alert(`‚úÖ PDF generated successfully!\n\n${ticketCount} serials per color √ó 4 colors = ${allTicketPairs.length} unique serials total\n${totalPages} pages generated\n\nSerial ranges:\n‚Ä¢ ${firstSerial} to ${formatSerial(currentSerial - (ticketCount * 3) - 1)}: RED\n‚Ä¢ ${formatSerial(currentSerial - (ticketCount * 3))} to ${formatSerial(currentSerial - (ticketCount * 2) - 1)}: GREEN\n‚Ä¢ ${formatSerial(currentSerial - (ticketCount * 2))} to ${formatSerial(currentSerial - ticketCount - 1)}: BLUE\n‚Ä¢ ${formatSerial(currentSerial - ticketCount)} to ${lastSerial}: YELLOW\n\nFile: ${fileName}`);
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Error generating PDF: ' + error.message);
                originalButton.innerHTML = originalText;
                originalButton.disabled = false;
            }
        }

        function buildScanUrl(serial, mode = 'edit', color = 'blue') {
            // Ensure SCAN_BASE_URL is always current if not set
            if (!SCAN_BASE_URL || SCAN_BASE_URL === DEFAULT_SCAN_BASE_URL) {
                const { origin, pathname } = window.location;
                SCAN_BASE_URL = `${origin}${pathname}`;
            }
            // Remove any existing query parameters from base URL
            const baseUrl = SCAN_BASE_URL.split('?')[0];
            return `${baseUrl}?mode=${mode}&serial=${encodeURIComponent(serial)}&color=${encodeURIComponent(color)}`;
        }
        
        function formatTimestamp(timestampStr) {
            if (!timestampStr) return '';
            try {
                const date = new Date(timestampStr);
                if (isNaN(date.getTime())) return timestampStr;
                
                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                
                const dayName = days[date.getDay()];
                const day = date.getDate();
                const month = months[date.getMonth()];
                const year = date.getFullYear();
                
                // Get ordinal suffix (1st, 2nd, 3rd, 4th, etc.)
                const getOrdinal = (n) => {
                    const s = ['th', 'st', 'nd', 'rd'];
                    const v = n % 100;
                    return n + (s[(v - 20) % 10] || s[v] || s[0]);
                };
                
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                
                return `${dayName} ${getOrdinal(day)} ${month}, ${year} ${hours}${minutes}HRS`;
            } catch (e) {
                return timestampStr;
            }
        }
        
        function formatDateAndTime(dateStr, timeStr) {
            if (!dateStr) return 'N/A';
            try {
                // Handle time - could be Date object, string in various formats
                let normalizedTime = '';
                let hours = 0;
                let minutes = 0;
                let hasValidTime = false;
                
                if (timeStr) {
                    // If it's a Date object, extract hours and minutes
                    if (timeStr instanceof Date) {
                        hours = timeStr.getHours();
                        minutes = timeStr.getMinutes();
                        hasValidTime = hours !== 0 || minutes !== 0;
                        normalizedTime = String(hours).padStart(2, '0') + ':' + String(minutes).padStart(2, '0');
                    } else {
                        // It's a string - normalize it
                        normalizedTime = (timeStr || '').toString().trim();
                        
                        // Handle 24-hour format: could be "0024", "00:24", "14:30", "1430", etc.
                        if (normalizedTime.length === 4 && !normalizedTime.includes(':')) {
                            // Format: "0024" (4 digits, no colon)
                            hours = parseInt(normalizedTime.substring(0, 2), 10) || 0;
                            minutes = parseInt(normalizedTime.substring(2, 4), 10) || 0;
                            normalizedTime = String(hours).padStart(2, '0') + ':' + String(minutes).padStart(2, '0');
                        } else if (normalizedTime.includes(':')) {
                            // Format: "00:24" or "14:30"
                            const timeParts = normalizedTime.split(':');
                            hours = parseInt(timeParts[0], 10) || 0;
                            minutes = parseInt(timeParts[1], 10) || 0;
                        } else {
                            // Try to parse as number or other format
                            const numTime = parseInt(normalizedTime, 10);
                            if (!isNaN(numTime) && numTime >= 0 && numTime < 2400) {
                                hours = Math.floor(numTime / 100);
                                minutes = numTime % 100;
                                normalizedTime = String(hours).padStart(2, '0') + ':' + String(minutes).padStart(2, '0');
                            }
                        }
                        
                        // Check if time is valid (not midnight)
                        hasValidTime = normalizedTime !== '' && 
                                      normalizedTime !== '00:00' && 
                                      normalizedTime !== '0:00' && 
                                      (hours !== 0 || minutes !== 0);
                    }
                }
                
                // Try to parse date (could be YYYY-MM-DD or other formats)
                let date;
                
                // First, try to parse as YYYY-MM-DD format explicitly (most common from Google Sheets)
                if (typeof dateStr === 'string' && dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    // Explicit YYYY-MM-DD format - parse directly to avoid timezone issues
                    const dateParts = dateStr.split('-');
                    const year = parseInt(dateParts[0], 10);
                    const month = parseInt(dateParts[1], 10) - 1; // Month is 0-indexed
                    const day = parseInt(dateParts[2], 10);
                    
                    if (hasValidTime) {
                        date = new Date(year, month, day, hours, minutes);
                    } else {
                        date = new Date(year, month, day);
                    }
                } else if (dateStr instanceof Date) {
                    date = new Date(dateStr);
                    if (hasValidTime) {
                        date.setHours(hours, minutes, 0, 0);
                    }
                } else if (typeof dateStr === 'string' && (dateStr.includes('T') || dateStr.includes(' '))) {
                    // ISO format or date-time string - be careful with timezone
                    // Try to extract YYYY-MM-DD part first
                    const dateMatch = dateStr.match(/^(\d{4}-\d{2}-\d{2})/);
                    if (dateMatch) {
                        const dateParts = dateMatch[1].split('-');
                        const year = parseInt(dateParts[0], 10);
                        const month = parseInt(dateParts[1], 10) - 1;
                        const day = parseInt(dateParts[2], 10);
                        
                        if (hasValidTime) {
                            date = new Date(year, month, day, hours, minutes);
                        } else {
                            date = new Date(year, month, day);
                        }
                    } else {
                        // Fallback to Date constructor
                        date = new Date(dateStr);
                        if (hasValidTime && !isNaN(date.getTime())) {
                            date.setHours(hours, minutes, 0, 0);
                        }
                    }
                } else if (typeof dateStr === 'string') {
                    // Try to parse as YYYY-MM-DD format
                    const dateParts = dateStr.split('-');
                    if (dateParts.length === 3) {
                        const year = parseInt(dateParts[0], 10);
                        const month = parseInt(dateParts[1], 10) - 1;
                        const day = parseInt(dateParts[2], 10);
                        
                        if (!isNaN(year) && !isNaN(month) && !isNaN(day)) {
                            if (hasValidTime) {
                                date = new Date(year, month, day, hours, minutes);
                            } else {
                                date = new Date(year, month, day);
                            }
                        } else {
                            // Fallback
                            date = new Date(dateStr);
                        }
                    } else {
                        // Fallback
                        date = new Date(dateStr);
                    }
                } else {
                    // Fallback
                    date = new Date(dateStr);
                }
                
                if (isNaN(date.getTime())) {
                    // If parsing failed, return formatted date string if possible
                    if (dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                        const [year, month, day] = dateStr.split('-').map(Number);
                        const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                        const tempDate = new Date(year, month - 1, day);
                        if (!isNaN(tempDate.getTime())) {
                            const dayName = days[tempDate.getDay()];
                            const getOrdinal = (n) => {
                                const s = ['th', 'st', 'nd', 'rd'];
                                const v = n % 100;
                                return n + (s[(v - 20) % 10] || s[v] || s[0]);
                            };
                            return `${dayName} ${getOrdinal(day)} ${months[month - 1]}, ${year}`;
                        }
                    }
                    return dateStr + (hasValidTime ? ' ' + normalizedTime : '');
                }
                
                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                
                const dayName = days[date.getDay()];
                const day = date.getDate();
                const month = months[date.getMonth()];
                const year = date.getFullYear();
                
                const getOrdinal = (n) => {
                    const s = ['th', 'st', 'nd', 'rd'];
                    const v = n % 100;
                    return n + (s[(v - 20) % 10] || s[v] || s[0]);
                };
                
                // Only show time if it's valid and not midnight (00:00)
                if (hasValidTime && date.getHours() !== 0 || date.getMinutes() !== 0) {
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    return `${dayName} ${getOrdinal(day)} ${month}, ${year} ${hours}${minutes}HRS`;
                } else {
                    // Just show date without time
                    return `${dayName} ${getOrdinal(day)} ${month}, ${year}`;
                }
            } catch (e) {
                console.error('Error formatting date/time:', e, 'dateStr:', dateStr, 'timeStr:', timeStr);
                const normalizedTime = (timeStr || '').toString().trim();
                const hasValidTime = normalizedTime !== '' && normalizedTime !== '00:00' && normalizedTime !== '0:00';
                return dateStr + (hasValidTime ? ' ' + normalizedTime : '');
            }
        }
        
        function formatChangeHistory(changeHistory) {
            if (!changeHistory) return '';
            // Change history format: "2025-10-11T10:24:00Z - User: Updated ticket\n..." or "2025-10-11T10:24:00.000Z - User: Updated ticket\n..."
            const lines = changeHistory.split('\n');
            return lines.map(line => {
                if (!line.trim()) return line;
                
                // Try multiple timestamp patterns
                // Pattern 1: ISO with milliseconds: 2025-10-11T10:24:00.000Z
                let timestampMatch = line.match(/(\d{4}-\d{2}-\d{2}[T ]\d{2}:\d{2}:\d{2}\.\d{3}Z?)/);
                if (timestampMatch) {
                    const timestamp = timestampMatch[1];
                    const formatted = formatTimestamp(timestamp);
                    return line.replace(timestamp, formatted);
                }
                
                // Pattern 2: ISO without milliseconds: 2025-10-11T10:24:00Z
                timestampMatch = line.match(/(\d{4}-\d{2}-\d{2}[T ]\d{2}:\d{2}:\d{2}Z?)/);
                if (timestampMatch) {
                    const timestamp = timestampMatch[1];
                    const formatted = formatTimestamp(timestamp);
                    return line.replace(timestamp, formatted);
                }
                
                // Pattern 3: Date only: 2025-10-11
                timestampMatch = line.match(/(\d{4}-\d{2}-\d{2})(?![T ])/);
                if (timestampMatch) {
                    const dateStr = timestampMatch[1];
                    // Try to format as date
                    try {
                        const [year, month, day] = dateStr.split('-').map(Number);
                        const date = new Date(year, month - 1, day);
                        if (!isNaN(date.getTime())) {
                            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                            const dayName = days[date.getDay()];
                            const getOrdinal = (n) => {
                                const s = ['th', 'st', 'nd', 'rd'];
                                const v = n % 100;
                                return n + (s[(v - 20) % 10] || s[v] || s[0]);
                            };
                            const formatted = `${dayName} ${getOrdinal(day)} ${months[month - 1]}, ${year}`;
                            return line.replace(dateStr, formatted);
                        }
                    } catch (e) {
                        // If formatting fails, return line as-is
                    }
                }
                
                return line;
            }).join('\n');
        }

        function renderTicketQRCodes(rootElement = document) {
            if (typeof QRCode === 'undefined') {
                return;
            }
            const elements = rootElement.querySelectorAll('.ticket-qr');
            elements.forEach(container => {
                const serial = container.dataset.serial;
                const isDuplicate = container.dataset.duplicate === 'true';
                const ticketColor = container.dataset.color || 'blue';
                if (!serial) return;
                const mode = isDuplicate ? 'edit' : 'view';
                const link = buildScanUrl(serial, mode, ticketColor);
                container.innerHTML = '';
                const canvas = document.createElement('canvas');
                QRCode.toCanvas(canvas, link, {
                    width: 140,
                    margin: 0,
                    color: {
                        dark: '#1a202c',
                        light: '#ffffff'
                    }
                }, (error) => {
                    if (error) {
                        container.textContent = 'QR';
                        return;
                    }
                    canvas.style.width = '100%';
                    canvas.style.height = '100%';
                    container.appendChild(canvas);
                });
                container.title = `Scan to ${mode === 'view' ? 'view' : 'edit'} ${serial}`;
            });
        }

        function createTicketHTML(serialNum, color, isDuplicate, data = {}, qrMode = 'edit') {
            const serialValue = typeof serialNum === 'number' ? formatSerial(serialNum) : (serialNum || '');
            const ticketColor = data.color || color;
            const duplicateBadge = isDuplicate ? '<span class="duplicate-label">DUPLICATE</span>' : '';
            const bandingSelections = new Set((data.bandingType || []).map(value => value.toLowerCase()));
            const productSelections = new Set((data.productType || []).map(value => value.toLowerCase()));
            const palletSelections = new Set((data.palletSize || []).map(value => value.toLowerCase()));

            const renderFieldValue = (value) => {
                const content = value !== undefined && value !== null && value !== ''
                    ? escapeHtml(String(value))
                    : '';
                const filledClass = content ? ' filled' : '';
                return `<span class="field-value${filledClass}">${content ? `<span>${content}</span>` : ''}</span>`;
            };

            return `
                <div class="ticket-column">
                    <div class="ticket ${ticketColor} ${isDuplicate ? 'duplicate' : ''}">
                            <div class="ticket-header">Promotion Items ¬∑ Finished Goods</div>
                        <div class="serial-wrapper">
                            <div class="serial-number">
                                <span>${serialValue}</span>
                                ${duplicateBadge}
                        </div>
                            <div class="ticket-qr" data-serial="${serialValue}" data-duplicate="${isDuplicate}" data-mode="${qrMode}" data-color="${ticketColor}"></div>
                        </div>
                        <div class="ticket-body">
                            <div class="field-row">
                                <div class="field-group">
                                    <span class="field-label">Date:</span>
                                    ${renderFieldValue(data.date)}
                                </div>
                                <div class="field-group">
                                    <span class="field-label">Time:</span>
                                    ${renderFieldValue(data.time)}
                                </div>
                            </div>
                            
                            <div class="field-row">
                                <div class="field-group">
                                    <span class="field-label">SKU:</span>
                                    ${renderFieldValue(data.sku)}
                                </div>
                            </div>
                            
                            <div class="field-row">
                                <div class="field-group">
                                    <span class="field-label">Qty:</span>
                                    ${renderFieldValue(data.qty)}
                                </div>
                                <div class="field-group">
                                    <span class="field-label">Layers:</span>
                                    ${renderFieldValue(data.layers)}
                                </div>
                            </div>
                            <div class="checkbox-columns">
                                <div class="checkbox-column">
                                    <div class="checkbox-column-title">Banding Type</div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="online_${serialNum}_${isDuplicate}" ${bandingSelections.has('online') ? 'checked' : ''}>
                                        <label for="online_${serialNum}_${isDuplicate}">Online</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="offline_${serialNum}_${isDuplicate}" ${bandingSelections.has('offline') ? 'checked' : ''}>
                                        <label for="offline_${serialNum}_${isDuplicate}">Offline</label>
                                    </div>
                                </div>
                                <div class="checkbox-column">
                                    <div class="checkbox-column-title">Product Type</div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="fg1_${serialNum}_${isDuplicate}" ${productSelections.has('1kg') ? 'checked' : ''}>
                                        <label for="fg1_${serialNum}_${isDuplicate}">1kg</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="fg05_${serialNum}_${isDuplicate}" ${productSelections.has('0.5kg') || productSelections.has('05kg') ? 'checked' : ''}>
                                        <label for="fg05_${serialNum}_${isDuplicate}">0.5kg</label>
                                    </div>
                                </div>
                                <div class="checkbox-column pallet">
                                    <div class="checkbox-column-title">Pallet Size</div>
                                    <div class="checkbox-items">
                                    <div class="checkbox-item">
                                            <input type="checkbox" id="p78_${serialNum}_${isDuplicate}" ${palletSelections.has('78') ? 'checked' : ''}>
                                        <label for="p78_${serialNum}_${isDuplicate}">78</label>
                                    </div>
                                    <div class="checkbox-item">
                                            <input type="checkbox" id="p105_${serialNum}_${isDuplicate}" ${palletSelections.has('105') ? 'checked' : ''}>
                                        <label for="p105_${serialNum}_${isDuplicate}">105</label>
                                    </div>
                                    <div class="checkbox-item">
                                            <input type="checkbox" id="p64_${serialNum}_${isDuplicate}" ${palletSelections.has('64') ? 'checked' : ''}>
                                        <label for="p64_${serialNum}_${isDuplicate}">64</label>
                                    </div>
                                    <div class="checkbox-item">
                                            <input type="checkbox" id="p100_${serialNum}_${isDuplicate}" ${palletSelections.has('100') ? 'checked' : ''}>
                                        <label for="p100_${serialNum}_${isDuplicate}">100</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="ticket-footer">Powered by NexGridCore DataLabs</div>
                    </div>
                </div>
            `;
        }

        // Google Sheets API Functions - Using Apps Script
        async function readTicketFromSheet(serial) {
            if (!GOOGLE_APPS_SCRIPT_URL) {
                throw new Error('Google Apps Script URL not configured');
            }
            try {
                const url = `${GOOGLE_APPS_SCRIPT_URL}?action=read&serial=${encodeURIComponent(serial)}`;
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Failed to read ticket: ${response.statusText}`);
                }
                const result = await response.json();
                if (!result.success) {
                    // If ticket not found, return null instead of throwing error
                    if (result.error && result.error.includes('not found')) {
                        return null;
                    }
                    throw new Error(result.error || 'Failed to read ticket');
                }
                if (!result.data) {
                    return null;
                }
                
                const ticket = result.data;
                if (result.pallet) {
                    ticket.pallet = result.pallet;
                }
                
                // Normalize field names - handle case variations and ensure Date/Time are correctly mapped
                // Google Sheets might return headers with different casing
                const normalizedTicket = {};
                
                // First, copy all original fields
                Object.keys(ticket).forEach(key => {
                    normalizedTicket[key] = ticket[key];
                });
                
                // Then normalize specific fields we need
                Object.keys(ticket).forEach(key => {
                    const normalizedKey = key.toLowerCase().trim();
                    
                    // Map Date field (column B) - try all variations
                    if (normalizedKey === 'date') {
                        normalizedTicket.Date = ticket[key];
                    }
                    // Map Time field (column C) - try all variations
                    else if (normalizedKey === 'time') {
                        normalizedTicket.Time = ticket[key];
                    }
                    // Map SachetType and TabletType
                    else if (normalizedKey === 'sachettype' || normalizedKey === 'sachet type') {
                        normalizedTicket.SachetType = ticket[key];
                    } else if (normalizedKey === 'tablettype' || normalizedKey === 'tablet type') {
                        normalizedTicket.TabletType = ticket[key];
                    }
                });
                
                // Ensure Date and Time are accessible with multiple fallbacks
                // Try direct access first, then normalized
                if (!normalizedTicket.Date) {
                    normalizedTicket.Date = ticket.Date || ticket['Date'] || ticket.date || ticket.DATE || '';
                }
                if (!normalizedTicket.Time) {
                    normalizedTicket.Time = ticket.Time || ticket['Time'] || ticket.time || ticket.TIME || '';
                }
                
                // Convert Date and Time from ISO strings to proper format
                // Date comes as ISO string like "2025-11-14T21:00:00.000Z" - extract just the date part
                // Time comes as ISO string like "1899-12-30T18:50:44.000Z" - extract just the time part
                // (1899-12-30 is Excel/Sheets epoch for time-only values)
                if (normalizedTicket.Date) {
                    try {
                        const dateObj = new Date(normalizedTicket.Date);
                        if (!isNaN(dateObj.getTime())) {
                            // Extract YYYY-MM-DD format
                            const year = dateObj.getFullYear();
                            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                            const day = String(dateObj.getDate()).padStart(2, '0');
                            normalizedTicket.Date = `${year}-${month}-${day}`;
                        }
                    } catch (e) {
                        // Silently handle date parsing errors
                    }
                }
                
                if (normalizedTicket.Time) {
                    try {
                        const timeObj = new Date(normalizedTicket.Time);
                        if (!isNaN(timeObj.getTime())) {
                            // Extract HH:MM format (24-hour)
                            const hours = String(timeObj.getHours()).padStart(2, '0');
                            const minutes = String(timeObj.getMinutes()).padStart(2, '0');
                            normalizedTicket.Time = `${hours}:${minutes}`;
                        }
                    } catch (e) {
                        // Silently handle time parsing errors
                    }
                }
                
                // Ensure SachetType and TabletType are accessible
                if (ticket.SachetType !== undefined) normalizedTicket.SachetType = ticket.SachetType;
                if (ticket['Sachet Type'] !== undefined) normalizedTicket.SachetType = ticket['Sachet Type'];
                if (ticket.TabletType !== undefined) normalizedTicket.TabletType = ticket.TabletType;
                if (ticket['Tablet Type'] !== undefined) normalizedTicket.TabletType = ticket['Tablet Type'];
                
                // Parse JSON fields
                if (normalizedTicket.MerchHistory) {
                    try {
                        normalizedTicket.MerchHistory = typeof normalizedTicket.MerchHistory === 'string' ? JSON.parse(normalizedTicket.MerchHistory) : normalizedTicket.MerchHistory;
                    } catch (e) {
                        normalizedTicket.MerchHistory = [];
                    }
                }
                
                // Merge normalized fields back
                Object.assign(ticket, normalizedTicket);
                
                return ticket;
            } catch (error) {
                throw error;
            }
        }
        
        async function saveTicketToSheet(ticketData, isUpdate = false, existingTicket = null) {
            if (!GOOGLE_APPS_SCRIPT_URL) {
                throw new Error('Google Apps Script URL not configured');
            }
            
            const timestamp = new Date().toISOString();
            const changeEntry = `${timestamp} - ${ticketData.modifiedBy || 'System'}: ${isUpdate ? 'Updated ticket' : 'Created ticket'}`;
            
            // Fix timestamps: CreatedAt, FirstModified, LastModified should be different
            let createdAt, firstModified, lastModified;
            if (isUpdate && existingTicket) {
                // Update: preserve original timestamps, update lastModified
                createdAt = existingTicket.CreatedAt || timestamp;
                // If FirstModified is empty or same as CreatedAt, set it now (first update)
                if (!existingTicket.FirstModified || existingTicket.FirstModified === existingTicket.CreatedAt) {
                    firstModified = timestamp; // First modification
                } else {
                    firstModified = existingTicket.FirstModified; // Preserve original first modification
                }
                lastModified = timestamp; // Always update last modified
            } else {
                // New ticket: all timestamps are the same initially
                createdAt = timestamp;
                firstModified = timestamp; // Will be updated on first modification
                lastModified = timestamp;
            }
            
            const row = [
                ticketData.serial,
                ticketData.date || '',
                ticketData.time || '',
                ticketData.sku || '',
                ticketData.qty || '',
                ticketData.layers || '',
                (ticketData.bandingType || []).join(','),
                (ticketData.productType || []).join(','),
                (ticketData.palletSize || []).join(','),
                ticketData.notes || '',
                ticketData.qualityIssueType || '',
                ticketData.qualityIssueDesc || '',
                ticketData.groupLeader || '',
                ticketData.sachetType || '',
                ticketData.tabletType || '',
                JSON.stringify(ticketData.merchHistory || []),
                createdAt,
                firstModified,
                lastModified,
                isUpdate ? (existingTicket?.ChangeHistory || '') + '\n' + changeEntry : changeEntry,
                ticketData.modifiedBy || 'System'
            ];
            
            try {
                // Use GET requests instead of POST to avoid CORS issues
                // Since GET works, we'll use it for writes too
                const serial = ticketData.serial;
                
                // Build query parameters - include productType and oldQty for calculations
                const oldQty = isUpdate && existingTicket ? (existingTicket.Qty || '0') : '0';
                const productType = (ticketData.productType || []).join(',');
                
                const params = new URLSearchParams({
                    action: isUpdate ? 'update' : 'append',
                    serial: serial,
                    values: JSON.stringify(row),
                    sku: ticketData.sku || '',
                    qty: ticketData.qty || '',
                    oldQty: oldQty,
                    productType: productType
                });
                
                const url = `${GOOGLE_APPS_SCRIPT_URL}?${params.toString()}`;
                console.log('Calling Apps Script with GET:', url.substring(0, 200) + '...');
                
                let response;
                try {
                    response = await fetch(url, {
                        method: 'GET',
                        headers: { 'Accept': 'application/json' }
                    });
                } catch (fetchError) {
                    console.error('Fetch error:', fetchError);
                    throw new Error(`Failed to connect to Apps Script: ${fetchError.message}. Please check:\n1. Apps Script URL is correct\n2. Apps Script is deployed with "Anyone" access\n3. Your internet connection is stable`);
                }
                
                if (!response.ok) {
                    const errorText = await response.text().catch(() => 'Unknown error');
                    throw new Error(`Failed to save: ${response.status} ${response.statusText}. Response: ${errorText.substring(0, 200)}`);
                }
                
                // Get response as text first, then parse
                const responseText = await response.text();
                console.log('Raw response from Apps Script:', responseText);
                console.log('Response length:', responseText.length);
                console.log('Response starts with:', responseText.substring(0, 50));
                
                // Check if Apps Script returned the raw form data (indicates it didn't process)
                if (responseText.startsWith('data=') || responseText.includes('%7B')) {
                    console.error('Apps Script appears to be returning raw request data instead of processing it');
                    throw new Error(`Apps Script error: The script is not processing the request correctly. It returned: "${responseText.substring(0, 100)}". Please check:\n1. Apps Script is deployed as a Web App (not API Executable)\n2. The doPost function exists in your Apps Script\n3. You've updated the Apps Script with the latest code\n4. Check Apps Script execution logs for errors`);
                }
                
                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (parseError) {
                    // If parsing fails, the response might be the form data itself
                    console.error('Failed to parse response as JSON:', parseError);
                    console.error('Full response text:', responseText);
                    throw new Error(`Invalid response from Apps Script. Expected JSON but got: "${responseText.substring(0, 200)}". Please check your Apps Script deployment and code.`);
                }
                
                if (!result.success) {
                    throw new Error(result.error || 'Failed to save ticket');
                }
                
                console.log('Successfully saved to sheet:', result);
                return result;
            } catch (error) {
                console.error('Error saving ticket:', error);
                // Provide more helpful error message
                if (error.message.includes('fetch') || error.message.includes('Failed to fetch')) {
                    throw new Error(`Network error: Failed to connect to Google Apps Script.\n\nPlease check:\n1. Apps Script is deployed with "Anyone, even anonymous" access\n2. The Apps Script URL is correct\n3. Your internet connection is stable\n\nOriginal error: ${error.message}`);
                }
                throw error;
            }
        }
        
        async function testGoogleSheetsConnection() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = '<div style="color: #667eea;">üîÑ Testing connection...</div>';
            
            const tests = [];
            
            // Test 1: Read headers
            try {
                const readUrl = `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_SHEET_ID}/values/Tickets!A1:S1?key=${GOOGLE_API_KEY}`;
                const readResponse = await fetch(readUrl);
                if (readResponse.ok) {
                    const data = await readResponse.json();
                    tests.push({ name: '‚úÖ Read Headers', status: 'success', details: `Found ${data.values?.[0]?.length || 0} columns` });
                } else {
                    const error = await readResponse.json().catch(() => ({}));
                    tests.push({ name: '‚ùå Read Headers', status: 'error', details: error.error?.message || readResponse.statusText });
                }
            } catch (e) {
                tests.push({ name: '‚ùå Read Headers', status: 'error', details: e.message });
            }
            
            // Test 2: Write test (append a test row)
            try {
                const testRow = [['TEST-' + Date.now(), new Date().toISOString().split('T')[0], '00:00', 'TEST-SKU', '1', '1', 'online', '1kg', '78', 'Test entry - can be deleted', '', '', '', '[]', new Date().toISOString(), new Date().toISOString(), new Date().toISOString(), 'Test', 'System']];
                const appendUrl = `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_SHEET_ID}/values/Tickets!A2:append?valueInputOption=RAW&insertDataOption=INSERT_ROWS&key=${GOOGLE_API_KEY}`;
                const appendResponse = await fetch(appendUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ values: testRow })
                });
                
                if (appendResponse.ok) {
                    tests.push({ name: '‚úÖ Write Test', status: 'success', details: 'Successfully wrote test row to sheet!' });
                } else {
                    const error = await appendResponse.json().catch(() => ({}));
                    const errorMsg = error.error?.message || appendResponse.statusText;
                    tests.push({ name: '‚ùå Write Test', status: 'error', details: errorMsg });
                }
            } catch (e) {
                tests.push({ name: '‚ùå Write Test', status: 'error', details: e.message });
            }
            
            // Test 3: Check sheet sharing
            try {
                const metaUrl = `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_SHEET_ID}?key=${GOOGLE_API_KEY}`;
                const metaResponse = await fetch(metaUrl);
                if (metaResponse.ok) {
                    const meta = await metaResponse.json();
                    tests.push({ name: '‚úÖ Sheet Access', status: 'success', details: `Sheet: "${meta.properties?.title || 'Unknown'}"` });
                } else {
                    tests.push({ name: '‚ùå Sheet Access', status: 'error', details: 'Cannot access sheet metadata' });
                }
            } catch (e) {
                tests.push({ name: '‚ùå Sheet Access', status: 'error', details: e.message });
            }
            
            // Display results
            const allPassed = tests.every(t => t.status === 'success');
            resultsDiv.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 10px; color: ${allPassed ? '#10b981' : '#ef4444'};">
                    ${allPassed ? '‚úÖ All Tests Passed!' : '‚ùå Some Tests Failed'}
                </div>
                ${tests.map(t => `
                    <div style="margin: 5px 0; padding: 8px; background: ${t.status === 'success' ? '#f0fdf4' : '#fef2f2'}; border-left: 3px solid ${t.status === 'success' ? '#10b981' : '#ef4444'};">
                        <strong>${t.name}</strong><br>
                        <small style="color: #666;">${t.details}</small>
                    </div>
                `).join('')}
                ${!allPassed ? `
                    <div style="margin-top: 15px; padding: 10px; background: #fef3c7; border-radius: 5px; font-size: 11px;">
                        <strong>üí° Troubleshooting Tips:</strong><br>
                        1. Configure OAuth consent screen in Google Cloud Console<br>
                        2. Share sheet: "Anyone with the link" ‚Üí "Editor"<br>
                        3. Enable Google Sheets API in Google Cloud Console<br>
                        4. Check API key restrictions include Google Sheets API
                    </div>
                ` : ''}
            `;
        }
        
        async function loadAuthorizedUsers() {
            if (!GOOGLE_APPS_SCRIPT_URL) return { users: [], skus: [], sachetTypes: [], tabletTypes: [] };
            try {
                const url = `${GOOGLE_APPS_SCRIPT_URL}?action=users`;
                const response = await fetch(url);
                if (!response.ok) return { users: [], skus: [], sachetTypes: [], tabletTypes: [] };
                const result = await response.json();
                if (!result.success) return { users: [], skus: [], sachetTypes: [], tabletTypes: [] };
                return {
                    users: result.data || [],
                    skus: result.skus || [],
                    sachetTypes: result.sachetTypes || [],
                    tabletTypes: result.tabletTypes || []
                };
            } catch (error) {
                console.error('Error loading users:', error);
                return { users: [], skus: [], sachetTypes: [], tabletTypes: [] };
            }
        }
        
        function populateDropdown(selectId, options, placeholder = 'Select...') {
            const select = document.getElementById(selectId);
            if (!select) return;
            select.innerHTML = `<option value="">${placeholder}</option>`;
            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                select.appendChild(option);
            });
        }
        
        function populateSKUDropdown(skus) {
            const skuSelect = document.getElementById('fillSku');
            const skuCustom = document.getElementById('fillSkuCustom');
            
            if (!skuSelect) return;
            
            // Clear existing options except the first one
            skuSelect.innerHTML = '<option value="">Select or type SKU...</option>';
            
            // Add SKUs from the list
            skus.forEach(sku => {
                const option = document.createElement('option');
                option.value = sku;
                option.textContent = sku;
                skuSelect.appendChild(option);
            });
            
            // Add "Custom..." option
            const customOption = document.createElement('option');
            customOption.value = '__custom__';
            customOption.textContent = '--- Enter Custom SKU ---';
            skuSelect.appendChild(customOption);
            
            // Handle selection change
            skuSelect.addEventListener('change', function() {
                if (this.value === '__custom__') {
                    this.style.display = 'none';
                    if (skuCustom) {
                        skuCustom.style.display = 'block';
                        skuCustom.focus();
                    }
                } else if (this.value) {
                    if (skuCustom) {
                        skuCustom.style.display = 'none';
                        skuCustom.value = '';
                    }
                }
            });
            
            // Handle custom input
            if (skuCustom) {
                skuCustom.addEventListener('input', function() {
                    if (this.value) {
                        skuSelect.value = '';
                    }
                });
                
                skuCustom.addEventListener('blur', function() {
                    if (!this.value) {
                        this.style.display = 'none';
                        skuSelect.style.display = 'block';
                    }
                });
            }
        }

        function populateAuthorizedUserSelects(users) {
            const loginSelect = document.getElementById('loginUser');
            if (loginSelect) {
                loginSelect.innerHTML = '<option value="">Select authorized user...</option>' +
                    users.map(u => `<option value="${u.id}">${u.name}</option>`).join('');
            }
        }

        async function authenticateUser(userId, passcode) {
            if (!GOOGLE_APPS_SCRIPT_URL) {
                throw new Error('Apps Script URL not configured');
            }
            const url = `${GOOGLE_APPS_SCRIPT_URL}?action=login&userId=${encodeURIComponent(userId)}&passcode=${encodeURIComponent(passcode)}`;
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`Login failed: ${response.statusText}`);
            }
            const result = await response.json();
            if (!result.success) {
                throw new Error(result.error || 'Invalid credentials');
            }
            return result.data;
        }

        function showLoginCard() {
            const loginCard = document.getElementById('loginCard');
            const editCard = document.getElementById('editCard');
            if (loginCard) loginCard.style.display = 'block';
            if (editCard) editCard.style.display = 'none';
            const fillPreview = document.querySelector('.fill-preview');
            if (fillPreview) fillPreview.style.display = 'none';
            const banner = document.getElementById('loggedInUserBanner');
            if (banner) banner.style.display = 'none';
        }

        function showEditCard() {
            const loginCard = document.getElementById('loginCard');
            const editCard = document.getElementById('editCard');
            if (loginCard) loginCard.style.display = 'none';
            if (editCard) editCard.style.display = 'block';
            updateLoggedInUserBanner();
        }

        async function handleLoginSubmit(event) {
            event.preventDefault();
            const loginStatus = document.getElementById('loginStatus');
            if (loginStatus) {
                loginStatus.textContent = 'üîê Verifying credentials...';
                loginStatus.classList.remove('error', 'success');
            }
            const userId = document.getElementById('loginUser')?.value;
            const passcode = document.getElementById('loginPasscode')?.value;
            if (!userId || !passcode) {
                if (loginStatus) {
                    loginStatus.textContent = '‚ùå Select a user and enter the passcode.';
                    loginStatus.classList.add('error');
                }
                return;
            }
            try {
                const userData = await authenticateUser(userId, passcode);
                setLoggedInUser({
                    id: userData.id || userId,
                    name: userData.name || userId,
                    loginAt: new Date().toISOString()
                });
                document.getElementById('loginPasscode').value = '';
                showEditCard();
                updateLoggedInUserBanner();
                if (loginStatus) {
                    loginStatus.textContent = '‚úÖ Login successful. Editor unlocked.';
                    loginStatus.classList.add('success');
                }
            } catch (error) {
                if (loginStatus) {
                    loginStatus.textContent = `‚ùå ${error.message}`;
                    loginStatus.classList.add('error');
                }
            }
        }
        
        // SKU Calculations are now handled automatically by Apps Script
        async function updateSKUCalculations(sku, qty) {
            // This function is kept for compatibility but calculations are handled by Apps Script
            // when saving tickets (see saveTicketToSheet function)
            console.log('SKU calculations handled by Apps Script');
        }
        
        // View Mode Functions
        async function initViewMode(serial) {
            document.body.classList.add('fill-mode-active');
            const fillContainer = document.getElementById('fillContainer');
            if (fillContainer) {
                fillContainer.classList.add('visible');
            }
            const movementSection = document.getElementById('movementSection');
            if (movementSection) {
                movementSection.style.display = 'block';
            }
            
            const viewCard = document.getElementById('viewCard');
            const editCard = document.getElementById('editCard');
            const fillPreview = document.querySelector('.fill-preview');
            if (viewCard) viewCard.style.display = 'block';
            if (editCard) editCard.style.display = 'none';
            if (fillPreview) fillPreview.style.display = 'none'; // Hide preview in view mode
            
            const serialValue = serial ? decodeURIComponent(serial) : formatSerial(currentSerial);
            const viewSerialDisplay = document.getElementById('viewSerialDisplay');
            if (viewSerialDisplay) {
                viewSerialDisplay.textContent = serialValue;
            }
            
            // Prevent back navigation - replace current history entry
            window.history.replaceState(null, '', window.location.href);
            
            // Block back button/swipe back
            window.addEventListener('popstate', (e) => {
                // Prevent going back to generator page
                window.history.pushState(null, '', window.location.href);
            });
            
            // Push a state to prevent back navigation
            window.history.pushState(null, '', window.location.href);
            
            const viewLoading = document.getElementById('viewLoading');
            const viewData = document.getElementById('viewData');
            
            try {
                const ticket = await readTicketFromSheet(serialValue);
                if (viewLoading) viewLoading.style.display = 'none';
                if (viewData) {
                    viewData.style.display = 'block';
                    if (!ticket) {
                        viewData.innerHTML = '<p style="text-align: center; padding: 40px; color: #718096;">No data found for this ticket.</p>';
                    } else {
                        viewData.innerHTML = renderViewMode(ticket);
                    }
                }
            } catch (error) {
                if (viewLoading) viewLoading.style.display = 'none';
                if (viewData) {
                    viewData.style.display = 'block';
                    viewData.innerHTML = `<p style="text-align: center; padding: 40px; color: #e53e3e;">Error loading ticket: ${error.message}</p>`;
                }
            }
        }
        
        function renderViewMode(ticket) {
            const merchHistory = ticket.MerchHistory ? (typeof ticket.MerchHistory === 'string' ? JSON.parse(ticket.MerchHistory) : ticket.MerchHistory) : [];
            
            // Detect color from serial number
            const serial = ticket.Serial || '';
            const ticketColor = serial.includes('-BL-') ? 'blue' :
                              serial.includes('-RD-') ? 'red' :
                              serial.includes('-GN-') ? 'green' :
                              serial.includes('-YL-') ? 'yellow' : 'blue';
            
            // Color coding
            const colorMap = {
                blue: { bg: '#e6f2ff', border: '#3182ce', text: '#2c5282', accent: '#4299e1' },
                red: { bg: '#fff5f5', border: '#e53e3e', text: '#742a2a', accent: '#fc8181' },
                green: { bg: '#f0fff4', border: '#38a169', text: '#22543d', accent: '#68d391' },
                yellow: { bg: '#fffbeb', border: '#d69e2e', text: '#744210', accent: '#f6e05e' }
            };
            const colors = colorMap[ticketColor] || colorMap.blue;
            
            // Format timestamps
            const createdAt = formatTimestamp(ticket.CreatedAt);
            const firstModified = formatTimestamp(ticket.FirstModified);
            const lastModified = formatTimestamp(ticket.LastModified);
            
            // Format Date and Time - ensure we're reading from the correct fields
            // Date is column B, Time is column C
            const dateValue = ticket.Date || ticket['Date'] || '';
            const timeValue = ticket.Time || ticket['Time'] || '';
            const formattedDateTime = formatDateAndTime(dateValue, timeValue);
            const palletInfo = ticket.pallet || ticket.PalletInfo || ticket._pallet || null;
            const originalQty = (() => {
                if (palletInfo && palletInfo.Quantity != null && palletInfo.Quantity !== '') {
                    const value = Number(palletInfo.Quantity);
                    if (!isNaN(value)) return value;
                }
                return parseFloat(ticket.Qty || 0) || 0;
            })();
            const remainingQty = (() => {
                if (palletInfo && palletInfo.RemainingQuantity != null && palletInfo.RemainingQuantity !== '') {
                    const value = Number(palletInfo.RemainingQuantity);
                    if (!isNaN(value)) return value;
                }
                return originalQty;
            })();
            const palletZone = palletInfo && palletInfo.CurrentZone ? palletInfo.CurrentZone : 'Receiving Area';
            const palletStatus = palletInfo && palletInfo.Status ? palletInfo.Status : 'Received';
            const palletRemaining = palletInfo && (palletInfo.RemainingQuantity ?? palletInfo.Quantity) ? (palletInfo.RemainingQuantity ?? palletInfo.Quantity) : '‚Äî';
            const palletLastMove = palletInfo && palletInfo.LastMovedAt ? formatMovementDate(palletInfo.LastMovedAt) : 'Not moved yet';
            const palletCreated = palletInfo && palletInfo.CreatedAt ? formatMovementDate(palletInfo.CreatedAt) : 'Pending';
            const palletInfoCard = `
                <div style="background: ${colors.bg}; padding: 20px; border-radius: 8px; border-left: 4px solid ${colors.border};">
                    <h3 style="margin: 0 0 15px 0; color: ${colors.text}; font-size: 18px; font-weight: 600;">üìç Pallet Location</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px;">
                        <div><strong style="color: ${colors.text};">Current Zone:</strong> <span style="color: #2d3748;">${escapeHtml(palletZone)}</span></div>
                        <div><strong style="color: ${colors.text};">Status:</strong> <span style="color: #2d3748;">${escapeHtml(palletStatus)}</span></div>
                        <div><strong style="color: ${colors.text};">Original Qty:</strong> <span style="color: #2d3748;">${escapeHtml(originalQty.toString())}</span></div>
                        <div><strong style="color: ${colors.text};">Remaining Qty:</strong> <span style="color: #2d3748;">${escapeHtml(remainingQty.toString())}</span></div>
                        <div><strong style="color: ${colors.text};">Last Movement:</strong> <span style="color: #4a5568;">${escapeHtml(palletLastMove)}</span></div>
                        <div><strong style="color: ${colors.text};">Pallet Created:</strong> <span style="color: #4a5568;">${escapeHtml(palletCreated)}</span></div>
                    </div>
                    ${!palletInfo ? `<div style="margin-top: 12px; padding: 10px; background: #fff; border-radius: 6px; color: #718096; font-size: 13px;">No pallet movement recorded yet. Submit this ticket via the Stock Movement panel to update.</div>` : ''}
                </div>
            `;
            
            // Parse Product Type to check for 1KG or 0.5KG
            const productType = (ticket.ProductType || '').toLowerCase();
            const has1KG = productType.includes('1kg') || productType.includes('1 kg');
            const has05KG = productType.includes('0.5kg') || productType.includes('0.5 kg') || productType.includes('0,5kg');
            const qty = remainingQty;
            let pieces = 0;
            let tabletSachetInfo = '';
            
            // Show tablet/sachet info if product type is 1KG or 0.5KG, regardless of quantity
            if (has1KG) {
                pieces = qty * 6;
                tabletSachetInfo = '1KG';
            } else if (has05KG) {
                pieces = qty * 12;
                tabletSachetInfo = '0.5KG';
            }
            
            // Calculate layers based on pallet size and quantity
            const palletConfig = {
                '100': { layers: 5, cartonsPerLayer: 20 },   // 100 / 5 = 20
                '105': { layers: 7, cartonsPerLayer: 15 },   // 105 / 7 = 15
                '78': { layers: 6, cartonsPerLayer: 13 },    // 78 / 6 = 13
                '64': { layers: 4, cartonsPerLayer: 16 }     // 64 / 4 = 16
            };
            
            let layersInfo = null;
            const palletSizeStr = (ticket.PalletSize || '').toString().trim();
            
            const computeLayerInfo = (quantityValue) => {
                if (!palletSizeStr || quantityValue <= 0) return null;
                const palletSizes = palletSizeStr.split(',').map(ps => ps.trim()).filter(ps => ps !== '');
                if (!palletSizes.length) return null;
                const palletSize = palletSizes[0];
                const config = palletConfig[palletSize];
                if (!config) return null;
                const cartonsPerLayer = config.cartonsPerLayer;
                const calculatedLayers = Math.ceil(quantityValue / cartonsPerLayer);
                const fullLayers = Math.floor(quantityValue / cartonsPerLayer);
                const remainderUnits = quantityValue % cartonsPerLayer;
                return {
                    palletSize,
                    cartonsPerLayer,
                    calculatedLayers,
                    fullLayers,
                    remainderUnits
                };
            };

            layersInfo = computeLayerInfo(remainingQty);
            const layersInfoOriginal = originalQty !== remainingQty ? computeLayerInfo(originalQty) : null;
            
            return `
                <div style="max-width: 900px; margin: 0 auto; padding: 30px; background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <div style="border-left: 6px solid ${colors.border}; padding-left: 20px; margin-bottom: 30px;">
                        <h2 style="margin: 0 0 5px 0; color: ${colors.text}; font-size: 28px; font-weight: 700;">${escapeHtml(serial)}</h2>
                    </div>
                    
                    <div style="display: grid; gap: 20px; margin-bottom: 30px;">
                        <div style="background: ${colors.bg}; padding: 20px; border-radius: 8px; border-left: 4px solid ${colors.border};">
                            <h3 style="margin: 0 0 15px 0; color: ${colors.text}; font-size: 18px; font-weight: 600;">Basic Information</h3>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                <div><strong style="color: ${colors.text};">Serial:</strong> <span style="color: #2d3748;">${escapeHtml(serial)}</span></div>
                                <div><strong style="color: ${colors.text};">Date & Time:</strong> <span style="color: #4a5568; font-family: 'Courier New', monospace;">${escapeHtml(formattedDateTime || 'N/A')}</span></div>
                                <div><strong style="color: ${colors.text};">SKU:</strong> <span style="color: #2d3748;">${escapeHtml(ticket.SKU || '')}</span></div>
                                <div>
                                    <strong style="color: ${colors.text};">Quantity (Original):</strong>
                                    <span style="color: #2d3748;">${escapeHtml(originalQty.toString())}</span>
                                </div>
                                <div>
                                    <strong style="color: ${colors.text};">Quantity (Remaining):</strong>
                                    <span style="color: #2d3748;">${escapeHtml(remainingQty.toString())}</span>
                                </div>
                                <div><strong style="color: ${colors.text};">Layers:</strong> 
                                    <span style="color: #2d3748;">
                                        ${layersInfo ? escapeHtml(layersInfo.calculatedLayers.toString()) : escapeHtml(ticket.Layers || '')}
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        ${palletInfoCard}
                        
                        <div style="background: ${colors.bg}; padding: 20px; border-radius: 8px; border-left: 4px solid ${colors.border};">
                            <h3 style="margin: 0 0 15px 0; color: ${colors.text}; font-size: 18px; font-weight: 600;">Product Details</h3>
                            <div style="display: grid; gap: 10px;">
                                <div><strong style="color: ${colors.text};">Banding Type:</strong> <span style="color: #2d3748; text-transform: uppercase;">${escapeHtml((ticket.BandingType || '').toUpperCase())}</span></div>
                                <div><strong style="color: ${colors.text};">Product Type:</strong> <span style="color: #2d3748; text-transform: uppercase;">${escapeHtml((ticket.ProductType || '').toUpperCase())}</span></div>
                                <div><strong style="color: ${colors.text};">Pallet Size:</strong> <span style="color: #2d3748;">${escapeHtml(ticket.PalletSize || '')}</span></div>
                            </div>
                        </div>
                        
                        ${layersInfo ? `
                        <div style="background: ${colors.bg}; padding: 20px; border-radius: 8px; border-left: 4px solid ${colors.border};">
                            <h3 style="margin: 0 0 15px 0; color: ${colors.text}; font-size: 18px; font-weight: 600;">üìä Layer Calculations</h3>
                            <div style="display: grid; gap: 10px;">
                                <div><strong style="color: ${colors.text};">Pallet Size:</strong> <span style="color: #2d3748;">${escapeHtml(layersInfo.palletSize)} cartons</span></div>
                                <div><strong style="color: ${colors.text};">Cartons per Layer:</strong> <span style="color: #2d3748; font-weight: 600;">${escapeHtml(layersInfo.cartonsPerLayer.toString())} cartons/layer</span></div>
                                <div style="padding-top: 8px; border-top: 1px solid ${colors.accent}40; margin-top: 8px;">
                                    <div style="margin-bottom: 8px;"><strong style="color: ${colors.text};">Remaining Quantity:</strong> <span style="color: #2d3748; font-weight: 600;">${escapeHtml(remainingQty.toString())} cartons</span></div>
                                    <div style="margin-bottom: 8px;"><strong style="color: ${colors.text};">Calculated Layers:</strong> <span style="color: #2d3748; font-weight: 700; font-size: 16px;">${escapeHtml(layersInfo.calculatedLayers.toString())} layers</span></div>
                                    ${layersInfo.fullLayers > 0 || layersInfo.remainderUnits > 0 ? `
                                        <div style="margin-bottom: 5px; padding-top: 8px; border-top: 1px solid ${colors.accent}20;">
                                            <div style="margin-bottom: 5px;"><strong style="color: ${colors.text};">Breakdown:</strong></div>
                                            <div style="color: #4a5568; font-size: 14px; margin-left: 10px;">
                                                ${layersInfo.fullLayers > 0 ? `${escapeHtml(layersInfo.fullLayers.toString())} full layer(s)` : ''}
                                                ${layersInfo.remainderUnits > 0 ? (layersInfo.fullLayers > 0 ? ` + ${escapeHtml(layersInfo.remainderUnits.toString())} units` : `${escapeHtml(layersInfo.remainderUnits.toString())} units`) : ''}
                                                ${layersInfo.remainderUnits > 0 && layersInfo.fullLayers > 0 ? (() => {
                                                    const nextLayer = layersInfo.fullLayers + 1;
                                                    let suffix = 'th';
                                                    if (nextLayer === 1) suffix = 'st';
                                                    else if (nextLayer === 2) suffix = 'nd';
                                                    else if (nextLayer === 3) suffix = 'rd';
                                                    return ` (${nextLayer}${suffix} layer is not full)`;
                                                })() : ''}
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                                ${layersInfoOriginal ? `
                                <div style="padding-top: 8px; border-top: 1px dashed ${colors.accent}40; margin-top: 12px; font-size: 13px; color: #4a5568;">
                                    <strong>Original Quantity:</strong> ${escapeHtml(originalQty.toString())} cartons ‚Ä¢
                                    <strong>Original Layers:</strong> ${escapeHtml(layersInfoOriginal.calculatedLayers.toString())}
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        ` : ''}
                        
                        ${tabletSachetInfo ? `
                        <div style="background: ${colors.bg}; padding: 20px; border-radius: 8px; border-left: 4px solid ${colors.border};">
                            <h3 style="margin: 0 0 15px 0; color: ${colors.text}; font-size: 18px; font-weight: 600;">üì¶ Tablet and Sachet Information</h3>
                            <div style="display: grid; gap: 10px;">
                                <div><strong style="color: ${colors.text};">Product Type:</strong> <span style="color: #2d3748;">${escapeHtml(tabletSachetInfo)}</span></div>
                                <div><strong style="color: ${colors.text};">Quantity Remaining (Cartons):</strong> <span style="color: #2d3748;">${escapeHtml(remainingQty.toString())} Cartons</span></div>
                                ${originalQty !== remainingQty ? `<div><strong style="color: ${colors.text};">Original Quantity:</strong> <span style="color: #2d3748;">${escapeHtml(originalQty.toString())} Cartons</span></div>` : ''}
                                ${ticket.SachetType ? `<div><strong style="color: ${colors.text};">Sachet Type:</strong> <span style="color: #2d3748;">${escapeHtml(ticket.SachetType)}</span></div>` : ''}
                                ${ticket.TabletType ? `<div><strong style="color: ${colors.text};">Tablet Type:</strong> <span style="color: #2d3748;">${escapeHtml(ticket.TabletType)}</span></div>` : ''}
                                <div style="padding-top: 8px; border-top: 1px solid ${colors.accent}40;">
                                    <div style="margin-bottom: 5px;"><strong style="color: ${colors.text};">Conversion:</strong> <span style="color: #4a5568; font-size: 14px;">${escapeHtml(remainingQty.toString())} Cartons √ó ${has1KG ? '6' : '12'} = </span></div>
                                    <div><strong style="color: ${colors.text};">Total Pieces Remaining:</strong> <span style="color: #2d3748; font-weight: 700; font-size: 18px;">${pieces.toLocaleString()} Pieces</span></div>
                                    ${originalQty !== remainingQty ? `<div style="margin-top: 6px; color: #718096; font-size: 13px;">Original pieces: ${( (originalQty) * (has1KG ? 6 : 12)).toLocaleString()}</div>` : ''}
                                </div>
                                <div style="padding-top: 8px; border-top: 1px solid ${colors.accent}40; margin-top: 8px;">
                                    <div style="margin-bottom: 8px;"><strong style="color: ${colors.text};">Carton to Sachet/Tablet Conversion:</strong></div>
                                    ${has1KG ? `
                                    <div style="margin-bottom: 5px; color: #4a5568; font-size: 14px;">1 Carton = 6 Sachets + 6 Tablet Pieces</div>
                                    <div style="margin-bottom: 5px; color: #4a5568; font-size: 14px;">100 Cartons = 600 Sachets + 600 Tablet Pieces</div>
                                    ` : `
                                    <div style="margin-bottom: 5px; color: #4a5568; font-size: 14px;">1 Carton = 12 Sachets + 12 Tablet Pieces</div>
                                    <div style="margin-bottom: 5px; color: #4a5568; font-size: 14px;">100 Cartons = 1,200 Sachets + 1,200 Tablet Pieces</div>
                                    `}
                                    ${(ticket.SachetType || ticket.TabletType) ? `
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                                        ${ticket.SachetType ? `
                                        <div>
                                            <div style="font-size: 12px; color: #718096; margin-bottom: 3px;">Sachets</div>
                                            <div style="color: #2d3748; font-weight: 700; font-size: 16px;">${(remainingQty * (has1KG ? 6 : 12)).toLocaleString()}</div>
                                        </div>
                                        ` : ''}
                                        ${ticket.TabletType ? `
                                        <div>
                                            <div style="font-size: 12px; color: #718096; margin-bottom: 3px;">Tablet Pieces</div>
                                            <div style="color: #2d3748; font-weight: 700; font-size: 16px;">${(remainingQty * (has1KG ? 6 : 12)).toLocaleString()}</div>
                                        </div>
                                        ` : ''}
                                    </div>
                                    ` : `
                                    <div style="margin-top: 10px; padding: 10px; background: #f7fafc; border-radius: 6px;">
                                        <div style="color: #718096; font-size: 13px;">Sachet Type and Tablet Type not specified</div>
                                    </div>
                                    `}
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${ticket.QualityIssueType ? `
                        <div style="background: #fff5f5; padding: 20px; border-radius: 8px; border-left: 4px solid #e53e3e;">
                            <h3 style="margin: 0 0 15px 0; color: #742a2a; font-size: 18px; font-weight: 600;">‚ö†Ô∏è Quality Issues</h3>
                            <div style="display: grid; gap: 10px;">
                                <div><strong style="color: #742a2a;">Type:</strong> <span style="color: #2d3748;">${escapeHtml(ticket.QualityIssueType === 'banding' ? 'Banding Quality Frailties' : 'Production Quality Frailties')}</span></div>
                                <div><strong style="color: #742a2a;">Group Leader:</strong> <span style="color: #2d3748;">${escapeHtml(ticket.GroupLeader || '')}</span></div>
                                <div><strong style="color: #742a2a;">Description:</strong> <span style="color: #2d3748;">${escapeHtml(ticket.QualityIssueDesc || '')}</span></div>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${merchHistory.length > 0 ? `
                        <div style="background: ${colors.bg}; padding: 20px; border-radius: 8px; border-left: 4px solid ${colors.border};">
                            <h3 style="margin: 0 0 15px 0; color: ${colors.text}; font-size: 18px; font-weight: 600;">üì¶ Merchandise History</h3>
                            ${merchHistory.map(entry => `
                                <div style="padding: 12px; margin-bottom: 10px; background: white; border-radius: 6px; border: 1px solid ${colors.accent}20;">
                                    <div style="font-weight: 600; color: ${colors.text}; margin-bottom: 5px;">${escapeHtml(entry.date || '')} - ${escapeHtml(entry.user || '')}</div>
                                    <div style="color: #4a5568; font-size: 14px;">${escapeHtml(entry.note || '')}</div>
                                </div>
                            `).join('')}
                        </div>
                        ` : ''}
                        
                        <div style="background: #edf2f7; padding: 20px; border-radius: 8px; border-left: 4px solid #718096;">
                            <h3 style="margin: 0 0 15px 0; color: #2d3748; font-size: 18px; font-weight: 600;">üïê Timestamps</h3>
                            <div style="display: grid; gap: 10px;">
                                <div><strong style="color: #2d3748;">Created At:</strong> <span style="color: #4a5568; font-family: 'Courier New', monospace;">${escapeHtml(createdAt)}</span></div>
                                <div><strong style="color: #2d3748;">First Modified:</strong> <span style="color: #4a5568; font-family: 'Courier New', monospace;">${escapeHtml(firstModified)}</span></div>
                                <div><strong style="color: #2d3748;">Last Modified:</strong> <span style="color: #4a5568; font-family: 'Courier New', monospace;">${escapeHtml(lastModified)}</span></div>
                            </div>
                        </div>
                        
                        ${ticket.ChangeHistory ? `
                        <div style="background: #f7fafc; padding: 20px; border-radius: 8px; border-left: 4px solid #cbd5e0;">
                            <h3 style="margin: 0 0 15px 0; color: #2d3748; font-size: 18px; font-weight: 600;">üìù Change History</h3>
                            <pre style="white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 13px; color: #4a5568; margin: 0; background: white; padding: 15px; border-radius: 6px; border: 1px solid #e2e8f0;">${escapeHtml(formatChangeHistory(ticket.ChangeHistory))}</pre>
                        </div>
                        ` : ''}
                        
                        ${ticket.Notes ? `
                        <div style="background: ${colors.bg}; padding: 20px; border-radius: 8px; border-left: 4px solid ${colors.border};">
                            <h3 style="margin: 0 0 15px 0; color: ${colors.text}; font-size: 18px; font-weight: 600;">üìã Notes</h3>
                            <p style="margin: 0; color: #2d3748; line-height: 1.6;">${escapeHtml(ticket.Notes)}</p>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }
        
        function addMerchHistoryEntry() {
            const container = document.getElementById('merchHistoryContainer');
            if (!container) return;
            const users = Array.from(document.querySelectorAll('#groupLeader option')).map(opt => ({ value: opt.value, text: opt.textContent }));
            const entry = document.createElement('div');
            entry.className = 'merch-history-entry';
            entry.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr 2fr auto; gap: 10px; margin-bottom: 10px; align-items: end;';
            entry.innerHTML = `
                <div class="fill-form-group">
                    <label>Date</label>
                    <input type="date" class="merch-history-date" name="merchHistoryDate[]">
                </div>
                <div class="fill-form-group">
                    <label>User</label>
                    <select class="merch-history-user" name="merchHistoryUser[]">
                        <option value="">Select user...</option>
                        ${users.filter(u => u.value).map(u => `<option value="${u.value}">${u.text}</option>`).join('')}
                    </select>
                </div>
                <div class="fill-form-group">
                    <label>Note</label>
                    <input type="text" class="merch-history-note" name="merchHistoryNote[]" placeholder="Enter note...">
                </div>
                <button type="button" onclick="this.parentElement.remove()" class="btn-reset" style="padding: 10px;">√ó</button>
            `;
            container.appendChild(entry);
        }
        
        async function initFillMode(serial) {
            // Prevent back navigation - replace current history entry
            window.history.replaceState(null, '', window.location.href);
            
            // Block back button/swipe back
            window.addEventListener('popstate', (e) => {
                // Prevent going back to generator page
                window.history.pushState(null, '', window.location.href);
            });
            
            // Push a state to prevent back navigation
            window.history.pushState(null, '', window.location.href);
            
            document.body.classList.add('fill-mode-active');

            const movementSection = document.getElementById('movementSection');
            if (movementSection) {
                movementSection.style.display = 'block';
            }

            const fillContainer = document.getElementById('fillContainer');
            if (fillContainer) {
                fillContainer.classList.add('visible');
            }
            
            const viewCard = document.getElementById('viewCard');
            const editCard = document.getElementById('editCard');
            if (viewCard) viewCard.style.display = 'none';
            if (isUserLoggedIn()) {
                showEditCard();
            } else {
                showLoginCard();
            }
            updateLoggedInUserBanner();

            const defaultSerial = serial ? decodeURIComponent(serial) : formatSerial(currentSerial);
            const serialInput = document.getElementById('fillSerial');
            const serialDisplay = document.getElementById('fillSerialDisplay');
            if (serialInput) {
                serialInput.value = defaultSerial;
            }
            if (serialDisplay) {
                serialDisplay.textContent = defaultSerial;
            }

            const movementPalletInput = document.getElementById('movementPalletId');
            if (movementPalletInput) {
                movementPalletInput.value = defaultSerial;
            }
            const movementCurrentZone = document.getElementById('movementCurrentZone');
            if (movementCurrentZone) {
                movementCurrentZone.value = '';
            }

            // Priority: URL color param > serial detection > default
            let detectedColour = urlColorParam || 
                (defaultSerial.includes('-BL-') ? 'blue' :
                 defaultSerial.includes('-RD-') ? 'red' :
                 defaultSerial.includes('-GN-') ? 'green' :
                 defaultSerial.includes('-YL-') ? 'yellow' : selectedColor);

            const fillColorSelect = document.getElementById('fillColor');
            if (fillColorSelect) {
                fillColorSelect.value = detectedColour;
                // Disable color selection - it cannot be changed during input
                fillColorSelect.disabled = true;
                fillColorSelect.style.backgroundColor = '#f7fafc';
                fillColorSelect.style.cursor = 'not-allowed';
            }
            
            // Load authorized users
            const { users, skus, sachetTypes, tabletTypes } = await loadAuthorizedUsers();
            populateAuthorizedUserSelects(users);
            populateSKUDropdown(skus);
            populateDropdown('sachetType', sachetTypes, 'Select sachet type...');
            populateDropdown('tabletType', tabletTypes, 'Select tablet type...');
            
            const groupLeaderSelect = document.getElementById('groupLeader');
            const merchHistoryUsers = document.querySelectorAll('.merch-history-user');
            if (groupLeaderSelect) {
                groupLeaderSelect.innerHTML = '<option value="">Select leader...</option>' + 
                    users.map(u => `<option value="${u.id}">${u.name}</option>`).join('');
            }
            merchHistoryUsers.forEach(select => {
                select.innerHTML = '<option value="">Select user...</option>' + 
                    users.map(u => `<option value="${u.id}">${u.name}</option>`).join('');
            });
            
            // Load existing ticket data if editing
            try {
                const existingTicket = await readTicketFromSheet(defaultSerial);
                if (existingTicket) {
                    populateFormFromTicket(existingTicket);
                }
            } catch (error) {
                console.log('No existing ticket or error loading:', error);
            }

            const backButton = document.getElementById('fillBack');
            if (backButton) {
                backButton.addEventListener('click', () => {
                    window.location.href = window.location.pathname;
                });
            }

            const form = document.getElementById('ticketForm');
            if (form) {
                form.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    
                    if (!isUserLoggedIn()) {
                        setFillStatus('‚ùå Please log in before editing tickets.');
                        showLoginCard();
                        return;
                    }
                    
                    setFillStatus('Saving to Google Sheets...');
                    try {
                        const data = collectFormData(form);
                        let existingTicket = null;
                        try {
                            existingTicket = await readTicketFromSheet(data.serial);
                            // Check if ticket actually exists (has data, not just headers)
                            if (existingTicket && (!existingTicket.Serial || existingTicket.Serial !== data.serial)) {
                                existingTicket = null;
                            }
                        } catch (e) {
                            // Ticket doesn't exist, that's fine
                            existingTicket = null;
                        }
                        const isUpdate = !!(existingTicket && existingTicket.Serial === data.serial);
                        
                        // Save to Google Sheets (pass existingTicket for timestamp handling)
                        const saveResult = await saveTicketToSheet(data, isUpdate, existingTicket);
                        console.log('Save result:', saveResult);
                        
                        // Update SKU calculations
                        if (data.sku && data.qty) {
                            await updateSKUCalculations(data.sku, data.qty);
                        }
                        
                        setFillStatus('Saved! Generating ticket preview...');
                        const pageElement = renderFilledTicket(data);
                        if (!pageElement) {
                            setFillStatus('Could not render preview.');
                            return;
                        }
                        await new Promise(resolve => setTimeout(resolve, 50));
                        renderTicketQRCodes(pageElement);
                        await new Promise(resolve => setTimeout(resolve, 50));
                        await downloadFilledTicket(pageElement, data.serial);
                        setFillStatus('‚úÖ Saved to Google Sheets and download complete!');
                    } catch (error) {
                        setFillStatus(`‚ùå Error: ${error.message}`);
                        console.error('Save error:', error);
                        alert(`Error saving to Google Sheets: ${error.message}\n\nCheck browser console for details.`);
                    }
                });
            }
        }
        
        function populateFormFromTicket(ticket) {
            if (ticket.Date) document.getElementById('fillDate').value = ticket.Date;
            if (ticket.Time) document.getElementById('fillTime').value = ticket.Time;
            // Set SKU - check if it exists in dropdown, otherwise use custom input
            if (ticket.SKU) {
                const skuSelect = document.getElementById('fillSku');
                const skuCustom = document.getElementById('fillSkuCustom');
                if (skuSelect) {
                    // Check if SKU exists in dropdown options
                    const optionExists = Array.from(skuSelect.options).some(opt => opt.value === ticket.SKU);
                    if (optionExists) {
                        skuSelect.value = ticket.SKU;
                        if (skuCustom) skuCustom.style.display = 'none';
                    } else {
                        // SKU not in dropdown, use custom input
                        skuSelect.value = '';
                        if (skuCustom) {
                            skuCustom.value = ticket.SKU;
                            skuCustom.style.display = 'block';
                            skuSelect.style.display = 'none';
                        }
                    }
                }
            }
            if (ticket.Qty) document.getElementById('fillQty').value = ticket.Qty;
            if (ticket.Layers) document.getElementById('fillLayers').value = ticket.Layers;
            if (ticket.Notes) document.getElementById('fillNotes').value = ticket.Notes;
            if (ticket.QualityIssueType) document.getElementById('qualityIssueType').value = ticket.QualityIssueType;
            if (ticket.QualityIssueDesc) document.getElementById('qualityIssueDesc').value = ticket.QualityIssueDesc;
            if (ticket.GroupLeader) document.getElementById('groupLeader').value = ticket.GroupLeader;
            if (ticket.SachetType) document.getElementById('sachetType').value = ticket.SachetType;
            if (ticket.TabletType) document.getElementById('tabletType').value = ticket.TabletType;
            
            // Populate checkboxes
            (ticket.BandingType || '').split(',').forEach(val => {
                const checkbox = document.querySelector(`input[name="bandingType"][value="${val.trim()}"]`);
                if (checkbox) checkbox.checked = true;
            });
            (ticket.ProductType || '').split(',').forEach(val => {
                const checkbox = document.querySelector(`input[name="productType"][value="${val.trim()}"]`);
                if (checkbox) checkbox.checked = true;
            });
            (ticket.PalletSize || '').split(',').forEach(val => {
                const checkbox = document.querySelector(`input[name="palletSize"][value="${val.trim()}"]`);
                if (checkbox) checkbox.checked = true;
            });
            
            // Populate merch history
            const merchHistory = ticket.MerchHistory ? (typeof ticket.MerchHistory === 'string' ? JSON.parse(ticket.MerchHistory) : ticket.MerchHistory) : [];
            const container = document.getElementById('merchHistoryContainer');
            if (container && merchHistory.length > 0) {
                container.innerHTML = '';
                merchHistory.forEach(entry => {
                    addMerchHistoryEntry();
                    const entries = container.querySelectorAll('.merch-history-entry');
                    const lastEntry = entries[entries.length - 1];
                    if (lastEntry) {
                        lastEntry.querySelector('.merch-history-date').value = entry.date || '';
                        lastEntry.querySelector('.merch-history-user').value = entry.user || '';
                        lastEntry.querySelector('.merch-history-note').value = entry.note || '';
                    }
                });
            }
        }

        function collectFormData(form) {
            if (!isUserLoggedIn()) {
                throw new Error('Session expired. Please log in again.');
            }
            const formData = new FormData(form);
            
            const collectChecked = (name) =>
                Array.from(form.querySelectorAll(`input[name="${name}"]:checked`))
                    .map(input => input.value.toLowerCase());
            
            // Get SKU from either dropdown or custom input
            const skuSelect = document.getElementById('fillSku');
            const skuCustom = document.getElementById('fillSkuCustom');
            let sku = '';
            if (skuSelect && skuSelect.value && skuSelect.value !== '__custom__') {
                sku = skuSelect.value;
            } else if (skuCustom && skuCustom.value) {
                sku = skuCustom.value.trim();
            } else {
                sku = formData.get('sku') || '';
            }
            
            // Validate pallet size vs quantity
            const qty = parseInt(formData.get('qty') || '0', 10);
            const palletSizes = collectChecked('palletSize').map(ps => parseInt(ps, 10)).filter(ps => !isNaN(ps));
            
            if (qty > 0 && palletSizes.length > 0) {
                const maxPalletSize = Math.max(...palletSizes);
                if (qty > maxPalletSize) {
                    throw new Error(`Quantity (${qty}) cannot exceed the selected pallet size (${maxPalletSize}). Please reduce quantity or select a larger pallet size.`);
                }
            }
            
            const merchHistoryEntries = [];
            document.querySelectorAll('.merch-history-entry').forEach(entry => {
                const date = entry.querySelector('.merch-history-date')?.value || '';
                const user = entry.querySelector('.merch-history-user')?.value || '';
                const note = entry.querySelector('.merch-history-note')?.value || '';
                if (date || user || note) {
                    merchHistoryEntries.push({ date, user, note });
                }
            });

            return {
                serial: formData.get('serial') || formatSerial(currentSerial),
                color: formData.get('color') || selectedColor,
                date: formData.get('date') || '',
                time: formData.get('time') || '',
                sku: sku, // Use the SKU from dropdown or custom input
                qty: formData.get('qty') || '',
                layers: formData.get('layers') || '',
                notes: formData.get('notes') || '',
                bandingType: collectChecked('bandingType'),
                productType: collectChecked('productType'),
                palletSize: collectChecked('palletSize'),
                qualityIssueType: formData.get('qualityIssueType') || '',
                qualityIssueDesc: formData.get('qualityIssueDesc') || '',
                groupLeader: formData.get('groupLeader') || '',
                sachetType: formData.get('sachetType') || '',
                tabletType: formData.get('tabletType') || '',
                merchHistory: merchHistoryEntries,
                modifiedBy: loggedInUser?.name || loggedInUser?.id || 'Unknown User',
                status: 'Received'
            };
        }

        // --- Stock Movement Interface ---

        function setMovementStatus(message, type = 'info') {
            const statusEl = document.getElementById('movementStatusMessage');
            if (!statusEl) return;
            statusEl.textContent = message || '';
            statusEl.classList.remove('error', 'success');
            if (type === 'error') {
                statusEl.classList.add('error');
            } else if (type === 'success') {
                statusEl.classList.add('success');
            }
        }

        function setMovementListLoading(message) {
            const list = document.getElementById('movementPalletList');
            if (!list) return;
            list.innerHTML = `<div style="color:#475569;">${message}</div>`;
        }

        function toggleMovementPanel(forceOpen) {
            if (!isUserLoggedIn()) {
                alert('üîê Please log in before using stock movement controls.');
                showLoginCard();
                return;
            }
            const panel = document.getElementById('movementPanel');
            const toggleBtn = document.getElementById('movementToggleBtn');
            if (!panel || !toggleBtn) return;
            const shouldOpen = forceOpen !== undefined ? forceOpen : !panel.classList.contains('active');
            if (shouldOpen) {
                panel.classList.add('active');
                toggleBtn.textContent = 'üö´ Close Stock Movement Control';
                ensureMovementPanelLoaded();
            } else {
                panel.classList.remove('active');
                toggleBtn.textContent = 'üöö Open Stock Movement Control';
            }
        }

        async function ensureMovementPanelLoaded() {
            if (movementPanelInitialized) {
                autoFillMovementOperator();
                return;
            }
            try {
                setMovementStatus('Loading zones...');
                const result = await callAppsScript(new URLSearchParams({ action: 'getZoneConfig' }));
                movementZones = (result.zones || []).filter(zone => zone.ZoneName);
                populateMovementZoneOptions();
                movementPanelInitialized = true;
                setMovementStatus('');
                await refreshMovementZone();
            } catch (error) {
                console.error('Movement init error:', error);
                setMovementStatus(error.message || 'Failed to load zones', 'error');
            }
        }

        function populateMovementZoneOptions() {
            const zoneSelect = document.getElementById('movementZoneSelect');
            const toZoneSelect = document.getElementById('movementToZoneSelect');
            if (!zoneSelect || !toZoneSelect) return;
            movementZones.sort((a, b) => (a.ZoneName || '').localeCompare(b.ZoneName || ''));
            zoneSelect.innerHTML = '';
            toZoneSelect.innerHTML = '';
            movementZones.forEach(zone => {
                const option = document.createElement('option');
                option.value = zone.ZoneName;
                option.textContent = `${zone.ZoneName} (${zone.Prefix || 'N/A'})`;
                zoneSelect.appendChild(option.cloneNode(true));
                toZoneSelect.appendChild(option);
            });
            if (!zoneSelect.value && movementZones.length) {
                zoneSelect.value = movementZones[0].ZoneName;
            }
            if (!toZoneSelect.value && movementZones.length) {
                toZoneSelect.value = movementZones[0].ZoneName;
            }
            updateMovementZoneMeta(zoneSelect.value);
            autoFillMovementOperator();
        }

        function updateMovementZoneMeta(zoneName) {
            const metaEl = document.getElementById('movementZoneMeta');
            if (!metaEl) return;
            const zone = movementZones.find(z => z.ZoneName === zoneName);
            if (!zone) {
                metaEl.textContent = '';
                return;
            }
            const fifoText = parseBooleanFlag(zone.FIFORequired) ? 'FIFO enforced' : 'FIFO not enforced';
            const splitText = parseBooleanFlag(zone.AllowsSplitting) ? 'Splitting allowed' : 'Splitting blocked';
            metaEl.textContent = `${zone.ZoneName} ‚Ä¢ Prefix ${zone.Prefix || 'N/A'} ‚Ä¢ ${fifoText} ‚Ä¢ ${splitText}`;
        }

        async function refreshMovementZone() {
            if (!movementPanelInitialized) {
                await ensureMovementPanelLoaded();
                return;
            }
            const zoneSelect = document.getElementById('movementZoneSelect');
            if (!zoneSelect || !zoneSelect.value) {
                setMovementListLoading('Select a zone to view pallets.');
                return;
            }
            const zoneName = zoneSelect.value;
            updateMovementZoneMeta(zoneName);
            const statusFilter = document.getElementById('movementStatusFilter')?.value || '';
            setMovementListLoading('Loading pallets...');
            try {
                const params = new URLSearchParams({
                    action: 'getPalletsInZone',
                    zoneName: zoneName,
                    limit: 25
                });
                if (statusFilter) params.append('status', statusFilter);
                const result = await callAppsScript(params);
                movementLastPallets = result.pallets || [];
                renderMovementPalletList(movementLastPallets);
                setMovementStatus(`Loaded ${movementLastPallets.length} pallet(s) from ${zoneName}`, 'success');
            } catch (error) {
                console.error('Failed to load pallets:', error);
                setMovementStatus(error.message || 'Failed to load pallets', 'error');
                setMovementListLoading(error.message || 'Unable to load pallets.');
            }
        }

        function renderMovementPalletList(pallets) {
            const list = document.getElementById('movementPalletList');
            if (!list) return;
            if (!pallets.length) {
                list.innerHTML = '<div style="color:#94a3b8;">No pallets found for this zone.</div>';
                return;
            }
            list.innerHTML = pallets.map(pallet => {
                const status = escapeHtml(pallet.Status || 'Active');
                const sku = escapeHtml(pallet.SKU || 'N/A');
                const qty = pallet.RemainingQuantity ?? pallet.Quantity ?? '';
                const created = formatMovementDate(pallet.CreatedAt || pallet.CreatedDate);
                const lastMoved = formatMovementDate(pallet.LastMovedAt);
                return `
                    <div class="movement-card">
                        <div class="movement-card-header">
                            <strong>${escapeHtml(pallet.PalletID || 'Unknown ID')}</strong>
                            <span class="badge">${status}</span>
                        </div>
                        <div class="movement-card-meta">
                            <div><strong>SKU:</strong> ${sku}</div>
                            <div><strong>Qty:</strong> ${qty || 'N/A'}</div>
                            <div><strong>Zone:</strong> ${escapeHtml(pallet.CurrentZone || 'N/A')}</div>
                            <div><strong>Created:</strong> ${created}</div>
                            <div><strong>Last Move:</strong> ${lastMoved}</div>
                        </div>
                        <div class="movement-card-actions">
                            <button type="button" class="btn-reset" onclick="selectMovementPallet('${escapeHtml(pallet.PalletID || '')}')">Select</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function selectMovementPallet(palletId) {
            const pallet = movementLastPallets.find(p => (p.PalletID || '').toString() === palletId);
            if (!pallet) return;
            movementSelectedPallet = pallet;
            const palletInput = document.getElementById('movementPalletId');
            const currentZoneInput = document.getElementById('movementCurrentZone');
            const reasonInput = document.getElementById('movementReason');
            if (palletInput) palletInput.value = pallet.PalletID || '';
            if (currentZoneInput) currentZoneInput.value = pallet.CurrentZone || '';
            if (reasonInput && !reasonInput.value) {
                reasonInput.value = `Move from ${pallet.CurrentZone || 'unknown zone'}`;
            }
            const toZoneSelect = document.getElementById('movementToZoneSelect');
            if (toZoneSelect && pallet.CurrentZone && toZoneSelect.value === pallet.CurrentZone) {
                const alternative = movementZones.find(zone => zone.ZoneName !== pallet.CurrentZone);
                if (alternative) {
                    toZoneSelect.value = alternative.ZoneName;
                }
            }
            setMovementStatus(`Selected ${pallet.PalletID} (currently ${pallet.CurrentZone || 'N/A'})`);
        }

        function resetMovementForm() {
            movementSelectedPallet = null;
            const form = document.getElementById('movementForm');
            if (form) form.reset();
            const currentZoneInput = document.getElementById('movementCurrentZone');
            if (currentZoneInput) currentZoneInput.value = '';
            autoFillMovementOperator();
            setMovementStatus('');
        }

        let isChildMode = false;

        function toggleMovementMode() {
            isChildMode = !isChildMode;
            const toggleBtn = document.getElementById('toggleChildModeBtn');
            const submitBtn = document.getElementById('movementSubmitBtn');
            const quantityWrapper = document.getElementById('movementQuantityWrapper');
            const toZoneSelect = document.getElementById('movementToZoneSelect');
            if (isChildMode) {
                toggleBtn.textContent = '‚Ü©Ô∏è Back to Full-Pallet Move';
                submitBtn.textContent = 'Create Child Pallet';
                if (quantityWrapper) {
                    quantityWrapper.querySelector('label').textContent = 'Child Quantity';
                    const input = document.getElementById('movementQuantity');
                    if (input) {
                        input.placeholder = 'Enter child pallet qty';
                        input.required = true;
                    }
                }
            } else {
                toggleBtn.textContent = '‚ú® Create Child Pallet';
                submitBtn.textContent = 'Move Pallet';
                if (quantityWrapper) {
                    quantityWrapper.querySelector('label').textContent = 'Quantity (optional)';
                    const input = document.getElementById('movementQuantity');
                    if (input) {
                        input.placeholder = 'Leave blank to keep full qty';
                        input.required = false;
                    }
                }
            }
        }

        async function submitMovementForm() {
            const palletId = document.getElementById('movementPalletId')?.value.trim();
            const toZone = document.getElementById('movementToZoneSelect')?.value;
            const movedBy = document.getElementById('movementMovedBy')?.value.trim();
            if (!palletId) {
                setMovementStatus('Enter pallet ID.', 'error');
                return;
            }
            if (!toZone) {
                setMovementStatus('Select destination zone.', 'error');
                return;
            }
            if (!movedBy) {
                setMovementStatus('Enter the user moving the pallet.', 'error');
                return;
            }
            const reason = document.getElementById('movementReason')?.value || '';
            const overrideReason = document.getElementById('movementOverrideReason')?.value || '';
            const quantity = document.getElementById('movementQuantity')?.value || '';
            const orderReference = document.getElementById('movementOrderRef')?.value || '';
            if (isChildMode) {
                if (!quantity || Number(quantity) <= 0) {
                    setMovementStatus('Enter child quantity greater than zero.', 'error');
                    return;
                }
            }
            try {
                setMovementStatus('Moving pallet...');
                const params = new URLSearchParams({
                    action: isChildMode ? 'createChildPallet' : 'movePallet',
                    palletId: palletId,
                    toZone: toZone,
                    movedBy: movedBy
                });
                if (reason) params.append('reason', reason);
                if (isChildMode) {
                    params.append('quantity', quantity);
                } else {
                    if (overrideReason) params.append('overrideReason', overrideReason);
                    if (quantity) params.append('quantity', quantity);
                    if (orderReference) params.append('orderReference', orderReference);
                }
                const result = await callAppsScript(params);
                if (isChildMode) {
                    setMovementStatus(result.message || 'Child pallet created successfully', 'success');
                } else {
                    setMovementStatus(result.message || 'Pallet moved successfully', 'success');
                }
                resetMovementForm();
                refreshMovementZone();
            } catch (error) {
                console.error('Move pallet error:', error);
                setMovementStatus(error.message || 'Failed to move pallet', 'error');
                if ((error.message || '').toLowerCase().includes('fifo')) {
                    document.getElementById('movementOverrideReason')?.focus();
                }
            }
        }

        async function callAppsScript(params) {
            if (!GOOGLE_APPS_SCRIPT_URL) {
                throw new Error('Google Apps Script URL not configured');
            }
            const url = `${GOOGLE_APPS_SCRIPT_URL}?${params.toString()}`;
            const response = await fetch(url, {
                method: 'GET',
                headers: { 'Accept': 'application/json' }
            });
            const text = await response.text();
            let result;
            try {
                result = JSON.parse(text);
            } catch (error) {
                console.error('Apps Script raw response:', text);
                throw new Error('Invalid response from Apps Script. Please redeploy the latest backend.');
            }
            if (!result.success) {
                throw new Error(result.error || 'Apps Script call failed');
            }
            return result;
        }

        function parseBooleanFlag(value) {
            if (value === true || value === false) return value;
            if (value === undefined || value === null) return false;
            const str = value.toString().toLowerCase();
            return str === 'true' || str === 'yes' || str === '1';
        }

        function formatMovementDate(value) {
            if (!value) return 'N/A';
            const date = new Date(value);
            if (isNaN(date.getTime())) {
                return value;
            }
            return `${date.toLocaleDateString()} ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
        }

        function autoFillMovementOperator() {
            const field = document.getElementById('movementMovedBy');
            if (field && !field.value && isUserLoggedIn()) {
                field.value = loggedInUser.name || loggedInUser.id || '';
            }
        }

        function renderFilledTicket(data) {
            const previewContainer = document.getElementById('fillPreview');
            if (!previewContainer) {
                return null;
            }

            const serialDisplay = document.getElementById('fillSerialDisplay');
            if (serialDisplay) {
                serialDisplay.textContent = data.serial;
            }

            const originalHtml = createTicketHTML(data.serial, data.color, false, data, 'view');
            const duplicateHtml = createTicketHTML(data.serial, data.color, true, data, 'edit');

            previewContainer.innerHTML = `
                <div class="page single">
                    <div class="ticket-row">
                        ${originalHtml}
                        ${duplicateHtml}
                    </div>
                </div>
            `;

            return previewContainer.querySelector('.page');
        }

        async function downloadFilledTicket(pageElement, serial) {
            if (typeof html2canvas === 'undefined') {
                alert('Download library not loaded.');
                return;
            }

            const canvas = await html2canvas(pageElement, {
                scale: window.devicePixelRatio > 1 ? window.devicePixelRatio : 2,
                backgroundColor: '#ffffff',
                useCORS: true
            });
            const link = document.createElement('a');
            const safeSerial = serial.replace(/[^a-z0-9_-]+/gi, '_');
            link.download = `${safeSerial || 'ticket'}_completed.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        function setFillStatus(message) {
            const status = document.getElementById('fillStatus');
            if (status) {
                status.textContent = message || '';
            }
        }
    </script>
</body>
</html>

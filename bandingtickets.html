<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>RetiFlux™ - Universal Warehouse Management</title>
    <link rel="icon" href="favicon.png" type="image/png">
    <link rel="preload" href="favicon.png" as="image">
    
    <!-- SECURITY FIX: Load config from external file (fallback to defaults if not found) -->
    <script src="config.js"></script>
    <script>
        // Validate config loaded, but don't block if missing (backward compatible)
        if (typeof window.BANDFLOW_CONFIG === 'undefined') {
            console.warn('⚠️ config.js not found. Using default values. For security, create config.js with your credentials.');
            window.BANDFLOW_CONFIG = {};
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cascadia+Mono:wght@400;600;700&family=Cascadia+Code:wght@400;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* Smooth scrolling for the entire page */
        html {
            scroll-behavior: smooth;
        }
        
        /* Elegant gold focus management for accessibility */
        *:focus-visible {
            outline: 3px solid #f59e0b;
            outline-offset: 2px;
            border-radius: 4px;
            box-shadow: 0 0 0 6px rgba(245, 158, 11, 0.2);
        }
        
        /* Remove default focus for mouse users */
        *:focus:not(:focus-visible) {
            outline: none;
        }

        :root {
            --font-app: 'Cascadia Mono', Consolas, 'Cascadia Code', monospace;
        }

        body {
            font-family: var(--font-app);
            padding: 20px;
            background: linear-gradient(135deg, #0f172a 0%, #1e3a5f 50%, #0f172a 100%);
            background-attachment: fixed;
            min-height: 100vh;
            color: #e2e8f0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Animated elegant gradient background */
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        body.fill-mode-active {
            background: linear-gradient(-45deg, #0f172a, #1e3a5f, #0f172a, #1e293b);
            background-size: 400% 400%;
            animation: gradientShift 20s ease infinite;
            overflow-x: hidden;
            overscroll-behavior-y: contain;
        }
        
        body.fill-mode-active .control-panel,
        body.fill-mode-active .print-container {
            display: none;
        }
        body.fill-mode-active #fillContainer {
            display: grid !important;
            grid-template-columns: 1fr;
            max-width: 1400px;
            margin: 0 auto;
            padding: 16px;
            gap: 20px;
            padding-bottom: max(80px, env(safe-area-inset-bottom));
        }
        body.fill-mode-active #movementSection {
            max-width: 1400px;
            margin: 24px auto;
            padding: 0 16px 80px;
        }
        /* Force login/edit cards visible when active - overrides any conflicting rules */
        body.fill-mode-active #loginCard.fill-card-active,
        body.fill-mode-active #editCard.fill-card-active {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        /* Splash: once per session */
        .retiflux-splash {
            position: fixed;
            inset: 0;
            background: #0f172a;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            transition: opacity 0.12s ease-out;
        }
        .retiflux-splash.fade-out { opacity: 0; pointer-events: none; }
        .retiflux-splash .splash-icon {
            width: 96px;
            height: 96px;
            position: relative;
            margin-bottom: 56px;
        }
        .retiflux-splash .splash-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            position: relative;
            z-index: 2;
            animation: splashIconIn 0.4s ease-out forwards;
            opacity: 0;
        }
        .retiflux-splash .splash-glow {
            position: absolute;
            inset: -24px;
            border-radius: 50%;
            border: 3px solid rgba(251, 191, 36, 0.6);
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.3);
            animation: splashPulse 1.4s ease-out 0.2s infinite;
            opacity: 1;
        }
        .retiflux-splash .splash-glow::before {
            content: '';
            position: absolute;
            inset: -12px;
            border-radius: 50%;
            border: 2px solid rgba(251, 191, 36, 0.35);
            animation: splashPulseOuter 1.4s ease-out 0.4s infinite;
        }
        .retiflux-splash .splash-title {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 1px;
            animation: splashTextIn 0.5s ease-out 0.4s forwards;
            opacity: 0;
        }
        .retiflux-splash .splash-subtitle {
            font-size: 11px;
            color: rgba(251, 191, 36, 0.7);
            margin-top: 8px;
            letter-spacing: 0.5px;
            animation: splashTextIn 0.5s ease-out 0.6s forwards;
            opacity: 0;
        }
        .retiflux-splash .splash-dots {
            display: flex;
            gap: 8px;
            margin-top: 32px;
            animation: splashTextIn 0.4s ease-out 0.8s forwards;
            opacity: 0;
        }
        .retiflux-splash .splash-dots span {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: rgba(251, 191, 36, 0.6);
            animation: splashDotPulse 1s ease-in-out infinite;
        }
        .retiflux-splash .splash-dots span:nth-child(2) { animation-delay: 0.2s; }
        .retiflux-splash .splash-dots span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes splashIconIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes splashPulse {
            0% { opacity: 0.9; transform: scale(0.9); border-color: rgba(251, 191, 36, 0.7); box-shadow: 0 0 25px rgba(251, 191, 36, 0.4); }
            50% { opacity: 1; transform: scale(1.15); border-color: rgba(251, 191, 36, 0.4); box-shadow: 0 0 35px rgba(251, 191, 36, 0.5); }
            100% { opacity: 0.5; transform: scale(1.35); border-color: rgba(251, 191, 36, 0.15); box-shadow: 0 0 15px rgba(251, 191, 36, 0.2); }
        }
        @keyframes splashPulseOuter {
            0% { opacity: 0.6; transform: scale(0.95); }
            100% { opacity: 0; transform: scale(1.5); }
        }
        @keyframes splashTextIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes splashDotPulse {
            0%, 100% { opacity: 0.4; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        /* Loading overlay: pulse icon only, for all loading states & section transitions */
        .retiflux-loading-overlay {
            will-change: opacity;
            contain: layout style;
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99998;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.12s ease-out;
        }
        .retiflux-loading-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .retiflux-loading-overlay .loading-pulse-icon {
            width: 64px;
            height: 64px;
            position: relative;
        }
        .retiflux-loading-overlay .loading-pulse-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            position: relative;
            z-index: 2;
        }
        .retiflux-loading-overlay .loading-pulse-glow {
            position: absolute;
            inset: -16px;
            border-radius: 50%;
            border: 2px solid rgba(251, 191, 36, 0.5);
            box-shadow: 0 0 16px rgba(251, 191, 36, 0.25);
            animation: splashPulse 1.4s ease-out 0.2s infinite;
            opacity: 1;
        }
        .retiflux-loading-overlay .loading-pulse-glow::before {
            content: '';
            position: absolute;
            inset: -8px;
            border-radius: 50%;
            border: 2px solid rgba(251, 191, 36, 0.25);
            animation: splashPulseOuter 1.4s ease-out 0.4s infinite;
        }

        /* Elegant gold-accented control panel */
        .control-panel {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(30, 58, 95, 0.95));
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            padding: 24px;
            border-radius: 24px;
            max-width: 650px;
            margin: 0 auto 30px;
            box-shadow: 
                0 12px 48px rgba(0, 0, 0, 0.4),
                0 4px 16px rgba(245, 158, 11, 0.2),
                inset 0 1px 0 rgba(245, 158, 11, 0.15);
            border: 2px solid rgba(245, 158, 11, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            animation: fadeInUp 0.5s ease-out;
        }
        
        .control-panel:hover {
            box-shadow: 
                0 16px 64px rgba(0, 0, 0, 0.5),
                0 8px 24px rgba(245, 158, 11, 0.3),
                inset 0 1px 0 rgba(245, 158, 11, 0.2);
            border-color: rgba(245, 158, 11, 0.5);
            transform: translateY(-2px);
        }
        
        @media (min-width: 768px) {
            .control-panel {
                padding: 35px;
            }
        }

        .control-panel h1 {
            margin-bottom: 10px;
            color: #fbbf24;
            text-align: center;
            font-size: 26px;
            font-weight: 800;
            letter-spacing: 0.5px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b, #fcd34d);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(245, 158, 11, 0.3);
            text-transform: uppercase;
        }
        
        @media (min-width: 768px) {
            .control-panel h1 {
                font-size: 28px;
            }
        }

        .subtitle {
            text-align: center;
            color: #718096;
            font-size: 13px;
            margin-bottom: 30px;
            font-weight: 400;
        }

        /* Elegant gold serial display */
        .current-serial {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 50%, #f59e0b 100%);
            background-size: 200% 200%;
            color: #0f172a;
            border-radius: 14px;
            margin-bottom: 25px;
            font-size: 15px;
            font-weight: 800;
            letter-spacing: 2px;
            box-shadow: 
                0 8px 32px rgba(245, 158, 11, 0.4),
                0 4px 16px rgba(0, 0, 0, 0.3),
                inset 0 2px 0 rgba(255, 255, 255, 0.3),
                inset 0 -2px 0 rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
            animation: pulseGlow 3s ease-in-out infinite;
            border: 2px solid rgba(252, 211, 77, 0.5);
        }
        
        @keyframes pulseGlow {
            0%, 100% {
                box-shadow: 
                    0 8px 32px rgba(245, 158, 11, 0.4),
                    0 4px 16px rgba(0, 0, 0, 0.3);
            }
            50% {
                box-shadow: 
                    0 12px 48px rgba(245, 158, 11, 0.6),
                    0 6px 24px rgba(0, 0, 0, 0.4);
            }
        }
        
        .current-serial::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: rotate(45deg);
            animation: shimmer 3s linear infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .current-serial strong {
            display: block;
            font-size: 22px;
            letter-spacing: 2px;
            margin-top: 6px;
            position: relative;
            z-index: 1;
        }
        
        @media (max-width: 767px) {
            .current-serial {
                padding: 16px;
                font-size: 14px;
                margin-bottom: 20px;
            }
            
            .current-serial strong {
                font-size: 18px;
            }
        }

        .form-group {
            margin-bottom: 22px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 700;
            color: #fbbf24;
            font-size: 13px;
            letter-spacing: 0.8px;
            text-transform: uppercase;
            text-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        /* Touch-friendly control panel inputs */
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 14px 16px;
            min-height: 48px;
            border: 2px solid rgba(226, 232, 240, 0.8);
            border-radius: 12px;
            font-size: 16px; /* Prevents iOS zoom */
            font-family: 'Cascadia Mono', monospace;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @media (min-width: 768px) {
            .form-group input,
            .form-group select {
                font-size: 15px;
                padding: 12px 15px;
                min-height: 44px;
            }
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(255, 255, 255, 1);
            box-shadow: 
                0 0 0 4px rgba(102, 126, 234, 0.15),
                0 4px 12px rgba(102, 126, 234, 0.2);
            transform: translateY(-1px);
        }
        
        .form-group input:hover,
        .form-group select:hover {
            border-color: #cbd5e0;
        }

        .form-group small {
            color: rgba(251, 191, 36, 0.7);
            display: block;
            margin-top: 6px;
            font-size: 11px;
            font-weight: 500;
            letter-spacing: 0.3px;
        }

        .color-selector {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        /* Touch-friendly color selector with glassmorphism */
        .color-option {
            padding: 20px;
            min-height: 56px;
            border: 3px solid transparent;
            border-radius: 14px;
            cursor: pointer;
            text-align: center;
            font-weight: 700;
            font-size: 13px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            letter-spacing: 0.8px;
            position: relative;
            overflow: hidden;
        }
        
        .color-option::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            transform: translate(-50%, -50%);
            transition: width 0.4s, height 0.4s;
        }
        
        .color-option:active::before {
            width: 300px;
            height: 300px;
        }

        .color-option:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 20px rgba(0,0,0,0.25);
        }

        .color-option.selected {
            border-color: rgba(45, 55, 72, 0.8);
            box-shadow: 
                0 8px 25px rgba(0,0,0,0.3),
                inset 0 2px 4px rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }
        
        @media (max-width: 767px) {
            .color-selector {
                grid-template-columns: repeat(2, 1fr);
                gap: 14px;
            }
            
            .color-option {
                padding: 24px;
                min-height: 64px;
                font-size: 14px;
            }
        }

        .color-red { background: #ff6b6b; color: white; }
        .color-blue { background: #4dabf7; color: white; }
        .color-green { background: #51cf66; color: white; }
        .color-yellow { background: #ffd43b; color: #2d3748; }

        /* Elegant gold gradient buttons */
        .btn-generate {
            width: 100%;
            padding: 18px 28px;
            min-height: 56px;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #fbbf24 100%);
            background-size: 200% 200%;
            color: #0f172a;
            border: none;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'Cascadia Mono', monospace;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            box-shadow: 
                0 8px 32px rgba(245, 158, 11, 0.4),
                0 4px 16px rgba(0, 0, 0, 0.3),
                inset 0 2px 0 rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(252, 211, 77, 0.5);
        }
        
        .btn-generate::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }
        
        .btn-generate:hover::before {
            left: 100%;
        }

        .btn-generate:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 
                0 12px 48px rgba(245, 158, 11, 0.6),
                0 6px 24px rgba(0, 0, 0, 0.4),
                inset 0 2px 0 rgba(255, 255, 255, 0.4);
            background-position: 100% 0;
            border-color: rgba(252, 211, 77, 0.8);
        }

        .btn-generate:active {
            transform: translateY(0) scale(0.98);
            box-shadow: 
                0 2px 8px rgba(102, 126, 234, 0.3),
                0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .btn-generate:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-reset {
            width: 100%;
            margin-top: 12px;
            padding: 16px 24px;
            min-height: 52px;
            background: rgba(30, 58, 95, 0.6);
            backdrop-filter: blur(15px);
            color: #fbbf24;
            border: 2px solid rgba(245, 158, 11, 0.4);
            border-radius: 14px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'Cascadia Mono', monospace;
            letter-spacing: 1.2px;
            text-transform: uppercase;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
        }

        .btn-reset:hover {
            background: rgba(30, 58, 95, 0.8);
            border-color: rgba(245, 158, 11, 0.6);
            transform: translateY(-2px);
            box-shadow: 
                0 6px 24px rgba(245, 158, 11, 0.3),
                0 3px 12px rgba(0, 0, 0, 0.3);
        }
        
        .btn-reset:active {
            transform: translateY(0) scale(0.98);
        }
        
        @media (min-width: 768px) {
            .btn-generate,
            .btn-reset {
                padding: 14px 22px;
                font-size: 15px;
            }
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }
            .control-panel {
                display: none;
            }
            .print-container {
                display: block !important;
            }
        }

        .print-container {
            display: none;
        }

        @page {
            size: A4;
            margin: 5mm;
        }

        .page {
            width: 210mm;
            height: 297mm;
            page-break-after: always;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .page:last-child {
            page-break-after: auto;
        }

        .ticket-row {
            display: flex;
            flex: 1;
            min-height: 74.25mm;
            border-bottom: 1px dashed #aaa;
        }

        .ticket-row:last-child {
            border-bottom: none;
        }

        .ticket-column {
            width: 50%;
            border-right: 2px dashed #666;
            position: relative;
        }

        .ticket-column:last-child {
            border-right: none;
        }

        .ticket {
            position: relative;
            height: 100%;
            padding: 3.6mm;
            display: flex;
            flex-direction: column;
            border: 3px solid;
            font-family: 'Cascadia Mono', 'Courier New', monospace;
        }

        .ticket.red { border-color: #ff6b6b; }
        .ticket.blue { border-color: #4dabf7; }
        .ticket.green { border-color: #51cf66; }
        .ticket.yellow { border-color: #ffd43b; }

        .ticket.duplicate {
            background: rgba(45, 55, 72, 0.06);
        }

        .ticket-header {
            text-align: center;
            font-weight: 700;
            font-size: 11px;
            padding-bottom: 1.8mm;
            margin-bottom: 2.6mm;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .serial-wrapper {
            display: flex;
            align-items: stretch;
            gap: 1.6mm;
            margin-bottom: 1.8mm;
        }

        .serial-number {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            padding: 2mm 1.4mm;
            background: #edf2f7;
            border: 1.2px solid #cbd5e0;
            border-radius: 3px;
            letter-spacing: 1.3px;
            font-size: 10.5px;
        }

        .ticket-qr {
            width: 20mm;
            min-width: 20mm;
            height: 20mm;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #ffffff;
            border: 1.2px solid #cbd5e0;
            border-radius: 3px;
            padding: 1.2mm;
        }

        .ticket-qr canvas,
        .ticket-qr img {
            width: 100%;
            height: 100%;
        }

        .ticket-body {
            flex: 1;
            font-size: 8px;
            display: flex;
            flex-direction: column;
            gap: 1.6mm;
        }

        .field-row {
            display: flex;
            gap: 2mm;
            margin-bottom: 1.6mm;
        }

        .field-group {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 2mm;
        }

        .field-label {
            font-weight: 600;
            white-space: nowrap;
            color: #2d3748;
        }

        .checkbox-columns {
            display: flex;
            gap: 2mm;
            margin-top: 1mm;
        }

        .checkbox-column {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1mm;
            padding: 1.6mm;
            border-radius: 3px;
            border: 1px solid #cbd5e0;
            background: #f7fafc;
        }

        .checkbox-column.pallet {
            background: #edf2f7;
        }

        .checkbox-column.pallet .checkbox-items {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 0.8mm;
        }

        .checkbox-column-title {
            font-weight: 700;
            font-size: 7px;
            letter-spacing: 0.4px;
            text-transform: uppercase;
            color: #4a5568;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 1.2mm;
            font-weight: 500;
            font-size: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 3.4mm;
            height: 3.4mm;
        }

        .ticket-footer {
            text-align: center;
            font-size: 7.2px;
            padding: 2mm 1mm;
            color: #2d3748;
            font-weight: 600;
            letter-spacing: 0.4px;
            background: rgba(226, 232, 240, 0.95);
            border-top: 1.4px solid rgba(45, 55, 72, 0.65);
            border-bottom-left-radius: 2px;
            border-bottom-right-radius: 2px;
            margin-top: auto;
        }

        .duplicate-label {
            font-size: 8px;
            color: #e53e3e;
            font-weight: 700;
            letter-spacing: 0.8px;
            text-transform: uppercase;
        }

        .field-value {
            flex: 1;
            border-bottom: 1.3px solid #2d3748;
            min-height: 12px;
            display: flex;
            align-items: flex-end;
        }

        .field-value.filled {
            align-items: center;
            color: #1a202c;
            font-weight: 600;
        }

        .field-value.filled span {
            width: 100%;
            word-break: break-word;
        }


        /* Modern vibrant fill mode - website style */
        .fill-mode {
            display: none;
            max-width: 1400px;
            margin: 0 auto;
            padding: 16px;
            gap: 20px;
        }

        .fill-mode.visible {
            display: grid;
            grid-template-columns: 1fr;
            padding-bottom: max(80px, env(safe-area-inset-bottom));
        }

        /* Elegant dark blue cards with gold accents */
        .fill-card {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(30, 58, 95, 0.98));
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-radius: 28px;
            padding: 20px;
            box-shadow: 
                0 16px 64px rgba(0, 0, 0, 0.5),
                0 8px 32px rgba(245, 158, 11, 0.2),
                inset 0 2px 0 rgba(245, 158, 11, 0.15);
            border: 2px solid rgba(245, 158, 11, 0.4);
            transition: opacity 0.12s ease-out, transform 0.12s ease-out;
            position: relative;
            overflow: hidden;
        }
        .fill-card.fade-in { animation: fillCardFadeIn 0.15s ease-out forwards; }
        @keyframes fillCardFadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @media (prefers-reduced-motion: reduce) {
            .retiflux-splash *, .retiflux-loading-overlay *, .fill-card.fade-in { animation-duration: 0.01ms !important; }
        }
        
        /* Elegant animated gold shimmer */
        .fill-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(245, 158, 11, 0.08) 0%, transparent 70%);
            animation: rotate 25s linear infinite;
        }
        
        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .fill-card > * {
            position: relative;
            z-index: 1;
        }
        
        /* Hidden preview - will be modal */
        .fill-preview {
            display: none !important;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .fill-card:hover,
        .fill-preview:hover {
            box-shadow: 
                0 12px 48px rgba(31, 38, 135, 0.2),
                0 4px 12px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.6);
            transform: translateY(-2px);
        }

        .fill-card h2,
        .fill-preview h2 {
            font-size: 28px;
            margin-bottom: 16px;
            font-weight: 800;
            background: linear-gradient(135deg, #fbbf24, #f59e0b, #fcd34d);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(245, 158, 11, 0.4);
            display: flex;
            align-items: center;
            gap: 12px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }
        
        .fill-card h2 button,
        .fill-preview h2 button {
            -webkit-text-fill-color: #fbbf24;
            color: #fbbf24;
        }
        
        .fill-card h2::before {
            content: '⬥';
            font-size: 24px;
            color: #fbbf24;
            animation: pulse 2s ease-in-out infinite;
            text-shadow: 0 0 20px rgba(245, 158, 11, 0.6);
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        
        /* Tablet breakpoint */
        @media (min-width: 768px) {
            .fill-mode {
                padding: 24px;
            }
            
            .fill-mode.visible {
                gap: 24px;
            }
            
            .fill-card,
            .fill-preview {
                padding: 28px;
                border-radius: 28px;
            }
            
            .fill-card h2,
            .fill-preview h2 {
                font-size: 22px;
            }
        }
        
        /* Desktop breakpoint */
        @media (min-width: 1024px) {
            .fill-mode {
                padding: 32px 24px 60px;
            }
            
            .fill-mode.visible {
                grid-template-columns: minmax(400px, 1fr) minmax(400px, 1fr);
                gap: 28px;
            }
            
            .fill-card,
            .fill-preview {
                padding: 32px;
            }
            
            .fill-card h2,
            .fill-preview h2 {
                font-size: 24px;
            }
        }

        /* Vibrant logged-in banner */
        .logged-in-banner {
            display: none;
            margin-bottom: 24px;
            padding: 20px 24px;
            border-radius: 18px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: #ffffff;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            animation: slideInDown 0.4s ease-out;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }
        
        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .logged-in-banner small {
            display: block;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
            margin-top: 4px;
            font-size: 13px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        @media (max-width: 767px) {
            .logged-in-banner {
                padding: 16px;
                font-size: 14px;
            }
        }

        /* Enhanced login status with glassmorphism */
        .login-status {
            margin-top: 14px;
            padding: 12px 16px;
            font-size: 14px;
            color: #475569;
            border-radius: 10px;
            background: rgba(148, 163, 184, 0.1);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            animation: fadeIn 0.3s ease-out;
        }

        .login-status.error {
            color: #dc2626;
            background: rgba(220, 38, 38, 0.1);
            border-left: 3px solid #dc2626;
        }

        .login-status.success {
            color: #16a34a;
            background: rgba(22, 163, 74, 0.1);
            border-left: 3px solid #16a34a;
        }
        
        .login-status:empty {
            padding: 0;
            background: transparent;
        }

        .fill-intro {
            font-size: 15px;
            color: rgba(251, 191, 36, 0.95);
            font-weight: 600;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            margin-bottom: 24px;
            line-height: 1.6;
            padding: 16px 20px;
            background: rgba(30, 58, 95, 0.4);
            border-left: 4px solid #f59e0b;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(245, 158, 11, 0.2);
        }
        
        @media (min-width: 768px) {
            .fill-intro {
                font-size: 15px;
                padding: 14px 18px;
            }
        }

        .fill-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Mobile-first form grid */
        .fill-form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
        }
        
        @media (min-width: 768px) {
            .fill-form-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 18px;
            }
        }
        
        @media (min-width: 1024px) {
            .fill-form-grid {
                grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
                gap: 20px;
            }
        }

        .fill-form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .fill-form-group label,
        .fill-group-label {
            font-size: 14px;
            font-weight: 700;
            color: #fbbf24;
            text-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
            letter-spacing: 0.8px;
            display: flex;
            align-items: center;
            gap: 6px;
            text-transform: uppercase;
            font-size: 12px;
        }

        /* Elegant gold-bordered inputs */
        .fill-form-group input[type="text"],
        .fill-form-group input[type="number"],
        .fill-form-group input[type="date"],
        .fill-form-group input[type="time"],
        .fill-form-group input[type="password"],
        .fill-form-group select,
        .fill-form-group textarea {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid rgba(245, 158, 11, 0.3);
            border-radius: 12px;
            font-size: 16px; /* Prevents iOS zoom on focus */
            font-family: 'Cascadia Mono', monospace;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-height: 48px; /* Touch-friendly */
            color: #0f172a;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        @media (min-width: 1024px) {
            .fill-form-group input[type="text"],
            .fill-form-group input[type="number"],
            .fill-form-group input[type="date"],
            .fill-form-group input[type="time"],
            .fill-form-group input[type="password"],
            .fill-form-group select,
            .fill-form-group textarea {
                font-size: 14px;
                padding: 12px 14px;
                min-height: 44px;
            }
        }

        .fill-form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .fill-form-group input:focus,
        .fill-form-group select:focus,
        .fill-form-group textarea:focus {
            outline: none;
            border-color: #f59e0b;
            background: rgba(255, 255, 255, 1);
            box-shadow: 
                0 0 0 4px rgba(245, 158, 11, 0.25),
                0 8px 24px rgba(245, 158, 11, 0.3),
                0 4px 12px rgba(0, 0, 0, 0.2);
            transform: translateY(-2px) scale(1.01);
        }
        
        .fill-form-group input:hover,
        .fill-form-group select:hover,
        .fill-form-group textarea:hover {
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-1px);
        }

        /* Elegant gold-bordered checkbox groups */
        .fill-checkbox-group {
            padding: 18px;
            border: 2px solid rgba(245, 158, 11, 0.3);
            border-radius: 16px;
            background: rgba(30, 58, 95, 0.3);
            backdrop-filter: blur(15px);
            gap: 12px;
            transition: all 0.3s ease;
        }
        
        .fill-checkbox-group:hover {
            background: rgba(30, 58, 95, 0.5);
            border-color: rgba(245, 158, 11, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(245, 158, 11, 0.2);
        }

        .fill-checkbox-group label {
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            color: rgba(251, 191, 36, 0.95);
            text-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            padding: 10px 12px;
            border-radius: 10px;
            min-height: 48px; /* Touch-friendly */
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(15, 23, 42, 0.3);
        }
        
        .fill-checkbox-group label:hover {
            background: rgba(245, 158, 11, 0.15);
            transform: translateX(4px);
            border-left: 3px solid #f59e0b;
        }
        
        .fill-checkbox-group label:active {
            transform: scale(0.98);
        }

        .fill-checkbox-group input[type="checkbox"] {
            width: 22px;
            height: 22px;
            cursor: pointer;
            accent-color: #f59e0b;
            filter: drop-shadow(0 2px 6px rgba(245, 158, 11, 0.4));
        }
        
        @media (min-width: 1024px) {
            .fill-checkbox-group input[type="checkbox"] {
                width: 18px;
                height: 18px;
            }
            
            .fill-checkbox-group label {
                font-size: 13px;
                min-height: 40px;
            }
        }

        .fill-notes-group textarea {
            min-height: 100px;
        }

        /* Responsive sticky action bar with glassmorphism */
        .fill-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 24px;
        }
        
        /* Mobile: Elegant sticky action bar */
        @media (max-width: 767px) {
            .fill-actions {
                position: sticky;
                bottom: 0;
                left: 0;
                right: 0;
                background: linear-gradient(to top, rgba(15, 23, 42, 0.98), rgba(30, 58, 95, 0.98));
                backdrop-filter: blur(20px) saturate(180%);
                -webkit-backdrop-filter: blur(20px) saturate(180%);
                padding: 16px;
                margin: 0 -20px -20px -20px;
                border-radius: 0 0 28px 28px;
                border-top: 2px solid rgba(245, 158, 11, 0.5);
                box-shadow: 
                    0 -6px 32px rgba(0, 0, 0, 0.4),
                    0 -2px 16px rgba(245, 158, 11, 0.2);
                z-index: 100;
                gap: 12px;
            }
        }
        
        /* Tablet and Desktop: Normal flow */
        @media (min-width: 768px) {
            .fill-actions {
                display: flex;
                flex-direction: row;
                gap: 16px;
                position: static;
                margin-top: 28px;
            }
            
            .fill-actions button {
                flex: 1;
            }
        }

        /* Elegant status messages */
        .fill-status {
            font-size: 15px;
            color: #fbbf24;
            font-weight: 600;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
            margin-top: 16px;
            min-height: 24px;
            padding: 14px 18px;
            border-radius: 12px;
            background: rgba(30, 58, 95, 0.5);
            backdrop-filter: blur(15px);
            border: 2px solid rgba(245, 158, 11, 0.4);
            transition: all 0.3s ease;
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .fill-status:empty {
            padding: 0;
            background: transparent;
            border: none;
        }
        
        /* Preview Modal Popup */
        .preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            z-index: 10000;
            padding: 20px;
            overflow-y: auto;
            animation: fadeIn 0.3s ease-out;
        }
        
        .preview-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* SKU Details Modal */
        .sku-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            z-index: 10001;
            padding: 20px;
            overflow-y: auto;
            animation: fadeIn 0.3s ease-out;
        }
        
        .sku-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .sku-modal-content {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(30, 58, 95, 0.98));
            border: 2px solid rgba(245, 158, 11, 0.4);
            border-radius: 20px;
            padding: 24px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 0 0 40px rgba(245, 158, 11, 0.2);
            animation: fadeInUp 0.4s ease-out;
        }
        
        .sku-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid rgba(245, 158, 11, 0.3);
        }
        
        .sku-modal-header h3 {
            margin: 0;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 20px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .sku-modal-close {
            background: rgba(245, 158, 11, 0.2);
            border: 2px solid rgba(245, 158, 11, 0.4);
            color: #fbbf24;
            border-radius: 8px;
            width: 32px;
            height: 32px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .sku-modal-close:hover {
            background: rgba(245, 158, 11, 0.4);
            border-color: #f59e0b;
            transform: scale(1.1);
        }
        
        .sku-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }
        
        .sku-table th {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
            padding: 12px;
            text-align: left;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
            border-bottom: 2px solid rgba(245, 158, 11, 0.4);
        }
        
        .sku-table th:last-child,
        .sku-table td:last-child {
            text-align: right;
        }
        
        .sku-table td {
            padding: 12px;
            color: rgba(255, 255, 255, 0.95);
            border-bottom: 1px solid rgba(245, 158, 11, 0.2);
        }
        
        .sku-table tr:hover {
            background: rgba(245, 158, 11, 0.1);
        }
        
        .sku-table .sku-code {
            font-family: 'Courier New', monospace;
            font-weight: 700;
            color: #fbbf24;
        }
        
        .sku-table .sku-qty {
            text-align: right;
            font-weight: 600;
        }
        
        .sku-table .sku-pallets {
            text-align: center;
            color: rgba(251, 191, 36, 0.8);
        }
        
        .preview-modal-content {
            background: #ffffff;
            border-radius: 20px;
            padding: 30px;
            max-width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            position: relative;
            animation: slideUpModal 0.4s ease-out;
        }
        
        @keyframes slideUpModal {
            from {
                opacity: 0;
                transform: translateY(50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .preview-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, #f59e0b, #fbbf24);
            border: 2px solid rgba(252, 211, 77, 0.5);
            border-radius: 50%;
            color: #0f172a;
            font-size: 28px;
            font-weight: 900;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(245, 158, 11, 0.4);
            z-index: 10001;
        }
        
        .preview-modal-close:hover {
            transform: rotate(90deg) scale(1.15);
            box-shadow: 0 8px 28px rgba(245, 158, 11, 0.6);
            border-color: rgba(252, 211, 77, 0.8);
        }
        
        .btn-preview {
            width: 100%;
            padding: 18px 28px;
            min-height: 56px;
            background: linear-gradient(135deg, rgba(30, 58, 95, 0.7), rgba(15, 23, 42, 0.7));
            backdrop-filter: blur(15px);
            color: #fbbf24;
            border: 2px solid rgba(245, 158, 11, 0.5);
            border-radius: 14px;
            font-size: 16px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'Cascadia Mono', monospace;
            letter-spacing: 1.2px;
            text-transform: uppercase;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
            margin-top: 12px;
        }
        
        .btn-preview:hover {
            background: linear-gradient(135deg, rgba(30, 58, 95, 0.9), rgba(15, 23, 42, 0.9));
            border-color: rgba(245, 158, 11, 0.7);
            transform: translateY(-2px);
            box-shadow: 
                0 8px 32px rgba(245, 158, 11, 0.3),
                0 4px 16px rgba(0, 0, 0, 0.3);
        }
        
        /* Loading spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(102, 126, 234, 0.2);
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Loading skeleton */
        .loading-skeleton {
            background: linear-gradient(90deg, 
                rgba(203, 213, 224, 0.2) 25%, 
                rgba(203, 213, 224, 0.4) 50%, 
                rgba(203, 213, 224, 0.2) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s ease-in-out infinite;
            border-radius: 8px;
            height: 20px;
            margin-bottom: 12px;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .skeleton-text {
            height: 16px;
            margin-bottom: 8px;
        }
        
        .skeleton-title {
            height: 24px;
            width: 60%;
            margin-bottom: 16px;
        }

        .fill-preview-note {
            font-size: 13px;
            color: #4a5568;
            margin-bottom: 16px;
        }

        .fill-preview-stage {
            background: #f7fafc;
            border-radius: 14px;
            padding: 16px;
            min-height: 420px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: auto;
        }

        .fill-preview-stage .page {
            transform: scale(0.9);
            transform-origin: top left;
        }

        .movement-toggle {
            max-width: 1200px;
            margin: 30px auto 0;
            text-align: center;
        }

        /* Elegant gold & dark blue movement panel */
        .movement-panel {
            display: none;
            max-width: 1400px;
            margin: 20px auto 60px;
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(30, 58, 95, 0.98));
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-radius: 24px;
            padding: 20px;
            box-shadow: 
                0 16px 64px rgba(0, 0, 0, 0.5),
                0 8px 32px rgba(245, 158, 11, 0.2),
                inset 0 1px 0 rgba(245, 158, 11, 0.15);
            border: 2px solid rgba(245, 158, 11, 0.4);
            transition: all 0.3s ease;
            animation: fadeInUp 0.5s ease-out;
        }
        
        @media (min-width: 768px) {
            .movement-panel {
                padding: 28px;
            }
        }

        .movement-panel.active {
            display: block;
        }

        /* Responsive movement panel header */
        .movement-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 16px;
            flex-wrap: wrap;
        }

        .movement-panel-header h2 {
            margin: 0;
            font-size: 20px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b, #fcd34d);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .movement-panel-header p {
            margin: 6px 0 0;
            color: rgba(251, 191, 36, 0.8);
            font-size: 14px;
            line-height: 1.5;
            font-weight: 500;
        }
        
        @media (min-width: 768px) {
            .movement-panel-header h2 {
                font-size: 24px;
            }
        }

        /* View tabs: Zone Monitor | Zone Receiving */
        .movement-view-tabs {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid rgba(245, 158, 11, 0.3);
        }
        .movement-tab-btn {
            padding: 10px 20px;
            background: rgba(30, 58, 95, 0.5);
            border: 2px solid rgba(245, 158, 11, 0.3);
            border-radius: 12px;
            color: rgba(251, 191, 36, 0.9);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .movement-tab-btn:hover {
            background: rgba(30, 58, 95, 0.8);
            border-color: rgba(245, 158, 11, 0.6);
        }
        .movement-tab-btn.active {
            background: linear-gradient(135deg, #f59e0b, #fbbf24);
            color: #0f172a;
            border-color: #f59e0b;
        }

        /* Zone Receiving layout - responsive for mobile, tablet, desktop */
        .receiving-layout {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .receiving-header-bar {
            display: flex;
            flex-wrap: wrap;
            align-items: flex-end;
            gap: 12px;
        }
        .receiving-operator {
            flex: 1;
            min-width: 180px;
        }
        .receiving-operator label {
            display: block;
            margin-bottom: 4px;
            color: #fbbf24;
            font-weight: 600;
            font-size: 13px;
        }
        .receiving-operator input {
            width: 100%;
            padding: 10px 14px;
            border-radius: 10px;
            border: 2px solid rgba(245, 158, 11, 0.4);
            background: rgba(15, 23, 42, 0.6);
            color: #e2e8f0;
            font-size: 14px;
        }
        .receiving-operator-display {
            padding: 10px 14px;
            border-radius: 10px;
            border: 2px solid rgba(245, 158, 11, 0.4);
            background: rgba(15, 23, 42, 0.6);
            color: #e2e8f0;
            font-size: 14px;
            font-weight: 600;
        }
        .receiving-operator-hint {
            display: block;
            margin-top: 6px;
            color: #64748b;
            font-size: 11px;
        }
        .receiving-zone-tabs {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 8px;
        }
        .receiving-zone-tabs-label {
            color: #94a3b8;
            font-weight: 600;
            font-size: 13px;
        }
        .receiving-zone-tabs-inner {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 4px;
        }
        .receiving-zone-tab {
            padding: 8px 16px;
            background: rgba(30, 58, 95, 0.5);
            border: 2px solid rgba(245, 158, 11, 0.3);
            border-radius: 10px;
            color: rgba(251, 191, 36, 0.9);
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s ease;
        }
        .receiving-zone-tab:hover {
            background: rgba(30, 58, 95, 0.8);
            border-color: rgba(245, 158, 11, 0.6);
        }
        .receiving-zone-tab.active {
            background: linear-gradient(135deg, #f59e0b, #fbbf24);
            color: #0f172a;
            border-color: #f59e0b;
        }
        .receiving-section {
            background: rgba(30, 58, 95, 0.3);
            border-radius: 16px;
            padding: 16px;
            border: 2px solid rgba(245, 158, 11, 0.3);
        }
        .receiving-section h4 {
            margin: 0 0 12px;
            color: #fbbf24;
            font-size: 15px;
            font-weight: 700;
        }
        .receiving-pallet-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 80px;
        }
        .receiving-pallet-card {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 12px 16px;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 12px;
            border: 2px solid rgba(245, 158, 11, 0.25);
        }
        .receiving-pallet-card .pallet-info {
            flex: 1;
            min-width: 140px;
        }
        .receiving-pallet-card .pallet-id {
            font-weight: 700;
            color: #fbbf24;
        }
        .receiving-pallet-card .pallet-meta {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 4px;
        }
        .receiving-pallet-card .pallet-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .receiving-pallet-card .btn-receive {
            padding: 8px 16px;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .receiving-pallet-card .btn-receive:hover {
            filter: brightness(1.1);
        }
        .receiving-pallet-card .btn-cancel-transit {
            padding: 8px 16px;
            background: rgba(239, 68, 68, 0.8);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }
        .receiving-pallet-card .btn-cancel-transit:hover {
            background: rgba(239, 68, 68, 1);
        }
        .badge-in-transit {
            display: inline-block;
            padding: 4px 10px;
            background: rgba(245, 158, 11, 0.3);
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            color: #fbbf24;
            margin-top: 4px;
        }

        /* Responsive movement grid */
        .movement-grid {
            margin-top: 25px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        
        @media (min-width: 768px) {
            .movement-grid {
                grid-template-columns: 1fr;
                gap: 24px;
            }
        }
        
        @media (min-width: 1024px) {
            .movement-grid {
                grid-template-columns: 1.2fr 1fr;
                gap: 24px;
            }
        }

        /* Elegant gold & dark blue movement columns */
        .movement-column {
            background: rgba(30, 58, 95, 0.3);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 18px;
            border: 2px solid rgba(245, 158, 11, 0.3);
            transition: all 0.3s ease;
        }
        
        .movement-column:hover {
            background: rgba(30, 58, 95, 0.4);
            box-shadow: 0 8px 24px rgba(245, 158, 11, 0.2);
            border-color: rgba(245, 158, 11, 0.5);
        }
        
        @media (min-width: 768px) {
            .movement-column {
                padding: 20px;
            }
        }

        .movement-section h3 {
            margin-top: 0;
            color: #fbbf24;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 16px;
        }

        /* Responsive movement controls */
        .movement-controls {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            align-items: end;
            margin-bottom: 16px;
        }
        
        @media (min-width: 640px) {
            .movement-controls {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (min-width: 1024px) {
            .movement-controls {
                grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            }
        }

        .movement-controls label {
            display: block;
            font-size: 12px;
            color: #fbbf24;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-weight: 600;
        }

        /* Touch-friendly movement controls with elegant styling */
        .movement-controls select,
        .movement-controls input {
            width: 100%;
            padding: 12px 14px;
            min-height: 48px;
            border: 2px solid rgba(245, 158, 11, 0.3);
            border-radius: 12px;
            font-size: 15px;
            font-family: 'Cascadia Mono', monospace;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            color: #0f172a;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .movement-controls select:focus,
        .movement-controls input:focus {
            outline: none;
            border-color: #f59e0b;
            box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.2);
            transform: translateY(-1px);
        }
        
        @media (min-width: 1024px) {
            .movement-controls select,
            .movement-controls input {
                padding: 10px 12px;
                min-height: 44px;
                font-size: 14px;
            }
        }

        .movement-zone-meta {
            font-size: 13px;
            color: rgba(251, 191, 36, 0.9);
            margin-bottom: 12px;
            border-left: 4px solid #f59e0b;
            padding-left: 10px;
            font-weight: 600;
        }

        .movement-pallet-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 520px;
            overflow-y: auto;
        }

        /* Elegant movement cards with gold accents */
        .movement-card {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 14px;
            padding: 16px;
            border: 2px solid rgba(245, 158, 11, 0.3);
            display: flex;
            flex-direction: column;
            gap: 8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .movement-card:hover {
            background: rgba(15, 23, 42, 0.8);
            border-color: #f59e0b;
            box-shadow: 
                0 8px 24px rgba(245, 158, 11, 0.25),
                0 2px 8px rgba(0, 0, 0, 0.3);
            transform: translateY(-2px);
        }
        
        .movement-card:active {
            transform: translateY(0) scale(0.99);
        }

        .movement-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }

        .movement-card-header strong {
            font-size: 16px;
            color: #fbbf24;
            font-weight: 700;
        }

        .movement-card .badge {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Responsive movement card meta */
        .movement-card-meta {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            font-size: 13px;
            color: rgba(255, 255, 255, 0.85);
            font-weight: 500;
        }
        
        @media (min-width: 640px) {
            .movement-card-meta {
                grid-template-columns: repeat(2, minmax(120px, 1fr));
            }
        }
        
        @media (min-width: 1024px) {
            .movement-card-meta {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            }
        }

        .movement-card-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 6px;
        }

        /* Responsive movement form grid */
        .movement-form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }
        
        @media (min-width: 640px) {
            .movement-form-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (min-width: 1024px) {
            .movement-form-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }

        /* Touch-friendly movement form inputs with elegant styling */
        .movement-form-grid input,
        .movement-form-grid select,
        .movement-form-grid textarea {
            width: 100%;
            padding: 14px 16px;
            min-height: 48px;
            border: 2px solid rgba(245, 158, 11, 0.3);
            border-radius: 12px;
            font-size: 16px;
            font-family: 'Cascadia Mono', monospace;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            color: #0f172a;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .movement-form-grid input:focus,
        .movement-form-grid select:focus,
        .movement-form-grid textarea:focus {
            outline: none;
            border-color: #f59e0b;
            background: rgba(255, 255, 255, 1);
            box-shadow: 
                0 0 0 4px rgba(245, 158, 11, 0.2),
                0 4px 12px rgba(245, 158, 11, 0.3);
            transform: translateY(-1px);
        }
        
        @media (min-width: 1024px) {
            .movement-form-grid input,
            .movement-form-grid select,
            .movement-form-grid textarea {
                font-size: 14px;
                padding: 10px 12px;
                min-height: 44px;
            }
        }

        .movement-form-grid textarea {
            resize: vertical;
            min-height: 100px;
        }

        .movement-form-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .movement-status {
            margin-top: 12px;
            font-size: 13px;
            font-weight: 600;
        }

        .movement-status.error {
            color: #fca5a5;
        }

        .movement-status.success {
            color: #86efac;
        }

        /* View mode responsive grids */
        .pallet-info-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }
        
        @media (min-width: 640px) {
            .pallet-info-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }
        
        /* Hide print container on mobile/tablet */
        @media (max-width: 1024px) {
            body {
                padding: 12px;
            }
            
            .control-panel h1 {
                font-size: 24px;
            }
            
            .current-serial {
                padding: 16px;
                font-size: 14px;
            }
            
            .current-serial strong {
                font-size: 18px;
            }
        }
        
        @media (max-width: 1024px) {
            .movement-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ── Movement-only mode (mode=movement from landing page) ── */
        body.movement-mode-active .control-panel,
        body.movement-mode-active .print-container,
        body.movement-mode-active .movement-toggle {
            display: none !important;
        }
        /* Keep fillContainer visible so movementSection (inside it) can show */
        body.movement-mode-active #fillContainer {
            display: grid !important;
            grid-template-columns: 1fr;
            max-width: 1400px;
            margin: 0 auto;
            padding: 16px;
            gap: 20px;
        }
        body.movement-mode-active #fillContainer > .fill-card {
            display: none !important;
        }
        body.movement-mode-active #movementSection {
            display: block !important;
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px 16px 80px;
        }
        body.movement-mode-active #movementPanel {
            margin-top: 0;
        }
        /* Movement-only login card overlay */
        body.movement-mode-active #movementLoginOverlay {
            display: flex !important;
        }

        /* ── Bin-cards mode ── */
        body.bincards-mode-active .control-panel,
        body.bincards-mode-active .print-container,
        body.bincards-mode-active #fillContainer,
        body.bincards-mode-active #movementSection,
        body.bincards-mode-active .movement-toggle {
            display: none !important;
        }
        body.bincards-mode-active #binCardsSection {
            display: block !important;
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px 16px 80px;
        }
        body.bincards-mode-active #binCardsLoginOverlay {
            display: flex !important;
        }

        /* Bin-cards login overlay — reuses movement-login-overlay styles */
        #binCardsLoginOverlay { display: none; }

        /* ── Bin-cards dashboard ── */
        #binCardsSection { display: none; }

        .bc-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 24px;
        }
        .bc-header h2 {
            margin: 0;
            font-size: 22px;
            color: #f1f5f9;
            font-weight: 700;
        }
        .bc-consistency-ok { color: #34d399 !important; }
        .bc-consistency-warn { color: #f87171 !important; font-weight: 600; }
        .bc-shift-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(245,158,11,0.12);
            border: 1px solid rgba(245,158,11,0.35);
            color: #fbbf24;
            font-size: 13px;
            font-weight: 600;
            padding: 6px 14px;
            border-radius: 20px;
            letter-spacing: 0.3px;
        }
        .bc-progress-bar {
            background: rgba(255,255,255,0.07);
            border-radius: 8px;
            height: 8px;
            margin-bottom: 24px;
            overflow: hidden;
        }
        .bc-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #fbbf24, #f59e0b);
            border-radius: 8px;
            transition: width 0.5s ease;
        }
        .bc-progress-label {
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 16px;
            margin-top: -18px;
            text-align: right;
        }

        /* Card grid */
        .bc-grid {
            display: block;
            margin-bottom: 32px;
        }
        .bc-card {
            background: linear-gradient(135deg, rgba(15,23,42,0.95), rgba(30,41,59,0.95));
            border: 1px solid rgba(245,158,11,0.2);
            border-radius: 16px;
            padding: 20px 22px;
            transition: border-color 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        .bc-card:hover {
            border-color: rgba(245,158,11,0.5);
            box-shadow: 0 4px 24px rgba(245,158,11,0.12);
        }
        .bc-card.bc-confirmed {
            border-color: rgba(52,211,153,0.4);
            background: linear-gradient(135deg, rgba(6,78,59,0.25), rgba(15,23,42,0.95));
        }
        .bc-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 14px;
        }
        .bc-card-zone {
            font-size: 11px;
            font-weight: 700;
            color: #818cf8;
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-bottom: 3px;
        }
        .bc-card-sku {
            font-size: 17px;
            font-weight: 700;
            color: #f1f5f9;
        }
        .bc-status-pill {
            font-size: 11px;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 12px;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }
        .bc-status-open     { background: rgba(245,158,11,0.15); color: #fbbf24; border: 1px solid rgba(245,158,11,0.3); }
        .bc-status-confirmed { background: rgba(52,211,153,0.15); color: #34d399; border: 1px solid rgba(52,211,153,0.3); }
        .bc-balances {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 14px;
        }
        .bc-bal-item { text-align: center; }
        .bc-bal-label {
            font-size: 10px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        .bc-bal-value {
            font-size: 20px;
            font-weight: 800;
            color: #e2e8f0;
        }
        .bc-bal-value.positive { color: #34d399; }
        .bc-bal-value.negative { color: #f87171; }
        .bc-confirm-btn {
            width: 100%;
            margin-top: 4px;
            padding: 10px;
            background: linear-gradient(135deg, rgba(245,158,11,0.15), rgba(245,158,11,0.08));
            border: 1px solid rgba(245,158,11,0.4);
            color: #fbbf24;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            letter-spacing: 0.3px;
            transition: background 0.2s;
        }
        .bc-confirm-btn:hover { background: rgba(245,158,11,0.25); }
        .bc-confirmed-summary {
            font-size: 12px;
            color: #64748b;
            margin-top: 8px;
            text-align: center;
        }

        /* ── Zone-card layout (1 card per zone) ── */
        .bc-zone-card {
            background: linear-gradient(135deg, rgba(15,23,42,0.97), rgba(22,40,70,0.97));
            border: 1px solid rgba(245,158,11,0.35);
            border-radius: 18px;
            margin-bottom: 24px;
            overflow: hidden;
        }
        .bc-zone-card.bc-zone-confirmed {
            border-color: rgba(52,211,153,0.45);
        }
        /* Card top bar */
        .bc-zc-topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
            padding: 18px 22px 14px;
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }
        .bc-zc-zone-name {
            font-size: 20px;
            font-weight: 800;
            color: #fbbf24;
            letter-spacing: 0.3px;
        }
        .bc-zc-topbar-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .bc-print-zone-btn {
            font-size: 11px;
            padding: 5px 10px;
            border: 1px solid rgba(148,163,184,0.4);
            color: #94a3b8;
            border-radius: 6px;
            cursor: pointer;
        }
        .bc-print-zone-btn:hover {
            background: rgba(148,163,184,0.1);
            color: #e2e8f0;
        }
        .bc-movements-table th, .bc-movements-table td {
            padding: 8px 12px;
            border-bottom: 1px solid rgba(148,163,184,0.15);
        }
        .bc-movements-table th { color: #94a3b8; font-weight: 600; font-size: 11px; text-transform: uppercase; }
        /* Zone balance summary row */
        .bc-zc-summary {
            display: flex;
            gap: 0;
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }
        .bc-zc-sum-item {
            flex: 1;
            padding: 14px 16px;
            text-align: center;
            border-right: 1px solid rgba(255,255,255,0.06);
        }
        .bc-zc-sum-item:last-child { border-right: none; }
        .bc-zc-sum-label {
            font-size: 10px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        .bc-zc-sum-value {
            font-size: 22px;
            font-weight: 800;
            color: #e2e8f0;
        }
        /* SKU breakdown table */
        .bc-zc-sku-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .bc-zc-sku-table th {
            padding: 8px 14px;
            text-align: left;
            font-size: 10px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-weight: 700;
            background: rgba(255,255,255,0.03);
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }
        .bc-zc-sku-table th:not(:first-child),
        .bc-zc-sku-table td:not(:first-child) { text-align: right; }
        .bc-zc-sku-table td {
            padding: 10px 14px;
            color: #e2e8f0;
            border-bottom: 1px solid rgba(255,255,255,0.04);
        }
        .bc-zc-sku-table tr:last-child td { border-bottom: none; }
        .bc-zc-sku-table tr:hover td { background: rgba(255,255,255,0.02); }
        .bc-zc-sku-table .variance-match { color: #34d399; }
        .bc-zc-sku-table .variance-short { color: #f87171; }
        .bc-zc-sku-table .variance-over { color: #a78bfa; }
        .bc-zc-sku-list-only { padding: 16px; background: rgba(255,255,255,0.03); border-radius: 10px; margin-bottom: 12px; }
        .bc-zc-sku-list-label { font-size: 11px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
        .bc-zc-sku-list { font-size: 13px; color: #e2e8f0; line-height: 1.6; }
        /* Footer: confirm button or confirmed stamp */
        .bc-zc-footer {
            padding: 16px 22px;
            border-top: 1px solid rgba(255,255,255,0.06);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
        }
        .bc-zc-confirmed-stamp {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #34d399;
        }
        .bc-card-zone { display: none; }

        /* Confirm modal */
        .bc-modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 600;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }
        .bc-modal-overlay.active { display: flex; }
        .bc-modal {
            width: 100%;
            max-width: 480px;
            background: linear-gradient(135deg, #0f172a, #1e3a5f);
            border: 2px solid rgba(245,158,11,0.4);
            border-radius: 20px;
            padding: 32px 28px 24px;
        }
        .bc-modal h3 { margin: 0 0 6px; color: #f1f5f9; font-size: 18px; }
        .bc-modal .bc-modal-sub { color: #64748b; font-size: 13px; margin-bottom: 24px; }
        .bc-modal-balances {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            padding: 16px;
        }
        .bc-modal-bal-item .label { font-size: 11px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; }
        .bc-modal-bal-item .value { font-size: 22px; font-weight: 800; color: #e2e8f0; }
        .bc-physical-inputs-section { margin-bottom: 16px; }
        .bc-physical-section-label { display: block; font-size: 13px; color: #94a3b8; margin-bottom: 12px; font-weight: 600; }
        .bc-physical-inputs-container { display: flex; flex-direction: column; gap: 10px; max-height: 240px; overflow-y: auto; }
        .bc-physical-sku-row {
            display: grid; grid-template-columns: 1fr 100px; gap: 12px; align-items: center;
            padding: 10px 14px; background: rgba(255,255,255,0.04); border-radius: 10px;
            border: 1px solid rgba(245,158,11,0.2);
        }
        .bc-physical-sku-row .sku-label { font-weight: 600; color: #e2e8f0; font-size: 13px; }
        .bc-physical-sku-row .sku-sys { font-size: 11px; color: #64748b; margin-top: 2px; }
        .bc-physical-sku-row input {
            padding: 10px 12px; background: rgba(255,255,255,0.06);
            border: 2px solid rgba(245,158,11,0.3); border-radius: 8px;
            color: #f1f5f9; font-size: 16px; font-weight: 700; text-align: center;
            outline: none; box-sizing: border-box; width: 100%; min-width: 0;
        }
        .bc-physical-sku-row input:focus { border-color: rgba(245,158,11,0.7); }
        .bc-receipt-intro { text-align: center; font-size: 13px; color: #34d399; font-weight: 600; margin-bottom: 16px; }
        .bc-receipt-table { overflow-x: auto; margin-bottom: 20px; max-height: 280px; overflow-y: auto; }
        .bc-receipt-table table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .bc-receipt-table th, .bc-receipt-table td { padding: 8px 12px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.08); }
        .bc-receipt-table th { color: #fbbf24; font-weight: 600; }
        .bc-receipt-table .variance-match { color: #34d399; }
        .bc-receipt-table .variance-short { color: #f87171; }
        .bc-receipt-table .variance-over { color: #a78bfa; }
        .bc-audit-filters { display: flex; flex-wrap: wrap; gap: 12px; align-items: flex-end; }
        .bc-audit-filters > div { display: flex; flex-direction: column; gap: 4px; }
        .bc-audit-filters label { font-size: 11px; color: #64748b; }
        .bc-audit-filters input, .bc-audit-filters select { padding: 8px 12px; border-radius: 8px; border: 1px solid rgba(245,158,11,0.3); background: rgba(255,255,255,0.06); color: #e2e8f0; }
        .bc-audit-table-wrap { max-height: 360px; overflow: auto; margin-bottom: 16px; }
        .bc-revoke-list { max-height: 320px; overflow-y: auto; }
        .bc-revoke-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.06); }
        .bc-revoke-btn { padding: 8px 16px; background: rgba(248,113,113,0.2); color: #f87171; border: 1px solid rgba(248,113,113,0.4); border-radius: 8px; font-weight: 600; cursor: pointer; }
        .bc-revoke-btn:hover { background: rgba(248,113,113,0.3); }
        .bc-variance-preview {
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 20px;
            background: rgba(255,255,255,0.04);
            color: #94a3b8;
        }
        .bc-variance-preview.match   { background: rgba(52,211,153,0.1); color: #34d399; }
        .bc-variance-preview.short   { background: rgba(248,113,113,0.1); color: #f87171; }
        .bc-variance-preview.over    { background: rgba(167,139,250,0.1); color: #a78bfa; }
        .bc-modal-actions { display: flex; gap: 12px; }
        .bc-modal-actions button { flex: 1; padding: 12px; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; border: none; }
        .bc-btn-cancel  { background: rgba(255,255,255,0.07); color: #94a3b8; }
        .bc-btn-confirm { background: linear-gradient(135deg, #f59e0b, #fbbf24); color: #0f172a; }
        .bc-btn-confirm:disabled { opacity: 0.5; cursor: not-allowed; }
        .bc-modal-status { text-align: center; font-size: 13px; margin-top: 12px; min-height: 20px; }

        /* Print bin card — report layout, no interactive elements */
        @media print {
            body.bincards-mode-active * { visibility: hidden; }
            body.bincards-mode-active #binCardsSection,
            body.bincards-mode-active #binCardsSection * { visibility: visible; }
            body.bincards-mode-active #binCardsSection {
                position: absolute; left: 0; top: 0; width: 100%; padding: 0; background: #fff;
            }
            body.bincards-mode-active #binCardsLoginOverlay,
            body.bincards-mode-active .bc-progress-bar,
            body.bincards-mode-active .bc-progress-label,
            body.bincards-mode-active .bc-movements-section,
            body.bincards-mode-active #bcLoadingState,
            body.bincards-mode-active #bcEmptyState,
            body.bincards-mode-active .bc-confirm-btn,
            body.bincards-mode-active .bc-print-btn,
            body.bincards-mode-active .bc-print-zone-btn,
            body.bincards-mode-active #bcAuditReportBtn,
            body.bincards-mode-active #bcRevokeAdminBtn,
            body.bincards-mode-active #bcReconReportBtn,
            body.bincards-mode-active .bc-header a[href="index.html"],
            body.bincards-mode-active .app-footer-bar,
            body.bincards-mode-active .bc-modal-overlay,
            body.bincards-mode-active .movement-login-overlay { display: none !important; visibility: hidden !important; }
            body.bincards-mode-active .bc-header {
                display: block !important; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid #333;
            }
            body.bincards-mode-active .bc-header h2 { font-size: 18px; color: #000; margin: 0; }
            body.bincards-mode-active .bc-header .bc-shift-badge,
            body.bincards-mode-active .bc-header div:first-child div:first-child,
            body.bincards-mode-active .bc-header .bc-consistency-ok,
            body.bincards-mode-active .bc-header .bc-consistency-warn,
            body.bincards-mode-active .bc-header #bcSnapshotAt { font-size: 11px; color: #333; margin-top: 4px; }
            body.bincards-mode-active .bc-grid {
                display: block !important; max-width: none;
            }
            body.bincards-mode-active .bc-zone-card {
                break-inside: avoid; page-break-inside: avoid;
                background: #fff !important; border: 1px solid #333 !important; margin-bottom: 20px; padding: 16px;
                box-shadow: none !important;
            }
            body.bincards-mode-active .bc-zone-card:not(:first-child) {
                page-break-before: always;
            }
            body.bincards-mode-active.bc-print-single-zone .bc-zone-card:not(.bc-zone-card-print-target) {
                display: none !important;
            }
            body.bincards-mode-active .bc-zone-card * { color: #000 !important; }
            body.bincards-mode-active .bc-zc-topbar { border-bottom: 1px solid #ccc; padding-bottom: 8px; margin-bottom: 12px; }
            body.bincards-mode-active .bc-zc-zone-name { color: #000 !important; font-size: 14px; }
            body.bincards-mode-active .bc-status-pill {
                border: 1px solid #333; color: #000; background: #f5f5f5;
            }
            body.bincards-mode-active .bc-zc-summary {
                background: #f9f9f9 !important; border: 1px solid #ddd; padding: 12px; margin-bottom: 12px;
            }
            body.bincards-mode-active .bc-zc-sum-item .bc-zc-sum-label { color: #555 !important; }
            body.bincards-mode-active .bc-zc-sum-item .bc-zc-sum-value { color: #000 !important; }
            body.bincards-mode-active .bc-zc-sku-table {
                border: 1px solid #333; font-size: 11px;
            }
            body.bincards-mode-active .bc-zc-sku-table th,
            body.bincards-mode-active .bc-zc-sku-table td {
                border: 1px solid #666; padding: 6px 8px; color: #000 !important;
            }
            body.bincards-mode-active .bc-zc-sku-table th { background: #e8e8e8 !important; }
            body.bincards-mode-active .bc-zc-sku-table .variance-match { color: #0a0 !important; }
            body.bincards-mode-active .bc-zc-sku-table .variance-short { color: #c00 !important; }
            body.bincards-mode-active .bc-zc-sku-table .variance-over { color: #60a !important; }
            body.bincards-mode-active .bc-zc-confirmed-stamp { color: #333 !important; font-size: 11px; margin-top: 8px; }
            body.bincards-mode-active .bc-zc-sku-list-only { background: #f5f5f5 !important; border: 1px solid #ddd; color: #000 !important; }
            body.bincards-mode-active .bc-zc-sku-list-label { color: #555 !important; }
            body.bincards-mode-active .bc-zc-sku-list { color: #000 !important; }
        }
        /* Print Stocks/Merchandise Reconciliation Report */
        @media print {
            body.bc-print-recon * { visibility: hidden; }
            body.bc-print-recon #bcReconReportModal,
            body.bc-print-recon #bcReconReportModal * { visibility: visible; }
            body.bc-print-recon #bcReconReportModal {
                position: absolute; left: 0; top: 0; width: 100%; background: #fff; display: block !important;
            }
            body.bc-print-recon #bcReconReportModal .bc-recon-filters,
            body.bc-print-recon #bcReconReportModal .bc-modal-actions,
            body.bc-print-recon #bcReconReportModal .btn-reset,
            body.bc-print-recon #bcReconReportModal .btn-generate { display: none !important; }
            body.bc-print-recon #bcReconReportModal h3 { color: #000; }
            body.bc-print-recon #bcReconReportModal .bc-recon-table,
            body.bc-print-recon #bcReconReportModal .bc-recon-table th,
            body.bc-print-recon #bcReconReportModal .bc-recon-table td { border: 1px solid #333; color: #000 !important; }
        }
        .movement-login-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #0b1628 0%, #1e3a5f 60%, #0b1628 100%);
            z-index: 500;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }
        .movement-login-card {
            width: 100%;
            max-width: 440px;
            background: linear-gradient(135deg, rgba(15,23,42,0.98), rgba(30,58,95,0.98));
            border: 2px solid rgba(245,158,11,0.4);
            border-radius: 24px;
            padding: 36px 32px 28px;
            box-shadow: 0 16px 64px rgba(0,0,0,0.5), 0 8px 32px rgba(245,158,11,0.15);
            position: relative;
        }
        .movement-login-card .mlc-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            background: rgba(245,158,11,0.12);
            border: 2px solid rgba(245,158,11,0.35);
            border-radius: 50%;
        }
        .movement-login-card .mlc-badge {
            display: block;
            text-align: center;
            font-size: 0.68rem;
            font-weight: 700;
            letter-spacing: 1.8px;
            text-transform: uppercase;
            color: #475569;
            margin-bottom: 20px;
        }
        .movement-login-card h2 {
            text-align: center;
            font-size: 1.25rem;
            font-weight: 700;
            background: linear-gradient(135deg, #fbbf24, #f59e0b, #fcd34d);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }
        .movement-login-card .mlc-tab-label {
            text-align: center;
            font-size: 0.82rem;
            color: #64748b;
            margin-bottom: 24px;
        }
        .movement-login-card .mlc-tab-label strong {
            color: #94a3b8;
        }
        .movement-login-card .fill-form-group label {
            color: #fbbf24;
        }
        .movement-login-card .mlc-footer {
            margin-top: 24px;
        }
        .movement-login-card .mlc-back {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.78rem;
            color: #64748b;
            text-decoration: none;
            margin-bottom: 20px;
            transition: color 0.15s;
        }
        .movement-login-card .mlc-back:hover { color: #94a3b8; }

        /* ── Consistent app footer ── */
        .app-footer-bar {
            text-align: center;
            margin-top: 28px;
            padding-top: 18px;
            border-top: 1px solid rgba(245, 158, 11, 0.2);
            font-size: 12px;
            color: #64748b;
            letter-spacing: 0.5px;
            font-weight: 500;
        }
        .app-footer-bar .footer-brand { color: #fbbf24; font-weight: 700; }
        .app-footer-bar .footer-lab   { color: #818cf8; font-weight: 700; }

        /* ── Global readability improvements ── */
        p, li, td, th, span, small, label {
            letter-spacing: 0.01em;
        }
        td, th {
            color: inherit;
        }
        .movement-panel,
        .movement-panel * {
            color: inherit;
        }
        .movement-panel td {
            color: rgba(226, 232, 240, 0.9);
        }
        .movement-panel th {
            color: #fbbf24;
        }
        select option {
            background: #1e3a5f;
            color: #e2e8f0;
        }

        /* ── Enhanced login card ── */
        #loginCard .fill-card-login-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.7rem;
            font-weight: 700;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            color: #475569;
            background: rgba(71, 85, 105, 0.15);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 20px;
            padding: 4px 12px;
            margin-bottom: 16px;
        }
        #loginCard h2 {
            font-size: 22px !important;
        }
        .login-lock-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 56px;
            height: 56px;
            margin: 0 auto 16px;
            background: rgba(245, 158, 11, 0.12);
            border: 2px solid rgba(245, 158, 11, 0.35);
            border-radius: 50%;
            font-size: 26px;
        }

        /* ── Table readability ── */
        table {
            color: #e2e8f0;
        }
        .movement-panel table td,
        #zoneOverviewTable td,
        #recentMovementsTable td {
            color: rgba(226, 232, 240, 0.9);
        }
        #zoneOverviewTable table,
        #recentMovementsTable table {
            color: #e2e8f0;
        }

        /* ── Control panel readability ── */
        .control-panel {
            color: #e2e8f0;
        }
        .control-panel label {
            color: #fbbf24;
        }
        .control-panel p,
        .control-panel small {
            color: #94a3b8;
        }

        /* ── Movement form labels ── */
        .movement-form-grid label {
            color: #fbbf24;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            display: block;
            margin-bottom: 6px;
        }
        .movement-section h3 {
            border-bottom: 1px solid rgba(245, 158, 11, 0.2);
            padding-bottom: 10px;
            margin-bottom: 16px;
        }

        /* ── Badge colors ── */
        .badge { color: #e2e8f0; }
        .badge[style*="Active"] { color: #86efac; }

        /* ── Improved view card readability ── */
        #viewCard p,
        #viewCard span,
        #viewCard small {
            color: inherit;
        }
        .pallet-info-grid span,
        .pallet-info-grid small {
            color: #94a3b8;
        }
    </style>
</head>
<body>
    <!-- Splash: once per session, view/edit modes only -->
    <div id="retifluxSplash" class="retiflux-splash" style="display:none;" aria-hidden="true">
        <div class="splash-icon">
            <div class="splash-glow"></div>
            <img src="favicon.png" alt="RetiFlux" width="96" height="96" loading="eager">
        </div>
        <div class="splash-title">RetiFlux™</div>
        <div class="splash-subtitle">Powered by NexGridCore DataLabs</div>
        <div class="splash-dots"><span></span><span></span><span></span></div>
    </div>
    <!-- Loading overlay: pulse icon only, for loading states & section transitions -->
    <div id="retifluxLoadingOverlay" class="retiflux-loading-overlay" aria-hidden="true">
        <div class="loading-pulse-icon">
            <div class="loading-pulse-glow"></div>
            <img src="favicon.png" alt="" width="64" height="64" loading="eager">
        </div>
    </div>
    <!-- Movement-only login overlay (shown in mode=movement when not logged in) -->
    <div class="movement-login-overlay" id="movementLoginOverlay">
        <div class="movement-login-card">
            <a href="index.html" class="mlc-back">← Back to Home</a>
            <div class="mlc-icon">🚚</div>
            <span class="mlc-badge">⬥ Authorized Personnel Only</span>
            <h2>Stock Movement Control</h2>
            <p class="mlc-tab-label">Opening: <strong id="mlcTabLabel">Zone Monitor</strong></p>
            <form id="movementLoginForm" class="fill-form" onsubmit="event.preventDefault(); return false;">
                <div class="fill-form-group">
                    <label for="movementLoginUser">Select User</label>
                    <select id="movementLoginUser" required>
                        <option value="">Loading authorized users...</option>
                    </select>
                </div>
                <div class="fill-form-group">
                    <label for="movementLoginPasscode">Passcode</label>
                    <input type="password" id="movementLoginPasscode" required placeholder="Enter your secure passcode">
                </div>
                <div class="fill-actions">
                    <button type="submit" class="btn-generate" id="movementLoginSubmit">🔓 Unlock Movement Controls</button>
                </div>
                <div id="movementLoginStatus" class="login-status"></div>
            </form>
            <div class="mlc-footer app-footer-bar"><strong class="footer-brand">RetiFlux™</strong> Powered by <strong class="footer-lab">NexGridCore DataLabs</strong></div>
        </div>
    </div>

    <!-- ── Bin-Cards login overlay ── -->
    <div class="movement-login-overlay" id="binCardsLoginOverlay">
        <div class="movement-login-card">
            <a href="index.html" class="mlc-back">← Back to Home</a>
            <div class="mlc-icon">📋</div>
            <span class="mlc-badge">⬥ Authorized Personnel Only</span>
            <h2>Bin Card Center</h2>
            <p class="mlc-tab-label">Current shift: <strong id="bcLoginShiftLabel">Loading...</strong></p>
            <form id="binCardsLoginForm" class="fill-form" onsubmit="event.preventDefault(); return false;">
                <div class="fill-form-group">
                    <label for="bcLoginUser">Select User</label>
                    <select id="bcLoginUser" required>
                        <option value="">Loading authorized users...</option>
                    </select>
                </div>
                <div class="fill-form-group">
                    <label for="bcLoginPasscode">Passcode</label>
                    <input type="password" id="bcLoginPasscode" required placeholder="Enter your secure passcode">
                </div>
                <div class="fill-actions">
                    <button type="submit" class="btn-generate" id="bcLoginSubmit">🔓 Open Bin Cards</button>
                </div>
                <div id="bcLoginStatus" class="login-status"></div>
            </form>
            <div class="mlc-footer app-footer-bar"><strong class="footer-brand">RetiFlux™</strong> Powered by <strong class="footer-lab">NexGridCore DataLabs</strong></div>
        </div>
    </div>

    <!-- ── Bin-Cards section ── -->
    <div id="binCardsSection">
        <div class="bc-header">
            <div>
                <div style="font-size:12px;color:#64748b;font-weight:600;letter-spacing:1px;text-transform:uppercase;margin-bottom:4px;">📋 Bin Card Center</div>
                <h2>Shift Stock Reconciliation</h2>
                <div id="bcPalletConsistency" class="bc-consistency-line" style="font-size:11px;margin-top:6px;color:#64748b;"></div>
                <div id="bcSnapshotAt" class="bc-consistency-line" style="font-size:11px;margin-top:4px;color:#94a3b8;display:none;"></div>
            </div>
            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
                <div style="display:flex;align-items:center;gap:8px;">
                    <label style="font-size:11px;color:#64748b;">Shift:</label>
                    <select id="bcShiftSelect" onchange="onBcShiftSelectChange()" style="font-size:12px;padding:6px 10px;background:rgba(15,23,42,0.8);border:1px solid rgba(148,163,184,0.3);border-radius:6px;color:#e2e8f0;">
                        <option value="current">Current</option>
                        <option value="previous">Previous</option>
                        <option value="custom">Custom…</option>
                    </select>
                    <span id="bcCustomShiftWrap" style="display:none;gap:6px;align-items:center;">
                        <input type="date" id="bcCustomDate" style="font-size:12px;padding:6px;background:rgba(15,23,42,0.8);border:1px solid rgba(148,163,184,0.3);border-radius:6px;color:#e2e8f0;">
                        <select id="bcCustomShift" style="font-size:12px;padding:6px 10px;background:rgba(15,23,42,0.8);border:1px solid rgba(148,163,184,0.3);border-radius:6px;color:#e2e8f0;">
                            <option value="Day">Day</option>
                            <option value="Night">Night</option>
                        </select>
                        <button type="button" class="btn-reset" onclick="loadBinCardsWithShift()" style="font-size:11px;padding:5px 10px;border:1px solid rgba(52,211,153,0.5);color:#34d399;border-radius:6px;">Load</button>
                    </span>
                </div>
                <span class="bc-shift-badge" id="bcShiftBadge">☀️ Loading shift…</span>
                <button class="bc-print-btn btn-reset" onclick="window.print()" style="font-size:12px;padding:7px 14px;border:1px solid rgba(148,163,184,0.3);color:#94a3b8;border-radius:8px;">🖨️ Print</button>
                <button class="btn-reset" id="bcAuditReportBtn" onclick="openBcAuditReport()" style="font-size:12px;padding:7px 14px;border:1px solid rgba(52,211,153,0.5);color:#34d399;border-radius:8px;">📊 Variance Audit Report</button>
                <button class="btn-reset" id="bcReconReportBtn" onclick="openBcReconReport()" style="font-size:12px;padding:7px 14px;border:1px solid rgba(129,140,248,0.5);color:#818cf8;border-radius:8px;">📦 Stocks/Merchandise Reconciliation Report</button>
                <button class="btn-reset" id="bcRevokeAdminBtn" onclick="openBcRevokeAdmin()" style="display:none;font-size:12px;padding:7px 14px;border:1px solid rgba(248,113,113,0.5);color:#f87171;border-radius:8px;">🔒 Revoke Bin Cards (QA/SUP)</button>
                <a href="index.html" style="font-size:12px;padding:7px 14px;border:1px solid rgba(245,158,11,0.3);color:#fbbf24;border-radius:8px;text-decoration:none;">← Home</a>
            </div>
        </div>

        <div class="bc-progress-bar"><div class="bc-progress-fill" id="bcProgressFill" style="width:0%"></div></div>
        <div class="bc-progress-label" id="bcProgressLabel">Loading…</div>

        <div id="bcMovementsSection" class="bc-movements-section" style="display:none;margin-bottom:20px;">
            <button type="button" class="btn-reset bc-movements-toggle" onclick="toggleBcMovements()" style="display:flex;align-items:center;gap:8px;width:100%;padding:12px 16px;background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.25);border-radius:10px;color:#fbbf24;font-size:13px;font-weight:600;cursor:pointer;text-align:left;">
                <span id="bcMovementsToggleIcon">▶</span>
                <span id="bcMovementsToggleLabel">📋 Movements this shift (0)</span>
            </button>
            <div id="bcMovementsContent" style="display:none;margin-top:12px;padding:16px;background:rgba(15,23,42,0.5);border:1px solid rgba(148,163,184,0.2);border-radius:10px;overflow-x:auto;">
                <div id="bcMovementsTableContainer"></div>
                <div id="bcMovementsShiftNote" style="font-size:11px;color:#64748b;margin-top:10px;"></div>
            </div>
        </div>

        <div id="bcLoadingState" style="text-align:center;padding:60px 20px;color:#64748b;">
            <div style="font-size:36px;margin-bottom:12px;">⏳</div>
            <div style="font-size:16px;font-weight:600;">Loading bin card data…</div>
            <div style="font-size:13px;margin-top:6px;">Reading Pallets and Zone Movements</div>
        </div>
        <div id="bcEmptyState" style="display:none;text-align:center;padding:60px 20px;color:#64748b;">
            <div style="font-size:36px;margin-bottom:12px;">📭</div>
            <div style="font-size:16px;font-weight:600;">No stock recorded yet for this shift</div>
            <div style="font-size:13px;margin-top:6px;">Bin cards will appear as pallets are added to zones</div>
        </div>
        <div class="bc-grid" id="bcGrid"></div>

        <div class="app-footer-bar"><strong class="footer-brand">RetiFlux™</strong> Powered by <strong class="footer-lab">NexGridCore DataLabs</strong></div>
    </div>

    <!-- ── Bin-card confirm modal ── -->
    <div class="bc-modal-overlay" id="bcConfirmModal">
        <div class="bc-modal">
            <h3 id="bcModalTitle">Zone Physical Count</h3>
            <div class="bc-modal-sub" id="bcModalSub">Zone · Shift</div>
            <!-- Entry view: no system figures shown (Option 3: transparency) -->
            <div id="bcModalEntryView">
                <div class="bc-physical-inputs-section">
                    <label class="bc-physical-section-label">📦 Enter physical count for each SKU (no figures shown until you confirm)</label>
                    <div id="bcPhysicalInputsContainer" class="bc-physical-inputs-container"></div>
                </div>
                <div class="bc-modal-actions">
                    <button class="bc-btn-cancel" onclick="closeBcModal()">Cancel</button>
                    <button class="bc-btn-confirm" id="bcConfirmBtn" onclick="submitBinCardConfirmation()">✅ Close Zone Card</button>
                </div>
                <div class="bc-modal-status" id="bcModalStatus"></div>
            </div>
            <!-- Receipt view: shown after submit — system vs physical vs variance (immutable) -->
            <div id="bcModalReceiptView" style="display:none;">
                <div class="bc-receipt-intro">✅ Card closed. Data is final — no edits allowed.</div>
                <div id="bcReceiptTable" class="bc-receipt-table"></div>
                <div class="bc-modal-actions" style="justify-content:center;">
                    <button class="bc-btn-confirm" onclick="typeof dismissBcReceipt==='function'&&dismissBcReceipt()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ── Variance Audit Report modal ── -->
    <div class="bc-modal-overlay" id="bcAuditReportModal" style="display:none;">
        <div class="bc-modal" style="max-width:900px;">
            <h3>📊 Variance Audit Report</h3>
            <div class="bc-audit-filters">
                <div><label>From Date</label><input type="date" id="bcAuditDateFrom"></div>
                <div><label>To Date</label><input type="date" id="bcAuditDateTo"></div>
                <div><label>Shift</label><select id="bcAuditShift"><option value="">All</option><option value="Day">Day</option><option value="Night">Night</option></select></div>
                <div><label>Zone</label><input type="text" id="bcAuditZone" placeholder="All"></div>
                <div><button class="btn-generate" onclick="loadBcAuditReport()">Load Report</button></div>
                <div><button class="btn-reset" onclick="exportBcAuditCsv()" id="bcAuditExportBtn" disabled>📥 Export CSV</button></div>
            </div>
            <div id="bcAuditReportTable" class="bc-audit-table-wrap"></div>
            <div class="bc-modal-actions" style="justify-content:center;"><button class="bc-btn-cancel" onclick="closeBcAuditReport()">Close</button></div>
        </div>
    </div>

    <!-- ── Revoke Bin Cards (QA/Supervisor only) ── -->
    <div class="bc-modal-overlay" id="bcRevokeAdminModal" style="display:none;">
        <div class="bc-modal" style="max-width:800px;">
            <h3>🔒 Revoke Bin Cards</h3>
            <p style="font-size:12px;color:#94a3b8;margin-bottom:16px;">Only QA or Supervisors can revoke. Revoked zones return to Open and may be re-confirmed.</p>
            <div class="bc-audit-filters" style="margin-bottom:16px;">
                <div><label>From Date</label><input type="date" id="bcRevokeDateFrom"></div>
                <div><label>To Date</label><input type="date" id="bcRevokeDateTo"></div>
                <div><button class="btn-generate" onclick="loadBcRevokeList()">Load</button></div>
            </div>
            <div id="bcRevokeList" class="bc-revoke-list"></div>
            <div class="bc-modal-actions" style="justify-content:center;"><button class="bc-btn-cancel" onclick="closeBcRevokeAdmin()">Close</button></div>
        </div>
    </div>

    <!-- ── Stocks/Merchandise Reconciliation Report modal ── -->
    <div class="bc-modal-overlay" id="bcReconReportModal" style="display:none;">
        <div class="bc-modal bc-recon-report-modal" style="max-width:1000px;">
            <h3>📦 Stocks/Merchandise Reconciliation Report</h3>
            <div class="bc-audit-filters bc-recon-filters">
                <div><label>Date range</label>
                    <select id="bcReconDatePreset" onchange="onBcReconPresetChange()">
                        <option value="all">All pallets</option>
                        <option value="today">Today</option>
                        <option value="7day">Last 7 days (rolling)</option>
                        <option value="30day">Last 30 days (rolling)</option>
                        <option value="month">This month</option>
                        <option value="custom">Custom range…</option>
                    </select>
                </div>
                <span id="bcReconCustomWrap" style="display:none;align-items:flex-end;gap:8px;">
                    <div><label>From</label><input type="date" id="bcReconDateFrom"></div>
                    <div><label>To</label><input type="date" id="bcReconDateTo"></div>
                </span>
                <div><button class="btn-generate" onclick="loadBcReconReport()">Load Report</button></div>
                <div><button class="btn-reset" onclick="exportBcReconCsv()" id="bcReconExportBtn" disabled>📥 Export CSV</button></div>
                <div><button class="btn-reset" onclick="printBcReconReport()" id="bcReconPrintBtn">🖨️ Print</button></div>
            </div>
            <div id="bcReconFilterLabel" style="font-size:12px;color:#64748b;margin-bottom:10px;"></div>
            <div id="bcReconReportTable" class="bc-recon-table-wrap"></div>
            <div class="bc-modal-actions" style="justify-content:center;"><button class="bc-btn-cancel" onclick="closeBcReconReport()">Close</button></div>
        </div>
    </div>

    <div class="control-panel">
        <h1>⬥ RetiFlux™</h1>
        <div class="subtitle">Retis Fluxit, Data Vincit</div>
        
        <div class="current-serial">
            <span>Next Serial</span>
            <strong id="nextSerial">FG-BL-00001</strong>
        </div>

        <div class="form-group">
            <label>📊 Number of Tickets (per side)</label>
            <input type="number" id="ticketCount" value="4" min="4" step="4">
            <small>Each A4 page prints 4 ticket pairs (8 total tickets)</small>
        </div>

        <div class="form-group">
            <label>🎨 Select Group Color</label>
            <div class="color-selector">
                <div class="color-option color-red" data-color="red">RED</div>
                <div class="color-option color-blue selected" data-color="blue">BLUE</div>
                <div class="color-option color-green" data-color="green">GREEN</div>
                <div class="color-option color-yellow" data-color="yellow">YELLOW</div>
            </div>
        </div>

        <button class="btn-generate" onclick="generateTickets()">
            🖨️ GENERATE & PRINT TICKETS
        </button>
        <button class="btn-generate" onclick="generateAllColorTicketsPDF(event)" style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); margin-top: 10px;">
            📥 DOWNLOAD PDF (52 Tickets × 4 Colors)
        </button>
        <button class="btn-reset" type="button" onclick="resetSerial()">
            ♻️ Reset Serial Number
        </button>
        
        <!-- SECURITY: Config sections hidden by default, require password to unlock -->
        <div class="form-group" style="margin-top: 25px; padding-top: 25px; border-top: 2px solid #e2e8f0;">
            <button type="button" class="btn-reset" onclick="unlockConfigSection()" id="unlockConfigBtn" style="width: 100%; background: #4c51bf; color: white; font-weight: 600;">
                🔒 Show Advanced Configuration
            </button>
            <small style="display: block; margin-top: 8px; color: #718096;">Password required to view/edit configuration</small>
        </div>
        
        <div id="configSection" style="display: none;">
            <div class="form-group" style="margin-top: 25px; padding-top: 25px; border-top: 2px solid #e2e8f0;">
                <button type="button" class="btn-reset" onclick="lockConfigSection()" id="lockConfigBtn" style="width: 100%; background: #e53e3e; color: white; font-weight: 600; margin-bottom: 15px; display: none;">
                    🔒 Lock Configuration
                </button>
                <label>⚙️ Google Sheets Configuration</label>
                <input type="text" id="googleSheetId" placeholder="Google Sheet ID (hidden)" style="margin-bottom: 10px;" readonly>
                <input type="text" id="googleApiKey" placeholder="Google API Key (hidden)" readonly>
                <button type="button" class="btn-reset" onclick="toggleConfigVisibility()" style="margin-top: 5px; width: 100%; font-size: 12px;">👁️ Show/Hide Values</button>
                <small>Get these from the setup instructions. Required for data tracking.</small>
                <button type="button" class="btn-reset" onclick="saveGoogleConfig()" style="margin-top: 10px; width: 100%;">💾 Save Configuration</button>
                <button type="button" class="btn-reset" onclick="testGoogleSheetsConnection()" style="margin-top: 10px; width: 100%; background: #667eea; color: white;">🔍 Test Connection</button>
                <div id="testResults" style="margin-top: 10px; padding: 10px; border-radius: 5px; display: none; font-size: 12px;"></div>
            </div>
            
            <div class="form-group" style="margin-top: 25px; padding-top: 25px; border-top: 2px solid #e2e8f0;">
                <label>📱 QR Code URL Configuration</label>
                <input type="text" id="scanBaseUrl" placeholder="https://nexgridcoredatalabs.github.io/Nexers-Banding-Tickets/" style="margin-bottom: 10px;">
                <small>Enter your network IP address and port (not localhost). This is what QR codes will link to. Find your IP with: ipconfig (Windows) or ifconfig (Mac/Linux)</small>
                <button type="button" class="btn-reset" onclick="saveScanUrlConfig()" style="margin-top: 10px; width: 100%;">💾 Save QR URL</button>
            </div>
        </div>
        
        <div class="app-footer-bar"><strong class="footer-brand">RetiFlux™</strong> Powered by <strong class="footer-lab">NexGridCore DataLabs</strong></div>
    </div>

    <div class="print-container" id="printContainer"></div>

    <div class="fill-mode" id="fillContainer">
        <div class="fill-card" id="viewCard" style="display: none;">
            <h2 id="viewRotatingHeading" style="margin: 0 0 4px 0; text-align: center; min-height: 2.5em; text-transform: none;"></h2>
            <span id="viewSerialDisplay" style="display:none; speak:none;" aria-hidden="true"></span>
            <div id="viewContent" class="fill-form">
                <div id="viewLoading" style="text-align: center; padding: 60px 20px;">
                    <div class="loading-spinner" style="width: 40px; height: 40px; margin: 0 auto 16px;"></div>
                    <p style="color: rgba(251, 191, 36, 0.95); font-size: 15px; margin-top: 12px; font-weight: 700; text-shadow: 0 2px 8px rgba(0, 0, 0, 0.4); letter-spacing: 0.5px;">Loading ticket data...</p>
                    <div class="loading-skeleton skeleton-title" style="margin: 24px auto 0; width: 70%;"></div>
                    <div class="loading-skeleton skeleton-text" style="margin: 12px auto 0; width: 90%;"></div>
                    <div class="loading-skeleton skeleton-text" style="margin: 8px auto 0; width: 80%;"></div>
                </div>
                <div id="viewData" style="display: none;"></div>
            </div>
            <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(245, 158, 11, 0.2);">
                <button type="button" id="viewModeLoginBtn" class="btn-reset" onclick="showViewModeLogin()" style="font-size: 12px; padding: 6px 14px; border: 2px solid rgba(245,158,11,0.5); color: #fbbf24; white-space: nowrap; margin-bottom: 12px;">🔐 Authorized Access</button>
                <div class="app-footer-bar" style="margin-top: 4px; padding-top: 0; border-top: none;"><strong class="footer-brand">RetiFlux™</strong> Powered by <strong class="footer-lab">NexGridCore DataLabs</strong></div>
            </div>
        </div>

        <div class="fill-card" id="loginCard" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
                <h2 style="margin: 0;">⬥ Authorized Login</h2>
                <button type="button" class="btn-reset" id="loginCloseBtn" onclick="closeLoginCard()" style="padding: 8px 16px; font-size: 13px; border: 2px solid rgba(245,158,11,0.5); color: #fbbf24; border-radius: 8px; white-space: nowrap;">✕ Close</button>
            </div>
            <div style="text-align: center; margin-bottom: 20px;">
                <div class="login-lock-icon">🔐</div>
                <div class="fill-card-login-badge">⬥ Authorized Personnel Only</div>
            </div>
            <p id="loginCardIntro" class="fill-intro">Only authorized production leads can edit tickets from this workstation. Please sign in to continue.</p>
            <form id="loginForm" class="fill-form">
                <div class="fill-form-group">
                    <label for="loginUser">Select User</label>
                    <select id="loginUser" required>
                        <option value="">Loading authorized users...</option>
                    </select>
                </div>
                <div class="fill-form-group">
                    <label for="loginPasscode">Passcode</label>
                    <input type="password" id="loginPasscode" required placeholder="Enter your secure passcode">
                </div>
                <div class="fill-actions">
                    <button type="submit" class="btn-generate" id="loginSubmit">🔓 Unlock Editor</button>
                    <button type="button" class="btn-reset" id="loginResetAccess">🔄 Reset Access</button>
                </div>
                <div id="loginStatus" class="login-status"></div>
            </form>
            <div style="text-align: center; margin-top: 30px; padding-top: 18px; border-top: 1px solid rgba(245, 158, 11, 0.2);">
                <div class="app-footer-bar" style="margin-top: 0; padding-top: 0; border-top: none;"><strong class="footer-brand">RetiFlux™</strong> Powered by <strong class="footer-lab">NexGridCore DataLabs</strong></div>
            </div>
        </div>
        
        <div class="fill-card" id="editCard" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                <h2 style="margin: 0;">⬥ Edit Ticket</h2>
                <button type="button" class="btn-reset" id="editCloseBtn" onclick="closeEditFormToHome()" style="padding: 8px 16px; font-size: 13px; border: 2px solid rgba(245,158,11,0.5); color: #fbbf24; border-radius: 8px; white-space: nowrap;">✕ Close</button>
            </div>
            <p id="editCardIntro" class="fill-intro">Enter the captured information for serial <strong id="fillSerialDisplay" style="color: #fcd34d; font-weight: 800; letter-spacing: 1px;"></strong>. When you submit, data is saved to Google Sheets and a finished ticket downloads as a PNG.</p>
            <div class="logged-in-banner" id="loggedInUserBanner">
                <div>
                    <span id="loggedInUserText"></span>
                    <small>Session locked to this user. All edits are tracked.</small>
                </div>
                <button type="button" class="btn-reset" id="logoutUserButton">Log out</button>
            </div>
            <form id="ticketForm" class="fill-form">
                <div class="fill-form-grid">
                    <div class="fill-form-group">
                        <label for="fillSerial">Ticket Serial</label>
                        <input type="text" id="fillSerial" name="serial" required inputmode="text">
                    </div>
                    <div class="fill-form-group">
                        <label for="fillColor">Ticket Colour</label>
                        <select id="fillColor" name="color">
                            <option value="blue">Blue</option>
                            <option value="red">Red</option>
                            <option value="green">Green</option>
                            <option value="yellow">Yellow</option>
                        </select>
                    </div>
                    <div class="fill-form-group">
                        <label for="fillDate">Date</label>
                        <input type="date" id="fillDate" name="date" inputmode="none">
                    </div>
                    <div class="fill-form-group">
                        <label for="fillTime">Time</label>
                        <input type="time" id="fillTime" name="time" inputmode="none">
                    </div>
                    <div class="fill-form-group">
                        <label for="fillSku">SKU</label>
                        <select id="fillSku" name="sku" required style="width: 100%; padding: 10px; border: 2px solid #cbd5e0; border-radius: 6px; font-size: 14px; background: white;">
                            <option value="">Select or type SKU...</option>
                        </select>
                        <input type="text" id="fillSkuCustom" name="skuCustom" placeholder="Or enter custom SKU..." style="width: 100%; padding: 10px; border: 2px solid #cbd5e0; border-radius: 6px; font-size: 14px; margin-top: 8px; display: none;">
                        <small style="display: block; margin-top: 5px; color: #718096; font-size: 12px;">Select from list or type custom SKU</small>
                    </div>
                    <div class="fill-form-group">
                        <label for="fillQty">Quantity</label>
                        <input type="number" id="fillQty" name="qty" min="0" step="1" inputmode="numeric">
                    </div>
                    <div class="fill-form-group">
                        <label for="fillLayers">Layers</label>
                        <input type="number" id="fillLayers" name="layers" min="0" step="1" inputmode="numeric">
                    </div>
                    <div class="fill-form-group fill-checkbox-group">
                        <span class="fill-group-label">Banding Type</span>
                        <label><input type="checkbox" name="bandingType" value="online"> Online</label>
                        <label><input type="checkbox" name="bandingType" value="offline"> Offline</label>
                    </div>
                    <div class="fill-form-group" id="productTypeDisplayGroup">
                        <label>Product Type</label>
                        <div id="productTypeDisplay" style="padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 8px; background: #f8fafc; color: #64748b; font-weight: 600;">— Select SKU first</div>
                        <input type="hidden" name="productType" id="productTypeHidden" value="">
                    </div>
                    <div class="fill-form-group fill-checkbox-group">
                        <span class="fill-group-label">Pallet Size</span>
                        <label><input type="checkbox" name="palletSize" value="78"> 78</label>
                        <label><input type="checkbox" name="palletSize" value="105"> 105</label>
                        <label><input type="checkbox" name="palletSize" value="64"> 64</label>
                        <label><input type="checkbox" name="palletSize" value="100"> 100</label>
                    </div>
                    <div class="fill-form-group fill-notes-group">
                        <label for="fillNotes">Notes / References</label>
                        <textarea id="fillNotes" name="notes" rows="4" placeholder="Additional remarks..."></textarea>
                    </div>
                    
                    <div class="fill-form-group" style="grid-column: 1 / -1; margin-top: 10px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                        <label style="font-size: 15px; font-weight: 700; margin-bottom: 15px;">Product Information (from SKU)</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div class="fill-form-group">
                                <label>Sachet Type</label>
                                <div id="sachetTypeDisplay" style="padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 8px; background: #f8fafc; color: #64748b; font-weight: 600;">—</div>
                                <input type="hidden" name="sachetType" id="sachetTypeHidden" value="">
                            </div>
                            <div class="fill-form-group">
                                <label>Tablet Type</label>
                                <div id="tabletTypeDisplay" style="padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 8px; background: #f8fafc; color: #64748b; font-weight: 600;">—</div>
                                <input type="hidden" name="tabletType" id="tabletTypeHidden" value="">
                            </div>
                            <div class="fill-form-group">
                                <label>UoM</label>
                                <div id="uomDisplay" style="padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 8px; background: #f8fafc; color: #64748b; font-weight: 600;">—</div>
                                <input type="hidden" name="uom" id="uomHidden" value="">
                            </div>
                        </div>
                    </div>
                    
                    <div class="fill-form-group" style="grid-column: 1 / -1; margin-top: 10px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                        <label style="font-size: 15px; font-weight: 700; margin-bottom: 15px;">Quality Issues</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div class="fill-form-group">
                                <label for="qualityIssueType">Issue Type</label>
                                <select id="qualityIssueType" name="qualityIssueType">
                                    <option value="">Select type...</option>
                                    <option value="banding">Banding Quality Frailties</option>
                                    <option value="production">Production Quality Frailties</option>
                                </select>
                            </div>
                            <div class="fill-form-group">
                                <label for="groupLeader">Group Leader</label>
                                <select id="groupLeader" name="groupLeader">
                                    <option value="">Select leader...</option>
                                </select>
                            </div>
                        </div>
                        <div class="fill-form-group">
                            <label for="qualityIssueDesc">Issue Description</label>
                            <textarea id="qualityIssueDesc" name="qualityIssueDesc" rows="3" placeholder="Describe the quality issue..."></textarea>
                        </div>
                    </div>
                    
                    <div class="fill-form-group" style="grid-column: 1 / -1; margin-top: 10px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                        <label style="font-size: 15px; font-weight: 700; margin-bottom: 15px;">Merchandise History</label>
                        <div id="merchHistoryContainer">
                            <div class="merch-history-entry" style="display: grid; grid-template-columns: 1fr; gap: 12px; margin-bottom: 12px; align-items: end; background: rgba(102, 126, 234, 0.03); padding: 16px; border-radius: 12px;">
                                <div class="fill-form-group">
                                    <label>Date</label>
                                    <input type="date" class="merch-history-date" name="merchHistoryDate[]" inputmode="none">
                                </div>
                                <div class="fill-form-group">
                                    <label>User</label>
                                    <select class="merch-history-user" name="merchHistoryUser[]">
                                        <option value="">Select user...</option>
                                    </select>
                                </div>
                                <div class="fill-form-group">
                                    <label>Note</label>
                                    <input type="text" class="merch-history-note" name="merchHistoryNote[]" placeholder="Enter note..." inputmode="text">
                                </div>
                            </div>
                        </div>
                        <style>
                            @media (min-width: 768px) {
                                .merch-history-entry {
                                    grid-template-columns: 1fr 1fr 2fr !important;
                                }
                            }
                        </style>
                        <button type="button" onclick="addMerchHistoryEntry()" class="btn-reset" style="width: 100%; margin-top: 10px;">+ Add History Entry</button>
                    </div>
                </div>
                <div class="fill-actions">
                    <button type="submit" class="btn-generate">💾 Save to Google Sheets & Download Ticket</button>
                </div>
                <div id="fillStatus" class="fill-status"></div>
            </form>
            <div class="app-footer-bar"><strong class="footer-brand">RetiFlux™</strong> Powered by <strong class="footer-lab">NexGridCore DataLabs</strong></div>
        </div>
        <div class="fill-preview">
            <h2>Live Preview</h2>
            <div class="fill-preview-note">Preview updates on submit before the download starts.</div>
            <div class="fill-preview-stage" id="fillPreview"></div>
            <div class="app-footer-bar"><strong class="footer-brand">RetiFlux™</strong> Powered by <strong class="footer-lab">NexGridCore DataLabs</strong></div>
        </div>

        <div id="movementSection" style="display: none;">
            <div class="movement-toggle">
                <button type="button" class="btn-generate" id="movementToggleBtn" onclick="toggleMovementPanel()">
                    🚚 Open Stock Movement Control
                </button>
                <a href="bandingtickets.html?mode=bincards" style="display:inline-block;margin-top:10px;padding:10px 20px;background:rgba(129,140,248,0.1);border:1px solid rgba(129,140,248,0.35);color:#818cf8;border-radius:12px;font-size:13px;font-weight:600;text-decoration:none;letter-spacing:0.3px;transition:background 0.2s;" onmouseover="this.style.background='rgba(129,140,248,0.2)'" onmouseout="this.style.background='rgba(129,140,248,0.1)'">
                    📋 View Bin Cards (Shift Reconciliation)
                </a>
            </div>

            <div class="movement-panel" id="movementPanel">
                <div class="movement-panel-header">
                    <div>
                        <h2>📦 Stock Movement Control</h2>
                        <p>Monitor pallets per zone, enforce FIFO, initiate moves, and receive inbounds.</p>
                    </div>
                    <button type="button" class="btn-reset" onclick="toggleMovementPanel(false)">Close</button>
                </div>

                <div class="movement-view-tabs">
                    <button type="button" class="movement-tab-btn active" data-view="monitor" onclick="switchMovementView('monitor')">Zone Monitor</button>
                    <button type="button" class="movement-tab-btn" data-view="receiving" onclick="switchMovementView('receiving')">Zone Receiving</button>
                </div>

                <div id="movementMonitorView" class="movement-view-content">
                <div class="movement-grid">
                    <div class="movement-column">
                        <div class="movement-section">
                            <h3>Zone Monitor</h3>
                            <div class="movement-controls">
                                <div>
                                    <label for="movementZoneSelect">Zone</label>
                                    <select id="movementZoneSelect"></select>
                                </div>
                                <div>
                                    <label for="movementStatusFilter">Status</label>
                                    <select id="movementStatusFilter">
                                        <option value="">Any status</option>
                                        <option value="Active">Active</option>
                                        <option value="Hold">Hold</option>
                                        <option value="Rework">Rework</option>
                                        <option value="Dispatch">Dispatch</option>
                                        <option value="Shipped">Shipped</option>
                                        <option value="Outbounding">Outbounding</option>
                                        <option value="Outbonded">Outbonded</option>
                                    </select>
                                </div>
                                <button type="button" class="btn-generate" onclick="refreshMovementZone(true)">🔄 Refresh</button>
                                <button type="button" class="btn-reset" onclick="refreshZoneOverview()" style="margin-top: 10px;">📊 View All Zones</button>
                                <button type="button" class="btn-reset" onclick="refreshRecentMovements()" style="margin-top: 10px;">📋 Recent Movements</button>
                            </div>
                            <div id="movementZoneMeta" class="movement-zone-meta"></div>
                            <div id="zoneOverviewTable" style="display: none; margin-top: 20px; background: rgba(15, 23, 42, 0.6); border-radius: 12px; padding: 16px; border: 2px solid rgba(245, 158, 11, 0.3);"></div>
                            <div id="recentMovementsTable" style="display: none; margin-top: 20px; background: rgba(15, 23, 42, 0.6); border-radius: 12px; padding: 16px; border: 2px solid rgba(245, 158, 11, 0.3);"></div>
                            <div id="movementPalletList" class="movement-pallet-list">
                                <div style="color:#94a3b8;">Select a zone to view pallets.</div>
                            </div>
                        </div>
                    </div>
                    <div class="movement-column movement-column-form">
                        <div class="movement-section">
                            <h3>Initiate Move</h3>
                            <form id="movementForm" onsubmit="event.preventDefault(); submitMovementForm();">
                                <div class="movement-form-grid">
                                    <div>
                                        <label for="movementPalletId">Pallet ID</label>
                                        <input type="text" id="movementPalletId" placeholder="FG-DET-00001" required>
                                    </div>
                                    <div>
                                        <label for="movementCurrentZone">Current Zone</label>
                                        <input type="text" id="movementCurrentZone" placeholder="Auto-detected" readonly>
                                    </div>
                                    <div>
                                        <label for="movementToZoneSelect">Move To</label>
                                        <select id="movementToZoneSelect" required></select>
                                    </div>
                                    <div>
                                        <label for="movementMovedBy">Moved By</label>
                                        <input type="text" id="movementMovedBy" placeholder="Clerk name / badge" required>
                                    </div>
                            <div id="movementQuantityWrapper">
                                <label for="movementQuantity">Quantity (optional)</label>
                                <input type="number" id="movementQuantity" min="0" step="1" placeholder="Leave blank to keep full qty">
                            </div>
                                    <div>
                                        <label for="movementOrderRef">Order Reference (optional)</label>
                                        <input type="text" id="movementOrderRef" placeholder="MT/Dispatch reference">
                                    </div>
                                    <div style="grid-column: 1 / -1;">
                                        <label for="movementReason">Reason / Notes</label>
                                        <textarea id="movementReason" rows="3" placeholder="Reason for movement, QA notes, etc."></textarea>
                                    </div>
                                    <div style="grid-column: 1 / -1;">
                                        <label for="movementOverrideReason">Override Reason (required when bypassing FIFO)</label>
                                        <textarea id="movementOverrideReason" rows="2" placeholder="Explain why FIFO is bypassed. Leave blank to enforce FIFO."></textarea>
                                    </div>
                                </div>
                        <div class="movement-form-actions">
                            <button type="button" class="btn-reset" id="toggleChildModeBtn" onclick="toggleMovementMode()">✨ Create Child Pallet</button>
                            <button type="submit" class="btn-generate" id="movementSubmitBtn">Initiate Move</button>
                            <button type="button" class="btn-reset" onclick="resetMovementForm()">Clear</button>
                        </div>
                                <div id="movementStatusMessage" class="movement-status"></div>
                            </form>
                        </div>
                    </div>
                </div>
                </div><!-- /movementMonitorView -->

                <div id="movementReceivingView" class="movement-view-content" style="display:none;">
                    <div class="receiving-layout">
                        <div class="receiving-header-bar">
                            <div class="receiving-operator">
                                <label>Operating as</label>
                                <div id="receivingOperatorDisplay" class="receiving-operator-display">—</div>
                                <small class="receiving-operator-hint">Actions use your logged-in identity; roles are enforced by Authorized Users.</small>
                            </div>
                            <button type="button" class="btn-generate" onclick="refreshReceivingView(true)">🔄 Refresh</button>
                        </div>
                        <div class="receiving-zone-tabs" role="tablist">
                            <span class="receiving-zone-tabs-label">Zone:</span>
                            <div id="receivingZoneTabs" class="receiving-zone-tabs-inner"></div>
                        </div>
                        <div id="receivingInboundsSection" class="receiving-section">
                            <h4>📥 Inbounds (awaiting receipt)</h4>
                            <div id="receivingInboundsList" class="receiving-pallet-list"></div>
                        </div>
                        <div id="receivingOutboundsSection" class="receiving-section">
                            <h4>📤 Outbounds (initiated from this zone)</h4>
                            <div id="receivingOutboundsList" class="receiving-pallet-list"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://apis.google.com/js/api.js"></script>
    <script>
        // Lazy-load print/QR libs only when needed
        const _scriptPromises = {};
        function loadScript(src) {
            if (_scriptPromises[src]) return _scriptPromises[src];
            _scriptPromises[src] = new Promise((resolve, reject) => {
                const s = document.createElement('script');
                s.src = src;
                s.onload = () => resolve();
                s.onerror = () => reject(new Error('Failed to load ' + src));
                document.body.appendChild(s);
            });
            return _scriptPromises[src];
        }
        async function ensurePrintLibs() {
            await Promise.all([
                loadScript('https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js'),
                loadScript('https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js'),
                loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js')
            ]);
        }
    </script>

    <script>
        const SERIES_PREFIX = 'BND';
        let selectedColor = 'blue';
        let _loadingOverlayRef = 0;
        function showRetifluxLoadingOverlay() {
            _loadingOverlayRef++;
            const el = document.getElementById('retifluxLoadingOverlay');
            if (el) { el.classList.add('visible'); el.setAttribute('aria-hidden', 'false'); }
        }
        function hideRetifluxLoadingOverlay() {
            _loadingOverlayRef = Math.max(0, _loadingOverlayRef - 1);
            if (_loadingOverlayRef > 0) return;
            const el = document.getElementById('retifluxLoadingOverlay');
            if (el) { el.classList.remove('visible'); el.setAttribute('aria-hidden', 'true'); }
        }
        function withLoadingOverlay(fn, minMs) {
            showRetifluxLoadingOverlay();
            const start = Date.now();
            return Promise.resolve(typeof fn === 'function' ? fn() : fn).then((r) => {
                const elapsed = Date.now() - start;
                const wait = minMs ? Math.max(0, minMs - elapsed) : 0;
                return wait > 0 ? new Promise(r => setTimeout(r, wait)) : r;
            }).then((r) => { hideRetifluxLoadingOverlay(); return r; }).catch((e) => { hideRetifluxLoadingOverlay(); throw e; });
        }
        let currentSerial = 1;
        let movementPanelInitialized = false;
        let movementZones = [];
        let movementLastPallets = [];
        let movementSelectedPallet = null;
        
        // PERFORMANCE OPTIMIZATION: Request caching system
        const requestCache = new Map();
        const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes cache
        
        function getCachedRequest(key, ttlMs) {
            const cached = requestCache.get(key);
            if (!cached) return null;
            const ttl = ttlMs != null ? ttlMs : CACHE_DURATION;
            if (Date.now() - cached.timestamp < ttl) return cached.data;
            requestCache.delete(key);
            return null;
        }
        
        function setCachedRequest(key, data) {
            requestCache.set(key, {
                data: data,
                timestamp: Date.now()
            });
        }
        
        function clearCache(pattern = null) {
            if (pattern) {
                // Clear specific pattern
                for (const key of requestCache.keys()) {
                    if (key.includes(pattern)) {
                        requestCache.delete(key);
                    }
                }
            } else {
                // Clear all cache
                requestCache.clear();
            }
        }
        
        // PERFORMANCE OPTIMIZATION: Elegant toast notification system
        function showToast(message, type = 'info', duration = 4000) {
            // Remove existing toasts
            const existingToasts = document.querySelectorAll('.toast-notification');
            existingToasts.forEach(toast => toast.remove());
            
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.setAttribute('role', 'alert');
            
            const icons = {
                success: '✅',
                error: '❌',
                warning: '⚠️',
                info: 'ℹ️'
            };
            
            const colors = {
                success: { bg: 'rgba(34, 197, 94, 0.95)', border: '#22c55e', text: '#ffffff' },
                error: { bg: 'rgba(239, 68, 68, 0.95)', border: '#ef4444', text: '#ffffff' },
                warning: { bg: 'rgba(245, 158, 11, 0.95)', border: '#f59e0b', text: '#0f172a' },
                info: { bg: 'rgba(59, 130, 246, 0.95)', border: '#3b82f6', text: '#ffffff' }
            };
            
            const style = colors[type] || colors.info;
            
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${style.bg};
                color: ${style.text};
                padding: 16px 24px;
                border-radius: 12px;
                border: 2px solid ${style.border};
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), 0 4px 16px rgba(0, 0, 0, 0.2);
                z-index: 10000;
                font-family: 'Cascadia Mono', monospace;
                font-size: 14px;
                font-weight: 600;
                max-width: 400px;
                animation: slideInRight 0.3s ease-out;
                backdrop-filter: blur(10px);
                display: flex;
                align-items: center;
                gap: 12px;
            `;
            
            toast.innerHTML = `
                <span style="font-size: 20px;">${icons[type] || icons.info}</span>
                <span style="flex: 1;">${escapeHtml(message)}</span>
                <button onclick="this.parentElement.remove()" style="background: transparent; border: none; color: ${style.text}; cursor: pointer; font-size: 18px; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; opacity: 0.8; transition: opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">×</button>
            `;
            
            document.body.appendChild(toast);
            
            // Auto-remove after duration
            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => toast.remove(), 300);
            }, duration);
            
            // Add CSS animations if not already added
            if (!document.getElementById('toast-animations')) {
                const styleSheet = document.createElement('style');
                styleSheet.id = 'toast-animations';
                styleSheet.textContent = `
                    @keyframes slideInRight {
                        from {
                            transform: translateX(100%);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(0);
                            opacity: 1;
                        }
                    }
                    @keyframes slideOutRight {
                        from {
                            transform: translateX(0);
                            opacity: 1;
                        }
                        to {
                            transform: translateX(100%);
                            opacity: 0;
                        }
                    }
                `;
                document.head.appendChild(styleSheet);
            }
        }
        
        // HARDCODED: GitHub Pages URL - Update this with your actual GitHub Pages URL
        const DEFAULT_SCAN_BASE_URL = 'https://nexgridcoredatalabs.github.io/Nexers-Banding-Tickets/bandingtickets.html';
        
        // Load saved scan URL or use hardcoded default
        let SCAN_BASE_URL = localStorage.getItem('scanBaseUrl') || DEFAULT_SCAN_BASE_URL;
        
        // Auto-detect the current page URL if no saved URL exists
        if (!localStorage.getItem('scanBaseUrl')) {
            const { protocol, origin, pathname, hostname } = window.location;
            
            // If accessing via file:// protocol, use default URL or prompt user
            if (protocol === 'file:') {
                // Use default URL so QR codes still generate (user can change in config)
                SCAN_BASE_URL = DEFAULT_SCAN_BASE_URL;
                localStorage.setItem('scanBaseUrl', SCAN_BASE_URL);
            } else if (hostname === 'localhost' || hostname === '127.0.0.1') {
                SCAN_BASE_URL = `${origin}${pathname}`;
                localStorage.setItem('scanBaseUrl', SCAN_BASE_URL);
            } else {
                // Web server (GitHub Pages, etc.) - use current URL
                SCAN_BASE_URL = `${origin}${pathname}`;
                localStorage.setItem('scanBaseUrl', SCAN_BASE_URL);
            }
        }
        
        // Load saved config into input field
        if (document.getElementById('scanBaseUrl')) {
            document.getElementById('scanBaseUrl').value = SCAN_BASE_URL;
        }
        
        function saveScanUrlConfig() {
            const url = document.getElementById('scanBaseUrl').value.trim();
            if (url) {
                // Basic validation
                if (!url.startsWith('http://') && !url.startsWith('https://')) {
                    showToast('URL must start with http:// or https://', 'error');
                    return;
                }
                if (url.includes('localhost') || url.includes('127.0.0.1')) {
                    if (!confirm('Warning: Using localhost will not work when scanning from phones. Continue anyway?')) {
                        return;
                    }
                }
                SCAN_BASE_URL = url;
                localStorage.setItem('scanBaseUrl', url);
                showToast('QR URL saved! Regenerate tickets for the new URL to take effect.', 'success');
            } else {
                showToast('Please enter a URL', 'warning');
            }
        }

        // Geofence - BIDCO Africa General Kago Rd, Thika, Kenya (hardcoded)
        var GEOFENCE = {
            lat: -1.049636,
            lng: 37.085402,
            radiusMeters: 200,
            maxAccuracyMeters: 50
        };
        // Bypass: add ?geofence=bypass&t=BIDCO_BYPASS to URL when away from facility
        var GEOFENCE_BYPASS_TOKEN = 'BIDCO_BYPASS';

        function haversineDistanceMeters(lat1, lng1, lat2, lng2) {
            var R = 6371000;
            var dLat = (lat2 - lat1) * Math.PI / 180;
            var dLng = (lng2 - lng1) * Math.PI / 180;
            var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLng / 2) * Math.sin(dLng / 2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        function checkGeofenceAccess() {
            return new Promise(function(resolve) {
                if (!navigator.geolocation) {
                    resolve({ ok: false, reason: 'Geolocation not supported' });
                    return;
                }
                navigator.geolocation.getCurrentPosition(
                    function(pos) {
                        var accuracy = pos.coords.accuracy;
                        if (accuracy > GEOFENCE.maxAccuracyMeters) {
                            resolve({ ok: false, reason: 'GPS accuracy too low', accuracy: accuracy, required: GEOFENCE.maxAccuracyMeters });
                            return;
                        }
                        var dist = haversineDistanceMeters(
                            GEOFENCE.lat, GEOFENCE.lng,
                            pos.coords.latitude, pos.coords.longitude
                        );
                        if (dist > GEOFENCE.radiusMeters) {
                            resolve({ ok: false, reason: 'Outside allowed area', distance: Math.round(dist), limit: GEOFENCE.radiusMeters });
                            return;
                        }
                        resolve({ ok: true, accuracy: Math.round(accuracy), distance: Math.round(dist) });
                    },
                    function(err) {
                        var msg = err.code === 1 ? 'Location permission denied' : (err.message || 'Could not get location');
                        resolve({ ok: false, reason: msg });
                    },
                    { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
                );
            });
        }

        var GEOFENCE_DENIED_MESSAGES = [
            'Looks like you\'re not quite where you need to be. When you\'re ready, come find us — we\'ll be waiting.',
            'Our GPS sensors are picky. They only wave you through when you\'re in the right spot. Try again when you\'ve arrived.',
            'Access denied — but don\'t take it personally. Even the best of us have been told to come back later.',
            'You\'re in the wrong neighborhood for this party. Swing by the right place and we\'ll roll out the welcome mat.',
            'The system says no for now. Location says you\'re not there yet. When you are, give it another shot.',
            'Oops — we can\'t verify where you are. Head to the right place, enable location, and try again.',
            'Almost there isn\'t close enough. Get to the spot, and we\'ll unlock the gate.',
            'Our virtual bouncer is strict. Show up at the right location and you\'re in.',
            'Location check failed. No worries — find the right spot, hit Try Again, and we\'ll sort it out.',
            'We couldn\'t place you. Make sure location\'s on, get where you need to be, and try again.'
        ];

        function showGeofenceDenied(result) {
            var idx = 1;
            function nextMessage() {
                var msg = GEOFENCE_DENIED_MESSAGES[idx % GEOFENCE_DENIED_MESSAGES.length];
                var el = document.getElementById('geofenceMsgRotate');
                if (el) {
                    el.style.opacity = '0';
                    setTimeout(function() {
                        if (el) { el.textContent = msg; el.style.opacity = '1'; }
                    }, 200);
                }
                idx++;
            }
            document.body.innerHTML = '<div style="display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, sans-serif;">' +
                '<div style="text-align: center; padding: 48px 40px; background: rgba(15, 23, 42, 0.95); border-radius: 16px; border: 2px solid rgba(239, 68, 68, 0.5); max-width: 440px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);">' +
                '<div style="font-size: 48px; margin-bottom: 16px;">🔒</div>' +
                '<h1 style="color: #fca5a5; margin-bottom: 16px; font-size: 22px; font-weight: 700;">Access Denied</h1>' +
                '<p id="geofenceMsgRotate" style="color: #cbd5e1; font-size: 15px; line-height: 1.7; min-height: 4.5em; transition: opacity 0.4s ease;">' + GEOFENCE_DENIED_MESSAGES[0] + '</p>' +
                '<p style="color: #94a3b8; font-size: 13px; margin-top: 20px;">💡 Ensure location services are enabled for this browser.</p>' +
                '<button onclick="window.location.reload()" style="margin-top: 28px; padding: 12px 24px; background: linear-gradient(135deg, #4f46e5, #6366f1); color: #fff; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 14px rgba(79, 70, 229, 0.4);">Try Again</button>' +
                '<div style="margin-top: 30px; padding-top: 18px; border-top: 1px solid rgba(245,158,11,0.2); text-align: center; font-size: 12px; color: #64748b; letter-spacing: 0.5px; font-weight: 500;">' +
                '<strong style="color:#fbbf24;font-weight:700;">RetiFlux™</strong> Powered by <strong style="color:#818cf8;font-weight:700;">NexGridCore DataLabs</strong></div></div></div>';
            setInterval(nextMessage, 15000);
        }

        const urlParams = new URLSearchParams(window.location.search);
        const currentMode = urlParams.get('mode');
        const initialSerialParam = urlParams.get('serial');
        const urlColorParam = urlParams.get('color');

        // When bypass is active, ensure links preserve bypass params so navigation stays in bypass mode
        if (urlParams.get('geofence') === 'bypass' && urlParams.get('t') === GEOFENCE_BYPASS_TOKEN) {
            var bypassQ = 'geofence=bypass&t=BIDCO_BYPASS';
            document.querySelectorAll('a[href*="index.html"]').forEach(function(a) {
                var h = a.getAttribute('href') || '';
                if (h.indexOf('geofence=bypass') >= 0) return;
                var sep = h.indexOf('?') >= 0 ? '&' : '?';
                a.href = h + sep + bypassQ;
            });
            document.querySelectorAll('a[href*="bandingtickets.html"]').forEach(function(a) {
                var h = a.getAttribute('href') || '';
                if (h.indexOf('geofence=bypass') >= 0) return;
                var sep = h.indexOf('?') >= 0 ? '&' : '?';
                a.href = h + sep + bypassQ;
            });
        }

        if ((currentMode === 'edit' || currentMode === 'fill') && urlParams.get('geofence') === 'bypass' && urlParams.get('t') === 'BIDCO_BYPASS') {
            document.body.classList.add('fill-mode-active');
        }

        const savedSerial = localStorage.getItem('bandingSerial');
        if (savedSerial) {
            currentSerial = parseInt(savedSerial, 10);
        }
        updateSerialDisplay();

        const loginFormEl = document.getElementById('loginForm');
        if (loginFormEl) {
            loginFormEl.addEventListener('submit', handleLoginSubmit);
        }

        const loginResetButton = document.getElementById('loginResetAccess');
        if (loginResetButton) {
            loginResetButton.addEventListener('click', () => {
                clearLoggedInUserSession();
                localStorage.removeItem(GENERATOR_ACCESS_TOKEN);
                localStorage.removeItem(USER_SESSION_KEY);
                alert('Access has been reset. Please reload the page and authenticate again.');
                showLoginCard();
            });
        }

        const logoutButton = document.getElementById('logoutUserButton');
        if (logoutButton) {
            logoutButton.addEventListener('click', () => {
                clearLoggedInUserSession();
                if (currentMode === 'view') {
                    // Stay on view page, just hide movement section
                    updateLoggedInUserBanner();
                } else {
                    showLoginCard();
                }
            });
        }

        function escapeHtml(value) {
            if (value === null || value === undefined) {
                return '';
            }
            return String(value).replace(/[&<>"']/g, (char) => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[char]));
        }

        /** Run fn when document is fully loaded. Handles case where load already fired. */
        function whenLoaded(fn) {
            if (document.readyState === 'complete') {
                setTimeout(fn, 0);
            } else {
                window.addEventListener('load', fn, { once: true });
            }
        }

        document.querySelectorAll('.color-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.color-option').forEach(opt => 
                    opt.classList.remove('selected'));
                this.classList.add('selected');
                selectedColor = this.dataset.color;
                updateSerialDisplay();
            });
        });

        // SECURITY FIX: Load from config.js (fallback to defaults for backward compatibility)
        const CONFIG = window.BANDFLOW_CONFIG || {};
        const DEFAULT_GOOGLE_SHEET_ID = CONFIG.GOOGLE_SHEET_ID || '1QXkL2K5hAfyvHKQ6mCFckmIu73lLw_XyENKSuqyFQgE';
        const DEFAULT_GOOGLE_API_KEY = CONFIG.GOOGLE_API_KEY || ''; // SECURITY: Never hardcode API keys!
        const DEFAULT_GOOGLE_APPS_SCRIPT_URL = CONFIG.GOOGLE_APPS_SCRIPT_URL || 'https://script.google.com/macros/s/AKfycbxVjIcc8M5_5bsqcnsyyE0SBWYa7AUVU3ws4bl70loqacX9GsS_ZvVifF3kG9GcGcmfmg/exec';
        
        const USER_SESSION_KEY = 'bandingUserSession';
        let loggedInUser = getStoredUser();
        
        function getStoredUser() {
            try {
                return JSON.parse(localStorage.getItem(USER_SESSION_KEY)) || null;
            } catch (error) {
                return null;
            }
        }
        
        function isUserLoggedIn() {
            return !!(loggedInUser && loggedInUser.id);
        }
        
        function setLoggedInUser(user, persist) {
            loggedInUser = user;
            if (persist !== false) {
                localStorage.setItem(USER_SESSION_KEY, JSON.stringify(user));
            }
            updateLoggedInUserBanner();
        }
        
        function clearLoggedInUserSession() {
            loggedInUser = null;
            localStorage.removeItem(USER_SESSION_KEY);
            updateLoggedInUserBanner();
        }
        
        function updateLoggedInUserBanner() {
            const banner = document.getElementById('loggedInUserBanner');
            const text = document.getElementById('loggedInUserText');
            if (!banner || !text) return;
            if (isUserLoggedIn()) {
                banner.style.display = 'flex';
                text.textContent = `Signed in as ${loggedInUser.name || loggedInUser.id}`;
            } else {
                banner.style.display = 'none';
                text.textContent = '';
            }
            const movementMovedByInput = document.getElementById('movementMovedBy');
            if (movementMovedByInput && isUserLoggedIn() && !movementMovedByInput.value) {
                movementMovedByInput.value = loggedInUser.name || loggedInUser.id || '';
            }
            if (typeof updateReceivingOperatorDisplay === 'function') updateReceivingOperatorDisplay();

            // In view and edit/fill modes, movement section is gated — only show to logged-in users.
            if (currentMode === 'view' || currentMode === 'edit' || currentMode === 'fill') {
                const movementSection = document.getElementById('movementSection');
                const loginBtn = document.getElementById('viewModeLoginBtn');
                if (movementSection) {
                    movementSection.style.display = isUserLoggedIn() ? 'block' : 'none';
                }
                if (loginBtn) {
                    loginBtn.style.display = isUserLoggedIn() ? 'none' : '';
                }
            }
        }

        updateLoggedInUserBanner();
        
        // Load configuration: Use hardcoded defaults, or localStorage override, or user input
        let GOOGLE_SHEET_ID = DEFAULT_GOOGLE_SHEET_ID || localStorage.getItem('googleSheetId') || '';
        let GOOGLE_API_KEY = DEFAULT_GOOGLE_API_KEY || localStorage.getItem('googleApiKey') || '';
        let GOOGLE_APPS_SCRIPT_URL = DEFAULT_GOOGLE_APPS_SCRIPT_URL || localStorage.getItem('googleAppsScriptUrl') || '';
        
        // Auto-save hardcoded values to localStorage if they exist
        if (DEFAULT_GOOGLE_SHEET_ID && DEFAULT_GOOGLE_API_KEY) {
            localStorage.setItem('googleSheetId', DEFAULT_GOOGLE_SHEET_ID);
            localStorage.setItem('googleApiKey', DEFAULT_GOOGLE_API_KEY);
            GOOGLE_SHEET_ID = DEFAULT_GOOGLE_SHEET_ID;
            GOOGLE_API_KEY = DEFAULT_GOOGLE_API_KEY;
        }
        if (DEFAULT_GOOGLE_APPS_SCRIPT_URL) {
            localStorage.setItem('googleAppsScriptUrl', DEFAULT_GOOGLE_APPS_SCRIPT_URL);
            GOOGLE_APPS_SCRIPT_URL = DEFAULT_GOOGLE_APPS_SCRIPT_URL;
        }
        
        const API_TIMEOUT_MS = 30000;
        
        // Shared flag for authorized users dropdown (must be declared before mode=movement/bincards blocks)
        let authorizedUsersLoaded = false;
        
        // SECURITY: Config section password protection
        const CONFIG_UNLOCK_TOKEN = 'config_section_unlocked';
        let configValuesVisible = false;
        
        function unlockConfigSection() {
            const password = prompt('🔐 Advanced Configuration Access\n\nEnter password to view/edit configuration:');
            if (password === GENERATOR_PASSWORD) {
                localStorage.setItem(CONFIG_UNLOCK_TOKEN, 'true');
                showConfigSection();
            } else if (password !== null) {
                alert('❌ Incorrect password. Access denied.');
            }
        }
        
        function showConfigSection() {
            const configSection = document.getElementById('configSection');
            const unlockBtn = document.getElementById('unlockConfigBtn');
            const lockBtn = document.getElementById('lockConfigBtn');
            if (configSection && unlockBtn) {
                configSection.style.display = 'block';
                unlockBtn.style.display = 'none';
                if (lockBtn) {
                    lockBtn.style.display = 'block';
                }
                // Load config values (masked)
                loadConfigValues();
            }
        }
        
        function lockConfigSection() {
            const configSection = document.getElementById('configSection');
            const unlockBtn = document.getElementById('unlockConfigBtn');
            const lockBtn = document.getElementById('lockConfigBtn');
            
            if (configSection && unlockBtn) {
                // Hide config section
                configSection.style.display = 'none';
                unlockBtn.style.display = 'block';
                if (lockBtn) {
                    lockBtn.style.display = 'none';
                }
                // Clear unlock token (force password on next unlock)
                localStorage.removeItem(CONFIG_UNLOCK_TOKEN);
                // Reset visibility state
                configValuesVisible = false;
                // Clear any visible values
                if (document.getElementById('googleSheetId')) {
                    document.getElementById('googleSheetId').value = '';
                    document.getElementById('googleSheetId').readOnly = true;
                }
                if (document.getElementById('googleApiKey')) {
                    document.getElementById('googleApiKey').value = '';
                    document.getElementById('googleApiKey').readOnly = true;
                }
            }
        }
        
        function loadConfigValues() {
            // Load values but mask them initially
            if (document.getElementById('googleSheetId')) {
                const sheetIdInput = document.getElementById('googleSheetId');
                const sheetId = GOOGLE_SHEET_ID || '';
                sheetIdInput.dataset.realValue = sheetId; // Store real value
                sheetIdInput.value = configValuesVisible ? sheetId : '•'.repeat(Math.max(sheetId.length, 20));
                sheetIdInput.readOnly = !configValuesVisible;
            }
            if (document.getElementById('googleApiKey')) {
                const apiKeyInput = document.getElementById('googleApiKey');
                const apiKey = GOOGLE_API_KEY || '';
                apiKeyInput.dataset.realValue = apiKey; // Store real value
                apiKeyInput.value = configValuesVisible ? apiKey : '•'.repeat(Math.max(apiKey.length, 20));
                apiKeyInput.readOnly = !configValuesVisible;
            }
        }
        
        function toggleConfigVisibility() {
            configValuesVisible = !configValuesVisible;
            const sheetIdInput = document.getElementById('googleSheetId');
            const apiKeyInput = document.getElementById('googleApiKey');
            
            
            if (sheetIdInput) {
                const realValue = GOOGLE_SHEET_ID || '';
                // Store real value in data attribute if not already stored
                if (!sheetIdInput.dataset.realValue) {
                    sheetIdInput.dataset.realValue = realValue;
                }
                sheetIdInput.value = configValuesVisible ? sheetIdInput.dataset.realValue : '•'.repeat(Math.max(sheetIdInput.dataset.realValue.length, 20));
                sheetIdInput.readOnly = !configValuesVisible;
            }
            
            if (apiKeyInput) {
                const realValue = GOOGLE_API_KEY || '';
                // Store real value in data attribute if not already stored
                if (!apiKeyInput.dataset.realValue) {
                    apiKeyInput.dataset.realValue = realValue;
                }
                apiKeyInput.value = configValuesVisible ? apiKeyInput.dataset.realValue : '•'.repeat(Math.max(apiKeyInput.dataset.realValue.length, 20));
                apiKeyInput.readOnly = !configValuesVisible;
            }
        }
        
        // Check if config section was previously unlocked
        if (localStorage.getItem(CONFIG_UNLOCK_TOKEN) === 'true') {
            showConfigSection();
        }
        
        // Load saved config into input fields (for display/override) - only if unlocked
        if (document.getElementById('googleSheetId') && localStorage.getItem(CONFIG_UNLOCK_TOKEN) === 'true') {
            loadConfigValues();
        }
        if (document.getElementById('googleApiKey') && localStorage.getItem(CONFIG_UNLOCK_TOKEN) === 'true') {
            // Already handled in loadConfigValues()
        }
        
        function saveGoogleConfig() {
            // Require password to save config
            const password = prompt('🔐 Save Configuration - Password Required\n\nEnter password to save configuration:');
            if (password !== GENERATOR_PASSWORD) {
                if (password !== null) {
                    alert('❌ Incorrect password. Configuration not saved.');
                }
                return;
            }
            
            const sheetIdInput = document.getElementById('googleSheetId');
            const apiKeyInput = document.getElementById('googleApiKey');
            
            // Get real values from data attributes or input
            let sheetId = sheetIdInput ? (sheetIdInput.dataset.realValue || sheetIdInput.value.trim().replace(/•/g, '')) : '';
            let apiKey = apiKeyInput ? (apiKeyInput.dataset.realValue || apiKeyInput.value.trim().replace(/•/g, '')) : '';
            
            // Fallback to existing values if empty
            if (!sheetId || sheetId.match(/^•+$/)) {
                sheetId = GOOGLE_SHEET_ID || '';
            }
            if (!apiKey || apiKey.match(/^•+$/)) {
                apiKey = GOOGLE_API_KEY || '';
            }
            
            if (sheetId && apiKey) {
                GOOGLE_SHEET_ID = sheetId;
                GOOGLE_API_KEY = apiKey;
                localStorage.setItem('googleSheetId', sheetId);
                localStorage.setItem('googleApiKey', apiKey);
                alert('✅ Configuration saved successfully!');
                // Reload to show updated values
                loadConfigValues();
            } else {
                alert('❌ Please enter both Sheet ID and API Key');
            }
        }
        
        // Generator access control - only accessible from this PC
        const GENERATOR_ACCESS_TOKEN = 'generator_access_granted';
        const GENERATOR_PASSWORD = CONFIG.GENERATOR_PASSWORD || 'NEXGRID2025'; // SECURITY: Load from config.js
        
        function checkGeneratorAccess() {
            // Always prompt — no localStorage caching
            const password = prompt('🔐 Generator Access Required\n\nEnter password to access ticket generator:');
            if (password === GENERATOR_PASSWORD) {
                return true;
            } else if (password !== null) {
                alert('❌ Incorrect password. Access denied.');
            }
            return false;
        }
        
        const SPLASH_SESSION_KEY = 'retifluxSplashShown';
        function shouldShowSplash() {
            try {
                return !sessionStorage.getItem(SPLASH_SESSION_KEY);
            } catch (e) { return false; }
        }
        function showSplashUI() {
            const el = document.getElementById('retifluxSplash');
            if (el) { el.style.display = 'flex'; el.setAttribute('aria-hidden', 'false'); }
        }
        function hideSplashUI() {
            const el = document.getElementById('retifluxSplash');
            if (!el) return;
            el.classList.add('fade-out');
            setTimeout(function() {
                el.style.display = 'none';
                el.classList.remove('fade-out');
                el.setAttribute('aria-hidden', 'true');
            }, 120);
        }
        async function runViewOrEditInit(serial) {
            const showSplash = (currentMode === 'edit' || currentMode === 'fill') || shouldShowSplash();
            if (showSplash) {
                try { sessionStorage.setItem(SPLASH_SESSION_KEY, '1'); } catch (e) {}
                showSplashUI();
            }
            const initPromise = currentMode === 'view' ? initViewMode(serial) : initFillMode(serial);
            const minDelay = showSplash ? new Promise(function(r) { setTimeout(r, 300); }) : Promise.resolve();
            try {
                await Promise.all([initPromise, minDelay]);
            } catch (e) {
                console.error('init error:', e);
            } finally {
                if (showSplash) hideSplashUI();
            }
        }

        // Protect main generator page - only allow access via QR codes (mode=view or mode=fill/edit) OR with password
        if (!currentMode) {
            // No mode parameter means direct access to generator - require password
            if (!checkGeneratorAccess()) {
                document.body.innerHTML = `
                    <div style="display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #0f172a 0%, #1e3a5f 50%, #0f172a 100%); font-family: 'Cascadia Mono', Consolas, monospace;">
                        <div style="text-align: center; padding: 48px 36px; background: rgba(15, 23, 42, 0.9); border: 2px solid rgba(245, 158, 11, 0.35); border-radius: 20px; box-shadow: 0 16px 48px rgba(0,0,0,0.5); max-width: 480px; width: 90%;">
                            <div style="font-size: 48px; margin-bottom: 16px;">⚠️</div>
                            <h1 style="color: #fca5a5; margin-bottom: 16px; font-size: 22px; font-weight: 700; letter-spacing: 0.5px;">Access Denied</h1>
                            <p style="color: #94a3b8; font-size: 15px; line-height: 1.7;">
                                Generator access is restricted to authorized devices only. Please scan a ticket QR code to view or edit ticket details.
                            </p>
                            <a href="index.html" style="display: inline-block; margin-top: 28px; padding: 12px 28px; background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #0f172a; font-weight: 700; border-radius: 10px; text-decoration: none; font-size: 14px;">← Back to Home</a>
                            <div class="app-footer-bar"><strong class="footer-brand">RetiFlux™</strong> Powered by <strong class="footer-lab">NexGridCore DataLabs</strong></div>
                        </div>
                    </div>
                `;
            }
            // If access granted, continue with normal page load (generator will show)
        } else if (currentMode === 'movement') {
            // Stock Movement Control — clean movement-only view (geofence required)
            (function() {
                var params = new URLSearchParams(window.location.search);
                if (params.get('geofence') === 'bypass' && params.get('t') === GEOFENCE_BYPASS_TOKEN) {
                    runMovementInit();
                    return;
                }
                var overlay = document.createElement('div');
                overlay.id = 'geofenceOverlay';
                overlay.style.cssText = 'position:fixed;inset:0;background:linear-gradient(135deg,#0f172a 0%,#1e3a5f 100%);display:flex;align-items:center;justify-content:center;z-index:99999;font-family:-apple-system,BlinkMacSystemFont,sans-serif;';
                overlay.innerHTML = '<div style="text-align:center;padding:40px;"><div style="width:64px;height:64px;margin:0 auto 20px;position:relative;"><div style="position:absolute;inset:-16px;border-radius:50%;border:2px solid rgba(251,191,36,0.5);box-shadow:0 0 16px rgba(251,191,36,0.25);animation:splashPulse 1.4s ease-out 0.2s infinite;"></div><img src="favicon.png" alt="" width="64" height="64" style="position:relative;z-index:2;object-fit:contain;"></div><p style="color:#fbbf24;font-size:18px;font-weight:600;">Verifying location...</p><p style="color:#94a3b8;font-size:14px;margin-top:12px;">GPS accuracy is required. Please allow location access.</p></div>';
                document.body.appendChild(overlay);
                checkGeofenceAccess().then(function(result) {
                    overlay.remove();
                    if (!result.ok) {
                        showGeofenceDenied(result);
                        return;
                    }
                    runMovementInit();
                });

                function runMovementInit() {
                    clearLoggedInUserSession(); // No persisted session: require fresh login every visit

                    const movementTab = urlParams.get('tab') || 'monitor'; // 'monitor' or 'receiving'

                    // Apply clean movement-only layout (fill-mode-active ensures fillContainer shows like edit mode)
                    document.body.classList.add('fill-mode-active', 'movement-mode-active');
                    var fc = document.getElementById('fillContainer');
                    if (fc) fc.classList.add('visible');
                    // Force visibility: inline display:none can override CSS in some browsers; remove it so movementSection and panel show after login
                    var ms = document.getElementById('movementSection');
                    if (ms) ms.style.removeProperty('display');

                    // Update tab label in login overlay
                const mlcTabLabel = document.getElementById('mlcTabLabel');
                if (mlcTabLabel) {
                    mlcTabLabel.textContent = movementTab === 'receiving' ? 'Zone Receiving' : 'Zone Monitor';
                }

                // Open movement panel and switch to the right tab after login
                function openMovementAtTab() {
                    const panel = document.getElementById('movementPanel');
                    const toggleBtn = document.getElementById('movementToggleBtn');
                    const section = document.getElementById('movementSection');
                    if (section) section.style.display = 'block';
                    if (panel) {
                        panel.classList.add('active');
                        panel.style.display = 'block';
                    }
                    if (toggleBtn) toggleBtn.textContent = '🚫 Close Stock Movement Control';
                    ensureMovementPanelLoaded().then(function() {
                        switchMovementView(movementTab);
                    });
                }

                // Prevent native form submit immediately (before async load completes) to avoid page reload
                (function() {
                    var f = document.getElementById('movementLoginForm');
                    if (f) f.addEventListener('submit', function(e) { e.preventDefault(); }, { capture: true });
                })();

                // Handle movement login form submission
                function initMovementLoginForm(users) {
                    populateAuthorizedUserSelects(users);
                    const form = document.getElementById('movementLoginForm');
                    if (!form) return;
                    form.addEventListener('submit', async function(e) {
                        e.preventDefault();
                        const statusEl = document.getElementById('movementLoginStatus');
                        const userId = document.getElementById('movementLoginUser').value;
                        const passcode = document.getElementById('movementLoginPasscode').value;
                        if (!userId || !passcode) {
                            if (statusEl) { statusEl.textContent = '⚠️ Please select a user and enter your passcode.'; statusEl.className = 'login-status error'; }
                            return;
                        }
                        const submitBtn = document.getElementById('movementLoginSubmit');
                        if (submitBtn) submitBtn.disabled = true;
                        if (statusEl) { statusEl.textContent = '⏳ Verifying...'; statusEl.className = 'login-status'; }
                        try {
                            const result = await verifyUserLogin(userId, passcode, { persist: false });
                            if (result.success) {
                                if (statusEl) { statusEl.textContent = '✅ Access granted.'; statusEl.className = 'login-status success'; }
                                setTimeout(function() {
                                    const overlay = document.getElementById('movementLoginOverlay');
                                    if (overlay) overlay.style.cssText = 'display:none!important';
                                    openMovementAtTab();
                                }, 600);
                            } else {
                                if (statusEl) { statusEl.textContent = '❌ ' + (result.message || 'Incorrect passcode.'); statusEl.className = 'login-status error'; }
                                if (submitBtn) submitBtn.disabled = false;
                            }
                        } catch (err) {
                            if (statusEl) { statusEl.textContent = '❌ Login failed. Please try again.'; statusEl.className = 'login-status error'; }
                            if (submitBtn) submitBtn.disabled = false;
                        }
                    });
                }

                (async function() {
                    // Always load users so the dropdown is ready regardless of session state
                    try {
                        const { users } = await loadAuthorizedUsers();
                        initMovementLoginForm(users);
                        authorizedUsersLoaded = true;
                    } catch (e) {
                        initMovementLoginForm([]);
                    }
                })();
                }
            })();
        } else if (currentMode === 'bincards') {
            // ── Bin Cards — shift stock reconciliation ── (geofence required)
            (function() {
                var params = new URLSearchParams(window.location.search);
                if (params.get('geofence') === 'bypass' && params.get('t') === GEOFENCE_BYPASS_TOKEN) {
                    runBincardsInit();
                    return;
                }
                var overlay = document.createElement('div');
                overlay.id = 'geofenceOverlay';
                overlay.style.cssText = 'position:fixed;inset:0;background:linear-gradient(135deg,#0f172a 0%,#1e3a5f 100%);display:flex;align-items:center;justify-content:center;z-index:99999;font-family:-apple-system,BlinkMacSystemFont,sans-serif;';
                overlay.innerHTML = '<div style="text-align:center;padding:40px;"><div style="width:64px;height:64px;margin:0 auto 20px;position:relative;"><div style="position:absolute;inset:-16px;border-radius:50%;border:2px solid rgba(251,191,36,0.5);box-shadow:0 0 16px rgba(251,191,36,0.25);animation:splashPulse 1.4s ease-out 0.2s infinite;"></div><img src="favicon.png" alt="" width="64" height="64" style="position:relative;z-index:2;object-fit:contain;"></div><p style="color:#fbbf24;font-size:18px;font-weight:600;">Verifying location...</p><p style="color:#94a3b8;font-size:14px;margin-top:12px;">GPS accuracy is required. Please allow location access.</p></div>';
                document.body.appendChild(overlay);
                checkGeofenceAccess().then(function(result) {
                    overlay.remove();
                    if (!result.ok) {
                        showGeofenceDenied(result);
                        return;
                    }
                    runBincardsInit();
                });

                function runBincardsInit() {
                    clearLoggedInUserSession(); // No persisted session: require fresh login every visit

                    document.body.classList.add('bincards-mode-active');

                    // Current shift label for login overlay
                var _h = new Date().getHours();
                var _shiftLabel = (_h >= 7 && _h < 19) ? '☀️ Day Shift (07:00–19:00)' : '🌙 Night Shift (19:00–07:00)';
                var _bcLoginShiftLabel = document.getElementById('bcLoginShiftLabel');
                if (_bcLoginShiftLabel) _bcLoginShiftLabel.textContent = _shiftLabel;

                // State
                var bcLoggedInUser = null;
                var bcCurrentShift = null;
                var bcAllCards     = [];   // raw Zone+SKU data from server
                var bcZones        = [];   // computed zone-level groupings
                var bcActiveZone   = null; // zone currently being confirmed in modal

                // ── Shift helpers (mirror of Apps Script getBinCardShiftInfo) ──
                function getClientShiftInfo() {
                    var now = new Date();
                    var y = now.getFullYear(), m = now.getMonth(), d = now.getDate();
                    var dayStart   = new Date(y, m, d,  7, 0, 0);
                    var nightStart = new Date(y, m, d, 19, 0, 0);
                    var nextDay7   = new Date(y, m, d + 1, 7, 0, 0);
                    var prev19     = new Date(y, m, d - 1, 19, 0, 0);
                    var pad = function(n) { return String(n).padStart(2, '0'); };
                    function dateKey(dt) { return dt.getFullYear() + '-' + pad(dt.getMonth()+1) + '-' + pad(dt.getDate()); }
                    if (now >= dayStart && now < nightStart) {
                        return { shift: 'Day', shiftDateKey: dateKey(dayStart), label: '☀️ Day Shift (07:00–19:00)', shiftStart: dayStart, shiftEnd: nightStart };
                    } else if (now >= nightStart) {
                        return { shift: 'Night', shiftDateKey: dateKey(nightStart), label: '🌙 Night Shift (19:00–07:00)', shiftStart: nightStart, shiftEnd: nextDay7 };
                    } else {
                        return { shift: 'Night', shiftDateKey: dateKey(prev19), label: '🌙 Night Shift (19:00–07:00)', shiftStart: prev19, shiftEnd: dayStart };
                    }
                }

                // ── Shift selection state ──
                function getBcShiftParams() {
                    var sel = document.getElementById('bcShiftSelect');
                    if (!sel) return {};
                    var v = (sel.value || '').toString();
                    if (v === 'current') return {};
                    if (v === 'previous') {
                        var si = getClientShiftInfo();
                        var prevDate, prevShift;
                        if (si.shift === 'Day') {
                            var d = new Date(si.shiftStart);
                            d.setDate(d.getDate() - 1);
                            prevDate = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
                            prevShift = 'Night';
                        } else {
                            prevDate = (si.shiftDateKey || '').split('-')[0] ? (function(){
                                var ymd = si.shiftDateKey.split('-');
                                if (ymd.length !== 3) return '';
                                return ymd[0] + '-' + ymd[1] + '-' + ymd[2];
                            }()) : '';
                            var ds = (si.shiftDateKey || '').split('-');
                            prevShift = 'Day';
                            if (ds.length === 3) prevDate = ds[0] + '-' + ds[1] + '-' + ds[2];
                        }
                        if (si.shift === 'Night') {
                            var nd = new Date(si.shiftStart.getFullYear(), si.shiftStart.getMonth(), si.shiftStart.getDate());
                            nd.setDate(nd.getDate() - 1);
                            prevDate = nd.getFullYear() + '-' + String(nd.getMonth()+1).padStart(2,'0') + '-' + String(nd.getDate()).padStart(2,'0');
                            prevShift = 'Night';
                        }
                        return { shiftDate: prevDate || '', shift: prevShift };
                    }
                    if (v === 'custom') {
                        var cd = document.getElementById('bcCustomDate');
                        var cs = document.getElementById('bcCustomShift');
                        return { shiftDate: (cd && cd.value) || '', shift: (cs && cs.value) || 'Day' };
                    }
                    return {};
                }
                window.onBcShiftSelectChange = function() {
                    var sel = document.getElementById('bcShiftSelect');
                    var wrap = document.getElementById('bcCustomShiftWrap');
                    if (!sel || !wrap) return;
                    wrap.style.display = (sel.value === 'custom') ? 'flex' : 'none';
                    if (sel.value === 'custom') {
                        var cd = document.getElementById('bcCustomDate');
                        if (cd && !cd.value) {
                            var n = new Date();
                            cd.value = n.getFullYear() + '-' + String(n.getMonth()+1).padStart(2,'0') + '-' + String(n.getDate()).padStart(2,'0');
                        }
                    } else {
                        loadAndRenderBinCards();
                    }
                };
                window.loadBinCardsWithShift = function() { loadAndRenderBinCards(); };

                // ── Fetch bin card data from Apps Script ──
                async function fetchBinCardData() {
                    var params = getBcShiftParams();
                    var url = GOOGLE_APPS_SCRIPT_URL + '?action=getBinCardData';
                    if (params.shiftDate && params.shift) {
                        url += '&shiftDate=' + encodeURIComponent(params.shiftDate) + '&shift=' + encodeURIComponent(params.shift);
                    }
                    var resp = await fetch(url);
                    if (!resp.ok) throw new Error('HTTP ' + resp.status);
                    return await resp.json();
                }

                // ── Render the dashboard ──
                function renderBinCards(data) {
                    bcCurrentShift   = data.shiftInfo;
                    bcAllCards       = data.cards || [];
                    var confZones    = data.confirmedZones || {};

                    var badge = document.getElementById('bcShiftBadge');
                    if (badge) badge.textContent = data.shiftInfo.label;

                    var snapAt = data.snapshotAt;
                    var snapEl = document.getElementById('bcSnapshotAt');
                    if (snapEl && snapAt) {
                        var d = new Date(snapAt);
                        snapEl.textContent = 'Closing balances as at: ' + (isNaN(d.getTime()) ? snapAt : d.toLocaleString(undefined, { dateStyle: 'medium', timeStyle: 'medium' }));
                        snapEl.style.display = 'block';
                    } else if (snapEl) snapEl.style.display = 'none';

                    var pc = data.palletConsistency || {};
                    var consEl = document.getElementById('bcPalletConsistency');
                    if (consEl) {
                        if (pc.consistent) {
                            consEl.innerHTML = '✓ Pallet count reconciled: ' + (pc.totalPallets || 0) + ' total = sum across zones (traceability OK)';
                            consEl.className = 'bc-consistency-line bc-consistency-ok';
                        } else if (pc.totalPallets != null || pc.sumOfZonePallets != null) {
                            consEl.innerHTML = '⚠ Data consistency gap: ' + (pc.totalPallets || 0) + ' pallets vs ' + (pc.sumOfZonePallets || 0) + ' summed by zone — investigate';
                            consEl.className = 'bc-consistency-line bc-consistency-warn';
                        } else {
                            consEl.innerHTML = '';
                            consEl.className = 'bc-consistency-line';
                        }
                    }

                    var confirmed = data.confirmedCount || 0;
                    var total     = data.totalCards     || 0;
                    var pct = total > 0 ? Math.round((confirmed / total) * 100) : 0;
                    var fill  = document.getElementById('bcProgressFill');
                    var label = document.getElementById('bcProgressLabel');
                    if (fill)  fill.style.width = pct + '%';
                    if (label) label.textContent = confirmed + ' of ' + total + ' zone' + (total !== 1 ? 's' : '') + ' confirmed (' + pct + '%)';

                    document.getElementById('bcLoadingState').style.display = 'none';

                    var movInShift = data.movementsInShift || [];
                    var movSection = document.getElementById('bcMovementsSection');
                    var movLabel = document.getElementById('bcMovementsToggleLabel');
                    var movContainer = document.getElementById('bcMovementsTableContainer');
                    var movNote = document.getElementById('bcMovementsShiftNote');
                    if (movSection && movLabel) {
                        movSection.style.display = 'block';
                        movLabel.textContent = '📋 Movements this shift (' + movInShift.length + ')';
                        var si = data.shiftInfo || {};
                        var fmtShift = function(iso) {
                            if (!iso) return '';
                            var d = new Date(iso);
                            return isNaN(d.getTime()) ? iso : d.toLocaleString(undefined, { dateStyle: 'short', timeStyle: 'short' });
                        };
                        movNote.textContent = 'Shift: ' + (si.label || si.shift || '') + '. Window: ' + fmtShift(si.shiftStart) + ' — ' + fmtShift(si.shiftEnd) + '. Only movements initiated in this window appear in zone In/Out.';
                        if (movInShift.length > 0 && movContainer) {
                            var mRows = movInShift.map(function(m) {
                                var dt = m.movementDate ? new Date(m.movementDate) : null;
                                var dtStr = dt && !isNaN(dt.getTime()) ? dt.toLocaleString() : (m.movementDate || '—');
                                return '<tr><td>' + escapeHtml(m.palletId || '—') + '</td><td>' + escapeHtml(m.sku || '—') + '</td><td>' + escapeHtml(m.fromZone || '—') + '</td><td>' + escapeHtml(m.toZone || '—') + '</td><td style="text-align:right">' + fmt(m.quantity) + '</td><td>' + escapeHtml(m.movedBy || '—') + '</td><td style="font-size:11px">' + escapeHtml(dtStr) + '</td></tr>';
                            }).join('');
                            movContainer.innerHTML = '<table class="bc-movements-table" style="width:100%;border-collapse:collapse;font-size:12px"><thead><tr><th>Pallet</th><th>SKU</th><th>From</th><th>To</th><th>Qty</th><th>By</th><th>When</th></tr></thead><tbody>' + mRows + '</tbody></table>';
                        } else if (movContainer) {
                            movContainer.innerHTML = '<p style="color:#64748b;margin:0;font-size:13px;">No movements recorded in this shift window yet.</p>';
                        }
                    }

                    var grid = document.getElementById('bcGrid');
                    grid.innerHTML = '';

                    if (bcAllCards.length === 0) {
                        document.getElementById('bcEmptyState').style.display = 'block';
                        return;
                    }

                    // Group SKU-level cards by zone
                    var zonesMap = {}, zoneOrder = [];
                    bcAllCards.forEach(function(card) {
                        if (!zonesMap[card.zone]) { zonesMap[card.zone] = []; zoneOrder.push(card.zone); }
                        zonesMap[card.zone].push(card);
                    });

                    // Build bcZones array (zone-level state used by modal)
                    bcZones = zoneOrder.map(function(zoneName) {
                        var skus = zonesMap[zoneName].map(function(c) { return Object.assign({}, c); });
                        var zConf = confZones[zoneName] || {};
                        var totalOpening, totalIn, totalOut, totalSystem;
                        if (zConf.confirmed && (zConf.totalOpening != null || zConf.totalMovedIn != null)) {
                            totalOpening = zConf.totalOpening || 0;
                            totalIn      = zConf.totalMovedIn || 0;
                            totalOut     = zConf.totalMovedOut || 0;
                            totalSystem  = zConf.totalSystem || 0;
                        } else {
                            totalOpening = 0; totalIn = 0; totalOut = 0; totalSystem = 0;
                            skus.forEach(function(c) {
                                totalOpening += (c.openingBalance || 0);
                                totalIn      += (c.movedIn || 0);
                                totalOut     += (c.movedOut || 0);
                                totalSystem  += (c.systemClosingBalance || 0);
                            });
                        }
                        var zd = {
                            zone: zoneName, skus: skus,
                            totalOpening: totalOpening, totalIn: totalIn, totalOut: totalOut, totalSystem: totalSystem,
                            confirmed: !!(zConf.confirmed), confirmedBy: zConf.confirmedBy || '', confirmedAt: zConf.confirmedAt || '',
                            totalPhysical: zConf.totalPhysical, zoneVariance: zConf.zoneVariance,
                            varianceSummary: ''
                        };
                        if (zConf.varianceDetails && zConf.varianceDetails.length) {
                            var vdMap = {};
                            zConf.varianceDetails.forEach(function(d) { vdMap[d.sku] = d; });
                            skus.forEach(function(s) {
                                var vd = vdMap[s.sku];
                                if (vd) {
                                    s.physicalCount = vd.physicalCount;
                                    s.variance = vd.variance;
                                    if (vd.openingBalance != null) s.openingBalance = vd.openingBalance;
                                    if (vd.movedIn != null) s.movedIn = vd.movedIn;
                                    if (vd.movedOut != null) s.movedOut = vd.movedOut;
                                    if (vd.systemClosing != null) s.systemClosingBalance = vd.systemClosing;
                                }
                            });
                            var parts = [];
                            zConf.varianceDetails.forEach(function(d) {
                                if (d.sku !== 'ZONE_TOTAL' && d.variance !== 0 && d.variance != null && !isNaN(d.variance)) {
                                    var abs = Math.abs(d.variance);
                                    parts.push(d.sku + ': ' + abs + (d.variance < 0 ? ' short' : ' over'));
                                }
                            });
                            if (parts.length) zd.varianceSummary = parts.join(' · ');
                        }
                        return zd;
                    });

                    bcZones.forEach(function(zd, zIdx) {
                        grid.appendChild(buildZoneCard(zd, zIdx));
                    });
                }

                function fmt(n) { return (n === undefined || n === null) ? '—' : Number(n).toLocaleString(); }

                function buildZoneCard(zd, zIdx) {
                    var card = document.createElement('div');
                    card.className = 'bc-zone-card' + (zd.confirmed ? ' bc-zone-confirmed' : '');
                    card.dataset.zidx = zIdx;

                    var statusClass = zd.confirmed ? 'bc-status-confirmed' : 'bc-status-open';
                    var statusText  = zd.confirmed ? '✅ Confirmed'        : '⏳ Open';

                    var bodyHtml, footer;
                    if (zd.confirmed) {
                        var skuRows = zd.skus.map(function(c) {
                            var v = c.variance;
                            var vCls = (v === 0 || v == null) ? 'variance-match' : (v < 0 ? 'variance-short' : 'variance-over');
                            var vStr = v === 0 ? '0 ✓' : (v == null ? '—' : (v > 0 ? '+' + v : v));
                            return '<tr><td style="font-weight:600;">' + escapeHtml(c.sku) + '</td>' +
                                '<td style="color:#94a3b8;">' + fmt(c.openingBalance) + '</td>' +
                                '<td style="color:#34d399;">+' + fmt(c.movedIn) + '</td>' +
                                '<td style="color:#f87171;">−' + fmt(c.movedOut) + '</td>' +
                                '<td>' + fmt(c.systemClosingBalance) + '</td>' +
                                '<td>' + fmt(c.physicalCount) + '</td>' +
                                '<td class="' + vCls + '">' + vStr + '</td></tr>';
                        }).join('');
                        var vSum = zd.varianceSummary || '';
                        bodyHtml = '<div class="bc-zc-summary">' +
                            '<div class="bc-zc-sum-item"><div class="bc-zc-sum-label">Opening</div><div class="bc-zc-sum-value" style="color:#94a3b8;">' + fmt(zd.totalOpening) + '</div></div>' +
                            '<div class="bc-zc-sum-item"><div class="bc-zc-sum-label">In</div><div class="bc-zc-sum-value" style="color:#34d399;">+' + fmt(zd.totalIn) + '</div></div>' +
                            '<div class="bc-zc-sum-item"><div class="bc-zc-sum-label">Out</div><div class="bc-zc-sum-value" style="color:#f87171;">−' + fmt(zd.totalOut) + '</div></div>' +
                            '<div class="bc-zc-sum-item"><div class="bc-zc-sum-label">Closing Bal.</div><div class="bc-zc-sum-value">' + fmt(zd.totalSystem) + '</div></div>' +
                            '<div class="bc-zc-sum-item"><div class="bc-zc-sum-label">Physical</div><div class="bc-zc-sum-value">' + fmt(zd.totalPhysical) + '</div></div>' +
                            '<div class="bc-zc-sum-item"><div class="bc-zc-sum-label">Variance</div><div class="bc-zc-sum-value ' + ((zd.zoneVariance === 0 || zd.zoneVariance == null) ? 'variance-match' : (zd.zoneVariance < 0 ? 'variance-short' : 'variance-over')) + '">' + (zd.zoneVariance == null ? '—' : (zd.zoneVariance === 0 ? '0' : zd.zoneVariance)) + '</div></div>' +
                            '</div>' +
                            '<div style="overflow-x:auto;"><table class="bc-zc-sku-table"><thead><tr><th>SKU</th><th>Open</th><th>In</th><th>Out</th><th>Closing Bal.</th><th>Physical</th><th>Var</th></tr></thead><tbody>' + skuRows + '</tbody></table></div>';
                        footer = '<div class="bc-zc-confirmed-stamp">✅ Confirmed by <strong>' + escapeHtml(zd.confirmedBy || '—') + '</strong>' + (vSum ? ' <span style="font-size:11px;color:#64748b;margin-left:8px;">' + escapeHtml(vSum) + '</span>' : '') + '</div>';
                    } else {
                        var skuList = zd.skus.map(function(c) { return escapeHtml(c.sku); }).join(', ');
                        bodyHtml = '<div class="bc-zc-sku-list-only"><div class="bc-zc-sku-list-label">SKUs in zone:</div><div class="bc-zc-sku-list">' + skuList + '</div></div>';
                        footer = '<button class="bc-confirm-btn" onclick="openBcZoneModal(' + zIdx + ')" style="width:100%;max-width:380px;">📝 Enter Physical Count &amp; Close Zone Card</button>';
                    }

                    card.innerHTML = '<div class="bc-zc-topbar">' +
                        '<span class="bc-zc-zone-name">📦 ' + escapeHtml(zd.zone) + '</span>' +
                        '<span class="bc-zc-topbar-right">' +
                        '<button type="button" class="bc-print-zone-btn btn-reset" onclick="printBcZone(' + zIdx + ')" title="Print this zone only">🖨️ Print zone</button>' +
                        '<span class="bc-status-pill ' + statusClass + '">' + statusText + '</span>' +
                        '</span></div>' + bodyHtml + '<div class="bc-zc-footer">' + footer + '</div>';
                    return card;
                }

                // ── Modal — per-SKU physical count confirmation ──
                window.openBcZoneModal = function(zIdx) {
                    var zd = bcZones[zIdx];
                    if (!zd) return;
                    bcActiveZone = zd;

                    document.getElementById('bcModalTitle').textContent = 'Zone Physical Count — ' + zd.zone;
                    document.getElementById('bcModalSub').textContent   =
                        (bcCurrentShift ? bcCurrentShift.label : '') +
                        (bcCurrentShift ? ' · ' + bcCurrentShift.shiftDateKey : '') +
                        ' · ' + zd.skus.length + ' SKU' + (zd.skus.length !== 1 ? 's' : '');

                    document.getElementById('bcModalEntryView').style.display = 'block';
                    document.getElementById('bcModalReceiptView').style.display = 'none';
                    var container = document.getElementById('bcPhysicalInputsContainer');
                    container.innerHTML = '';
                    zd.skus.forEach(function(s, idx) {
                        var row = document.createElement('div');
                        row.className = 'bc-physical-sku-row';
                        row.dataset.sku = s.sku;
                        row.dataset.idx = idx;
                        row.innerHTML =
                            '<div><div class="sku-label">' + escapeHtml(s.sku) + '</div></div>' +
                            '<input type="number" min="0" placeholder="0" data-sku="' + escapeHtml(s.sku) + '" ' +
                                'data-opening="' + (s.openingBalance || 0) + '" data-movedin="' + (s.movedIn || 0) + '" ' +
                                'data-movedout="' + (s.movedOut || 0) + '" data-sys="' + (s.systemClosingBalance || 0) + '">';
                        container.appendChild(row);
                    });
                    if (zd.skus.length > 0) {
                        var firstInput = container.querySelector('input');
                        if (firstInput) firstInput.focus();
                    }
                    document.getElementById('bcModalStatus').textContent = '';
                    document.getElementById('bcConfirmBtn').disabled = false;
                    document.getElementById('bcConfirmModal').classList.add('active');
                };

                window.closeBcModal = function() {
                    document.getElementById('bcConfirmModal').classList.remove('active');
                    bcActiveZone = null;
                };


                window.submitBinCardConfirmation = async function() {
                    var zd        = bcActiveZone;
                    var container = document.getElementById('bcPhysicalInputsContainer');
                    var statusEl  = document.getElementById('bcModalStatus');
                    var confirmBtn = document.getElementById('bcConfirmBtn');

                    if (!zd) return;
                    if (!bcLoggedInUser) {
                        statusEl.textContent = '❌ Session error — please reload and log in again.';
                        statusEl.style.color = '#f87171';
                        return;
                    }

                    var inputs = container ? container.querySelectorAll('input[data-sku]') : [];
                    var physicalCounts = [];
                    var allValid = true;
                    for (var i = 0; i < inputs.length; i++) {
                        var inp = inputs[i];
                        var val = parseFloat(inp.value);
                        var sku = inp.dataset.sku || '';
                        if (isNaN(val) || inp.value === '') {
                            allValid = false;
                            break;
                        }
                        physicalCounts.push({
                            sku: sku,
                            physicalCount: val,
                            openingBalance: Number(inp.dataset.opening) || 0,
                            movedIn: Number(inp.dataset.movedin) || 0,
                            movedOut: Number(inp.dataset.movedout) || 0,
                            systemClosingBalance: Number(inp.dataset.sys) || 0
                        });
                    }
                    if (!allValid || physicalCounts.length === 0) {
                        statusEl.textContent = '⚠️ Please enter a physical count (0 or more) for every SKU.';
                        statusEl.style.color = '#fbbf24';
                        return;
                    }

                    confirmBtn.disabled  = true;
                    statusEl.textContent = '⏳ Saving confirmation…';
                    statusEl.style.color = '#94a3b8';

                    try {
                        var url = GOOGLE_APPS_SCRIPT_URL +
                            '?action=confirmZoneBinCardPerSku' +
                            '&zone='                 + encodeURIComponent(zd.zone) +
                            '&shift='                + encodeURIComponent(bcCurrentShift.shift) +
                            '&shiftDate='            + encodeURIComponent(bcCurrentShift.shiftDateKey) +
                            '&physicalCounts='       + encodeURIComponent(JSON.stringify(physicalCounts)) +
                            '&confirmedBy='          + encodeURIComponent(bcLoggedInUser.name || bcLoggedInUser.id);

                        var resp   = await fetch(url);
                        var result = await resp.json();

                        if (result.success) {
                            var userName = bcLoggedInUser.name || bcLoggedInUser.id;
                            var vd = result.varianceDetails || [];
                            zd.confirmed   = true;
                            zd.confirmedBy = userName;
                            zd.varianceDetails = vd;
                            // Overlay varianceDetails onto skus so card shows physical/variance
                            var vdMap = {};
                            vd.forEach(function(d) { vdMap[d.sku] = d; });
                            zd.skus.forEach(function(s) {
                                var d = vdMap[s.sku];
                                if (d) {
                                    s.physicalCount = d.physicalCount;
                                    s.variance = d.variance;
                                }
                            });
                            var zTotal = vd.filter(function(d) { return d.sku === 'ZONE_TOTAL'; })[0];
                            if (zTotal) {
                                zd.totalPhysical = zTotal.physicalCount;
                                zd.zoneVariance  = zTotal.variance;
                            }
                            var parts = [];
                            vd.forEach(function(d) {
                                if (d.sku !== 'ZONE_TOTAL' && d.variance !== 0 && d.variance != null && !isNaN(d.variance)) {
                                    parts.push(d.sku + ': ' + Math.abs(d.variance) + (d.variance < 0 ? ' short' : ' over'));
                                }
                            });
                            zd.varianceSummary = parts.join(' · ');

                            document.getElementById('bcModalEntryView').style.display = 'none';
                            var receiptView = document.getElementById('bcModalReceiptView');
                            var receiptTable = document.getElementById('bcReceiptTable');
                            var rows = vd.map(function(d) {
                                var vCls = d.variance === 0 ? 'variance-match' : (d.variance < 0 ? 'variance-short' : 'variance-over');
                                var vStr = d.variance === 0 ? '0 ✓' : (d.variance > 0 ? '+' + d.variance : d.variance);
                                return '<tr><td>' + escapeHtml(d.sku) + '</td><td>' + fmt(d.systemClosing) + '</td><td>' + fmt(d.physicalCount) + '</td><td class="' + vCls + '">' + vStr + '</td></tr>';
                            }).join('');
                            receiptTable.innerHTML = '<table><thead><tr><th>SKU</th><th>System</th><th>Physical</th><th>Variance</th></tr></thead><tbody>' + rows + '</tbody></table>';
                            receiptView.style.display = 'block';

                            window.dismissBcReceipt = function() {
                                var z = bcActiveZone;
                                if (z) {
                                    var grid = document.getElementById('bcGrid');
                                    var zIdx = bcZones.indexOf(z);
                                    var oldCards = grid.querySelectorAll('.bc-zone-card');
                                    if (oldCards[zIdx]) grid.replaceChild(buildZoneCard(z, zIdx), oldCards[zIdx]);
                                    var confirmedNow = bcZones.filter(function(zone) { return zone.confirmed; }).length;
                                    var pct = bcZones.length > 0 ? Math.round((confirmedNow / bcZones.length) * 100) : 0;
                                    var fill = document.getElementById('bcProgressFill');
                                    var label = document.getElementById('bcProgressLabel');
                                    if (fill) fill.style.width = pct + '%';
                                    if (label) label.textContent = confirmedNow + ' of ' + bcZones.length + ' zones confirmed (' + pct + '%)';
                                }
                                closeBcModal();
                            };
                        } else {
                            statusEl.textContent = '❌ ' + (result.error || 'Save failed. Try again.');
                            statusEl.style.color = '#f87171';
                            confirmBtn.disabled  = false;
                        }
                    } catch (err) {
                        statusEl.textContent = '❌ Network error. Please try again.';
                        statusEl.style.color = '#f87171';
                        confirmBtn.disabled  = false;
                    }
                };

                window.toggleBcMovements = function() {
                    var content = document.getElementById('bcMovementsContent');
                    var icon = document.getElementById('bcMovementsToggleIcon');
                    if (content && icon) {
                        var show = content.style.display !== 'block';
                        content.style.display = show ? 'block' : 'none';
                        icon.textContent = show ? '▼' : '▶';
                    }
                };

                window.printBcZone = function(zIdx) {
                    var grid = document.getElementById('bcGrid');
                    if (!grid) return;
                    var cards = grid.querySelectorAll('.bc-zone-card');
                    var card = cards[zIdx];
                    if (!card) return;
                    card.classList.add('bc-zone-card-print-target');
                    document.body.classList.add('bc-print-single-zone');
                    var onAfterPrint = function() {
                        document.body.classList.remove('bc-print-single-zone');
                        card.classList.remove('bc-zone-card-print-target');
                        window.removeEventListener('afterprint', onAfterPrint);
                    };
                    window.addEventListener('afterprint', onAfterPrint);
                    window.print();
                };

                // Prevent native form submit immediately (before async load completes) to avoid page reload
                (function() {
                    var f = document.getElementById('binCardsLoginForm');
                    if (f) f.addEventListener('submit', function(e) { e.preventDefault(); }, { capture: true });
                })();

                // ── Login form ──
                function initBcLoginForm(users) {
                    populateAuthorizedUserSelects(users);
                    var form = document.getElementById('binCardsLoginForm');
                    if (!form) return;
                    form.addEventListener('submit', async function(ev) {
                        ev.preventDefault();
                        var statusEl  = document.getElementById('bcLoginStatus');
                        var userId    = document.getElementById('bcLoginUser').value;
                        var passcode  = document.getElementById('bcLoginPasscode').value;
                        var submitBtn = document.getElementById('bcLoginSubmit');
                        if (!userId || !passcode) {
                            statusEl.textContent = '⚠️ Please select a user and enter your passcode.';
                            statusEl.className   = 'login-status error';
                            return;
                        }
                        submitBtn.disabled   = true;
                        statusEl.textContent = '⏳ Verifying…';
                        statusEl.className   = 'login-status';
                        try {
                            var result = await verifyUserLogin(userId, passcode, { persist: false });
                            if (result.success) {
                                bcLoggedInUser = result.user || { id: userId, name: userId };
                                statusEl.textContent = '✅ Access granted. Loading bin cards…';
                                statusEl.className   = 'login-status success';
                                setTimeout(function() {
                                    var bcOvr = document.getElementById('binCardsLoginOverlay');
                                    if (bcOvr) bcOvr.style.cssText = 'display:none!important';
                                    loadAndRenderBinCards();
                                }, 600);
                            } else {
                                statusEl.textContent = '❌ ' + (result.message || 'Incorrect passcode.');
                                statusEl.className   = 'login-status error';
                                submitBtn.disabled   = false;
                            }
                        } catch (err) {
                            statusEl.textContent = '❌ Login failed. Please try again.';
                            statusEl.className   = 'login-status error';
                            submitBtn.disabled   = false;
                        }
                    });
                }

                function bcShowRevokeButtonIfAllowed() {
                    var btn = document.getElementById('bcRevokeAdminBtn');
                    if (!btn) return;
                    var role = (bcLoggedInUser && bcLoggedInUser.role) ? (bcLoggedInUser.role || '').toString().toLowerCase() : '';
                    btn.style.display = (role === 'qa' || role === 'supervisor') ? '' : 'none';
                }

                async function loadAndRenderBinCards() {
                    try {
                        var data = await fetchBinCardData();
                        if (data.success) {
                            renderBinCards(data);
                            bcShowRevokeButtonIfAllowed();
                        } else {
                            document.getElementById('bcLoadingState').innerHTML =
                                '<div style="font-size:32px;margin-bottom:12px;">⚠️</div>' +
                                '<div style="font-size:15px;font-weight:600;color:#f87171;">' + (data.error || 'Failed to load bin card data') + '</div>';
                        }
                    } catch (err) {
                        document.getElementById('bcLoadingState').innerHTML =
                            '<div style="font-size:32px;margin-bottom:12px;">❌</div>' +
                            '<div style="font-size:15px;font-weight:600;color:#f87171;">Could not reach server. Check your connection.</div>';
                    }
                }

                var bcAuditReportRows = [];
                window.openBcAuditReport = function() {
                    var now = new Date();
                    var pad = function(n) { return (n < 10 ? '0' : '') + n; };
                    var today = now.getFullYear() + '-' + pad(now.getMonth()+1) + '-' + pad(now.getDate());
                    var dfEl = document.getElementById('bcAuditDateFrom');
                    var dtEl = document.getElementById('bcAuditDateTo');
                    if (dfEl) dfEl.value = today;
                    if (dtEl) dtEl.value = today;
                    document.getElementById('bcAuditReportModal').style.display = 'flex';
                    loadBcAuditReport();
                };
                window.closeBcAuditReport = function() { document.getElementById('bcAuditReportModal').style.display = 'none'; };
                window.viewBcShiftInBinCards = function(shiftDate, shift) {
                    var sel = document.getElementById('bcShiftSelect');
                    var cd = document.getElementById('bcCustomDate');
                    var cs = document.getElementById('bcCustomShift');
                    if (sel) sel.value = 'custom';
                    if (cd) cd.value = shiftDate || '';
                    if (cs) cs.value = (shift === 'Night') ? 'Night' : 'Day';
                    document.getElementById('bcCustomShiftWrap').style.display = 'flex';
                    closeBcAuditReport();
                    loadAndRenderBinCards();
                };
                window.loadBcAuditReport = async function loadBcAuditReport() {
                    var df = document.getElementById('bcAuditDateFrom').value;
                    var dt = document.getElementById('bcAuditDateTo').value;
                    var sh = document.getElementById('bcAuditShift').value;
                    var z  = document.getElementById('bcAuditZone').value.trim();
                    var url = GOOGLE_APPS_SCRIPT_URL + '?action=getBinCardVarianceReport&dateFrom=' + encodeURIComponent(df) + '&dateTo=' + encodeURIComponent(dt) + '&shift=' + encodeURIComponent(sh) + '&zone=' + encodeURIComponent(z);
                    try {
                        var resp = await fetch(url);
                        var txt = await resp.text();
                        var result = {};
                        try { result = JSON.parse(txt); } catch (_) { throw new Error('Invalid response from server'); }
                        bcAuditReportRows = Array.isArray(result.rows) ? result.rows : [];
                        var tbl = document.getElementById('bcAuditReportTable');
                        var fmt = function(n) { return (n === undefined || n === null) ? '—' : Number(n).toLocaleString(); };
                        var html = '<table class="bc-zc-sku-table"><thead><tr><th>Zone</th><th>SKU</th><th>Shift</th><th>Date</th><th>System</th><th>Physical</th><th>Variance</th><th>By</th><th>At</th><th></th></tr></thead><tbody>';
                        var seenShifts = {};
                        bcAuditReportRows.forEach(function(r) {
                            var vCls = r.variance === 0 ? 'variance-match' : (r.variance < 0 ? 'variance-short' : 'variance-over');
                            var viewKey = (r.shiftDate || '') + '|' + (r.shift || '');
                            var viewLink = !seenShifts[viewKey] ? '<button type="button" class="btn-reset" onclick="viewBcShiftInBinCards(\'' + escapeHtml(r.shiftDate).replace(/'/g,"\\'") + '\',\'' + escapeHtml(r.shift||'Day').replace(/'/g,"\\'") + '\')" style="font-size:11px;padding:4px 8px;border:1px solid rgba(52,211,153,0.5);color:#34d399;border-radius:6px;cursor:pointer;">View in Bin Cards</button>' : '';
                            if (!seenShifts[viewKey]) seenShifts[viewKey] = true;
                            html += '<tr><td>' + escapeHtml(r.zone) + '</td><td>' + escapeHtml(r.sku) + '</td><td>' + escapeHtml(r.shift) + '</td><td>' + escapeHtml(r.shiftDate) + '</td><td>' + fmt(r.systemClosing) + '</td><td>' + fmt(r.physicalCount) + '</td><td class="' + vCls + '">' + (r.variance === 0 ? '0' : r.variance) + '</td><td>' + escapeHtml(r.confirmedBy) + '</td><td>' + escapeHtml((r.confirmedAt || '').substring(0,19)) + '</td><td>' + viewLink + '</td></tr>';
                        });
                        html += '</tbody></table>';
                        if (bcAuditReportRows.length === 0) {
                            tbl.innerHTML = '<div style="padding:24px;color:#64748b;">No confirmed bin cards in date range. Widen the dates or clear Shift/Zone filters.</div>';
                        } else {
                            tbl.innerHTML = html;
                        }
                        document.getElementById('bcAuditExportBtn').disabled = bcAuditReportRows.length === 0;
                    } catch (e) { document.getElementById('bcAuditReportTable').innerHTML = '<div style="padding:24px;color:#f87171;">Failed to load: ' + (e.message || 'Unknown error') + '</div>'; }
                }
                window.exportBcAuditCsv = function() {
                    if (bcAuditReportRows.length === 0) return;
                    var hdr = 'Zone,SKU,Shift,Date,System,Physical,Variance,ConfirmedBy,ConfirmedAt';
                    var rows = bcAuditReportRows.map(function(r) { return [r.zone,r.sku,r.shift,r.shiftDate,r.systemClosing,r.physicalCount,r.variance,r.confirmedBy,r.confirmedAt].map(function(x) { return '"' + String(x || '').replace(/"/g,'""') + '"'; }).join(','); });
                    var csv = hdr + '\n' + rows.join('\n');
                    var blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
                    var a = document.createElement('a');
                    a.href = (window.URL || window.webkitURL).createObjectURL(blob);
                    a.download = 'bin-card-variance-report-' + new Date().toISOString().slice(0,10) + '.csv';
                    a.style.display = 'none';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    if (a.href && a.href.indexOf('blob:') === 0) (window.URL || window.webkitURL).revokeObjectURL(a.href);
                };

                window.openBcRevokeAdmin = function() {
                    if (!bcLoggedInUser) return;
                    var role = (bcLoggedInUser.role || '').toString().toLowerCase();
                    if (role !== 'qa' && role !== 'supervisor') { alert('Only QA or Supervisors can revoke bin cards.'); return; }
                    var n = new Date();
                    var today = n.getFullYear()+'-'+(n.getMonth()+1<10?'0':'')+(n.getMonth()+1)+'-'+(n.getDate()<10?'0':'')+n.getDate();
                    var df = document.getElementById('bcRevokeDateFrom');
                    var dt = document.getElementById('bcRevokeDateTo');
                    if (df) df.value = today;
                    if (dt) dt.value = today;
                    document.getElementById('bcRevokeAdminModal').style.display = 'flex';
                    loadBcRevokeList();
                };
                window.closeBcRevokeAdmin = function() { document.getElementById('bcRevokeAdminModal').style.display = 'none'; };
                window.loadBcRevokeList = async function loadBcRevokeList() {
                    var dfEl = document.getElementById('bcRevokeDateFrom');
                    var dtEl = document.getElementById('bcRevokeDateTo');
                    var n = new Date();
                    var today = n.getFullYear()+'-'+(n.getMonth()+1<10?'0':'')+(n.getMonth()+1)+'-'+(n.getDate()<10?'0':'')+n.getDate();
                    if (dfEl && !dfEl.value) dfEl.value = today;
                    if (dtEl && !dtEl.value) dtEl.value = today;
                    var df = (dfEl && dfEl.value) || today;
                    var dt = (dtEl && dtEl.value) || today;
                    var url = GOOGLE_APPS_SCRIPT_URL + '?action=getConfirmedBinCardsForAdmin&dateFrom=' + encodeURIComponent(df) + '&dateTo=' + encodeURIComponent(dt);
                    try {
                        var resp = await fetch(url);
                        var result = await resp.json();
                        var zones = result.zones || [];
                        var list = document.getElementById('bcRevokeList');
                        list.innerHTML = zones.map(function(z) {
                            var zoneEsc = escapeHtml(z.zone).replace(/'/g, "\\'");
                            var shiftEsc = escapeHtml(z.shift).replace(/'/g, "\\'");
                            var dateEsc = escapeHtml(z.shiftDate).replace(/'/g, "\\'");
                            return '<div class="bc-revoke-item"><div><strong>' + escapeHtml(z.zone) + '</strong> · ' + escapeHtml(z.shiftDate) + ' ' + escapeHtml(z.shift) + '<br><small style="color:#64748b;">By ' + escapeHtml(z.confirmedBy) + '</small></div><button class="btn-reset bc-revoke-btn" data-zone="' + escapeHtml(z.zone) + '" data-shift="' + escapeHtml(z.shift) + '" data-date="' + escapeHtml(z.shiftDate) + '">Revoke</button></div>';
                        }).join('') || '<div style="padding:24px;color:#64748b;">No confirmed bin cards in date range.</div>';
                        list.querySelectorAll('.bc-revoke-btn').forEach(function(btn) {
                            btn.onclick = function() { revokeBcCard(btn.dataset.zone, btn.dataset.shift, btn.dataset.date); };
                        });
                    } catch (e) { document.getElementById('bcRevokeList').innerHTML = '<div style="padding:24px;color:#f87171;">Failed to load.</div>'; }
                }
                window.revokeBcCard = async function(zone, shift, shiftDate) {
                    if (!bcLoggedInUser || !confirm('Revoke this bin card? The zone will return to Open and can be re-confirmed.')) return;
                    var url = GOOGLE_APPS_SCRIPT_URL + '?action=revokeZoneBinCard&zone=' + encodeURIComponent(zone) + '&shift=' + encodeURIComponent(shift) + '&shiftDate=' + encodeURIComponent(shiftDate) + '&revokedBy=' + encodeURIComponent(bcLoggedInUser.name || bcLoggedInUser.id);
                    try {
                        var resp = await fetch(url);
                        var result = await resp.json();
                        if (result.success) { loadBcRevokeList(); loadAndRenderBinCards(); }
                        else alert('❌ ' + (result.error || 'Revoke failed'));
                    } catch (e) { alert('❌ ' + (e.message || 'Revoke failed')); }
                };

                var bcReconReportRows = [];
                window.openBcReconReport = function() {
                    document.getElementById('bcReconReportModal').style.display = 'flex';
                    document.getElementById('bcReconDatePreset').value = 'today';
                    onBcReconPresetChange();
                    loadBcReconReport();
                };
                window.closeBcReconReport = function() { document.getElementById('bcReconReportModal').style.display = 'none'; };
                window.onBcReconPresetChange = function() {
                    var preset = document.getElementById('bcReconDatePreset').value;
                    var wrap = document.getElementById('bcReconCustomWrap');
                    if (wrap) wrap.style.display = (preset === 'custom') ? 'inline-flex' : 'none';
                    if (preset === 'custom') {
                        var n = new Date();
                        var pad = function(x) { return (x < 10 ? '0' : '') + x; };
                        var today = n.getFullYear() + '-' + pad(n.getMonth()+1) + '-' + pad(n.getDate());
                        var df = document.getElementById('bcReconDateFrom');
                        var dt = document.getElementById('bcReconDateTo');
                        if (df && !df.value) df.value = today;
                        if (dt && !dt.value) dt.value = today;
                    }
                };
                window.loadBcReconReport = async function() {
                    var preset = document.getElementById('bcReconDatePreset').value;
                    var df = document.getElementById('bcReconDateFrom');
                    var dt = document.getElementById('bcReconDateTo');
                    var url = GOOGLE_APPS_SCRIPT_URL + '?action=getPalletReconciliationReport&datePreset=' + encodeURIComponent(preset);
                    if (preset === 'custom' && df && dt) url += '&dateFrom=' + encodeURIComponent(df.value) + '&dateTo=' + encodeURIComponent(dt.value);
                    try {
                        var resp = await fetch(url);
                        var txt = await resp.text();
                        var result = {};
                        try { result = JSON.parse(txt); } catch (_) { throw new Error('Invalid response'); }
                        bcReconReportRows = Array.isArray(result.rows) ? result.rows : [];
                        var label = document.getElementById('bcReconFilterLabel');
                        if (label) label.textContent = 'Filter: ' + (result.filterLabel || preset) + (result.dateFrom && result.dateTo ? ' (' + result.dateFrom + ' — ' + result.dateTo + ')' : '');
                        var tbl = document.getElementById('bcReconReportTable');
                        var fmt = function(n) { return (n === undefined || n === null) ? '—' : Number(n).toLocaleString(); };
                        if (bcReconReportRows.length === 0) {
                            tbl.innerHTML = '<div style="padding:24px;color:#64748b;">No pallets birthed in selected period.</div>';
                        } else {
                            var html = '<table class="bc-zc-sku-table bc-recon-table"><thead><tr><th>SKU</th><th>Total Birthed</th><th>Total Qty</th><th>In Zones</th><th>In Transit</th><th>Dispatched</th><th>Reconciled</th><th>Notes</th></tr></thead><tbody>';
                            bcReconReportRows.forEach(function(r) {
                                var reconCls = r.reconciled ? 'variance-match' : 'variance-short';
                                var inTransitStr = r.inTransit > 0 ? fmt(r.inTransit) + ' (' + fmt(r.inTransitQty) + ')' : fmt(r.inTransit);
                                var dispatchedStr = r.dispatched > 0 ? fmt(r.dispatched) + ' (' + fmt(r.dispatchedQty) + ')' : fmt(r.dispatched);
                                html += '<tr><td>' + escapeHtml(r.sku) + '</td><td>' + fmt(r.totalBirthed) + '</td><td>' + fmt(r.totalQty) + '</td><td>' + fmt(r.inZonesCount) + ' (' + fmt(r.inZonesQty) + ')</td><td>' + inTransitStr + '</td><td>' + dispatchedStr + '</td><td class="' + reconCls + '">' + (r.reconciled ? '✓' : '✗') + '</td><td style="font-size:11px">' + escapeHtml(r.notes || '') + '</td></tr>';
                            });
                            html += '</tbody></table>';
                            tbl.innerHTML = html;
                        }
                        document.getElementById('bcReconExportBtn').disabled = bcReconReportRows.length === 0;
                    } catch (e) {
                        document.getElementById('bcReconReportTable').innerHTML = '<div style="padding:24px;color:#f87171;">Failed to load: ' + (e.message || 'Unknown error') + '</div>';
                    }
                };
                window.exportBcReconCsv = function() {
                    if (bcReconReportRows.length === 0) return;
                    var hdr = 'SKU,TotalBirthed,TotalQty,InZonesCount,InZonesQty,InTransit,InTransitQty,Dispatched,DispatchedQty,Reconciled,ZoneBreakdown,Notes';
                    var rows = bcReconReportRows.map(function(r) {
                        return [r.sku,r.totalBirthed,r.totalQty,r.inZonesCount,r.inZonesQty,r.inTransit,r.inTransitQty,r.dispatched,r.dispatchedQty,r.reconciled ? 'Yes' : 'No',(r.zoneBreakdown||''),(r.notes||'')].map(function(x) { return '"' + String(x||'').replace(/"/g,'""') + '"'; }).join(',');
                    });
                    var csv = hdr + '\n' + rows.join('\n');
                    var blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
                    var a = document.createElement('a');
                    a.href = (window.URL || window.webkitURL).createObjectURL(blob);
                    a.download = 'stocks-merchandise-reconciliation-' + new Date().toISOString().slice(0,10) + '.csv';
                    a.style.display = 'none';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    if (a.href && a.href.indexOf('blob:') === 0) (window.URL || window.webkitURL).revokeObjectURL(a.href);
                };
                window.printBcReconReport = function() {
                    document.body.classList.add('bc-print-recon');
                    window.print();
                    document.body.classList.remove('bc-print-recon');
                };

                (async function() {
                    // Always load users so the dropdown is ready regardless of session state
                    try {
                        var { users } = await loadAuthorizedUsers();
                        initBcLoginForm(users);
                        authorizedUsersLoaded = true;
                    } catch (e) {
                        initBcLoginForm([]);
                    }
                })();
                }
            })();

        } else if (currentMode === 'view' || currentMode === 'edit' || currentMode === 'fill') {
            (function() {
                var params = new URLSearchParams(window.location.search);
                var bypassToken = params.get('t');
                if (params.get('geofence') === 'bypass' && bypassToken === GEOFENCE_BYPASS_TOKEN) {
                    document.body.classList.add('fill-mode-active');
                    runViewOrEditInit(initialSerialParam);
                    return;
                }
                var overlay = document.createElement('div');
                overlay.id = 'geofenceOverlay';
                overlay.style.cssText = 'position:fixed;inset:0;background:linear-gradient(135deg,#0f172a 0%,#1e293b 100%);display:flex;align-items:center;justify-content:center;z-index:99999;font-family:-apple-system,BlinkMacSystemFont,sans-serif;';
                overlay.innerHTML = '<div style="text-align:center;padding:40px;"><div style="width:64px;height:64px;margin:0 auto 20px;position:relative;"><div style="position:absolute;inset:-16px;border-radius:50%;border:2px solid rgba(251,191,36,0.5);box-shadow:0 0 16px rgba(251,191,36,0.25);animation:splashPulse 1.4s ease-out 0.2s infinite;"></div><img src="favicon.png" alt="" width="64" height="64" style="position:relative;z-index:2;object-fit:contain;"></div><p style="color:#fbbf24;font-size:18px;font-weight:600;">Verifying location...</p><p style="color:#94a3b8;font-size:14px;margin-top:12px;">GPS accuracy is required. Please allow location access.</p></div>';
                document.body.appendChild(overlay);
                checkGeofenceAccess().then(function(result) {
                    overlay.remove();
                    if (!result.ok) {
                        showGeofenceDenied(result);
                        return;
                    }
                    runViewOrEditInit(initialSerialParam);
                });
            })();
        }

        function formatSerial(serialNumber) {
            return `FG-${SERIES_PREFIX}-${String(serialNumber).padStart(5, '0')}`;
        }

        function updateSerialDisplay() {
            const formatted = formatSerial(currentSerial);
            const nextSerialEl = document.getElementById('nextSerial');
            if (nextSerialEl) {
                nextSerialEl.textContent = formatted;
            }
        }

        function resetSerial() {
            // Require password validation
            const password = prompt('🔐 Serial Reset - Password Required\n\nEnter password to reset serial number:');
            if (password !== GENERATOR_PASSWORD) {
                if (password !== null) {
                    alert('❌ Incorrect password. Reset cancelled.');
                }
                return;
            }

            // Prompt for new serial number
            const newSerialInput = prompt(`🔢 Reset Serial Number\n\nCurrent serial: ${formatSerial(currentSerial)}\n\nEnter the serial number to reset to (e.g., 1085):`);
            
            if (newSerialInput === null) {
                // User cancelled
                return;
            }

            // Validate input
            const newSerial = parseInt(newSerialInput, 10);
            if (isNaN(newSerial) || newSerial < 1) {
                alert('❌ Invalid serial number. Please enter a positive number.');
                return;
            }

            // Confirm reset
            const confirmReset = confirm(`⚠️ Confirm Serial Reset\n\nCurrent: ${formatSerial(currentSerial)}\nNew: ${formatSerial(newSerial)}\n\nThis action cannot be undone. Continue?`);
            
            if (!confirmReset) {
                return;
            }

            // Perform reset
            currentSerial = newSerial;
            localStorage.setItem('bandingSerial', currentSerial);
            updateSerialDisplay();
            
            alert(`✅ Serial number reset successfully!\n\nNew serial: ${formatSerial(currentSerial)}`);
        }

        async function generateTickets() {
            const ticketCount = parseInt(document.getElementById('ticketCount').value, 10);
            if (ticketCount % 4 !== 0) {
                showToast('Number of tickets must be a multiple of 4', 'warning');
                return;
            }
            await ensurePrintLibs();
            const container = document.getElementById('printContainer');
            const generateBtn = document.querySelector('.btn-generate[onclick="generateTickets()"]');
            const originalBtnText = generateBtn ? generateBtn.innerHTML : '';
            
            // Show loading state on button only (not in container to avoid breaking layout)
            if (generateBtn) {
                generateBtn.disabled = true;
                generateBtn.innerHTML = '⏳ Generating Tickets...';
                generateBtn.style.opacity = '0.7';
            }
            
            // Clear container immediately without loading message (to maintain 8 tickets per page)
            container.innerHTML = '';

            const ticketsPerPage = 4;
            const pages = Math.ceil(ticketCount / ticketsPerPage);

            for (let page = 0; page < pages; page++) {
                const pageDiv = document.createElement('div');
                pageDiv.className = 'page';

                const ticketsOnThisPage = Math.min(ticketsPerPage, ticketCount - (page * ticketsPerPage));
                
                for (let i = 0; i < ticketsOnThisPage; i++) {
                    const serialNum = currentSerial + (page * ticketsPerPage) + i;

                    const rowDiv = document.createElement('div');
                    rowDiv.className = 'ticket-row';

                    rowDiv.innerHTML += createTicketHTML(serialNum, selectedColor, false, {}, 'view');
                    rowDiv.innerHTML += createTicketHTML(serialNum, selectedColor, true, {}, 'edit');

                    pageDiv.appendChild(rowDiv);
                }

                container.appendChild(pageDiv);
            }

            // Restore button state
            if (generateBtn) {
                generateBtn.disabled = false;
                generateBtn.innerHTML = originalBtnText;
                generateBtn.style.opacity = '1';
            }
            
            renderTicketQRCodes(container);

            // Show print dialog
            setTimeout(() => {
                window.print();
                
                // Increment serial AFTER print dialog is shown
                setTimeout(() => {
                    const confirmPrint = confirm('Did you complete printing the tickets?\n\nClick OK if you printed successfully.\nClick Cancel if you cancelled the print (serial will not increment).');
                    
                    if (confirmPrint) {
                        const startSerial = formatSerial(currentSerial);
                        const endSerial = formatSerial(currentSerial + ticketCount - 1);
                        
                        currentSerial += ticketCount;
                        localStorage.setItem('bandingSerial', currentSerial);
                        updateSerialDisplay();
                        
                        // Show elegant success popup
                        showSuccessPopup({
                            title: '✅ Print Successful!',
                            message: `
                                <div style="text-align: left; line-height: 1.8;">
                                    <div style="margin-bottom: 16px; padding: 14px; background: rgba(245, 158, 11, 0.1); border-radius: 10px; border-left: 4px solid #f59e0b;">
                                        <strong style="color: #fbbf24; font-size: 16px;">📊 Print Summary</strong>
                                    </div>
                                    
                                    <div style="margin-bottom: 12px;">
                                        <strong style="color: #fbbf24;">Tickets Printed:</strong> 
                                        <span style="color: #fff; font-size: 18px; font-weight: 700;">${ticketCount} tickets</span>
                                    </div>
                                    
                                    <div style="margin-bottom: 12px;">
                                        <strong style="color: #fbbf24;">Color:</strong> 
                                        <span style="color: #fff; font-weight: 600; text-transform: uppercase;">${selectedColor}</span>
                                    </div>
                                    
                                    <div style="margin-bottom: 12px;">
                                        <strong style="color: #fbbf24;">Serial Range:</strong> 
                                        <span style="color: #fff; font-family: 'Courier New', monospace; font-weight: 600;">${startSerial} → ${endSerial}</span>
                                    </div>
                                    
                                    <div style="margin-top: 20px; padding: 16px; background: rgba(245, 158, 11, 0.15); border-radius: 10px; border: 2px solid rgba(245, 158, 11, 0.4);">
                                        <strong style="color: #fbbf24; font-size: 15px;">🎯 Next Serial Number:</strong><br>
                                        <span style="color: #fcd34d; font-size: 24px; font-weight: 800; font-family: 'Courier New', monospace; letter-spacing: 2px;">${formatSerial(currentSerial)}</span>
                                    </div>
                                </div>
                            `
                        });
                    } else {
                        showToast('Print cancelled. Serial counter NOT updated. Current serial: ' + formatSerial(currentSerial), 'warning', 5000);
                    }
                }, 500);
            }, 100);
        }

        async function generateAllColorTicketsPDF(event) {
            event = event || { target: document.querySelector('.btn-generate[onclick*="generateAllColorTicketsPDF"]') };
            showRetifluxLoadingOverlay();
            try {
                await ensurePrintLibs();
            } catch (e) {
                hideRetifluxLoadingOverlay();
                showToast('PDF libraries not loaded. Please refresh the page.', 'error');
                return;
            }
            const ticketCount = 52;
            const colors = ['red', 'blue', 'green', 'yellow'];
            const ticketsPerPage = 4; // 4 ticket pairs per page (8 tickets total)
            
            // Show loading message
            const originalButton = event.target;
            const originalText = originalButton.innerHTML;
            originalButton.innerHTML = '⏳ Generating PDF...';
            originalButton.disabled = true;

            try {
                const container = document.getElementById('printContainer');
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: rgba(251, 191, 36, 0.9);"><div class="loading-spinner"></div><p style="margin-top: 20px; font-weight: 600;">Generating PDF tickets...</p><p style="margin-top: 10px; font-size: 13px; opacity: 0.8;">This may take a moment for large batches</p></div>';
                container.style.display = 'block';

                // Generate all tickets: 52 serials per color × 4 colors = 208 unique serials total
                // Serial 1-52: RED
                // Serial 53-104: GREEN
                // Serial 105-156: BLUE
                // Serial 157-208: YELLOW
                let allTicketPairs = [];
                
                // Generate 52 serials for each color (208 total unique serials)
                colors.forEach((color, colorIndex) => {
                    for (let ticketNum = 0; ticketNum < ticketCount; ticketNum++) {
                        const serialNum = currentSerial + (colorIndex * ticketCount) + ticketNum;
                        allTicketPairs.push({
                            serial: serialNum,
                            color: color
                        });
                    }
                });

                // Group into pages: 4 ticket pairs per page (each pair = view + edit)
                const pairsPerPage = 4;
                const totalPagesCount = Math.ceil(allTicketPairs.length / pairsPerPage);

                // Create pages in the container
                for (let pageIdx = 0; pageIdx < totalPagesCount; pageIdx++) {
                    const pageDiv = document.createElement('div');
                    pageDiv.className = 'page';
                    pageDiv.style.width = '210mm';
                    pageDiv.style.height = '297mm';
                    pageDiv.style.pageBreakAfter = 'always';

                    const startIdx = pageIdx * pairsPerPage;
                    const endIdx = Math.min(startIdx + pairsPerPage, allTicketPairs.length);
                    const pairsOnPage = allTicketPairs.slice(startIdx, endIdx);

                    // Create a row for each ticket pair (view + edit)
                    pairsOnPage.forEach(ticket => {
                        const rowDiv = document.createElement('div');
                        rowDiv.className = 'ticket-row';
                        rowDiv.innerHTML += createTicketHTML(ticket.serial, ticket.color, false, {}, 'view');
                        rowDiv.innerHTML += createTicketHTML(ticket.serial, ticket.color, true, {}, 'edit');
                        pageDiv.appendChild(rowDiv);
                    });

                    container.appendChild(pageDiv);
                }

                // Render QR codes
                await new Promise((resolve) => {
                    renderTicketQRCodes(container);
                    // Wait for QR codes to render (they're async)
                    setTimeout(resolve, 2000);
                });

                // Initialize PDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                const pageWidth = 210; // A4 width in mm
                const pageHeight = 297; // A4 height in mm

                // Get all pages
                const pages = Array.from(container.querySelectorAll('.page'));
                const totalPages = pages.length;
                
                // Optimized: Process and add pages incrementally to avoid memory issues
                const BATCH_SIZE = 2; // Process 2 pages at a time to reduce memory usage
                
                originalButton.innerHTML = `⏳ Rendering ${totalPages} pages (optimized)...`;

                // Process pages in batches and add to PDF incrementally
                for (let batchStart = 0; batchStart < totalPages; batchStart += BATCH_SIZE) {
                    const batchEnd = Math.min(batchStart + BATCH_SIZE, totalPages);
                    const batch = pages.slice(batchStart, batchEnd);
                    
                    // Update progress
                    originalButton.innerHTML = `⏳ Rendering pages ${batchStart + 1}-${batchEnd} of ${totalPages}...`;
                    
                    // Process batch in parallel
                    const batchPromises = batch.map((pageElement, batchIdx) => {
                        return html2canvas(pageElement, {
                            scale: 1.2, // Reduced scale to prevent memory issues
                            backgroundColor: '#ffffff',
                            useCORS: true,
                            logging: false,
                            width: pageElement.scrollWidth,
                            height: pageElement.scrollHeight,
                            removeContainer: false,
                            allowTaint: false
                        }).then(canvas => {
                            // Use JPEG with compression instead of PNG to reduce size
                            const imgData = canvas.toDataURL('image/jpeg', 0.85); // JPEG at 85% quality
                            return {
                                index: batchStart + batchIdx,
                                data: imgData,
                                width: pageWidth,
                                height: (canvas.height * pageWidth) / canvas.width
                            };
                        });
                    });
                    
                    // Wait for batch to complete
                    const batchResults = await Promise.all(batchPromises);
                    
                    // Sort batch by index
                    batchResults.sort((a, b) => a.index - b.index);
                    
                    // Add pages to PDF immediately (incremental approach)
                    originalButton.innerHTML = `⏳ Adding pages ${batchStart + 1}-${batchEnd} to PDF...`;
                    batchResults.forEach((pageImg, batchIdx) => {
                        const pageIndex = batchStart + batchIdx;
                        if (pageIndex > 0) {
                            pdf.addPage();
                        }
                        // Use JPEG format
                        pdf.addImage(pageImg.data, 'JPEG', 0, 0, pageImg.width, pageImg.height, undefined, 'FAST');
                    });
                    
                    // Clear batch results from memory
                    batchResults.length = 0;
                }

                // Download PDF
                const fileName = `Banding_Tickets_${ticketCount}_AllColors_${new Date().toISOString().split('T')[0]}.pdf`;
                pdf.save(fileName);

                // Increment serial AFTER successful PDF download
                setTimeout(() => {
                    const confirmDownload = confirm('Did the PDF download successfully?\n\nClick OK if you received the PDF.\nClick Cancel if the download failed (serial will not increment).');
                    
                    if (confirmDownload) {
                        const totalTickets = ticketCount * colors.length;
                        const startSerial = formatSerial(currentSerial);
                        const endSerial = formatSerial(currentSerial + totalTickets - 1);
                        
                        // Update serial number (ticketCount × 4 colors = total unique serials used)
                        currentSerial += totalTickets;
                        localStorage.setItem('bandingSerial', currentSerial);
                        updateSerialDisplay();
                        
                        // Show elegant success popup
                        showSuccessPopup({
                            title: '✅ PDF Download Successful!',
                            message: `
                                <div style="text-align: left; line-height: 1.8;">
                                    <div style="margin-bottom: 16px; padding: 14px; background: rgba(245, 158, 11, 0.1); border-radius: 10px; border-left: 4px solid #f59e0b;">
                                        <strong style="color: #fbbf24; font-size: 16px;">📊 Download Summary</strong>
                                    </div>
                                    
                                    <div style="margin-bottom: 12px;">
                                        <strong style="color: #fbbf24;">Total Tickets:</strong> 
                                        <span style="color: #fff; font-size: 18px; font-weight: 700;">${totalTickets} tickets</span>
                                    </div>
                                    
                                    <div style="margin-bottom: 12px;">
                                        <strong style="color: #fbbf24;">Breakdown:</strong> 
                                        <span style="color: #fff; font-weight: 600;">${ticketCount} × 4 colors (RED, GREEN, BLUE, YELLOW)</span>
                                    </div>
                                    
                                    <div style="margin-bottom: 12px;">
                                        <strong style="color: #fbbf24;">Serial Range:</strong> 
                                        <span style="color: #fff; font-family: 'Courier New', monospace; font-weight: 600;">${startSerial} → ${endSerial}</span>
                                    </div>
                                    
                                    <div style="margin-bottom: 12px;">
                                        <strong style="color: #fbbf24;">File Name:</strong> 
                                        <span style="color: #fff; font-size: 13px; font-weight: 500;">${fileName}</span>
                                    </div>
                                    
                                    <div style="margin-top: 20px; padding: 16px; background: rgba(245, 158, 11, 0.15); border-radius: 10px; border: 2px solid rgba(245, 158, 11, 0.4);">
                                        <strong style="color: #fbbf24; font-size: 15px;">🎯 Next Serial Number:</strong><br>
                                        <span style="color: #fcd34d; font-size: 24px; font-weight: 800; font-family: 'Courier New', monospace; letter-spacing: 2px;">${formatSerial(currentSerial)}</span>
                                    </div>
                                </div>
                            `
                        });
                    } else {
                        showToast('Download failed. Serial counter NOT updated. Current serial: ' + formatSerial(currentSerial), 'warning', 5000);
                    }
                }, 500);

                // Hide container
                container.style.display = 'none';
                container.innerHTML = '';

                originalButton.innerHTML = originalText;
                originalButton.disabled = false;

                const firstSerial = formatSerial(currentSerial - (ticketCount * colors.length));
                const lastSerial = formatSerial(currentSerial - 1);
                alert(`✅ PDF generated successfully!\n\n${ticketCount} serials per color × 4 colors = ${allTicketPairs.length} unique serials total\n${totalPages} pages generated\n\nSerial ranges:\n• ${firstSerial} to ${formatSerial(currentSerial - (ticketCount * 3) - 1)}: RED\n• ${formatSerial(currentSerial - (ticketCount * 3))} to ${formatSerial(currentSerial - (ticketCount * 2) - 1)}: GREEN\n• ${formatSerial(currentSerial - (ticketCount * 2))} to ${formatSerial(currentSerial - ticketCount - 1)}: BLUE\n• ${formatSerial(currentSerial - ticketCount)} to ${lastSerial}: YELLOW\n\nFile: ${fileName}`);
            } catch (error) {
                console.error('Error generating PDF:', error);
                showToast('Error generating PDF: ' + error.message, 'error', 6000);
                originalButton.innerHTML = originalText;
                originalButton.disabled = false;
            } finally {
                hideRetifluxLoadingOverlay();
            }
        }

        function buildScanUrl(serial, mode = 'edit', color = 'blue') {
            // Ensure SCAN_BASE_URL is always set
            if (!SCAN_BASE_URL || SCAN_BASE_URL === '') {
                const { protocol, origin, pathname } = window.location;
                // If file:// protocol, use default URL
                if (protocol === 'file:') {
                    SCAN_BASE_URL = DEFAULT_SCAN_BASE_URL;
                } else {
                    SCAN_BASE_URL = `${origin}${pathname}`;
                }
            }
            // Remove any existing query parameters from base URL
            const baseUrl = SCAN_BASE_URL.split('?')[0];
            const url = `${baseUrl}?mode=${mode}&serial=${encodeURIComponent(serial)}&color=${encodeURIComponent(color)}`;
            return url;
        }
        
        function formatTimestamp(timestampStr) {
            if (!timestampStr) return '';
            try {
                const date = new Date(timestampStr);
                if (isNaN(date.getTime())) return timestampStr;
                
                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                
                const dayName = days[date.getDay()];
                const day = date.getDate();
                const month = months[date.getMonth()];
                const year = date.getFullYear();
                
                // Get ordinal suffix (1st, 2nd, 3rd, 4th, etc.)
                const getOrdinal = (n) => {
                    const s = ['th', 'st', 'nd', 'rd'];
                    const v = n % 100;
                    return n + (s[(v - 20) % 10] || s[v] || s[0]);
                };
                
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                
                return `${dayName} ${getOrdinal(day)} ${month}, ${year} ${hours}${minutes}HRS`;
            } catch (e) {
                return timestampStr;
            }
        }
        
        function formatDateAndTime(dateStr, timeStr) {
            if (!dateStr) return 'N/A';
            try {
                // Handle time - could be Date object, string in various formats
                let normalizedTime = '';
                let hours = 0;
                let minutes = 0;
                let hasValidTime = false;
                
                if (timeStr) {
                    // If it's a Date object, extract hours and minutes
                    if (timeStr instanceof Date) {
                        hours = timeStr.getHours();
                        minutes = timeStr.getMinutes();
                        hasValidTime = hours !== 0 || minutes !== 0;
                        normalizedTime = String(hours).padStart(2, '0') + ':' + String(minutes).padStart(2, '0');
                    } else {
                        // It's a string - normalize it
                        normalizedTime = (timeStr || '').toString().trim();
                        
                        // Handle 24-hour format: could be "0024", "00:24", "14:30", "1430", etc.
                        if (normalizedTime.length === 4 && !normalizedTime.includes(':')) {
                            // Format: "0024" (4 digits, no colon)
                            hours = parseInt(normalizedTime.substring(0, 2), 10) || 0;
                            minutes = parseInt(normalizedTime.substring(2, 4), 10) || 0;
                            normalizedTime = String(hours).padStart(2, '0') + ':' + String(minutes).padStart(2, '0');
                        } else if (normalizedTime.includes(':')) {
                            // Format: "00:24" or "14:30"
                            const timeParts = normalizedTime.split(':');
                            hours = parseInt(timeParts[0], 10) || 0;
                            minutes = parseInt(timeParts[1], 10) || 0;
                        } else {
                            // Try to parse as number or other format
                            const numTime = parseInt(normalizedTime, 10);
                            if (!isNaN(numTime) && numTime >= 0 && numTime < 2400) {
                                hours = Math.floor(numTime / 100);
                                minutes = numTime % 100;
                                normalizedTime = String(hours).padStart(2, '0') + ':' + String(minutes).padStart(2, '0');
                            }
                        }
                        
                        // Check if time is valid (not midnight)
                        hasValidTime = normalizedTime !== '' && 
                                      normalizedTime !== '00:00' && 
                                      normalizedTime !== '0:00' && 
                                      (hours !== 0 || minutes !== 0);
                    }
                }
                
                // Try to parse date (could be YYYY-MM-DD or other formats)
                let date;
                
                // First, try to parse as YYYY-MM-DD format explicitly (most common from Google Sheets)
                if (typeof dateStr === 'string' && dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    // Explicit YYYY-MM-DD format - parse directly to avoid timezone issues
                    const dateParts = dateStr.split('-');
                    const year = parseInt(dateParts[0], 10);
                    const month = parseInt(dateParts[1], 10) - 1; // Month is 0-indexed
                    const day = parseInt(dateParts[2], 10);
                    
                    if (hasValidTime) {
                        date = new Date(year, month, day, hours, minutes);
                    } else {
                        date = new Date(year, month, day);
                    }
                } else if (dateStr instanceof Date) {
                    date = new Date(dateStr);
                    if (hasValidTime) {
                        date.setHours(hours, minutes, 0, 0);
                    }
                } else if (typeof dateStr === 'string' && (dateStr.includes('T') || dateStr.includes(' '))) {
                    // ISO format or date-time string - be careful with timezone
                    // Try to extract YYYY-MM-DD part first
                    const dateMatch = dateStr.match(/^(\d{4}-\d{2}-\d{2})/);
                    if (dateMatch) {
                        const dateParts = dateMatch[1].split('-');
                        const year = parseInt(dateParts[0], 10);
                        const month = parseInt(dateParts[1], 10) - 1;
                        const day = parseInt(dateParts[2], 10);
                        
                        if (hasValidTime) {
                            date = new Date(year, month, day, hours, minutes);
                        } else {
                            date = new Date(year, month, day);
                        }
                    } else {
                        // Fallback to Date constructor
                        date = new Date(dateStr);
                        if (hasValidTime && !isNaN(date.getTime())) {
                            date.setHours(hours, minutes, 0, 0);
                        }
                    }
                } else if (typeof dateStr === 'string') {
                    // Try to parse as YYYY-MM-DD format
                    const dateParts = dateStr.split('-');
                    if (dateParts.length === 3) {
                        const year = parseInt(dateParts[0], 10);
                        const month = parseInt(dateParts[1], 10) - 1;
                        const day = parseInt(dateParts[2], 10);
                        
                        if (!isNaN(year) && !isNaN(month) && !isNaN(day)) {
                            if (hasValidTime) {
                                date = new Date(year, month, day, hours, minutes);
                            } else {
                                date = new Date(year, month, day);
                            }
                        } else {
                            // Fallback
                            date = new Date(dateStr);
                        }
                    } else {
                        // Fallback
                        date = new Date(dateStr);
                    }
                } else {
                    // Fallback
                    date = new Date(dateStr);
                }
                
                if (isNaN(date.getTime())) {
                    // If parsing failed, return formatted date string if possible
                    if (dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                        const [year, month, day] = dateStr.split('-').map(Number);
                        const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                        const tempDate = new Date(year, month - 1, day);
                        if (!isNaN(tempDate.getTime())) {
                            const dayName = days[tempDate.getDay()];
                            const getOrdinal = (n) => {
                                const s = ['th', 'st', 'nd', 'rd'];
                                const v = n % 100;
                                return n + (s[(v - 20) % 10] || s[v] || s[0]);
                            };
                            return `${dayName} ${getOrdinal(day)} ${months[month - 1]}, ${year}`;
                        }
                    }
                    return dateStr + (hasValidTime ? ' ' + normalizedTime : '');
                }
                
                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                
                const dayName = days[date.getDay()];
                const day = date.getDate();
                const month = months[date.getMonth()];
                const year = date.getFullYear();
                
                const getOrdinal = (n) => {
                    const s = ['th', 'st', 'nd', 'rd'];
                    const v = n % 100;
                    return n + (s[(v - 20) % 10] || s[v] || s[0]);
                };
                
                // Only show time if it's valid and not midnight (00:00)
                if (hasValidTime && date.getHours() !== 0 || date.getMinutes() !== 0) {
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    return `${dayName} ${getOrdinal(day)} ${month}, ${year} ${hours}${minutes}HRS`;
                } else {
                    // Just show date without time
                    return `${dayName} ${getOrdinal(day)} ${month}, ${year}`;
                }
            } catch (e) {
                console.error('Error formatting date/time:', e, 'dateStr:', dateStr, 'timeStr:', timeStr);
                const normalizedTime = (timeStr || '').toString().trim();
                const hasValidTime = normalizedTime !== '' && normalizedTime !== '00:00' && normalizedTime !== '0:00';
                return dateStr + (hasValidTime ? ' ' + normalizedTime : '');
            }
        }
        
        function formatChangeHistory(changeHistory) {
            if (!changeHistory) return '';
            // Change history format: "2025-10-11T10:24:00Z - User: Updated ticket\n..." or "2025-10-11T10:24:00.000Z - User: Updated ticket\n..."
            const lines = changeHistory.split('\n');
            return lines.map(line => {
                if (!line.trim()) return line;
                
                // Try multiple timestamp patterns
                // Pattern 1: ISO with milliseconds: 2025-10-11T10:24:00.000Z
                let timestampMatch = line.match(/(\d{4}-\d{2}-\d{2}[T ]\d{2}:\d{2}:\d{2}\.\d{3}Z?)/);
                if (timestampMatch) {
                    const timestamp = timestampMatch[1];
                    const formatted = formatTimestamp(timestamp);
                    return line.replace(timestamp, formatted);
                }
                
                // Pattern 2: ISO without milliseconds: 2025-10-11T10:24:00Z
                timestampMatch = line.match(/(\d{4}-\d{2}-\d{2}[T ]\d{2}:\d{2}:\d{2}Z?)/);
                if (timestampMatch) {
                    const timestamp = timestampMatch[1];
                    const formatted = formatTimestamp(timestamp);
                    return line.replace(timestamp, formatted);
                }
                
                // Pattern 3: Date only: 2025-10-11
                timestampMatch = line.match(/(\d{4}-\d{2}-\d{2})(?![T ])/);
                if (timestampMatch) {
                    const dateStr = timestampMatch[1];
                    // Try to format as date
                    try {
                        const [year, month, day] = dateStr.split('-').map(Number);
                        const date = new Date(year, month - 1, day);
                        if (!isNaN(date.getTime())) {
                            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                            const dayName = days[date.getDay()];
                            const getOrdinal = (n) => {
                                const s = ['th', 'st', 'nd', 'rd'];
                                const v = n % 100;
                                return n + (s[(v - 20) % 10] || s[v] || s[0]);
                            };
                            const formatted = `${dayName} ${getOrdinal(day)} ${months[month - 1]}, ${year}`;
                            return line.replace(dateStr, formatted);
                        }
                    } catch (e) {
                        // If formatting fails, return line as-is
                    }
                }
                
                return line;
            }).join('\n');
        }

        // OPTIMIZED: Batch QR code rendering for better performance
        function renderTicketQRCodes(rootElement = document) {
            if (typeof QRCode === 'undefined') {
                console.error('❌ QRCode library not loaded!');
                return;
            }
            const elements = Array.from(rootElement.querySelectorAll('.ticket-qr'));
            const totalElements = elements.length;
            
            if (totalElements === 0) return;
            
            // Show loading indicator
            elements.forEach(container => {
                if (!container.querySelector('.qr-loading')) {
                    const loadingDiv = document.createElement('div');
                    loadingDiv.className = 'qr-loading';
                    loadingDiv.style.cssText = 'display: flex; align-items: center; justify-content: center; height: 100%; color: rgba(251, 191, 36, 0.6); font-size: 10px;';
                    loadingDiv.textContent = '⏳';
                    container.innerHTML = '';
                    container.appendChild(loadingDiv);
                }
            });
            
            // Batch processing configuration
            const BATCH_SIZE = 10; // Process 10 QR codes per frame
            let currentIndex = 0;
            let completedCount = 0;
            
            function processBatch() {
                const batchEnd = Math.min(currentIndex + BATCH_SIZE, totalElements);
                const batch = elements.slice(currentIndex, batchEnd);
                
                batch.forEach(container => {
                    const serial = container.dataset.serial;
                    const isDuplicate = container.dataset.duplicate === 'true';
                    const ticketColor = container.dataset.color || 'blue';
                    
                    if (!serial) {
                        container.innerHTML = '<span style="color: #fca5a5; font-size: 10px;">ERROR</span>';
                        completedCount++;
                        return;
                    }
                    
                    const mode = container.dataset.mode || (isDuplicate ? 'edit' : 'view');
                    const link = buildScanUrl(serial, mode, ticketColor);
                    
                    if (!link || link === '') {
                        console.error(`❌ Failed to generate URL for serial ${serial}`);
                        container.innerHTML = '<span style="color: #fca5a5; font-size: 10px;">QR ERROR</span>';
                        completedCount++;
                        return;
                    }
                    
                    const canvas = document.createElement('canvas');
                    QRCode.toCanvas(canvas, link, {
                        width: 140,
                        margin: 0,
                        color: {
                            dark: '#1a202c',
                            light: '#ffffff'
                        }
                    }, (error) => {
                        completedCount++;
                        if (error) {
                            console.error(`❌ QR code generation failed for ${serial}:`, error);
                            container.innerHTML = '<span style="color: #fca5a5; font-size: 10px;">ERROR</span>';
                            return;
                        }
                        canvas.style.width = '100%';
                        canvas.style.height = '100%';
                        container.innerHTML = '';
                        container.appendChild(canvas);
                        container.title = `Scan to ${mode === 'view' ? 'view' : 'edit'} ${serial}`;
                    });
                });
                
                currentIndex = batchEnd;
                
                // Continue with next batch if there are more elements
                if (currentIndex < totalElements) {
                    requestAnimationFrame(processBatch);
                } else if (completedCount === totalElements) {
                }
            }
            
            // Start batch processing
            requestAnimationFrame(processBatch);
        }

        function createTicketHTML(serialNum, color, isDuplicate, data = {}, qrMode = 'edit') {
            const serialValue = typeof serialNum === 'number' ? formatSerial(serialNum) : (serialNum || '');
            const ticketColor = data.color || color;
            const duplicateBadge = isDuplicate ? '<span class="duplicate-label">DUPLICATE</span>' : '';
            const bandingSelections = new Set((data.bandingType || []).map(value => value.toLowerCase()));
            const productSelections = new Set((Array.isArray(data.productType) ? data.productType : (data.productType ? [data.productType] : [])).map(value => String(value).toLowerCase()));
            const palletSelections = new Set((data.palletSize || []).map(value => value.toLowerCase()));

            const renderFieldValue = (value) => {
                const content = value !== undefined && value !== null && value !== ''
                    ? escapeHtml(String(value))
                    : '';
                const filledClass = content ? ' filled' : '';
                return `<span class="field-value${filledClass}">${content ? `<span>${content}</span>` : ''}</span>`;
            };

            return `
                <div class="ticket-column">
                    <div class="ticket ${ticketColor} ${isDuplicate ? 'duplicate' : ''}">
                            <div class="ticket-header">Promotion Items · Finished Goods</div>
                        <div class="serial-wrapper">
                            <div class="serial-number">
                                <span>${serialValue}</span>
                                ${duplicateBadge}
                        </div>
                            <div class="ticket-qr" data-serial="${serialValue}" data-duplicate="${isDuplicate}" data-mode="${qrMode}" data-color="${ticketColor}"></div>
                        </div>
                        <div class="ticket-body">
                            <div class="field-row">
                                <div class="field-group">
                                    <span class="field-label">Date:</span>
                                    ${renderFieldValue(data.date)}
                                </div>
                                <div class="field-group">
                                    <span class="field-label">Time:</span>
                                    ${renderFieldValue(data.time)}
                                </div>
                            </div>
                            
                            <div class="field-row">
                                <div class="field-group">
                                    <span class="field-label">SKU:</span>
                                    ${renderFieldValue(data.sku)}
                                </div>
                            </div>
                            
                            <div class="field-row">
                                <div class="field-group">
                                    <span class="field-label">Qty:</span>
                                    ${renderFieldValue(data.qty)}
                                </div>
                                <div class="field-group">
                                    <span class="field-label">Layers:</span>
                                    ${renderFieldValue(data.layers)}
                                </div>
                            </div>
                            <div class="checkbox-columns">
                                <div class="checkbox-column">
                                    <div class="checkbox-column-title">Banding Type</div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="online_${serialNum}_${isDuplicate}" ${bandingSelections.has('online') ? 'checked' : ''}>
                                        <label for="online_${serialNum}_${isDuplicate}">Online</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="offline_${serialNum}_${isDuplicate}" ${bandingSelections.has('offline') ? 'checked' : ''}>
                                        <label for="offline_${serialNum}_${isDuplicate}">Offline</label>
                                    </div>
                                </div>
                                <div class="checkbox-column">
                                    <div class="checkbox-column-title">Product Type</div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="fg1_${serialNum}_${isDuplicate}" ${productSelections.has('1kg') ? 'checked' : ''}>
                                        <label for="fg1_${serialNum}_${isDuplicate}">1kg</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="fg05_${serialNum}_${isDuplicate}" ${productSelections.has('0.5kg') || productSelections.has('05kg') ? 'checked' : ''}>
                                        <label for="fg05_${serialNum}_${isDuplicate}">0.5kg</label>
                                    </div>
                                </div>
                                <div class="checkbox-column pallet">
                                    <div class="checkbox-column-title">Pallet Size</div>
                                    <div class="checkbox-items">
                                    <div class="checkbox-item">
                                            <input type="checkbox" id="p78_${serialNum}_${isDuplicate}" ${palletSelections.has('78') ? 'checked' : ''}>
                                        <label for="p78_${serialNum}_${isDuplicate}">78</label>
                                    </div>
                                    <div class="checkbox-item">
                                            <input type="checkbox" id="p105_${serialNum}_${isDuplicate}" ${palletSelections.has('105') ? 'checked' : ''}>
                                        <label for="p105_${serialNum}_${isDuplicate}">105</label>
                                    </div>
                                    <div class="checkbox-item">
                                            <input type="checkbox" id="p64_${serialNum}_${isDuplicate}" ${palletSelections.has('64') ? 'checked' : ''}>
                                        <label for="p64_${serialNum}_${isDuplicate}">64</label>
                                    </div>
                                    <div class="checkbox-item">
                                            <input type="checkbox" id="p100_${serialNum}_${isDuplicate}" ${palletSelections.has('100') ? 'checked' : ''}>
                                        <label for="p100_${serialNum}_${isDuplicate}">100</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="ticket-footer">RetiFlux™ Powered by NexGridCore DataLabs</div>
                    </div>
                </div>
            `;
        }

        // Google Sheets API Functions - Using Apps Script with CACHING
        async function readTicketFromSheet(serial, useCache = true) {
            if (!GOOGLE_APPS_SCRIPT_URL) {
                throw new Error('Google Apps Script URL not configured');
            }
            
            // Check cache first
            const cacheKey = `ticket_${serial}`;
            if (useCache) {
                const cached = getCachedRequest(cacheKey);
                if (cached !== null) {
                    return cached;
                }
            }
            
            try {
                const ctrl = new AbortController();
                const t = setTimeout(function() { ctrl.abort(); }, API_TIMEOUT_MS);
                const url = `${GOOGLE_APPS_SCRIPT_URL}?action=read&serial=${encodeURIComponent(serial)}`;
                const response = await fetch(url, { signal: ctrl.signal });
                clearTimeout(t);
                if (!response.ok) {
                    throw new Error(`Failed to read ticket: ${response.statusText}`);
                }
                const result = await response.json();
                if (!result.success) {
                    // If ticket not found, return null instead of throwing error
                    if (result.error && result.error.includes('not found')) {
                        return null;
                    }
                    throw new Error(result.error || 'Failed to read ticket');
                }
                if (!result.data) {
                    return null;
                }
                
                const ticket = result.data;
                if (result.pallet) {
                    ticket.pallet = result.pallet;
                }
                
                // Normalize field names - handle case variations and ensure Date/Time are correctly mapped
                // Google Sheets might return headers with different casing
                const normalizedTicket = {};
                
                // First, copy all original fields
                Object.keys(ticket).forEach(key => {
                    normalizedTicket[key] = ticket[key];
                });
                
                // Then normalize specific fields we need
                Object.keys(ticket).forEach(key => {
                    const normalizedKey = key.toLowerCase().trim();
                    
                    // Map Date field (column B) - try all variations
                    if (normalizedKey === 'date') {
                        normalizedTicket.Date = ticket[key];
                    }
                    // Map Time field (column C) - try all variations
                    else if (normalizedKey === 'time') {
                        normalizedTicket.Time = ticket[key];
                    }
                    // Map SachetType and TabletType
                    else if (normalizedKey === 'sachettype' || normalizedKey === 'sachet type') {
                        normalizedTicket.SachetType = ticket[key];
                    } else if (normalizedKey === 'tablettype' || normalizedKey === 'tablet type') {
                        normalizedTicket.TabletType = ticket[key];
                    }
                });
                
                // Ensure Date and Time are accessible with multiple fallbacks
                // Try direct access first, then normalized
                if (!normalizedTicket.Date) {
                    normalizedTicket.Date = ticket.Date || ticket['Date'] || ticket.date || ticket.DATE || '';
                }
                if (!normalizedTicket.Time) {
                    normalizedTicket.Time = ticket.Time || ticket['Time'] || ticket.time || ticket.TIME || '';
                }
                
                // Convert Date and Time from ISO strings to proper format
                // Date comes as ISO string like "2025-11-14T21:00:00.000Z" - extract just the date part
                // Time comes as ISO string like "1899-12-30T18:50:44.000Z" - extract just the time part
                // (1899-12-30 is Excel/Sheets epoch for time-only values)
                if (normalizedTicket.Date) {
                    try {
                        const dateObj = new Date(normalizedTicket.Date);
                        if (!isNaN(dateObj.getTime())) {
                            // Extract YYYY-MM-DD format
                            const year = dateObj.getFullYear();
                            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                            const day = String(dateObj.getDate()).padStart(2, '0');
                            normalizedTicket.Date = `${year}-${month}-${day}`;
                        }
                    } catch (e) {
                        // Silently handle date parsing errors
                    }
                }
                
                if (normalizedTicket.Time) {
                    try {
                        const timeObj = new Date(normalizedTicket.Time);
                        if (!isNaN(timeObj.getTime())) {
                            // Extract HH:MM format (24-hour)
                            const hours = String(timeObj.getHours()).padStart(2, '0');
                            const minutes = String(timeObj.getMinutes()).padStart(2, '0');
                            normalizedTicket.Time = `${hours}:${minutes}`;
                        }
                    } catch (e) {
                        // Silently handle time parsing errors
                    }
                }
                
                // Ensure SachetType and TabletType are accessible
                if (ticket.SachetType !== undefined) normalizedTicket.SachetType = ticket.SachetType;
                if (ticket['Sachet Type'] !== undefined) normalizedTicket.SachetType = ticket['Sachet Type'];
                if (ticket.TabletType !== undefined) normalizedTicket.TabletType = ticket.TabletType;
                if (ticket['Tablet Type'] !== undefined) normalizedTicket.TabletType = ticket['Tablet Type'];
                
                // Parse JSON fields
                if (normalizedTicket.MerchHistory) {
                    try {
                        normalizedTicket.MerchHistory = typeof normalizedTicket.MerchHistory === 'string' ? JSON.parse(normalizedTicket.MerchHistory) : normalizedTicket.MerchHistory;
                    } catch (e) {
                        normalizedTicket.MerchHistory = [];
                    }
                }
                
                // Merge normalized fields back
                Object.assign(ticket, normalizedTicket);
                
                // Cache the result
                if (useCache) {
                    setCachedRequest(cacheKey, ticket);
                }
                
                return ticket;
            } catch (error) {
                throw error;
            }
        }
        
        async function saveTicketToSheet(ticketData, isUpdate = false, existingTicket = null) {
            if (!GOOGLE_APPS_SCRIPT_URL) {
                throw new Error('Google Apps Script URL not configured');
            }
            
            // Clear cache for this ticket after save
            const serial = ticketData.serial;
            if (serial) {
                clearCache(`ticket_${serial}`);
            }
            
            const timestamp = new Date().toISOString();
            const changeEntry = `${timestamp} - ${ticketData.modifiedBy || 'System'}: ${isUpdate ? 'Updated ticket' : 'Created ticket'}`;
            
            // Fix timestamps: CreatedAt, FirstModified, LastModified should be different
            let createdAt, firstModified, lastModified;
            if (isUpdate && existingTicket) {
                // Update: preserve original timestamps, update lastModified
                createdAt = existingTicket.CreatedAt || timestamp;
                // If FirstModified is empty or same as CreatedAt, set it now (first update)
                if (!existingTicket.FirstModified || existingTicket.FirstModified === existingTicket.CreatedAt) {
                    firstModified = timestamp; // First modification
                } else {
                    firstModified = existingTicket.FirstModified; // Preserve original first modification
                }
                lastModified = timestamp; // Always update last modified
            } else {
                // New ticket: all timestamps are the same initially
                createdAt = timestamp;
                firstModified = timestamp; // Will be updated on first modification
                lastModified = timestamp;
            }
            
            const row = [
                ticketData.serial,
                ticketData.date || '',
                ticketData.time || '',
                ticketData.sku || '',
                ticketData.qty || '',
                ticketData.layers || '',
                (ticketData.bandingType || []).join(','),
                ticketData.productType || '',
                (ticketData.palletSize || []).join(','),
                ticketData.notes || '',
                ticketData.qualityIssueType || '',
                ticketData.qualityIssueDesc || '',
                ticketData.groupLeader || '',
                ticketData.sachetType || '',
                ticketData.tabletType || '',
                ticketData.uom || '',
                JSON.stringify(ticketData.merchHistory || []),
                createdAt,
                firstModified,
                lastModified,
                isUpdate ? (existingTicket?.ChangeHistory || '') + '\n' + changeEntry : changeEntry,
                ticketData.modifiedBy || 'System'
            ];
            
            try {
                // Use GET requests instead of POST to avoid CORS issues
                // Since GET works, we'll use it for writes too
                const serial = ticketData.serial;
                
                // Build query parameters - include productType and oldQty for calculations
                const oldQty = isUpdate && existingTicket ? (existingTicket.Qty || '0') : '0';
                const productType = Array.isArray(ticketData.productType) ? (ticketData.productType || []).join(',') : (ticketData.productType || '');
                
                const params = new URLSearchParams({
                    action: isUpdate ? 'update' : 'append',
                    serial: serial,
                    values: JSON.stringify(row),
                    sku: ticketData.sku || '',
                    qty: ticketData.qty || '',
                    oldQty: oldQty,
                    productType: productType
                });
                
                const url = `${GOOGLE_APPS_SCRIPT_URL}?${params.toString()}`;
                
                let response;
                try {
                    response = await fetch(url, {
                        method: 'GET',
                        headers: { 'Accept': 'application/json' }
                    });
                } catch (fetchError) {
                    console.error('Fetch error:', fetchError);
                    throw new Error(`Failed to connect to Apps Script: ${fetchError.message}. Please check:\n1. Apps Script URL is correct\n2. Apps Script is deployed with "Anyone" access\n3. Your internet connection is stable`);
                }
                
                if (!response.ok) {
                    const errorText = await response.text().catch(() => 'Unknown error');
                    throw new Error(`Failed to save: ${response.status} ${response.statusText}. Response: ${errorText.substring(0, 200)}`);
                }
                
                // Get response as text first, then parse
                const responseText = await response.text();
                
                // Check if Apps Script returned the raw form data (indicates it didn't process)
                if (responseText.startsWith('data=') || responseText.includes('%7B')) {
                    console.error('Apps Script appears to be returning raw request data instead of processing it');
                    throw new Error(`Apps Script error: The script is not processing the request correctly. It returned: "${responseText.substring(0, 100)}". Please check:\n1. Apps Script is deployed as a Web App (not API Executable)\n2. The doPost function exists in your Apps Script\n3. You've updated the Apps Script with the latest code\n4. Check Apps Script execution logs for errors`);
                }
                
                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (parseError) {
                    // If parsing fails, the response might be the form data itself
                    console.error('Failed to parse response as JSON:', parseError);
                    console.error('Full response text:', responseText);
                    throw new Error(`Invalid response from Apps Script. Expected JSON but got: "${responseText.substring(0, 200)}". Please check your Apps Script deployment and code.`);
                }
                
                if (!result.success) {
                    throw new Error(result.error || 'Failed to save ticket');
                }
                
                return result;
            } catch (error) {
                console.error('Error saving ticket:', error);
                // Provide more helpful error message
                if (error.message.includes('fetch') || error.message.includes('Failed to fetch')) {
                    throw new Error(`Network error: Failed to connect to Google Apps Script.\n\nPlease check:\n1. Apps Script is deployed with "Anyone, even anonymous" access\n2. The Apps Script URL is correct\n3. Your internet connection is stable\n\nOriginal error: ${error.message}`);
                }
                throw error;
            }
        }
        
        async function testGoogleSheetsConnection() {
            // SECURITY: Require password to test connection
            const password = prompt('🔐 Test Connection - Password Required\n\nEnter password to test Google Sheets connection:');
            if (password !== GENERATOR_PASSWORD) {
                if (password !== null) {
                    alert('❌ Incorrect password. Access denied.');
                }
                return;
            }
            
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = '<div style="color: #667eea;">🔄 Testing connection...</div>';
            
            const tests = [];
            
            // Test 1: Read headers
            try {
                const readUrl = `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_SHEET_ID}/values/Tickets!A1:S1?key=${GOOGLE_API_KEY}`;
                const readResponse = await fetch(readUrl);
                if (readResponse.ok) {
                    const data = await readResponse.json();
                    tests.push({ name: '✅ Read Headers', status: 'success', details: `Found ${data.values?.[0]?.length || 0} columns` });
                } else {
                    const error = await readResponse.json().catch(() => ({}));
                    tests.push({ name: '❌ Read Headers', status: 'error', details: error.error?.message || readResponse.statusText });
                }
            } catch (e) {
                tests.push({ name: '❌ Read Headers', status: 'error', details: e.message });
            }
            
            // Test 2: Write test (append a test row)
            try {
                const testRow = [['TEST-' + Date.now(), new Date().toISOString().split('T')[0], '00:00', 'TEST-SKU', '1', '1', 'online', '1kg', '78', 'Test entry - can be deleted', '', '', '', '[]', new Date().toISOString(), new Date().toISOString(), new Date().toISOString(), 'Test', 'System']];
                const appendUrl = `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_SHEET_ID}/values/Tickets!A2:append?valueInputOption=RAW&insertDataOption=INSERT_ROWS&key=${GOOGLE_API_KEY}`;
                const appendResponse = await fetch(appendUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ values: testRow })
                });
                
                if (appendResponse.ok) {
                    tests.push({ name: '✅ Write Test', status: 'success', details: 'Successfully wrote test row to sheet!' });
                } else {
                    const error = await appendResponse.json().catch(() => ({}));
                    const errorMsg = error.error?.message || appendResponse.statusText;
                    tests.push({ name: '❌ Write Test', status: 'error', details: errorMsg });
                }
            } catch (e) {
                tests.push({ name: '❌ Write Test', status: 'error', details: e.message });
            }
            
            // Test 3: Check sheet sharing
            try {
                const metaUrl = `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_SHEET_ID}?key=${GOOGLE_API_KEY}`;
                const metaResponse = await fetch(metaUrl);
                if (metaResponse.ok) {
                    const meta = await metaResponse.json();
                    tests.push({ name: '✅ Sheet Access', status: 'success', details: `Sheet: "${meta.properties?.title || 'Unknown'}"` });
                } else {
                    tests.push({ name: '❌ Sheet Access', status: 'error', details: 'Cannot access sheet metadata' });
                }
            } catch (e) {
                tests.push({ name: '❌ Sheet Access', status: 'error', details: e.message });
            }
            
            // Display results
            const allPassed = tests.every(t => t.status === 'success');
            resultsDiv.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 10px; color: ${allPassed ? '#10b981' : '#ef4444'};">
                    ${allPassed ? '✅ All Tests Passed!' : '❌ Some Tests Failed'}
                </div>
                ${tests.map(t => `
                    <div style="margin: 5px 0; padding: 8px; background: ${t.status === 'success' ? '#f0fdf4' : '#fef2f2'}; border-left: 3px solid ${t.status === 'success' ? '#10b981' : '#ef4444'};">
                        <strong>${t.name}</strong><br>
                        <small style="color: #666;">${t.details}</small>
                    </div>
                `).join('')}
                ${!allPassed ? `
                    <div style="margin-top: 15px; padding: 10px; background: #fef3c7; border-radius: 5px; font-size: 11px;">
                        <strong>💡 Troubleshooting Tips:</strong><br>
                        1. Configure OAuth consent screen in Google Cloud Console<br>
                        2. Share sheet: "Anyone with the link" → "Editor"<br>
                        3. Enable Google Sheets API in Google Cloud Console<br>
                        4. Check API key restrictions include Google Sheets API
                    </div>
                ` : ''}
            `;
        }
        
        async function loadAuthorizedUsers() {
            if (!GOOGLE_APPS_SCRIPT_URL) return { users: [], skus: [], sachetTypes: [], tabletTypes: [] };
            try {
                const ctrl = new AbortController();
                const timeout = 30000;
                const t = setTimeout(function() { ctrl.abort(); }, timeout);
                const url = `${GOOGLE_APPS_SCRIPT_URL}?action=users`;
                const response = await fetch(url, { signal: ctrl.signal });
                clearTimeout(t);
                if (!response.ok) return { users: [], skus: [], sachetTypes: [], tabletTypes: [] };
                const result = await response.json();
                if (!result.success) return { users: [], skus: [], sachetTypes: [], tabletTypes: [] };
                return {
                    users: result.data || [],
                    skus: result.skus || [],
                    sachetTypes: result.sachetTypes || [],
                    tabletTypes: result.tabletTypes || []
                };
            } catch (error) {
                if (error?.name !== 'AbortError') console.error('Error loading users:', error);
                return { users: [], skus: [], sachetTypes: [], tabletTypes: [] };
            }
        }

        async function loadSkusFromZoneMapping() {
            if (!GOOGLE_APPS_SCRIPT_URL) return [];
            try {
                const ctrl = new AbortController();
                const timeout = 30000;
                const t = setTimeout(function() { ctrl.abort(); }, timeout);
                const url = `${GOOGLE_APPS_SCRIPT_URL}?action=getSkus`;
                const response = await fetch(url, { signal: ctrl.signal });
                clearTimeout(t);
                if (!response.ok) return [];
                const result = await response.json();
                if (!result.success) return [];
                return result.skus || [];
            } catch (error) {
                if (error?.name !== 'AbortError') console.error('Error loading SKUs:', error);
                return [];
            }
        }

        const skuProductInfoCache = new Map();
        const SKU_INFO_CACHE_TTL = 5 * 60 * 1000;
        async function loadSkuProductInfo(sku) {
            if (!GOOGLE_APPS_SCRIPT_URL || !sku) return { productType: '', sachetType: '', tabletType: '', uom: '' };
            const cached = skuProductInfoCache.get(sku);
            if (cached && Date.now() - cached.t < SKU_INFO_CACHE_TTL) return cached.v;
            try {
                const ctrl = new AbortController();
                const t = setTimeout(function() { ctrl.abort(); }, API_TIMEOUT_MS);
                const url = `${GOOGLE_APPS_SCRIPT_URL}?action=getSkuProductInfo&sku=${encodeURIComponent(sku)}`;
                const response = await fetch(url, { signal: ctrl.signal });
                clearTimeout(t);
                if (!response.ok) return { productType: '', sachetType: '', tabletType: '', uom: '' };
                const result = await response.json();
                if (!result.success || !result.info) return { productType: '', sachetType: '', tabletType: '', uom: '' };
                const info = result.info;
                skuProductInfoCache.set(sku, { v: info, t: Date.now() });
                return info;
            } catch (error) {
                console.error('Error loading SKU info:', error);
                return { productType: '', sachetType: '', tabletType: '', uom: '' };
            }
        }
        
        function populateDropdown(selectId, options, placeholder = 'Select...') {
            const select = document.getElementById(selectId);
            if (!select) return;
            select.innerHTML = `<option value="">${placeholder}</option>`;
            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                select.appendChild(option);
            });
        }
        
        function populateSKUDropdown(skus) {
            const skuSelect = document.getElementById('fillSku');
            const skuCustom = document.getElementById('fillSkuCustom');
            
            if (!skuSelect) return;
            
            // Clear existing options - SKUs from SKUZoneMapping only
            skuSelect.innerHTML = '<option value="">Select SKU...</option>';
            
            // Add SKUs from SKUZoneMapping
            (skus || []).forEach(sku => {
                const option = document.createElement('option');
                option.value = sku;
                option.textContent = sku;
                skuSelect.appendChild(option);
            });
            
            // Hide custom SKU input - not used anymore
            if (skuCustom) skuCustom.style.display = 'none';
            
            // On SKU select: load product info and auto-fill read-only fields
            if (!skuSelect.dataset.skuChangeBound) {
                skuSelect.dataset.skuChangeBound = '1';
                skuSelect.addEventListener('change', async function() {
                const val = this.value;
                if (!val) {
                    document.getElementById('productTypeDisplay').textContent = '— Select SKU first';
                    document.getElementById('productTypeHidden').value = '';
                    document.getElementById('sachetTypeDisplay').textContent = '—';
                    document.getElementById('sachetTypeHidden').value = '';
                    document.getElementById('tabletTypeDisplay').textContent = '—';
                    document.getElementById('tabletTypeHidden').value = '';
                    document.getElementById('uomDisplay').textContent = '—';
                    document.getElementById('uomHidden').value = '';
                    return;
                }
                const info = await loadSkuProductInfo(val);
                document.getElementById('productTypeDisplay').textContent = info.productType || '—';
                document.getElementById('productTypeHidden').value = info.productType || '';
                document.getElementById('sachetTypeDisplay').textContent = info.sachetType || '—';
                document.getElementById('sachetTypeHidden').value = info.sachetType || '';
                document.getElementById('tabletTypeDisplay').textContent = info.tabletType || '—';
                document.getElementById('tabletTypeHidden').value = info.tabletType || '';
                document.getElementById('uomDisplay').textContent = info.uom || '—';
                document.getElementById('uomHidden').value = info.uom || '';
                });
            }
            
            // Keep custom input handling for backwards compat (hidden)
            if (skuCustom) {
                skuCustom.addEventListener('input', function() {
                    if (this.value) {
                        skuSelect.value = '';
                    }
                });
                
                skuCustom.addEventListener('blur', function() {
                    if (!this.value) {
                        this.style.display = 'none';
                        skuSelect.style.display = 'block';
                    }
                });
            }
        }

        /** Populate ALL user dropdowns: loginUser (edit card), movementLoginUser, bcLoginUser */
        function populateAuthorizedUserSelects(users) {
            const opts = (users && users.length)
                ? '<option value="">Select authorized user...</option>' +
                  users.map(function(u) {
                      var id = (u.id || u.name || '').toString();
                      var name = (u.name || u.id || id).toString();
                      return '<option value="' + escapeHtml(id) + '">' + escapeHtml(name) + '</option>';
                  }).join('')
                : '<option value="">No users found — check Authorized Users sheet</option>';
            ['loginUser', 'movementLoginUser', 'bcLoginUser'].forEach(function(id) {
                var el = document.getElementById(id);
                if (el) el.innerHTML = opts;
            });
        }

        async function authenticateUser(userId, passcode) {
            if (!GOOGLE_APPS_SCRIPT_URL) {
                throw new Error('Apps Script URL not configured');
            }
            const url = `${GOOGLE_APPS_SCRIPT_URL}?action=login&userId=${encodeURIComponent(userId)}&passcode=${encodeURIComponent(passcode)}`;
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`Login failed: ${response.statusText}`);
            }
            const result = await response.json();
            if (!result.success) {
                throw new Error(result.error || 'Invalid credentials');
            }
            return result.data;
        }

        /**
         * Shared login wrapper used by movement and bin-cards overlays.
         * Returns { success: true, user } or { success: false, message }.
         * options.persist: when false, does not save to localStorage (session-only; used for movement/bin cards).
         */
        async function verifyUserLogin(userId, passcode, options) {
            try {
                const userData = await authenticateUser(userId, passcode);
                const user = {
                    id:   userData.id   || userId,
                    name: userData.name || userId,
                    role: userData.role || ''
                };
                setLoggedInUser(user, options && options.persist === false ? false : true);
                return { success: true, user };
            } catch (err) {
                return { success: false, message: err.message || 'Incorrect passcode.' };
            }
        }

        async function showLoginCard() {
            showRetifluxLoadingOverlay();
            try {
                const loginCard = document.getElementById('loginCard');
                const editCard = document.getElementById('editCard');
                if (loginCard) { loginCard.style.display = 'block'; loginCard.classList.add('fade-in', 'fill-card-active'); }
                if (editCard) { editCard.style.display = 'none'; editCard.classList.remove('fill-card-active'); }
                const banner = document.getElementById('loggedInUserBanner');
                if (banner) banner.style.display = 'none';
                if (!authorizedUsersLoaded) {
                    const loginSelect = document.getElementById('loginUser');
                    if (loginSelect && loginSelect.options.length <= 1) {
                        const { users } = await loadAuthorizedUsers();
                        populateAuthorizedUserSelects(users);
                        authorizedUsersLoaded = true;
                    }
                }
            } finally {
                setTimeout(hideRetifluxLoadingOverlay, 120);
            }
        }

        // Called from the "Authorized Access" button in view mode.
        // Shows the login card as a modal overlay without leaving the view page.
        async function showViewModeLogin() {
            if (!authorizedUsersLoaded) {
                const { users } = await loadAuthorizedUsers();
                populateAuthorizedUserSelects(users);
                authorizedUsersLoaded = true;
            }
            // Reuse the loginCard but show it as an overlay on top of the viewCard
            const loginCard = document.getElementById('loginCard');
            if (loginCard) {
                loginCard.style.display = 'block';
                loginCard.style.position = 'fixed';
                loginCard.style.top = '50%';
                loginCard.style.left = '50%';
                loginCard.style.transform = 'translate(-50%, -50%)';
                loginCard.style.zIndex = '9999';
                loginCard.style.maxWidth = '420px';
                loginCard.style.width = '90%';
                loginCard.style.boxShadow = '0 24px 80px rgba(0,0,0,0.7)';
            }
        }

        function closeEditFormToHome() {
            window.location.href = new URL('index.html', window.location.href).href;
        }

        function closeLoginCard() {
            if (currentMode === 'view') {
                closeViewModeLogin();
            } else if (currentMode === 'edit' || currentMode === 'fill') {
                const serial = typeof initialSerialParam !== 'undefined' ? initialSerialParam : (new URLSearchParams(window.location.search).get('serial') || '');
                const color = urlColorParam || 'blue';
                const params = new URLSearchParams(window.location.search);
                const qs = new URLSearchParams({ mode: 'view', serial: serial || formatSerial(currentSerial), color: color });
                if (params.get('geofence') === 'bypass' && params.get('t')) {
                    qs.set('geofence', 'bypass');
                    qs.set('t', params.get('t'));
                }
                window.location.href = `${window.location.pathname}?${qs.toString()}`;
            } else {
                showEditCard();
            }
        }

        // Called after a successful login when in view mode — close overlay and reveal movement
        function closeViewModeLogin() {
            showRetifluxLoadingOverlay();
            const loginCard = document.getElementById('loginCard');
            if (loginCard) {
                loginCard.style.display = 'none';
                loginCard.style.position = '';
                loginCard.style.top = '';
                loginCard.style.left = '';
                loginCard.style.transform = '';
                loginCard.style.zIndex = '';
                loginCard.style.maxWidth = '';
                loginCard.style.width = '';
                loginCard.style.boxShadow = '';
            }
            setTimeout(hideRetifluxLoadingOverlay, 120);
        }

        function showEditCard() {
            showRetifluxLoadingOverlay();
            const loginCard = document.getElementById('loginCard');
            const editCard = document.getElementById('editCard');
            if (loginCard) { loginCard.style.display = 'none'; loginCard.classList.remove('fill-card-active'); }
            if (editCard) { editCard.style.display = 'block'; editCard.classList.add('fade-in', 'fill-card-active'); }
            updateLoggedInUserBanner();
            setTimeout(hideRetifluxLoadingOverlay, 120);
        }

        async function handleLoginSubmit(event) {
            event.preventDefault();
            const loginStatus = document.getElementById('loginStatus');
            if (loginStatus) {
                loginStatus.textContent = '🔐 Verifying credentials...';
                loginStatus.classList.remove('error', 'success');
            }
            const userId = document.getElementById('loginUser')?.value;
            const passcode = document.getElementById('loginPasscode')?.value;
            if (!userId || !passcode) {
                if (loginStatus) {
                    loginStatus.textContent = '❌ Select a user and enter the passcode.';
                    loginStatus.classList.add('error');
                }
                return;
            }
            try {
                const userData = await authenticateUser(userId, passcode);
                setLoggedInUser({
                    id: userData.id || userId,
                    name: userData.name || userId,
                    role: userData.role || '',
                    loginAt: new Date().toISOString()
                });
                document.getElementById('loginPasscode').value = '';
                if (currentMode === 'view') {
                    // In view mode: close the login overlay, re-render ticket with full cards, update banner
                    closeViewModeLogin();
                    updateLoggedInUserBanner();
                    await refreshViewTicket();
                    showToast(`Signed in as ${userData.name || userId}. Full ticket details and Stock Movement Control are now available.`, 'success', 5000);
                } else {
                    showEditCard();
                    updateLoggedInUserBanner();
                }
                if (loginStatus) {
                    loginStatus.textContent = '✅ Login successful. Editor unlocked.';
                    loginStatus.classList.add('success');
                }
            } catch (error) {
                if (loginStatus) {
                    loginStatus.textContent = `❌ ${error.message}`;
                    loginStatus.classList.add('error');
                }
            }
        }
        
        // SKU Calculations are now handled automatically by Apps Script
        async function updateSKUCalculations(sku, qty) {
            // This function is kept for compatibility but calculations are handled by Apps Script
            // when saving tickets (see saveTicketToSheet function)
        }
        
        // View Mode Functions - witty heading (rotates on refresh, corporate-friendly)
        let viewHeadingIdx = 0;
        const VIEW_HEADING_PHRASES = [
            s => `⬥ Your ticket has arrived — ready when you are. Viewing: ${s}`,
            s => `⬥ Ticket loaded and ready to roll. Viewing: ${s}`,
            s => `⬥ Everything you need for ${s}, right here.`,
            s => `⬥ Here's what you're looking for. Serial: ${s}`,
            s => `⬥ Ticket ${s} — ready for the spotlight.`
        ];
        function advanceViewHeading() {
            const el = document.getElementById('viewRotatingHeading');
            const serialEl = document.getElementById('viewSerialDisplay');
            if (!el || !serialEl) return;
            const serial = serialEl.textContent.trim() || '—';
            el.textContent = VIEW_HEADING_PHRASES[viewHeadingIdx](serial);
            viewHeadingIdx = (viewHeadingIdx + 1) % VIEW_HEADING_PHRASES.length;
        }
        function startViewHeadingRotation() {
            advanceViewHeading();
        }
        function stopViewHeadingRotation() {
            viewHeadingIdx = 0;
        }
        
        async function initViewMode(serial) {
            document.body.classList.add('fill-mode-active');
            const fillContainer = document.getElementById('fillContainer');
            if (fillContainer) {
                fillContainer.classList.add('visible');
            }
            // Movement section only visible to logged-in authorized users in view mode
            // updateLoggedInUserBanner() will show/hide it based on login state
            
            const viewCard = document.getElementById('viewCard');
            const editCard = document.getElementById('editCard');
            if (viewCard) viewCard.style.display = 'block';
            if (editCard) editCard.style.display = 'none';
            // Preview is now in modal - no longer needed here
            
            const serialValue = serial ? decodeURIComponent(serial) : formatSerial(currentSerial);
            const viewSerialDisplay = document.getElementById('viewSerialDisplay');
            if (viewSerialDisplay) {
                viewSerialDisplay.textContent = serialValue;
            }
            
            // Prevent back navigation - replace current history entry
            window.history.replaceState(null, '', window.location.href);
            
            // Block back button/swipe back
            window.addEventListener('popstate', (e) => {
                // Prevent going back to generator page
                window.history.pushState(null, '', window.location.href);
            });
            
            // Push a state to prevent back navigation
            window.history.pushState(null, '', window.location.href);
            
            const viewLoading = document.getElementById('viewLoading');
            const viewData = document.getElementById('viewData');
            showRetifluxLoadingOverlay();
            try {
                // Ensure ZoneConfig is loaded for status lookup
                if (!movementZones || movementZones.length === 0) {
                    try {
                        const result = await callAppsScript(new URLSearchParams({ action: 'getZoneConfig' }));
                        const allZones = (result.zones || []).filter(zone => zone.ZoneName);
                        // Deduplicate zones (case-insensitive)
                        const zoneMap = new Map();
                        allZones.forEach(zone => {
                            const normalizedName = (zone.ZoneName || '').trim();
                            if (!normalizedName) return;
                            const existingKey = Array.from(zoneMap.keys()).find(
                                key => key.toLowerCase() === normalizedName.toLowerCase()
                            );
                            if (existingKey) {
                                const existing = zoneMap.get(existingKey);
                                if (normalizedName === existingKey || normalizedName.length < existingKey.length) {
                                    zoneMap.delete(existingKey);
                                    zoneMap.set(normalizedName, { ...zone, ZoneName: normalizedName });
                                }
                            } else {
                                zoneMap.set(normalizedName, { ...zone, ZoneName: normalizedName });
                            }
                        });
                        movementZones = Array.from(zoneMap.values());
                    } catch (zoneError) {
                        // ZoneConfig optional for status lookup
                    }
                }
                
                const ticket = await readTicketFromSheet(serialValue);
                if (viewLoading) viewLoading.style.display = 'none';
                if (viewData) {
                    viewData.style.display = 'block';
                    if (!ticket) {
                        viewData.innerHTML = '<p style="text-align: center; padding: 40px; color: #718096;">No data found for this ticket.</p>';
                    } else {
                        viewData.innerHTML = renderViewMode(ticket);
                    }
                }
            } catch (error) {
                if (viewLoading) viewLoading.style.display = 'none';
                if (viewData) {
                    viewData.style.display = 'block';
                    viewData.innerHTML = `<p style="text-align: center; padding: 40px; color: #e53e3e;">Error loading ticket: ${error.message}</p>`;
                }
            } finally {
                hideRetifluxLoadingOverlay();
                startViewHeadingRotation();
            }
        }
        
        async function refreshViewTicket() {
            var serialEl = document.getElementById('viewSerialDisplay');
            var serial = serialEl ? serialEl.textContent.trim() : '';
            if (!serial) return;
            showRetifluxLoadingOverlay();
            var viewLoading = document.getElementById('viewLoading');
            var viewData = document.getElementById('viewData');
            if (viewLoading) viewLoading.style.display = 'block';
            if (viewData) { viewData.style.display = 'none'; viewData.innerHTML = ''; }
            clearCache('ticket_' + serial);
            try {
                var ticket = await readTicketFromSheet(serial, false);
                if (viewLoading) viewLoading.style.display = 'none';
                if (viewData) {
                    viewData.style.display = 'block';
                    viewData.innerHTML = ticket ? renderViewMode(ticket) : '<p style="text-align: center; padding: 40px; color: #718096;">No data found for this ticket.</p>';
                }
            } catch (err) {
                if (viewLoading) viewLoading.style.display = 'none';
                if (viewData) {
                    viewData.style.display = 'block';
                    viewData.innerHTML = '<p style="text-align: center; padding: 40px; color: #e53e3e;">Error: ' + (err.message || 'Failed to refresh') + '</p>';
                }
            } finally {
                hideRetifluxLoadingOverlay();
                advanceViewHeading();
            }
        }

        function renderViewMode(ticket) {
            const merchHistory = ticket.MerchHistory ? (typeof ticket.MerchHistory === 'string' ? JSON.parse(ticket.MerchHistory) : ticket.MerchHistory) : [];
            
            // Detect color from serial number
            const serial = ticket.Serial || '';
            const ticketColor = serial.includes('-BL-') ? 'blue' :
                              serial.includes('-RD-') ? 'red' :
                              serial.includes('-GN-') ? 'green' :
                              serial.includes('-YL-') ? 'yellow' : 'blue';
            
            // Elegant gold and dark blue color scheme
            const colorMap = {
                blue: { bg: 'rgba(30, 58, 95, 0.3)', border: '#f59e0b', text: '#fbbf24', accent: '#fcd34d' },
                red: { bg: 'rgba(30, 58, 95, 0.3)', border: '#f59e0b', text: '#fbbf24', accent: '#fcd34d' },
                green: { bg: 'rgba(30, 58, 95, 0.3)', border: '#f59e0b', text: '#fbbf24', accent: '#fcd34d' },
                yellow: { bg: 'rgba(30, 58, 95, 0.3)', border: '#f59e0b', text: '#fbbf24', accent: '#fcd34d' }
            };
            const colors = colorMap[ticketColor] || colorMap.blue;
            
            // Format timestamps
            const createdAt = formatTimestamp(ticket.CreatedAt);
            const firstModified = formatTimestamp(ticket.FirstModified);
            const lastModified = formatTimestamp(ticket.LastModified);
            
            // Format Date and Time - ensure we're reading from the correct fields
            // Date is column B, Time is column C
            const dateValue = ticket.Date || ticket['Date'] || '';
            const timeValue = ticket.Time || ticket['Time'] || '';
            const formattedDateTime = formatDateAndTime(dateValue, timeValue);
            const palletInfo = ticket.pallet || ticket.PalletInfo || ticket._pallet || null;
            const originalQty = (() => {
                if (palletInfo && palletInfo.Quantity != null && palletInfo.Quantity !== '') {
                    const value = Number(palletInfo.Quantity);
                    if (!isNaN(value)) return value;
                }
                return parseFloat(ticket.Qty || 0) || 0;
            })();
            const remainingQty = (() => {
                if (palletInfo && palletInfo.RemainingQuantity != null && palletInfo.RemainingQuantity !== '') {
                    const value = Number(palletInfo.RemainingQuantity);
                    if (!isNaN(value)) return value;
                }
                return originalQty;
            })();
            const palletZone = palletInfo && palletInfo.CurrentZone ? palletInfo.CurrentZone : 'Receiving Area';
            
            // Get DefaultStatus from ZoneConfig for the pallet's current zone
            let palletStatus = 'Received'; // Default fallback
            if (palletZone && movementZones && movementZones.length > 0) {
                // Find zone config for current zone (case-insensitive match)
                const zoneConfig = movementZones.find(z => 
                    z.ZoneName && z.ZoneName.toLowerCase() === palletZone.toLowerCase()
                );
                if (zoneConfig && zoneConfig.DefaultStatus) {
                    palletStatus = zoneConfig.DefaultStatus;
                } else if (palletInfo && palletInfo.Status) {
                    // Fallback to pallet's Status if zone config not found
                    palletStatus = palletInfo.Status;
                }
            } else if (palletInfo && palletInfo.Status) {
                // Fallback to pallet's Status if ZoneConfig not loaded
                palletStatus = palletInfo.Status;
            }
            const palletRemaining = palletInfo && (palletInfo.RemainingQuantity ?? palletInfo.Quantity) ? (palletInfo.RemainingQuantity ?? palletInfo.Quantity) : '—';
            const palletLastMove = palletInfo && palletInfo.LastMovedAt ? formatMovementDate(palletInfo.LastMovedAt) : 'Not moved yet';
            const palletCreated = palletInfo && palletInfo.CreatedAt ? formatMovementDate(palletInfo.CreatedAt) : 'Pending';
            const palletInfoCard = `
                <div style="background: ${colors.bg}; padding: 24px; border-radius: 16px; border: 2px solid ${colors.border}; backdrop-filter: blur(10px);">
                    <h3 style="margin: 0 0 18px 0; color: ${colors.text}; font-size: 18px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);">⬥ Pallet Location</h3>
                    <div class="pallet-info-grid" style="display: grid; grid-template-columns: 1fr; gap: 14px;">
                        <div><strong style="color: ${colors.text}; font-weight: 600;">Current Zone:</strong> <span style="color: rgba(255, 255, 255, 0.95); font-weight: 500;">${escapeHtml(palletZone)}</span></div>
                        <div><strong style="color: ${colors.text}; font-weight: 600;">Status:</strong> <span style="color: rgba(255, 255, 255, 0.95); font-weight: 500;">${escapeHtml(palletStatus)}</span></div>
                        <div><strong style="color: ${colors.text}; font-weight: 600;">Original Qty:</strong> <span style="color: rgba(255, 255, 255, 0.95); font-weight: 500;">${escapeHtml(originalQty.toString())}</span></div>
                        <div><strong style="color: ${colors.text}; font-weight: 600;">Remaining Qty:</strong> <span style="color: rgba(255, 255, 255, 0.95); font-weight: 500;">${escapeHtml(remainingQty.toString())}</span></div>
                        <div><strong style="color: ${colors.text}; font-weight: 600;">Last Movement:</strong> <span style="color: rgba(255, 255, 255, 0.9); font-weight: 500;">${escapeHtml(palletLastMove)}</span></div>
                        <div><strong style="color: ${colors.text}; font-weight: 600;">Pallet Created:</strong> <span style="color: rgba(255, 255, 255, 0.9); font-weight: 500;">${escapeHtml(palletCreated)}</span></div>
                    </div>
                    ${!palletInfo ? `<div style="margin-top: 14px; padding: 12px; background: rgba(245, 158, 11, 0.1); border-radius: 8px; color: rgba(251, 191, 36, 0.9); font-size: 13px; border: 1px solid rgba(245, 158, 11, 0.3);">No pallet movement recorded yet. Submit this ticket via the Stock Movement panel to update.</div>` : ''}
                </div>
            `;
            
            // Parse Product Type to check for 1KG or 0.5KG
            const productType = (ticket.ProductType || '').toLowerCase();
            const has1KG = productType.includes('1kg') || productType.includes('1 kg');
            const has05KG = productType.includes('0.5kg') || productType.includes('0.5 kg') || productType.includes('0,5kg');
            const qty = remainingQty;
            let pieces = 0;
            let tabletSachetInfo = '';
            
            // Show tablet/sachet info if product type is 1KG or 0.5KG, regardless of quantity
            if (has1KG) {
                pieces = qty * 6;
                tabletSachetInfo = '1KG';
            } else if (has05KG) {
                pieces = qty * 12;
                tabletSachetInfo = '0.5KG';
            }
            
            // Calculate layers based on pallet size and quantity
            const palletConfig = {
                '100': { layers: 5, cartonsPerLayer: 20 },   // 100 / 5 = 20
                '105': { layers: 7, cartonsPerLayer: 15 },   // 105 / 7 = 15
                '78': { layers: 6, cartonsPerLayer: 13 },    // 78 / 6 = 13
                '64': { layers: 4, cartonsPerLayer: 16 }     // 64 / 4 = 16
            };
            
            let layersInfo = null;
            const palletSizeStr = (ticket.PalletSize || '').toString().trim();
            
            const computeLayerInfo = (quantityValue) => {
                if (!palletSizeStr || quantityValue <= 0) return null;
                const palletSizes = palletSizeStr.split(',').map(ps => ps.trim()).filter(ps => ps !== '');
                if (!palletSizes.length) return null;
                    const palletSize = palletSizes[0];
                    const config = palletConfig[palletSize];
                if (!config) return null;
                const cartonsPerLayer = config.cartonsPerLayer;
                const calculatedLayers = Math.ceil(quantityValue / cartonsPerLayer);
                const fullLayers = Math.floor(quantityValue / cartonsPerLayer);
                const remainderUnits = quantityValue % cartonsPerLayer;
                return {
                    palletSize,
                    cartonsPerLayer,
                    calculatedLayers,
                    fullLayers,
                    remainderUnits
                };
            };

            layersInfo = computeLayerInfo(remainingQty);
            const layersInfoOriginal = originalQty !== remainingQty ? computeLayerInfo(originalQty) : null;
            
            return `
                <div style="max-width: 900px; margin: 0 auto; padding: 30px; background: linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(30, 58, 95, 0.98)); border-radius: 20px; box-shadow: 0 16px 64px rgba(0, 0, 0, 0.5), 0 8px 32px rgba(245, 158, 11, 0.2); border: 2px solid rgba(245, 158, 11, 0.4); backdrop-filter: blur(20px);">
                    <div style="border-left: 6px solid ${colors.border}; padding-left: 20px; margin-bottom: 30px;">
                        <h2 style="margin: 0 0 5px 0; background: linear-gradient(135deg, #fbbf24, #f59e0b, #fcd34d); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 28px; font-weight: 800; letter-spacing: 1px; text-transform: uppercase;">${escapeHtml(serial)}</h2>
                    </div>
                    
                    <div style="display: grid; gap: 20px; margin-bottom: 30px;">
                        <div style="background: ${colors.bg}; padding: 24px; border-radius: 16px; border: 2px solid ${colors.border}; backdrop-filter: blur(10px);">
                            <h3 style="margin: 0 0 18px 0; color: ${colors.text}; font-size: 18px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);">⬥ Basic Information</h3>
                            <div class="pallet-info-grid" style="display: grid; gap: 14px;">
                                <div><strong style="color: ${colors.text}; font-weight: 600;">Serial:</strong> <span style="color: rgba(255, 255, 255, 0.95); font-weight: 500;">${escapeHtml(serial)}</span></div>
                                <div><strong style="color: ${colors.text}; font-weight: 600;">Date & Time:</strong> <span style="color: rgba(255, 255, 255, 0.9); font-family: 'Courier New', monospace; font-weight: 500;">${escapeHtml(formattedDateTime || 'N/A')}</span></div>
                                <div><strong style="color: ${colors.text}; font-weight: 600;">SKU:</strong> <span style="color: rgba(255, 255, 255, 0.95); font-weight: 500;">${escapeHtml(ticket.SKU || '')}</span></div>
                                <div>
                                    <strong style="color: ${colors.text};">Quantity (Original):</strong>
                                    <span style="color: rgba(255, 255, 255, 0.95); font-weight: 500;">${escapeHtml(originalQty.toString())}</span>
                                </div>
                                <div>
                                    <strong style="color: ${colors.text};">Quantity (Remaining):</strong>
                                    <span style="color: rgba(255, 255, 255, 0.95); font-weight: 500;">${escapeHtml(remainingQty.toString())}</span>
                                </div>
                                <div><strong style="color: ${colors.text};">Layers:</strong> 
                                    <span style="color: rgba(255, 255, 255, 0.95); font-weight: 500;">
                                        ${layersInfo ? escapeHtml(layersInfo.calculatedLayers.toString()) : escapeHtml(ticket.Layers || '')}
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        ${palletInfoCard}
                        
                        ${isUserLoggedIn() ? `
                        <div style="background: ${colors.bg}; padding: 24px; border-radius: 16px; border: 2px solid ${colors.border}; backdrop-filter: blur(10px);">
                            <h3 style="margin: 0 0 18px 0; color: ${colors.text}; font-size: 18px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);">⬥ Product Details</h3>
                            <div style="display: grid; gap: 14px;">
                                <div><strong style="color: ${colors.text}; font-weight: 600;">Banding Type:</strong> <span style="color: rgba(255, 255, 255, 0.95); text-transform: uppercase; font-weight: 500;">${escapeHtml((ticket.BandingType || '').toUpperCase())}</span></div>
                                <div><strong style="color: ${colors.text}; font-weight: 600;">Product Type:</strong> <span style="color: rgba(255, 255, 255, 0.95); text-transform: uppercase; font-weight: 500;">${escapeHtml((ticket.ProductType || '').toUpperCase())}</span></div>
                                <div><strong style="color: ${colors.text}; font-weight: 600;">Pallet Size:</strong> <span style="color: rgba(255, 255, 255, 0.95); font-weight: 500;">${escapeHtml(ticket.PalletSize || '')}</span></div>
                                ${ticket.UoM ? `<div><strong style="color: ${colors.text}; font-weight: 600;">UoM:</strong> <span style="color: rgba(255, 255, 255, 0.95); font-weight: 500;">${escapeHtml(ticket.UoM)}</span></div>` : ''}
                            </div>
                        </div>
                        ` : ''}
                        
                        ${layersInfo ? `
                        <div style="background: ${colors.bg}; padding: 20px; border-radius: 8px; border-left: 4px solid ${colors.border};">
                            <h3 style="margin: 0 0 15px 0; color: ${colors.text}; font-size: 18px; font-weight: 600;">📊 Layer Calculations</h3>
                            <div style="display: grid; gap: 10px;">
                                <div><strong style="color: ${colors.text};">Pallet Size:</strong> <span style="color: rgba(255, 255, 255, 0.95); font-weight: 500;">${escapeHtml(layersInfo.palletSize)} cartons</span></div>
                                <div><strong style="color: ${colors.text};">Cartons per Layer:</strong> <span style="color: rgba(255, 255, 255, 0.95); font-weight: 600;">${escapeHtml(layersInfo.cartonsPerLayer.toString())} cartons/layer</span></div>
                                <div style="padding-top: 8px; border-top: 1px solid ${colors.accent}40; margin-top: 8px;">
                                    <div style="margin-bottom: 8px;"><strong style="color: ${colors.text};">Remaining Quantity:</strong> <span style="color: rgba(255, 255, 255, 0.95); font-weight: 600;">${escapeHtml(remainingQty.toString())} cartons</span></div>
                                    <div style="margin-bottom: 8px;"><strong style="color: ${colors.text};">Calculated Layers:</strong> <span style="color: rgba(255, 255, 255, 0.95); font-weight: 700; font-size: 16px;">${escapeHtml(layersInfo.calculatedLayers.toString())} layers</span></div>
                                    ${layersInfo.fullLayers > 0 || layersInfo.remainderUnits > 0 ? `
                                        <div style="margin-bottom: 5px; padding-top: 8px; border-top: 1px solid ${colors.accent}20;">
                                            <div style="margin-bottom: 5px;"><strong style="color: ${colors.text};">Breakdown:</strong></div>
                                            <div style="color: rgba(255, 255, 255, 0.85); font-size: 14px; margin-left: 10px; font-weight: 500;">
                                                ${layersInfo.fullLayers > 0 ? `${escapeHtml(layersInfo.fullLayers.toString())} full layer(s)` : ''}
                                                ${layersInfo.remainderUnits > 0 ? (layersInfo.fullLayers > 0 ? ` + ${escapeHtml(layersInfo.remainderUnits.toString())} units` : `${escapeHtml(layersInfo.remainderUnits.toString())} units`) : ''}
                                                ${layersInfo.remainderUnits > 0 && layersInfo.fullLayers > 0 ? (() => {
                                                    const nextLayer = layersInfo.fullLayers + 1;
                                                    let suffix = 'th';
                                                    if (nextLayer === 1) suffix = 'st';
                                                    else if (nextLayer === 2) suffix = 'nd';
                                                    else if (nextLayer === 3) suffix = 'rd';
                                                    return ` (${nextLayer}${suffix} layer is not full)`;
                                                })() : ''}
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                                ${layersInfoOriginal ? `
                                <div style="padding-top: 8px; border-top: 1px dashed ${colors.accent}40; margin-top: 12px; font-size: 13px; color: rgba(255, 255, 255, 0.85); font-weight: 500;">
                                    <strong>Original Quantity:</strong> ${escapeHtml(originalQty.toString())} cartons •
                                    <strong>Original Layers:</strong> ${escapeHtml(layersInfoOriginal.calculatedLayers.toString())}
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        ` : ''}
                        
                        ${isUserLoggedIn() && tabletSachetInfo ? `
                        <div style="background: ${colors.bg}; padding: 24px; border-radius: 16px; border: 2px solid ${colors.border}; backdrop-filter: blur(10px);">
                            <h3 style="margin: 0 0 18px 0; color: ${colors.text}; font-size: 18px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);">⬥ Tablet & Sachet Info</h3>
                            <div style="display: grid; gap: 14px;">
                                <div><strong style="color: ${colors.text}; font-weight: 600;">Product Type:</strong> <span style="color: rgba(255, 255, 255, 0.95); font-weight: 500;">${escapeHtml(tabletSachetInfo)}</span></div>
                                <div><strong style="color: ${colors.text}; font-weight: 600;">Quantity Remaining (Cartons):</strong> <span style="color: rgba(255, 255, 255, 0.95); font-weight: 500;">${escapeHtml(remainingQty.toString())} Cartons</span></div>
                                ${originalQty !== remainingQty ? `<div><strong style="color: ${colors.text}; font-weight: 600;">Original Quantity:</strong> <span style="color: rgba(255, 255, 255, 0.95); font-weight: 500;">${escapeHtml(originalQty.toString())} Cartons</span></div>` : ''}
                                ${ticket.SachetType ? `<div><strong style="color: ${colors.text}; font-weight: 600;">Sachet Type:</strong> <span style="color: rgba(255, 255, 255, 0.95); font-weight: 500;">${escapeHtml(ticket.SachetType)}</span></div>` : ''}
                                ${ticket.TabletType ? `<div><strong style="color: ${colors.text}; font-weight: 600;">Tablet Type:</strong> <span style="color: rgba(255, 255, 255, 0.95); font-weight: 500;">${escapeHtml(ticket.TabletType)}</span></div>` : ''}
                                <div style="padding-top: 8px; border-top: 1px solid ${colors.accent}40;">
                                    <div style="margin-bottom: 5px;"><strong style="color: ${colors.text};">Conversion:</strong> <span style="color: rgba(255, 255, 255, 0.85); font-size: 14px; font-weight: 500;">${escapeHtml(remainingQty.toString())} Cartons × ${has1KG ? '6' : '12'} = </span></div>
                                    <div><strong style="color: ${colors.text};">Total Pieces Remaining:</strong> <span style="color: rgba(255, 255, 255, 0.95); font-weight: 700; font-size: 18px;">${pieces.toLocaleString()} Pieces</span></div>
                                    ${originalQty !== remainingQty ? `<div style="margin-top: 6px; color: rgba(255, 255, 255, 0.75); font-size: 13px; font-weight: 500;">Original pieces: ${( (originalQty) * (has1KG ? 6 : 12)).toLocaleString()}</div>` : ''}
                                </div>
                                <div style="padding-top: 8px; border-top: 1px solid ${colors.accent}40; margin-top: 8px;">
                                    <div style="margin-bottom: 8px;"><strong style="color: ${colors.text};">Carton to Sachet/Tablet Conversion:</strong></div>
                                    ${has1KG ? `
                                    <div style="margin-bottom: 5px; color: rgba(255, 255, 255, 0.85); font-size: 14px; font-weight: 500;">1 Carton = 6 Sachets + 6 Tablet Pieces</div>
                                    <div style="margin-bottom: 5px; color: rgba(255, 255, 255, 0.85); font-size: 14px; font-weight: 500;">100 Cartons = 600 Sachets + 600 Tablet Pieces</div>
                                    ` : `
                                    <div style="margin-bottom: 5px; color: rgba(255, 255, 255, 0.85); font-size: 14px; font-weight: 500;">1 Carton = 12 Sachets + 12 Tablet Pieces</div>
                                    <div style="margin-bottom: 5px; color: rgba(255, 255, 255, 0.85); font-size: 14px; font-weight: 500;">100 Cartons = 1,200 Sachets + 1,200 Tablet Pieces</div>
                                    `}
                                    ${(ticket.SachetType || ticket.TabletType) ? `
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                                        ${ticket.SachetType ? `
                                        <div>
                                            <div style="font-size: 12px; color: rgba(251, 191, 36, 0.8); margin-bottom: 3px; font-weight: 600;">Sachets</div>
                                            <div style="color: rgba(255, 255, 255, 0.95); font-weight: 700; font-size: 16px;">${(remainingQty * (has1KG ? 6 : 12)).toLocaleString()}</div>
                                        </div>
                                        ` : ''}
                                        ${ticket.TabletType ? `
                                        <div>
                                            <div style="font-size: 12px; color: rgba(251, 191, 36, 0.8); margin-bottom: 3px; font-weight: 600;">Tablet Pieces</div>
                                            <div style="color: rgba(255, 255, 255, 0.95); font-weight: 700; font-size: 16px;">${(remainingQty * (has1KG ? 6 : 12)).toLocaleString()}</div>
                                        </div>
                                        ` : ''}
                                    </div>
                                    ` : `
                                    <div style="margin-top: 10px; padding: 10px; background: rgba(30, 58, 95, 0.4); border-radius: 6px; border: 1px solid rgba(245, 158, 11, 0.3);">
                                        <div style="color: rgba(255, 255, 255, 0.75); font-size: 13px; font-weight: 500;">Sachet Type and Tablet Type not specified</div>
                                    </div>
                                    `}
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${isUserLoggedIn() && ticket.QualityIssueType ? `
                        <div style="background: rgba(220, 38, 38, 0.15); padding: 24px; border-radius: 16px; border: 2px solid rgba(220, 38, 38, 0.5); backdrop-filter: blur(10px);">
                            <h3 style="margin: 0 0 18px 0; color: #fbbf24; font-size: 18px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);">⚠️ Quality Issues</h3>
                            <div style="display: grid; gap: 14px;">
                                <div><strong style="color: #fbbf24; font-weight: 600;">Type:</strong> <span style="color: rgba(255, 255, 255, 0.95); font-weight: 500;">${escapeHtml(ticket.QualityIssueType === 'banding' ? 'Banding Quality Frailties' : 'Production Quality Frailties')}</span></div>
                                <div><strong style="color: #fbbf24; font-weight: 600;">Group Leader:</strong> <span style="color: rgba(255, 255, 255, 0.95); font-weight: 500;">${escapeHtml(ticket.GroupLeader || '')}</span></div>
                                <div><strong style="color: #fbbf24; font-weight: 600;">Description:</strong> <span style="color: rgba(255, 255, 255, 0.95); font-weight: 500;">${escapeHtml(ticket.QualityIssueDesc || '')}</span></div>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${isUserLoggedIn() && merchHistory.length > 0 ? `
                        <div style="background: ${colors.bg}; padding: 24px; border-radius: 16px; border: 2px solid ${colors.border}; backdrop-filter: blur(10px);">
                            <h3 style="margin: 0 0 18px 0; color: ${colors.text}; font-size: 18px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);">⬥ Merchandise History</h3>
                            ${merchHistory.map(entry => `
                                <div style="padding: 16px; margin-bottom: 12px; background: rgba(15, 23, 42, 0.4); border-radius: 10px; border: 1px solid rgba(245, 158, 11, 0.3); backdrop-filter: blur(5px);">
                                    <div style="font-weight: 700; color: ${colors.text}; margin-bottom: 6px; font-size: 14px;">${escapeHtml(entry.date || '')} - ${escapeHtml(entry.user || '')}</div>
                                    <div style="color: rgba(255, 255, 255, 0.9); font-size: 14px; font-weight: 500;">${escapeHtml(entry.note || '')}</div>
                                </div>
                            `).join('')}
                        </div>
                        ` : ''}
                        
                        ${isUserLoggedIn() ? `
                        <div style="background: rgba(30, 58, 95, 0.2); padding: 24px; border-radius: 16px; border: 2px solid rgba(245, 158, 11, 0.3); backdrop-filter: blur(10px);">
                            <h3 style="margin: 0 0 18px 0; color: #fbbf24; font-size: 18px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);">⬥ Timestamps</h3>
                            <div style="display: grid; gap: 14px;">
                                <div><strong style="color: #fbbf24; font-weight: 600;">Created At:</strong> <span style="color: rgba(255, 255, 255, 0.9); font-family: 'Courier New', monospace; font-weight: 500;">${escapeHtml(createdAt)}</span></div>
                                <div><strong style="color: #fbbf24; font-weight: 600;">First Modified:</strong> <span style="color: rgba(255, 255, 255, 0.9); font-family: 'Courier New', monospace; font-weight: 500;">${escapeHtml(firstModified)}</span></div>
                                <div><strong style="color: #fbbf24; font-weight: 600;">Last Modified:</strong> <span style="color: rgba(255, 255, 255, 0.9); font-family: 'Courier New', monospace; font-weight: 500;">${escapeHtml(lastModified)}</span></div>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${isUserLoggedIn() && ticket.ChangeHistory ? `
                        <div style="background: rgba(30, 58, 95, 0.2); padding: 24px; border-radius: 16px; border: 2px solid rgba(245, 158, 11, 0.3); backdrop-filter: blur(10px);">
                            <h3 style="margin: 0 0 18px 0; color: #fbbf24; font-size: 18px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);">⬥ Change History</h3>
                            <pre style="white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 13px; color: rgba(255, 255, 255, 0.9); margin: 0; background: rgba(15, 23, 42, 0.5); padding: 18px; border-radius: 10px; border: 1px solid rgba(245, 158, 11, 0.2); font-weight: 500;">${escapeHtml(formatChangeHistory(ticket.ChangeHistory))}</pre>
                        </div>
                        ` : ''}
                        
                        ${isUserLoggedIn() && ticket.Notes ? `
                        <div style="background: ${colors.bg}; padding: 24px; border-radius: 16px; border: 2px solid ${colors.border}; backdrop-filter: blur(10px);">
                            <h3 style="margin: 0 0 18px 0; color: ${colors.text}; font-size: 18px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);">⬥ Notes</h3>
                            <p style="margin: 0; color: rgba(255, 255, 255, 0.95); line-height: 1.7; font-weight: 500;">${escapeHtml(ticket.Notes)}</p>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }
        
        function addMerchHistoryEntry() {
            const container = document.getElementById('merchHistoryContainer');
            if (!container) return;
            const users = Array.from(document.querySelectorAll('#groupLeader option')).map(opt => ({ value: opt.value, text: opt.textContent }));
            const entry = document.createElement('div');
            entry.className = 'merch-history-entry';
            entry.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr 2fr auto; gap: 10px; margin-bottom: 10px; align-items: end;';
            entry.innerHTML = `
                <div class="fill-form-group">
                    <label>Date</label>
                    <input type="date" class="merch-history-date" name="merchHistoryDate[]">
                </div>
                <div class="fill-form-group">
                    <label>User</label>
                    <select class="merch-history-user" name="merchHistoryUser[]">
                        <option value="">Select user...</option>
                        ${users.filter(u => u.value).map(u => `<option value="${u.value}">${u.text}</option>`).join('')}
                    </select>
                </div>
                <div class="fill-form-group">
                    <label>Note</label>
                    <input type="text" class="merch-history-note" name="merchHistoryNote[]" placeholder="Enter note...">
                </div>
                <button type="button" onclick="this.parentElement.remove()" class="btn-reset" style="padding: 10px;">×</button>
            `;
            container.appendChild(entry);
        }
        
        async function initFillMode(serial) {
            // Prevent back navigation - replace current history entry
            window.history.replaceState(null, '', window.location.href);
            
            // Block back button/swipe back
            window.addEventListener('popstate', (e) => {
                // Prevent going back to generator page
                window.history.pushState(null, '', window.location.href);
            });
            
            // Push a state to prevent back navigation
            window.history.pushState(null, '', window.location.href);
            
            document.body.classList.add('fill-mode-active');

            const movementSection = document.getElementById('movementSection');
            if (movementSection) {
                movementSection.style.display = isUserLoggedIn() ? 'block' : 'none';
            }

            const fillContainer = document.getElementById('fillContainer');
            if (fillContainer) {
                fillContainer.classList.add('visible');
            }
            
            const viewCard = document.getElementById('viewCard');
            const loginCard = document.getElementById('loginCard');
            const editCard = document.getElementById('editCard');
            if (viewCard) viewCard.style.display = 'none';
            if (loginCard) {
                loginCard.style.display = 'none';
                loginCard.classList.remove('fill-card-active');
                loginCard.style.position = ''; loginCard.style.top = ''; loginCard.style.left = ''; loginCard.style.transform = ''; loginCard.style.zIndex = ''; loginCard.style.maxWidth = ''; loginCard.style.width = ''; loginCard.style.boxShadow = '';
            }
            if (editCard) { editCard.style.display = 'none'; editCard.classList.remove('fill-card-active'); }
            
            const urlSerial = (typeof initialSerialParam !== 'undefined' && initialSerialParam) ? initialSerialParam : (serial || '');
            const defaultSerial = urlSerial ? decodeURIComponent(String(urlSerial)).trim() : '';
            const serialInput = document.getElementById('fillSerial');
            const serialDisplay = document.getElementById('fillSerialDisplay');
            if (serialInput) {
                serialInput.value = defaultSerial;
                serialInput.placeholder = defaultSerial ? '' : 'e.g. FG-DET-00123';
            }
            if (serialDisplay) serialDisplay.textContent = defaultSerial || '—';
            const editCardIntro = document.getElementById('editCardIntro');
            if (editCardIntro) {
                editCardIntro.innerHTML = defaultSerial
                    ? 'Enter the captured information for serial <strong id="fillSerialDisplay" style="color: #fcd34d; font-weight: 800; letter-spacing: 1px;">' + defaultSerial + '</strong>. When you submit, data is saved to Google Sheets and a finished ticket downloads as a PNG.'
                    : 'Enter the ticket serial above, then fill in the captured information. When you submit, data is saved to Google Sheets and a finished ticket downloads as a PNG.';
            }
            
            if (isUserLoggedIn()) {
                if (editCard) { editCard.style.display = 'block'; editCard.classList.add('fade-in', 'fill-card-active'); editCard.scrollIntoView({ behavior: 'auto', block: 'start' }); }
                if (loginCard) { loginCard.style.display = 'none'; loginCard.classList.remove('fill-card-active'); }
            } else {
                if (loginCard) { loginCard.style.display = 'block'; loginCard.classList.add('fade-in', 'fill-card-active'); loginCard.scrollIntoView({ behavior: 'auto', block: 'start' }); }
                if (editCard) { editCard.style.display = 'none'; editCard.classList.remove('fill-card-active'); }
                const loginIntro = document.getElementById('loginCardIntro');
                if (loginIntro) loginIntro.textContent = defaultSerial ? 'Log in to edit ticket ' + defaultSerial + '. Loading authorized users…' : 'Log in to edit a ticket. Enter the ticket serial in the form after signing in. Loading authorized users…';
            }
            updateLoggedInUserBanner();
            
            let users = [];
            let skus = [];
            // Run API calls in background - form is already visible, no blocking overlay
            try {
                const [usersResult, skusResult] = await Promise.all([
                    loadAuthorizedUsers(),
                    loadSkusFromZoneMapping()
                ]);
                users = (usersResult && usersResult.users) ? usersResult.users : [];
                skus = Array.isArray(skusResult) ? skusResult : [];
                populateAuthorizedUserSelects(users);
                authorizedUsersLoaded = true;
                const loginIntro2 = document.getElementById('loginCardIntro');
                if (loginIntro2) loginIntro2.textContent = defaultSerial ? 'Log in to edit ticket ' + defaultSerial + '. Only authorized production leads can edit.' : 'Log in to edit a ticket. Enter the serial above, then sign in. Only authorized production leads can edit.';
            } catch (e) {
                console.error('Edit mode init:', e);
                const loginIntro2 = document.getElementById('loginCardIntro');
                if (loginIntro2) loginIntro2.textContent = defaultSerial ? 'Log in to edit ticket ' + defaultSerial + '. (Some data may still be loading.)' : 'Log in to edit a ticket. (Some data may still be loading.)';
            }

            const movementPalletInput = document.getElementById('movementPalletId');
            if (movementPalletInput) {
                movementPalletInput.value = defaultSerial;
            }
            const movementCurrentZone = document.getElementById('movementCurrentZone');
            if (movementCurrentZone) {
                movementCurrentZone.value = '';
            }

            // Priority: URL color param > serial detection > default
            let detectedColour = urlColorParam || 
                (defaultSerial.includes('-BL-') ? 'blue' :
                 defaultSerial.includes('-RD-') ? 'red' :
                 defaultSerial.includes('-GN-') ? 'green' :
                 defaultSerial.includes('-YL-') ? 'yellow' : selectedColor);

            const fillColorSelect = document.getElementById('fillColor');
            if (fillColorSelect) {
                fillColorSelect.value = detectedColour;
                // When no serial from URL, user enters serial - allow color selection
                if (defaultSerial) {
                    fillColorSelect.disabled = true;
                    fillColorSelect.style.backgroundColor = '#f7fafc';
                    fillColorSelect.style.cursor = 'not-allowed';
                } else {
                    fillColorSelect.disabled = false;
                    fillColorSelect.style.backgroundColor = '';
                    fillColorSelect.style.cursor = '';
                }
            }
            
            populateSKUDropdown(skus);
            
            const groupLeaderSelect = document.getElementById('groupLeader');
            const merchHistoryUsers = document.querySelectorAll('.merch-history-user');
            if (groupLeaderSelect) {
                groupLeaderSelect.innerHTML = '<option value="">Select leader...</option>' + 
                    users.map(u => `<option value="${u.id}">${u.name}</option>`).join('');
            }
            merchHistoryUsers.forEach(select => {
                select.innerHTML = '<option value="">Select user...</option>' + 
                    users.map(u => `<option value="${u.id}">${u.name}</option>`).join('');
            });
            
            // Load existing ticket data if editing (skip when no serial - user will enter it)
            if (defaultSerial) {
                try {
                    const existingTicket = await readTicketFromSheet(defaultSerial);
                    if (existingTicket) {
                        populateFormFromTicket(existingTicket);
                    }
                } catch (error) {
                }
            }


            const form = document.getElementById('ticketForm');
            if (form) {
                form.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    
                    if (!isUserLoggedIn()) {
                        setFillStatus('❌ Please log in before editing tickets.');
                        showLoginCard();
                        return;
                    }
                    
                    setFillStatus('💾 Saving to Google Sheets...');
                    showRetifluxLoadingOverlay();
                    try {
                        const data = collectFormData(form);
                        let existingTicket = null;
                        try {
                            existingTicket = await readTicketFromSheet(data.serial);
                            // Check if ticket actually exists (has data, not just headers)
                            if (existingTicket && (!existingTicket.Serial || existingTicket.Serial !== data.serial)) {
                                existingTicket = null;
                            }
                        } catch (e) {
                            // Ticket doesn't exist, that's fine
                            existingTicket = null;
                        }
                        const isUpdate = !!(existingTicket && existingTicket.Serial === data.serial);
                        
                        // Save to Google Sheets (pass existingTicket for timestamp handling)
                        const saveResult = await saveTicketToSheet(data, isUpdate, existingTicket);
                        
                        // Update SKU calculations
                        if (data.sku && data.qty) {
                            await updateSKUCalculations(data.sku, data.qty);
                        }
                        
                        setFillStatus('📄 Generating ticket preview...');
                        const pageElement = renderFilledTicket(data);
                        if (!pageElement) {
                            setFillStatus('Could not render preview.');
                            return;
                        }
                        await new Promise(resolve => setTimeout(resolve, 50));
                        renderTicketQRCodes(pageElement);
                        await new Promise(resolve => setTimeout(resolve, 50));
                        await downloadFilledTicket(pageElement, data.serial);
                        setFillStatus('✅ Saved to Google Sheets and download complete!');
                        showToast('Ticket saved successfully!', 'success');
                    } catch (error) {
                        setFillStatus(`❌ Error: ${error.message}`);
                        console.error('Save error:', error);
                        showToast(`Error saving to Google Sheets: ${error.message}`, 'error', 6000);
                        
                        // Restore button state on error
                        const submitBtn = document.getElementById('movementSubmitBtn') || document.querySelector('#ticketForm button[type="submit"]');
                        if (submitBtn) {
                            submitBtn.disabled = false;
                        }
                    } finally {
                        hideRetifluxLoadingOverlay();
                    }
                });
            }
        }
        
        function populateFormFromTicket(ticket) {
            if (ticket.Date) document.getElementById('fillDate').value = ticket.Date;
            if (ticket.Time) document.getElementById('fillTime').value = ticket.Time;
            // Set SKU - check if it exists in dropdown, otherwise use custom input
            if (ticket.SKU) {
                const skuSelect = document.getElementById('fillSku');
                const skuCustom = document.getElementById('fillSkuCustom');
                if (skuSelect) {
                    // Check if SKU exists in dropdown; if not, add it for editing existing ticket
                    const optionExists = Array.from(skuSelect.options).some(opt => opt.value === ticket.SKU);
                    if (!optionExists && ticket.SKU) {
                        const opt = document.createElement('option');
                        opt.value = ticket.SKU;
                        opt.textContent = ticket.SKU;
                        skuSelect.appendChild(opt);
                    }
                    if (ticket.SKU) {
                        skuSelect.value = ticket.SKU;
                        loadSkuProductInfo(ticket.SKU).then(info => {
                            document.getElementById('productTypeDisplay').textContent = info.productType || ticket.ProductType || '—';
                            document.getElementById('productTypeHidden').value = info.productType || (ticket.ProductType || '').split(',')[0] || '';
                            document.getElementById('sachetTypeDisplay').textContent = info.sachetType || ticket.SachetType || ticket['Sachet Type'] || '—';
                            document.getElementById('sachetTypeHidden').value = info.sachetType || ticket.SachetType || ticket['Sachet Type'] || '';
                            document.getElementById('tabletTypeDisplay').textContent = info.tabletType || ticket.TabletType || ticket['Tablet Type'] || '—';
                            document.getElementById('tabletTypeHidden').value = info.tabletType || ticket.TabletType || ticket['Tablet Type'] || '';
                            document.getElementById('uomDisplay').textContent = info.uom || ticket.UoM || '—';
                            document.getElementById('uomHidden').value = info.uom || ticket.UoM || '';
                        });
                    }
                    if (skuCustom) skuCustom.style.display = 'none';
                }
            }
            if (ticket.Qty) document.getElementById('fillQty').value = ticket.Qty;
            if (ticket.Layers) document.getElementById('fillLayers').value = ticket.Layers;
            if (ticket.Notes) document.getElementById('fillNotes').value = ticket.Notes;
            if (ticket.QualityIssueType) document.getElementById('qualityIssueType').value = ticket.QualityIssueType;
            if (ticket.QualityIssueDesc) document.getElementById('qualityIssueDesc').value = ticket.QualityIssueDesc;
            if (ticket.GroupLeader) document.getElementById('groupLeader').value = ticket.GroupLeader;
            
            // Product info from SKU - set from ticket if loadSkuProductInfo hasn't run yet
            var pt = (ticket.ProductType || '').toString().split(',')[0] || '';
            if (document.getElementById('productTypeHidden').value === '' && pt) {
                document.getElementById('productTypeDisplay').textContent = pt || '—';
                document.getElementById('productTypeHidden').value = pt;
            }
            if (document.getElementById('sachetTypeHidden').value === '' && (ticket.SachetType || ticket['Sachet Type'])) {
                var st = ticket.SachetType || ticket['Sachet Type'] || '';
                document.getElementById('sachetTypeDisplay').textContent = st || '—';
                document.getElementById('sachetTypeHidden').value = st;
            }
            if (document.getElementById('tabletTypeHidden').value === '' && (ticket.TabletType || ticket['Tablet Type'])) {
                var tt = ticket.TabletType || ticket['Tablet Type'] || '';
                document.getElementById('tabletTypeDisplay').textContent = tt || '—';
                document.getElementById('tabletTypeHidden').value = tt;
            }
            if (document.getElementById('uomHidden').value === '' && ticket.UoM) {
                document.getElementById('uomDisplay').textContent = ticket.UoM || '—';
                document.getElementById('uomHidden').value = ticket.UoM || '';
            }
            
            // Populate checkboxes
            (ticket.BandingType || '').split(',').forEach(val => {
                const checkbox = document.querySelector(`input[name="bandingType"][value="${val.trim()}"]`);
                if (checkbox) checkbox.checked = true;
            });
            (ticket.PalletSize || '').split(',').forEach(val => {
                const checkbox = document.querySelector(`input[name="palletSize"][value="${val.trim()}"]`);
                if (checkbox) checkbox.checked = true;
            });
            
            // Populate merch history
            const merchHistory = ticket.MerchHistory ? (typeof ticket.MerchHistory === 'string' ? JSON.parse(ticket.MerchHistory) : ticket.MerchHistory) : [];
            const container = document.getElementById('merchHistoryContainer');
            if (container && merchHistory.length > 0) {
                container.innerHTML = '';
                merchHistory.forEach(entry => {
                    addMerchHistoryEntry();
                    const entries = container.querySelectorAll('.merch-history-entry');
                    const lastEntry = entries[entries.length - 1];
                    if (lastEntry) {
                        lastEntry.querySelector('.merch-history-date').value = entry.date || '';
                        lastEntry.querySelector('.merch-history-user').value = entry.user || '';
                        lastEntry.querySelector('.merch-history-note').value = entry.note || '';
                    }
                });
            }
        }

        function collectFormData(form) {
            if (!isUserLoggedIn()) {
                throw new Error('Session expired. Please log in again.');
            }
            const formData = new FormData(form);
            
            const collectChecked = (name) =>
                Array.from(form.querySelectorAll(`input[name="${name}"]:checked`))
                    .map(input => input.value.toLowerCase());
            
            // Get SKU from either dropdown or custom input
            const skuSelect = document.getElementById('fillSku');
            const skuCustom = document.getElementById('fillSkuCustom');
            let sku = '';
            if (skuSelect && skuSelect.value && skuSelect.value !== '__custom__') {
                sku = skuSelect.value;
            } else if (skuCustom && skuCustom.value) {
                sku = skuCustom.value.trim();
            } else {
                sku = formData.get('sku') || '';
            }
            
            // Validate pallet size vs quantity
            const qty = parseInt(formData.get('qty') || '0', 10);
            const palletSizes = collectChecked('palletSize').map(ps => parseInt(ps, 10)).filter(ps => !isNaN(ps));
            
            if (qty > 0 && palletSizes.length > 0) {
                const maxPalletSize = Math.max(...palletSizes);
                if (qty > maxPalletSize) {
                    throw new Error(`Quantity (${qty}) cannot exceed the selected pallet size (${maxPalletSize}). Please reduce quantity or select a larger pallet size.`);
                }
            }
            
            const merchHistoryEntries = [];
            document.querySelectorAll('.merch-history-entry').forEach(entry => {
                const date = entry.querySelector('.merch-history-date')?.value || '';
                const user = entry.querySelector('.merch-history-user')?.value || '';
                const note = entry.querySelector('.merch-history-note')?.value || '';
                if (date || user || note) {
                    merchHistoryEntries.push({ date, user, note });
                }
            });

            return {
                serial: formData.get('serial') || formatSerial(currentSerial),
                color: formData.get('color') || selectedColor,
                date: formData.get('date') || '',
                time: formData.get('time') || '',
                sku: sku, // Use the SKU from dropdown or custom input
                qty: formData.get('qty') || '',
                layers: formData.get('layers') || '',
                notes: formData.get('notes') || '',
                bandingType: collectChecked('bandingType'),
                productType: document.getElementById('productTypeHidden')?.value || '',
                palletSize: collectChecked('palletSize'),
                qualityIssueType: formData.get('qualityIssueType') || '',
                qualityIssueDesc: formData.get('qualityIssueDesc') || '',
                groupLeader: formData.get('groupLeader') || '',
                sachetType: document.getElementById('sachetTypeHidden')?.value || formData.get('sachetType') || '',
                tabletType: document.getElementById('tabletTypeHidden')?.value || formData.get('tabletType') || '',
                uom: document.getElementById('uomHidden')?.value || formData.get('uom') || '',
                merchHistory: merchHistoryEntries,
                modifiedBy: loggedInUser?.name || loggedInUser?.id || 'Unknown User',
                status: 'Received'
            };
        }

        // --- Stock Movement Interface ---

        function setMovementStatus(message, type = 'info') {
            const statusEl = document.getElementById('movementStatusMessage');
            if (!statusEl) return;
            statusEl.textContent = message || '';
            statusEl.classList.remove('error', 'success');
            if (type === 'error') {
                statusEl.classList.add('error');
            } else if (type === 'success') {
                statusEl.classList.add('success');
            }
        }

        function setMovementListLoading(message) {
            const list = document.getElementById('movementPalletList');
            if (!list) return;
            list.innerHTML = `<div style="color:#475569;">${message}</div>`;
        }

        let movementCurrentView = 'monitor';
        let receivingSelectedZone = null;

        async function switchMovementView(view) {
            showRetifluxLoadingOverlay();
            try {
                movementCurrentView = view;
                const monitor = document.getElementById('movementMonitorView');
                const receiving = document.getElementById('movementReceivingView');
                const btns = document.querySelectorAll('.movement-tab-btn');
                btns.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.view === view);
                });
                if (monitor) monitor.style.display = view === 'monitor' ? 'block' : 'none';
                if (receiving) receiving.style.display = view === 'receiving' ? 'block' : 'none';
                if (view === 'receiving') {
                    await ensureMovementPanelLoaded();
                    updateReceivingOperatorDisplay();
                    initReceivingZoneTabs();
                    refreshReceivingView();
                }
            } finally {
                setTimeout(hideRetifluxLoadingOverlay, 120);
            }
        }

        function updateReceivingOperatorDisplay() {
            const el = document.getElementById('receivingOperatorDisplay');
            if (!el) return;
            if (isUserLoggedIn()) {
                el.textContent = loggedInUser.name || loggedInUser.id || '—';
                el.style.color = '#e2e8f0';
            } else {
                el.textContent = 'Not logged in';
                el.style.color = '#94a3b8';
            }
        }

        function initReceivingZoneTabs() {
            const container = document.getElementById('receivingZoneTabs');
            if (!container || !movementZones.length) return;
            container.innerHTML = '';
            movementZones.forEach((zone, idx) => {
                const name = (zone.ZoneName || '').trim();
                if (!name) return;
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'receiving-zone-tab' + (idx === 0 ? ' active' : '');
                btn.textContent = name;
                btn.dataset.zone = name;
                btn.onclick = () => selectReceivingZone(name);
                container.appendChild(btn);
            });
            receivingSelectedZone = (movementZones[0] && movementZones[0].ZoneName) ? movementZones[0].ZoneName.trim() : null;
        }

        function selectReceivingZone(zoneName) {
            receivingSelectedZone = zoneName;
            document.querySelectorAll('.receiving-zone-tab').forEach(t => t.classList.toggle('active', t.dataset.zone === zoneName));
            refreshReceivingView();
        }

        async function refreshReceivingView(forceFresh) {
            if (!receivingSelectedZone) return;
            showRetifluxLoadingOverlay();
            const inList = document.getElementById('receivingInboundsList');
            const outList = document.getElementById('receivingOutboundsList');
            if (inList) inList.innerHTML = '<div style="color:#64748b;">Loading...</div>';
            if (outList) outList.innerHTML = '<div style="color:#64748b;">Loading...</div>';
            try {
                const opts = forceFresh ? { skipCache: true } : {};
                const [inRes, outRes] = await Promise.all([
                    callAppsScript(new URLSearchParams({ action: 'getInboundsToZone', zoneName: receivingSelectedZone }), opts),
                    callAppsScript(new URLSearchParams({ action: 'getOutboundsFromZone', zoneName: receivingSelectedZone }), opts)
                ]);
                renderReceivingInbounds(inRes.pallets || []);
                renderReceivingOutbounds(outRes.pallets || []);
            } catch (err) {
                console.error('Receiving refresh error:', err);
                if (inList) inList.innerHTML = `<div style="color:#ef4444;">Failed to load: ${err.message || 'Unknown error'}</div>`;
                if (outList) outList.innerHTML = `<div style="color:#ef4444;">Failed to load: ${err.message || 'Unknown error'}</div>`;
            } finally {
                hideRetifluxLoadingOverlay();
            }
        }

        function renderReceivingInbounds(pallets) {
            const list = document.getElementById('receivingInboundsList');
            if (!list) return;
            if (!pallets.length) {
                list.innerHTML = '<div style="color:#64748b;">No inbounds awaiting receipt.</div>';
                return;
            }
            list.innerHTML = pallets.map(p => {
                const id = (p.PalletID || p.PalletId || p.ID || '').toString().trim();
                const qty = p.Quantity != null ? p.Quantity : (p.QuantityPacked || '');
                const from = p.CurrentZone || '—';
                const initiated = p.InTransitInitiatedAt ? new Date(p.InTransitInitiatedAt).toLocaleString() : '';
                return `
                    <div class="receiving-pallet-card">
                        <div class="pallet-info">
                            <span class="pallet-id">${escapeHtml(id)}</span>
                            <div class="pallet-meta">Qty: ${escapeHtml(String(qty))} · From: ${escapeHtml(from)} · Initiated: ${escapeHtml(initiated)}</div>
                        </div>
                        <div class="pallet-actions">
                            <button type="button" class="btn-receive" data-pallet-id="${escapeHtml(id)}" onclick="doReceivePallet(this.dataset.palletId, this)">Receive</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderReceivingOutbounds(pallets) {
            const list = document.getElementById('receivingOutboundsList');
            if (!list) return;
            const canCancel = isUserLoggedIn() && (loggedInUser?.role || '').toLowerCase().match(/^(supervisor|qa)$/);
            if (!pallets.length) {
                list.innerHTML = '<div style="color:#64748b;">No outbounds from this zone.</div>';
                return;
            }
            list.innerHTML = pallets.map(p => {
                const id = (p.PalletID || p.PalletId || p.ID || '').toString().trim();
                const qty = p.Quantity != null ? p.Quantity : (p.QuantityPacked || '');
                const to = p.InTransitToZone || '—';
                const initiated = p.InTransitInitiatedAt ? new Date(p.InTransitInitiatedAt).toLocaleString() : '';
                return `
                    <div class="receiving-pallet-card">
                        <div class="pallet-info">
                            <span class="pallet-id">${escapeHtml(id)}</span>
                            <div class="pallet-meta">Qty: ${escapeHtml(String(qty))} · To: ${escapeHtml(to)} · Initiated: ${escapeHtml(initiated)}</div>
                            <div class="badge-in-transit">In Transit to ${escapeHtml(to)}</div>
                        </div>
                        <div class="pallet-actions">
                            ${canCancel ? `<button type="button" class="btn-cancel-transit" data-pallet-id="${escapeHtml(id)}" onclick="doCancelTransit(this.dataset.palletId, this)">Cancel Transit</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function doReceivePallet(palletId, btnEl) {
            if (!isUserLoggedIn()) {
                showToast('Please log in to receive pallets.', 'error', 5000);
                return;
            }
            if (!(palletId || '').toString().trim()) {
                showToast('Invalid pallet ID.', 'error', 5000);
                return;
            }
            if (!receivingSelectedZone) return;
            const receivedBy = (loggedInUser?.id || '').toString().trim();
            if (!receivedBy) {
                showToast('Your session has no user ID. Please log in again.', 'error', 5000);
                return;
            }
            const card = btnEl?.closest('.receiving-pallet-card');
            const origContent = card?.innerHTML;
            if (card) {
                card.style.opacity = '0.6';
                card.style.pointerEvents = 'none';
                if (btnEl) { btnEl.disabled = true; btnEl.textContent = '...'; }
            }
            try {
                const result = await callAppsScript(new URLSearchParams({
                    action: 'receivePallet',
                    palletId: palletId,
                    zoneName: receivingSelectedZone,
                    receivedBy: receivedBy
                }));
                clearCache('getInboundsToZone');
                clearCache('getOutboundsFromZone');
                clearCache('getPalletsInZone');
                clearCache('getZoneInventoryTotals');
                showToast(result.message || 'Pallet received successfully', 'success', 5000);
                if (card) card.remove();
                refreshReceivingView();
                refreshMovementZone();
            } catch (err) {
                showToast(err.message || 'Failed to receive pallet', 'error', 6000);
                if (card) { card.style.opacity = '1'; card.style.pointerEvents = ''; if (btnEl) { btnEl.disabled = false; btnEl.textContent = 'Receive'; } }
            }
        }

        async function doCancelTransit(palletId, btnEl) {
            if (!isUserLoggedIn()) {
                showToast('Please log in to cancel transit.', 'error', 5000);
                return;
            }
            const reason = prompt('Escalation reason (required for Cancel Transit):');
            if (reason === null) return;
            if (!(reason || '').trim()) {
                showToast('Escalation reason is required.', 'error', 5000);
                return;
            }
            const card = btnEl?.closest('.receiving-pallet-card');
            if (card) { card.style.opacity = '0.6'; card.style.pointerEvents = 'none'; if (btnEl) { btnEl.disabled = true; btnEl.textContent = '...'; } }
            try {
                const result = await callAppsScript(new URLSearchParams({
                    action: 'cancelTransit',
                    palletId: palletId,
                    cancelledBy: loggedInUser.id,
                    escalationReason: (reason || '').trim()
                }));
                clearCache('getInboundsToZone');
                clearCache('getOutboundsFromZone');
                clearCache('getPalletsInZone');
                clearCache('getZoneInventoryTotals');
                showToast(result.message || 'Transit cancelled', 'success', 5000);
                if (card) card.remove();
                refreshReceivingView();
                refreshMovementZone();
            } catch (err) {
                showToast(err.message || 'Failed to cancel transit', 'error', 6000);
                if (card) { card.style.opacity = '1'; card.style.pointerEvents = ''; if (btnEl) { btnEl.disabled = false; btnEl.textContent = 'Cancel Transit'; } }
            }
        }

        function toggleMovementPanel(forceOpen) {
            if (!isUserLoggedIn()) {
                alert('🔐 Please log in before using stock movement controls.');
                showLoginCard();
                return;
            }
            const panel = document.getElementById('movementPanel');
            const toggleBtn = document.getElementById('movementToggleBtn');
            if (!panel || !toggleBtn) return;
            const shouldOpen = forceOpen !== undefined ? forceOpen : !panel.classList.contains('active');
            if (shouldOpen) {
                panel.classList.add('active');
                toggleBtn.textContent = '🚫 Close Stock Movement Control';
                ensureMovementPanelLoaded();
            } else {
                panel.classList.remove('active');
                toggleBtn.textContent = '🚚 Open Stock Movement Control';
            }
        }

        async function ensureMovementPanelLoaded() {
            if (movementPanelInitialized) {
                autoFillMovementOperator();
                return;
            }
            try {
                setMovementStatus('Loading zones...');
                const result = await callAppsScript(new URLSearchParams({ action: 'getZoneConfig' }));
                const allZones = (result.zones || []).filter(zone => zone.ZoneName);
                
                // DEDUPLICATE: Remove duplicate zones (case-insensitive, trim whitespace)
                const zoneMap = new Map();
                allZones.forEach(zone => {
                    const normalizedName = (zone.ZoneName || '').trim();
                    if (!normalizedName) return;
                    
                    // Check for existing zone (case-insensitive)
                    const existingKey = Array.from(zoneMap.keys()).find(
                        key => key.toLowerCase() === normalizedName.toLowerCase()
                    );
                    
                    if (existingKey) {
                        // Keep the one with better formatting (prefer exact match, then shorter name)
                        const existing = zoneMap.get(existingKey);
                        if (normalizedName === existingKey || normalizedName.length < existingKey.length) {
                            zoneMap.delete(existingKey);
                            zoneMap.set(normalizedName, { ...zone, ZoneName: normalizedName });
                        }
                        // Otherwise keep existing
                    } else {
                        zoneMap.set(normalizedName, { ...zone, ZoneName: normalizedName });
                    }
                });
                
                movementZones = Array.from(zoneMap.values());
                
                // Extract all unique DefaultStatus values from zones for status filter dropdown
                const allStatuses = new Set();
                movementZones.forEach(zone => {
                    const defaultStatus = (zone.DefaultStatus || '').trim();
                    if (defaultStatus) {
                        allStatuses.add(defaultStatus);
                    }
                });
                // Add common statuses that might not be in DefaultStatus
                allStatuses.add('Active');
                allStatuses.add('Hold');
                allStatuses.add('Rework');
                allStatuses.add('Dispatch');
                allStatuses.add('Shipped');
                allStatuses.add('Outbounding');
                allStatuses.add('Outbonded');
                
                // Update status filter dropdown with statuses from ZoneConfig
                const statusFilter = document.getElementById('movementStatusFilter');
                if (statusFilter) {
                    statusFilter.innerHTML = '<option value="">Any status</option>';
                    Array.from(allStatuses).sort().forEach(status => {
                        const option = document.createElement('option');
                        option.value = status;
                        option.textContent = status;
                        statusFilter.appendChild(option);
                    });
                }
                
                populateMovementZoneOptions(false, null);
                movementPanelInitialized = true;
                const zoneSelectEl = document.getElementById('movementZoneSelect');
                if (zoneSelectEl && !zoneSelectEl.dataset.changeListenerAdded) {
                    zoneSelectEl.dataset.changeListenerAdded = '1';
                    zoneSelectEl.addEventListener('change', function() {
                        if (this.value) refreshMovementZone();
                    });
                }
                const palletIdInput = document.getElementById('movementPalletId');
                if (palletIdInput) {
                    palletIdInput.addEventListener('blur', function() {
                        const pid = this.value.trim();
                        if (!pid) return;
                        const pallet = movementLastPallets.find(p => (p.PalletID || '').toLowerCase() === pid.toLowerCase());
                        if (pallet) {
                            movementSelectedPallet = pallet;
                            const cz = document.getElementById('movementCurrentZone');
                            if (cz) cz.value = pallet.CurrentZone || '';
                            const status = (pallet.Status || '').toLowerCase();
                            if (status.includes('outbounding')) {
                                populateMovementZoneOptions(true, null);
                            } else {
                                populateMovementZoneOptions(false, pallet.CurrentZone || null);
                            }
                        }
                    });
                }
                setMovementStatus('');
                await refreshMovementZone();
            } catch (error) {
                console.error('Movement init error:', error);
                showToast(error.message || 'Failed to load zones', 'error', 6000);
                setMovementStatus('');
            }
        }

        // Zone eligibility function - STRICTLY follows all rules (GLOBAL - accessible everywhere)
        function getAllowedDestinations(fromZoneName) {
            if (!movementZones || movementZones.length === 0) return [];
            const fromZone = (fromZoneName || '').toLowerCase();
            const allowed = [];
            
            // Rule 1: From Receiving Area (REC) - can move to ALL except OUT and OBD
            if (fromZone.includes('receiving area')) {
                movementZones.forEach(z => {
                    const zName = z.ZoneName.toLowerCase();
                    // Case-insensitive check: exclude outbounding and all OUTBONDED variations
                    if (!zName.includes('outbounding') && zName !== 'outbonded' && zName !== 'outbounded') {
                        allowed.push(z.ZoneName);
                    }
                });
                return allowed;
            }
            
            // Rule 2: From Product Zones (DET, FAT, LIQ, SOP) - only SM, DSP, QAH
            if (fromZone.includes('detergents zone') || fromZone.includes('fats zone') || 
                fromZone.includes('liquids/oils zone') || fromZone.includes('soaps zone')) {
                movementZones.forEach(z => {
                    const zName = z.ZoneName.toLowerCase();
                    if (zName.includes('supermarket area') || zName.includes('dispatch loading area') || 
                        zName === 'qa hold') {
                        allowed.push(z.ZoneName);
                    }
                });
                return allowed;
            }
            
            // Rule 3: From Rework Zone (REW) - can move to REC, QAH, SM (NOT DSP)
            if (fromZone.includes('rework zone') || fromZone.includes('rework')) {
                movementZones.forEach(z => {
                    const zName = z.ZoneName.toLowerCase();
                    if (zName.includes('receiving area') || zName === 'qa hold' || 
                        zName.includes('supermarket area')) {
                        allowed.push(z.ZoneName);
                    }
                });
                return allowed;
            }
            
            // Rule 4: From SuperMarket Area (SM) - can move to SM (itself), DSP, QAH
            if (fromZone.includes('supermarket area')) {
                movementZones.forEach(z => {
                    const zName = z.ZoneName.toLowerCase();
                    if (zName.includes('supermarket area') || zName.includes('dispatch loading area') || 
                        zName === 'qa hold') {
                        allowed.push(z.ZoneName);
                    }
                });
                return allowed;
            }
            
            // Rule 5: From QA Hold (QAH) - can move to REW, DSP, SM, QAH (itself)
            if (fromZone === 'qa hold') {
                movementZones.forEach(z => {
                    const zName = z.ZoneName.toLowerCase();
                    if (zName.includes('rework') || zName.includes('dispatch loading area') || 
                        zName.includes('supermarket area') || zName === 'qa hold') {
                        allowed.push(z.ZoneName);
                    }
                });
                return allowed;
            }
            
            // Rule 6: From Dispatch Loading Area (DSP) - can move to OUT, REW, QAH, SM (NOT itself)
            if (fromZone.includes('dispatch loading area')) {
                movementZones.forEach(z => {
                    const zName = z.ZoneName.toLowerCase();
                    if (zName.includes('outbounding') || zName.includes('rework') || 
                        zName === 'qa hold' || zName.includes('supermarket area')) {
                        allowed.push(z.ZoneName);
                    }
                });
                return allowed;
            }
            
            // Rule 7: From Outbounding (OUT) - can move to OBD, REW, QAH
            if (fromZone.includes('outbounding')) {
                movementZones.forEach(z => {
                    const zName = z.ZoneName.toLowerCase();
                    // Case-insensitive matching for OUTBONDED (handles: outbonded, OUTBONDED, Outbonded, OUTBOUNDED, Outbounded)
                    if (zName === 'outbonded' || zName === 'outbounded' || zName.includes('rework') || zName === 'qa hold') {
                        allowed.push(z.ZoneName);
                    }
                });
                return allowed;
            }
            
            // Rule 8: From OUTBONDED (OBD) - FINAL, no movement allowed
            // Case-insensitive check for all OUTBONDED variations
            if (fromZone === 'outbonded' || fromZone === 'outbounded') {
                return []; // No destinations allowed
            }
            
            return allowed;
        }
        
        function populateMovementZoneOptions(filterForOutbounding = false, fromZoneName = null) {
            const zoneSelect = document.getElementById('movementZoneSelect');
            const toZoneSelect = document.getElementById('movementToZoneSelect');
            if (!zoneSelect || !toZoneSelect) return;
            
            // Ensure Outbounding zone exists (note: it's "Outbounding" not "Outbounded" based on sheet)
            const hasOutbounding = movementZones.some(z => 
                z.ZoneName.toLowerCase() === 'outbounding'
            );
            if (!hasOutbounding) {
                movementZones.push({
                    ZoneName: 'Outbounding',
                    Prefix: 'OUT',
                    FIFORequired: false,
                    AllowsSplitting: false
                });
            }
            
            // Ensure OUTBONDED zone exists (final consumer destination)
            const hasOutbonded = movementZones.some(z => 
                z.ZoneName.toLowerCase() === 'outbonded'
            );
            if (!hasOutbonded) {
                movementZones.push({
                    ZoneName: 'OUTBONDED',
                    Prefix: 'OBD',
                    FIFORequired: false,
                    AllowsSplitting: false
                });
            }
            
            // Ensure Rework Zone exists (check for both "Rework Zone" and "Rework")
            const hasRework = movementZones.some(z => 
                z.ZoneName.toLowerCase().includes('rework')
            );
            if (!hasRework) {
                movementZones.push({
                    ZoneName: 'Rework Zone',
                    Prefix: 'REW',
                    FIFORequired: false,
                    AllowsSplitting: true
                });
            }
            
            // Ensure QA Hold zone exists
            const hasQAHold = movementZones.some(z => 
                z.ZoneName.toLowerCase() === 'qa hold'
            );
            if (!hasQAHold) {
                movementZones.push({
                    ZoneName: 'QA Hold',
                    Prefix: 'QAH',
                    FIFORequired: false,
                    AllowsSplitting: false
                });
            }
            
            movementZones.sort((a, b) => (a.ZoneName || '').localeCompare(b.ZoneName || ''));
            const savedZoneValue = zoneSelect.value;
            zoneSelect.innerHTML = '';
            
            // Placeholder - user must select a zone before any data loads
            const placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.textContent = 'Select zone';
            zoneSelect.appendChild(placeholder);
            
            movementZones.forEach(zone => {
                const option = document.createElement('option');
                option.value = zone.ZoneName;
                option.textContent = `${zone.ZoneName} (${zone.Prefix || 'N/A'})`;
                zoneSelect.appendChild(option.cloneNode(true));
            });
            
            let zonesToShow = [];
            if (filterForOutbounding) {
                zonesToShow = movementZones.filter(z => {
                    const name = z.ZoneName.toLowerCase();
                    return name === 'outbonded' || name.includes('rework') || name === 'qa hold';
                });
            } else if (fromZoneName) {
                const allowedNames = getAllowedDestinations(fromZoneName);
                zonesToShow = movementZones.filter(z => allowedNames.includes(z.ZoneName));
            }
            
            toZoneSelect.innerHTML = '';
            if (zonesToShow.length === 0) {
                const placeholder = document.createElement('option');
                placeholder.value = '';
                placeholder.textContent = fromZoneName ? 'No destinations allowed from this zone' : 'Select a pallet first';
                toZoneSelect.appendChild(placeholder);
            } else {
                zonesToShow.forEach(zone => {
                    const option = document.createElement('option');
                    option.value = zone.ZoneName;
                    option.textContent = `${zone.ZoneName} (${zone.Prefix || 'N/A'})`;
                    toZoneSelect.appendChild(option);
                });
                const outboundedOption = zonesToShow.find(z => z.ZoneName.toLowerCase() === 'outbonded' || z.ZoneName.toLowerCase() === 'outbounded');
                toZoneSelect.value = outboundedOption ? outboundedOption.ZoneName : zonesToShow[0].ZoneName;
            }
            
            if (movementZones.length) {
                const toRestore = movementZones.find(z => z.ZoneName === savedZoneValue);
                zoneSelect.value = toRestore ? savedZoneValue : '';
            }
            updateMovementZoneMeta(zoneSelect.value);
            autoFillMovementOperator();
        }
        
        // NEW: Comprehensive zone overview table with FIFO indicators
        // Zone eligibility function - STRICTLY follows all rules (GLOBAL - accessible everywhere)
        function getAllowedDestinations(fromZoneName) {
            if (!movementZones || movementZones.length === 0) return [];
            const fromZone = (fromZoneName || '').toLowerCase();
            const allowed = [];
            
            // Rule 1: From Receiving Area (REC) - can move to ALL except OUT and OBD
            if (fromZone.includes('receiving area')) {
                movementZones.forEach(z => {
                    const zName = z.ZoneName.toLowerCase();
                    // Case-insensitive check: exclude outbounding and all OUTBONDED variations
                    if (!zName.includes('outbounding') && zName !== 'outbonded' && zName !== 'outbounded') {
                        allowed.push(z.ZoneName);
                    }
                });
                return allowed;
            }
            
            // Rule 2: From Product Zones (DET, FAT, LIQ, SOP) - only SM, DSP, QAH
            if (fromZone.includes('detergents zone') || fromZone.includes('fats zone') || 
                fromZone.includes('liquids/oils zone') || fromZone.includes('soaps zone')) {
                movementZones.forEach(z => {
                    const zName = z.ZoneName.toLowerCase();
                    if (zName.includes('supermarket area') || zName.includes('dispatch loading area') || 
                        zName === 'qa hold') {
                        allowed.push(z.ZoneName);
                    }
                });
                return allowed;
            }
            
            // Rule 3: From Rework Zone (REW) - can move to REC, QAH, SM (NOT DSP)
            if (fromZone.includes('rework zone') || fromZone.includes('rework')) {
                movementZones.forEach(z => {
                    const zName = z.ZoneName.toLowerCase();
                    if (zName.includes('receiving area') || zName === 'qa hold' || 
                        zName.includes('supermarket area')) {
                        allowed.push(z.ZoneName);
                    }
                });
                return allowed;
            }
            
            // Rule 4: From SuperMarket Area (SM) - can move to SM (itself), DSP, QAH
            if (fromZone.includes('supermarket area')) {
                movementZones.forEach(z => {
                    const zName = z.ZoneName.toLowerCase();
                    if (zName.includes('supermarket area') || zName.includes('dispatch loading area') || 
                        zName === 'qa hold') {
                        allowed.push(z.ZoneName);
                    }
                });
                return allowed;
            }
            
            // Rule 5: From QA Hold (QAH) - can move to REW, DSP, SM, QAH (itself)
            if (fromZone === 'qa hold') {
                movementZones.forEach(z => {
                    const zName = z.ZoneName.toLowerCase();
                    if (zName.includes('rework') || zName.includes('dispatch loading area') || 
                        zName.includes('supermarket area') || zName === 'qa hold') {
                        allowed.push(z.ZoneName);
                    }
                });
                return allowed;
            }
            
            // Rule 6: From Dispatch Loading Area (DSP) - can move to OUT, REW, QAH, SM (NOT itself)
            if (fromZone.includes('dispatch loading area')) {
                movementZones.forEach(z => {
                    const zName = z.ZoneName.toLowerCase();
                    if (zName.includes('outbounding') || zName.includes('rework') || 
                        zName === 'qa hold' || zName.includes('supermarket area')) {
                        allowed.push(z.ZoneName);
                    }
                });
                return allowed;
            }
            
            // Rule 7: From Outbounding (OUT) - can move to OBD, REW, QAH
            if (fromZone.includes('outbounding')) {
                movementZones.forEach(z => {
                    const zName = z.ZoneName.toLowerCase();
                    // Case-insensitive matching for OUTBONDED (handles: outbonded, OUTBONDED, Outbonded, OUTBOUNDED, Outbounded)
                    if (zName === 'outbonded' || zName === 'outbounded' || zName.includes('rework') || zName === 'qa hold') {
                        allowed.push(z.ZoneName);
                    }
                });
                return allowed;
            }
            
            // Rule 8: From OUTBONDED (OBD) - FINAL, no movement allowed
            // Case-insensitive check for all OUTBONDED variations
            if (fromZone === 'outbonded' || fromZone === 'outbounded') {
                return []; // No destinations allowed
            }
            
            return allowed;
        }
        
        async function refreshZoneOverview() {
            const tableContainer = document.getElementById('zoneOverviewTable');
            const palletList = document.getElementById('movementPalletList');
            
            if (!tableContainer) {
                showToast('Zone overview table not found', 'error');
                return;
            }
            
            // Toggle visibility
            const isVisible = tableContainer.style.display !== 'none';
            tableContainer.style.display = isVisible ? 'none' : 'block';
            if (palletList) palletList.style.display = isVisible ? 'flex' : 'none';
            
            if (isVisible) return; // Hide table
            
            showRetifluxLoadingOverlay();
            try {
            // Ensure zones are loaded first
            if (!movementPanelInitialized || !movementZones || movementZones.length === 0) {
                tableContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: rgba(251, 191, 36, 0.9);"><p>Loading zones...</p></div>';
                try {
                    await ensureMovementPanelLoaded();
                } catch (error) {
                    tableContainer.innerHTML = `<div style="color: #fca5a5; padding: 20px; text-align: center;">Error loading zones: ${error.message}</div>`;
                    return;
                }
            }
            
            if (!movementZones || movementZones.length === 0) {
                tableContainer.innerHTML = '<div style="color: #fca5a5; padding: 20px; text-align: center;">No zones found. Please configure zones first.</div>';
                return;
            }
            
            try {
                // OPTIMIZED: Load all zones in parallel with better error handling
                const totalZones = movementZones.length;
                let loadedCount = 0;
                
                // Create all zone loading promises at once
                const zonePromises = movementZones.map(async (zone, index) => {
                    try {
                        const params = new URLSearchParams({
                            action: 'getPalletsInZone',
                            zoneName: zone.ZoneName,
                            limit: 10000
                        });
                        
                        // Increased timeout to 15 seconds per zone (more realistic for large datasets)
                        const timeoutPromise = new Promise((_, reject) => 
                            setTimeout(() => reject(new Error(`Timeout after 15s`)), 15000)
                        );
                        
                        const result = await Promise.race([
                            callAppsScript(params),
                            timeoutPromise
                        ]);
                        
                        const pallets = result.pallets || [];
                        
                        // Sort by CreatedAt for FIFO (oldest first)
                        pallets.sort((a, b) => {
                            const dateA = new Date(a.CreatedAt || a.CreatedDate || 0);
                            const dateB = new Date(b.CreatedAt || b.CreatedDate || 0);
                            return dateA - dateB;
                        });
                        
                        loadedCount++;
                        // Update progress
                        if (loadedCount % Math.max(1, Math.floor(totalZones / 4)) === 0 || loadedCount === totalZones) {
                            const progress = Math.round((loadedCount / totalZones) * 100);
                            tableContainer.innerHTML = `<div style="text-align: center; padding: 20px; color: rgba(251, 191, 36, 0.9);"><div class="loading-spinner"></div><p>Loading zone overview...</p><p style="font-size: 12px; margin-top: 8px; opacity: 0.7;">${loadedCount} of ${totalZones} zones loaded (${progress}%)</p></div>`;
                        }
                        
                        return {
                            zone: zone,
                            pallets: pallets,
                            totalQty: pallets.reduce((sum, p) => sum + (parseFloat(p.RemainingQuantity ?? p.Quantity ?? 0) || 0), 0),
                            oldestPallet: pallets[0] || null,
                            needsMovement: pallets.length > 0 && parseBooleanFlag(zone.FIFORequired) && pallets.length > 1,
                            error: null
                        };
                    } catch (error) {
                        console.error(`Error loading zone ${zone.ZoneName}:`, error);
                        loadedCount++;
                        // Update progress even on error
                        const progress = Math.round((loadedCount / totalZones) * 100);
                        if (loadedCount % Math.max(1, Math.floor(totalZones / 4)) === 0 || loadedCount === totalZones) {
                            tableContainer.innerHTML = `<div style="text-align: center; padding: 20px; color: rgba(251, 191, 36, 0.9);"><div class="loading-spinner"></div><p>Loading zone overview...</p><p style="font-size: 12px; margin-top: 8px; opacity: 0.7;">${loadedCount} of ${totalZones} zones loaded (${progress}%)</p><p style="font-size: 11px; margin-top: 4px; color: rgba(252, 165, 165, 0.8);">Some zones may have errors</p></div>`;
                        }
                        return {
                            zone: zone,
                            pallets: [],
                            totalQty: 0,
                            oldestPallet: null,
                            needsMovement: false,
                            error: error.message || 'Failed to load'
                        };
                    }
                });
                
                // Show initial loading state
                tableContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: rgba(251, 191, 36, 0.9);"><div class="loading-spinner"></div><p>Loading zone overview...</p><p style="font-size: 12px; margin-top: 8px; opacity: 0.7;">Loading zones (aligned with Inventory Snapshot)...</p></div>';
                
                // Load zone totals from backend (same source as Inventory Snapshot)
                let zoneTotalsMap = {};
                try {
                    const totalsResp = await callAppsScript(new URLSearchParams({ action: 'getZoneInventoryTotals' }));
                    if (totalsResp.success && totalsResp.zones) {
                        totalsResp.zones.forEach(z => {
                            zoneTotalsMap[z.zoneName] = { current: z.current || 0, palletsCurrent: z.palletsCurrent || 0 };
                        });
                    }
                } catch (e) {
                    console.warn('getZoneInventoryTotals failed, using getPalletsInZone sums:', e);
                }
                
                // Load zones in batches of 5 to avoid overwhelming the API
                const BATCH_SIZE = 5;
                const allSettledResults = [];
                
                for (let i = 0; i < zonePromises.length; i += BATCH_SIZE) {
                    const batch = zonePromises.slice(i, i + BATCH_SIZE);
                    const batchResults = await Promise.allSettled(batch);
                    allSettledResults.push(...batchResults);
                    
                    // Small delay between batches to avoid rate limiting
                    if (i + BATCH_SIZE < zonePromises.length) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                }
                
                // Extract results (both fulfilled and rejected)
                const allZonesData = allSettledResults.map((result, index) => {
                    if (result.status === 'fulfilled') {
                        return result.value;
                    } else {
                        // If promise itself was rejected (shouldn't happen due to try-catch, but safety)
                        const zone = movementZones[index];
                        return {
                            zone: zone || { ZoneName: 'Unknown' },
                            pallets: [],
                            totalQty: 0,
                            oldestPallet: null,
                            needsMovement: false,
                            error: result.reason?.message || 'Unknown error'
                        };
                    }
                });
                
                // List all zones for user reference
                const allZoneNames = movementZones.map(z => z.ZoneName).filter(Boolean).sort();
                
                // Helper function to recommend destination zone based on forward movement flow - STRICTLY follows rules
                const recommendDestination = function(currentZone, palletStatus) {
                    const status = (palletStatus || '').toLowerCase();
                    const zoneName = currentZone.ZoneName || currentZone;
                    
                    // SPECIAL RULE: Outbounding status can ONLY move to: OUTBONDED (consumer), Rework Zone, or QA Hold
                    // Note: "Outbounding" is a zone name, not just a status
                    if (status.includes('outbounding') || status === 'shipped') {
                        // Priority: OUTBONDED first (final consumer), then Rework Zone, then QA Hold
                        // Match zones case-insensitively and handle "Rework Zone" vs "Rework"
                        const allowedZoneNames = ['OUTBONDED', 'Outbonded', 'Rework Zone', 'Rework', 'QA Hold'];
                        for (const allowedZone of allowedZoneNames) {
                            const zoneExists = movementZones.some(z => 
                                z.ZoneName.toLowerCase() === allowedZone.toLowerCase() ||
                                z.ZoneName.toLowerCase().includes(allowedZone.toLowerCase())
                            );
                            if (zoneExists) {
                                // Return the actual zone name from movementZones
                                const foundZone = movementZones.find(z => 
                                    z.ZoneName.toLowerCase() === allowedZone.toLowerCase() ||
                                    z.ZoneName.toLowerCase().includes(allowedZone.toLowerCase())
                                );
                                return foundZone ? foundZone.ZoneName : allowedZone;
                            }
                        }
                        return null; // No allowed zones found
                    }
                    
                    // Dispatch or Shipped -> Outbounding zone first, then OUTBONDED
                    if (status === 'dispatch' || status === 'shipped') {
                        // First check if current zone is Dispatch Loading Area → should go to Outbounding
                        if (zoneName.toLowerCase().includes('dispatch loading area')) {
                            const outboundingZone = movementZones.find(z => 
                                z.ZoneName.toLowerCase().includes('outbounding')
                            );
                            if (outboundingZone) {
                                return outboundingZone.ZoneName;
                            }
                        }
                        // Otherwise, if already in Outbounding, go to OUTBONDED
                        if (zoneName.toLowerCase().includes('outbounding')) {
                            const outbondedZone = movementZones.find(z => 
                                z.ZoneName.toLowerCase() === 'outbonded'
                            );
                            if (outbondedZone) {
                                return outbondedZone.ZoneName;
                            }
                        }
                    }
                    
                    // Get allowed destinations based on strict rules
                    const allowedDestinations = getAllowedDestinations(zoneName);
                    
                    // Priority recommendations based on forward flow
                    const zoneLower = zoneName.toLowerCase();
                    
                    // Forward flow priority: REC → Product Zones → SM → DSP → OUT → OBD
                    if (zoneLower.includes('receiving area')) {
                        // Prefer product zones first
                        const productZones = ['Detergents Zone', 'Fats Zone', 'Liquids/Oils Zone', 'Soaps Zone'];
                        for (const pz of productZones) {
                            if (allowedDestinations.includes(pz)) return pz;
                        }
                        // Then SM, QAH, REW, DSP
                        if (allowedDestinations.includes('SuperMarket Area')) return 'SuperMarket Area';
                        if (allowedDestinations.includes('QA Hold')) return 'QA Hold';
                        if (allowedDestinations.find(z => z.toLowerCase().includes('rework'))) {
                            return allowedDestinations.find(z => z.toLowerCase().includes('rework'));
                        }
                        if (allowedDestinations.find(z => z.toLowerCase().includes('dispatch loading area'))) {
                            return allowedDestinations.find(z => z.toLowerCase().includes('dispatch loading area'));
                        }
                    } else if (zoneLower.includes('detergents zone') || zoneLower.includes('fats zone') || 
                               zoneLower.includes('liquids/oils zone') || zoneLower.includes('soaps zone')) {
                        // Product zones → SM first, then DSP, then QAH
                        if (allowedDestinations.includes('SuperMarket Area')) return 'SuperMarket Area';
                        if (allowedDestinations.find(z => z.toLowerCase().includes('dispatch loading area'))) {
                            return allowedDestinations.find(z => z.toLowerCase().includes('dispatch loading area'));
                        }
                        if (allowedDestinations.includes('QA Hold')) return 'QA Hold';
                    } else if (zoneLower.includes('supermarket area')) {
                        // SM → DSP first
                        if (allowedDestinations.find(z => z.toLowerCase().includes('dispatch loading area'))) {
                            return allowedDestinations.find(z => z.toLowerCase().includes('dispatch loading area'));
                        }
                        if (allowedDestinations.includes('QA Hold')) return 'QA Hold';
                    } else if (zoneLower.includes('dispatch loading area')) {
                        // DSP → OUT first
                        if (allowedDestinations.find(z => z.toLowerCase().includes('outbounding'))) {
                            return allowedDestinations.find(z => z.toLowerCase().includes('outbounding'));
                        }
                        // Then REW, QAH, SM
                        if (allowedDestinations.find(z => z.toLowerCase().includes('rework'))) {
                            return allowedDestinations.find(z => z.toLowerCase().includes('rework'));
                        }
                        if (allowedDestinations.includes('QA Hold')) return 'QA Hold';
                        if (allowedDestinations.includes('SuperMarket Area')) return 'SuperMarket Area';
                    } else if (zoneLower.includes('outbounding')) {
                        // OUT → OBD first
                        if (allowedDestinations.includes('OUTBONDED')) return 'OUTBONDED';
                        // Then REW, QAH
                        if (allowedDestinations.find(z => z.toLowerCase().includes('rework'))) {
                            return allowedDestinations.find(z => z.toLowerCase().includes('rework'));
                        }
                        if (allowedDestinations.includes('QA Hold')) return 'QA Hold';
                    } else if (zoneLower.includes('rework')) {
                        // REW → REC first (for repositioning), then SM, then QAH (NOT DSP)
                        if (allowedDestinations.find(z => z.toLowerCase().includes('receiving area'))) {
                            return allowedDestinations.find(z => z.toLowerCase().includes('receiving area'));
                        }
                        if (allowedDestinations.includes('SuperMarket Area')) return 'SuperMarket Area';
                        if (allowedDestinations.includes('QA Hold')) return 'QA Hold';
                    } else if (zoneLower === 'qa hold') {
                        // QAH → REW first, then DSP, then SM
                        if (allowedDestinations.find(z => z.toLowerCase().includes('rework'))) {
                            return allowedDestinations.find(z => z.toLowerCase().includes('rework'));
                        }
                        if (allowedDestinations.find(z => z.toLowerCase().includes('dispatch loading area'))) {
                            return allowedDestinations.find(z => z.toLowerCase().includes('dispatch loading area'));
                        }
                        if (allowedDestinations.includes('SuperMarket Area')) return 'SuperMarket Area';
                    }
                    
                    // Return first allowed destination if no priority match
                    return allowedDestinations.length > 0 ? allowedDestinations[0] : null;
                };
                
                // Get allowed destinations for Outbounding status
                const getAllowedDestinationsForOutbounding = () => {
                    const allowed = ['Outbounded', 'Rework', 'QA Hold'];
                    return allowed.filter(zoneName => 
                        movementZones.some(z => z.ZoneName === zoneName)
                    );
                };
                
                // Build comprehensive table
                let tableHTML = `
                    <h3 style="color: #fbbf24; margin: 0 0 16px 0; font-size: 18px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">⬥ Zone Overview & FIFO Status</h3>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                            <thead>
                                <tr style="background: rgba(245, 158, 11, 0.2); border-bottom: 2px solid rgba(245, 158, 11, 0.4);">
                                    <th style="padding: 12px; text-align: left; color: #fbbf24; font-weight: 700; text-transform: uppercase;">Zone</th>
                                    <th style="padding: 12px; text-align: center; color: #fbbf24; font-weight: 700; text-transform: uppercase;">Pallets</th>
                                    <th style="padding: 12px; text-align: center; color: #fbbf24; font-weight: 700; text-transform: uppercase;">SKUs</th>
                                    <th style="padding: 12px; text-align: center; color: #fbbf24; font-weight: 700; text-transform: uppercase;">Total Qty</th>
                                    <th style="padding: 12px; text-align: left; color: #fbbf24; font-weight: 700; text-transform: uppercase;">Oldest Pallet</th>
                                    <th style="padding: 12px; text-align: center; color: #fbbf24; font-weight: 700; text-transform: uppercase;">FIFO</th>
                                    <th style="padding: 12px; text-align: center; color: #fbbf24; font-weight: 700; text-transform: uppercase;">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                allZonesData.forEach((zoneData, index) => {
                    const zone = zoneData.zone;
                    const fifoRequired = parseBooleanFlag(zone.FIFORequired);
                    const oldestDate = zoneData.oldestPallet ? formatMovementDate(zoneData.oldestPallet.CreatedAt || zoneData.oldestPallet.CreatedDate) : 'N/A';
                    const oldestId = zoneData.oldestPallet ? (zoneData.oldestPallet.PalletID || 'N/A') : 'N/A';
                    const hasError = zoneData.error;
                    
                    // Count unique SKUs in this zone and build SKU details map
                    const uniqueSKUs = new Set();
                    const skuDetails = new Map(); // SKU -> { totalQty, palletCount }
                    if (!hasError && zoneData.pallets.length > 0) {
                        zoneData.pallets.forEach(pallet => {
                            const sku = (pallet.SKU || pallet.sku || '').trim();
                            if (sku) {
                                uniqueSKUs.add(sku);
                                const qty = parseFloat(pallet.RemainingQuantity ?? pallet.Quantity ?? 0) || 0;
                                if (skuDetails.has(sku)) {
                                    const existing = skuDetails.get(sku);
                                    existing.totalQty += qty;
                                    existing.palletCount += 1;
                                } else {
                                    skuDetails.set(sku, { totalQty: qty, palletCount: 1 });
                                }
                            }
                        });
                    }
                    const skuCount = uniqueSKUs.size;
                    const skuDetailsArray = Array.from(skuDetails.entries()).map(([sku, data]) => ({
                        sku,
                        totalQty: data.totalQty,
                        palletCount: data.palletCount
                    })).sort((a, b) => a.sku.localeCompare(b.sku));
                    
                    // Determine action recommendation - ALWAYS show if there are pallets
                    let actionHTML = '<span style="color: rgba(255, 255, 255, 0.5);">—</span>';
                    
                    if (!hasError && zoneData.pallets.length > 0) {
                        // Find pallets that need movement (forward flow)
                        const palletsNeedingMovement = zoneData.pallets.filter(p => {
                            const status = (p.Status || '').toLowerCase();
                            // Outbounding should move to Outbounded/Rework/QA Hold
                            if (status.includes('outbounding')) {
                                return true; // Always needs movement
                            }
                            // Dispatch, Shipped: If in Dispatch Loading Area → Outbounding, if in Outbounding → OUTBONDED
                            if (status === 'dispatch' || status === 'shipped') {
                                const currentZoneLower = (p.CurrentZone || '').toLowerCase();
                                if (currentZoneLower.includes('dispatch loading area')) {
                                    const outboundingZone = movementZones.find(z => 
                                        z.ZoneName.toLowerCase().includes('outbounding')
                                    );
                                    return outboundingZone && p.CurrentZone !== outboundingZone.ZoneName;
                                } else if (currentZoneLower.includes('outbounding')) {
                                    const outbondedZone = movementZones.find(z => 
                                        z.ZoneName.toLowerCase() === 'outbonded'
                                    );
                                    return outbondedZone && p.CurrentZone !== outbondedZone.ZoneName;
                                }
                            }
                            // FIFO zones with multiple pallets - oldest should move
                            if (fifoRequired && zoneData.pallets.length > 1) {
                                return p.PalletID === oldestId;
                            }
                            return false;
                        });
                        
                        // Priority: Outbounding > Dispatch/Shipped > FIFO oldest
                        let priorityPallet = null;
                        let allAllowedDestinations = [];
                        
                        if (palletsNeedingMovement.length > 0) {
                            // Get the priority pallet (Outbounding first, then Dispatch/Shipped, then FIFO oldest)
                            priorityPallet = palletsNeedingMovement.find(p => 
                                (p.Status || '').toLowerCase().includes('outbounding')
                            ) || palletsNeedingMovement.find(p => 
                                (p.Status || '').toLowerCase() === 'dispatch' ||
                                (p.Status || '').toLowerCase() === 'shipped'
                            ) || palletsNeedingMovement[0];
                            
                            const palletStatus = priorityPallet.Status || '';
                            // Get ALL allowed destinations for this zone
                            allAllowedDestinations = getAllowedDestinations(zone.ZoneName);
                            
                            // Filter based on pallet status if needed (e.g., Outbounding status has special rules)
                            if (palletStatus.toLowerCase().includes('outbounding')) {
                                // Outbounding status can ONLY move to: OUTBONDED, Rework Zone, QA Hold
                                allAllowedDestinations = allAllowedDestinations.filter(z => {
                                    const zLower = z.toLowerCase();
                                    return zLower === 'outbonded' || zLower.includes('rework') || zLower === 'qa hold';
                                });
                            }
                        } else if (zoneData.pallets.length > 0) {
                            // Even if no specific movement needed, show oldest pallet for FIFO zones
                            if (fifoRequired && oldestId !== 'N/A') {
                                priorityPallet = zoneData.oldestPallet;
                                // Get ALL allowed destinations for this zone
                                allAllowedDestinations = getAllowedDestinations(zone.ZoneName);
                            }
                        }
                        
                        // Build action HTML - ALWAYS show if we have a pallet
                        if (priorityPallet && allAllowedDestinations.length > 0) {
                            const palletId = priorityPallet.PalletID || oldestId || 'N/A';
                            const palletStatus = priorityPallet.Status || '';
                            
                            // Get recommended destination (first priority)
                            const recommendedDest = recommendDestination(zone, palletStatus);
                            
                            // Build list of all options
                            const otherOptions = allAllowedDestinations.filter(dest => dest !== recommendedDest);
                            
                            actionHTML = `
                                <div style="text-align: left; font-size: 11px; line-height: 1.6;">
                                    <div style="margin-bottom: 6px;">
                                        <strong style="color: #fbbf24; font-size: 10px;">Move First:</strong><br>
                                        <span style="color: rgba(255, 255, 255, 0.95); font-family: 'Courier New', monospace; font-weight: 700; font-size: 12px;">${escapeHtml(palletId)}</span>
                                    </div>
                                    <div style="margin-bottom: 4px;">
                                        <strong style="color: #fbbf24; font-size: 10px;">→ Options:</strong><br>
                                        ${recommendedDest ? 
                                            `<span style="color: #fcd34d; font-weight: 700; font-size: 11px;">★ ${escapeHtml(recommendedDest)}</span>` : 
                                            ''
                                        }
                                        ${otherOptions.length > 0 ? 
                                            otherOptions.map(dest => 
                                                `<br><span style="color: rgba(255, 255, 255, 0.85); font-weight: 600; font-size: 10px;">• ${escapeHtml(dest)}</span>`
                                            ).join('') : 
                                            ''
                                        }
                                    </div>
                                    ${fifoRequired && zoneData.pallets.length > 1 ? 
                                        `<small style="color: rgba(251, 191, 36, 0.7); font-size: 9px; display: block; margin-top: 4px;">(FIFO - oldest first)</small>` : 
                                        ''
                                    }
                                </div>
                            `;
                        } else if (priorityPallet) {
                            // Show pallet ID even if no destinations available
                            actionHTML = `
                                <div style="text-align: left; font-size: 11px;">
                                    <strong style="color: #fbbf24; font-size: 10px;">Move First:</strong><br>
                                    <span style="color: rgba(255, 255, 255, 0.95); font-family: 'Courier New', monospace; font-weight: 700; font-size: 12px;">${escapeHtml(priorityPallet.PalletID || oldestId || 'N/A')}</span>
                                    ${fifoRequired ? `<br><small style="color: rgba(251, 191, 36, 0.7); font-size: 9px;">(FIFO - oldest)</small>` : ''}
                                    ${allAllowedDestinations.length === 0 ? `<br><small style="color: rgba(252, 165, 165, 0.8); font-size: 9px;">No movement options</small>` : ''}
                                </div>
                            `;
                        }
                    }
                    
                    tableHTML += `
                        <tr style="border-bottom: 1px solid rgba(245, 158, 11, 0.2); ${index % 2 === 0 ? 'background: rgba(15, 23, 42, 0.3);' : ''}">
                            <td style="padding: 12px; color: rgba(255, 255, 255, 0.95); font-weight: 600;">
                                ${escapeHtml(zone.ZoneName)}<br>
                                <small style="color: rgba(251, 191, 36, 0.7); font-size: 11px;">Prefix: ${zone.Prefix || 'N/A'}</small>
                                ${hasError ? `<br><small style="color: #fca5a5; font-size: 10px;">⚠️ ${escapeHtml(zoneData.error)}</small>` : ''}
                            </td>
                            <td style="padding: 12px; text-align: center; color: rgba(255, 255, 255, 0.95); font-weight: 600;">${hasError ? '—' : (zoneTotalsMap[zone.ZoneName]?.palletsCurrent ?? zoneData.pallets.length)}</td>
                            <td style="padding: 12px; text-align: center;">
                                ${hasError ? '—' : 
                                    (skuCount > 0 ? 
                                        `<span style="color: #fbbf24; font-weight: 700; cursor: pointer; text-decoration: underline; text-decoration-color: rgba(251, 191, 36, 0.5); transition: all 0.2s ease;" onmouseover="this.style.color='#fcd34d'; this.style.textDecorationColor='rgba(252, 211, 77, 0.8)'" onmouseout="this.style.color='#fbbf24'; this.style.textDecorationColor='rgba(251, 191, 36, 0.5)'" onclick="showSKUModal('${escapeHtml(zone.ZoneName)}', ${JSON.stringify(skuDetailsArray).replace(/"/g, '&quot;')})" title="Click to view SKU details">${skuCount}</span>` :
                                        '<span style="color: rgba(255, 255, 255, 0.5);">0</span>'
                                    )
                                }
                            </td>
                            <td style="padding: 12px; text-align: center; color: rgba(255, 255, 255, 0.95); font-weight: 600;">${hasError ? '—' : (zoneTotalsMap[zone.ZoneName]?.current ?? zoneData.totalQty).toLocaleString()}</td>
                            <td style="padding: 12px; color: rgba(255, 255, 255, 0.85); font-size: 12px;">
                                ${hasError ? '—' : escapeHtml(oldestId)}<br>
                                ${!hasError ? `<small style="color: rgba(251, 191, 36, 0.6);">${oldestDate}</small>` : ''}
                            </td>
                            <td style="padding: 12px; text-align: center;">
                                ${hasError ? '<span style="color: rgba(255, 255, 255, 0.5);">—</span>' : 
                                    (fifoRequired ? 
                                        `<span style="color: #fbbf24; font-weight: 700;">✓ Enforced</span>` : 
                                        `<span style="color: rgba(255, 255, 255, 0.5);">—</span>`
                                    )
                                }
                            </td>
                            <td style="padding: 12px; text-align: left; min-width: 180px;">
                                ${actionHTML}
                            </td>
                        </tr>
                    `;
                });
                
                tableHTML += `
                            </tbody>
                        </table>
                    </div>
                    <div style="margin-top: 16px; padding: 12px; background: rgba(245, 158, 11, 0.1); border-radius: 8px; border-left: 4px solid #f59e0b;">
                        <p style="margin: 0; color: rgba(251, 191, 36, 0.9); font-size: 12px; line-height: 1.6;">
                            <strong>📋 Action Column:</strong> Shows which pallet ID to move first and recommended destination zone (follows strict zone flow rules).<br>
                            <strong>⚠️ FIFO Zones:</strong> Oldest pallets (by creation date) should be moved first.<br>
                            <strong>🚚 Outbounding Status:</strong> Can ONLY move to: <strong>OUTBONDED</strong> (consumer), <strong>Rework Zone</strong>, or <strong>QA Hold</strong>.<br>
                            <strong>📦 SKUs Column:</strong> Click on the number to view detailed SKU breakdown with quantities.
                        </p>
                    </div>
                `;
                
                tableContainer.innerHTML = tableHTML;
            } catch (error) {
                console.error('Error loading zone overview:', error);
                tableContainer.innerHTML = `<div style="color: #fca5a5; padding: 20px; text-align: center;">Error loading zone overview: ${error.message}</div>`;
            }
            } finally {
                hideRetifluxLoadingOverlay();
            }
        }

        async function refreshRecentMovements() {
            const tableContainer = document.getElementById('recentMovementsTable');
            const palletList = document.getElementById('movementPalletList');
            const zoneOverviewTable = document.getElementById('zoneOverviewTable');
            
            if (!tableContainer) {
                showToast('Recent movements table not found', 'error');
                return;
            }
            
            const isVisible = tableContainer.style.display !== 'none';
            tableContainer.style.display = isVisible ? 'none' : 'block';
            if (palletList) palletList.style.display = isVisible ? 'flex' : 'none';
            if (zoneOverviewTable) zoneOverviewTable.style.display = 'none';
            
            if (isVisible) return;
            
            showRetifluxLoadingOverlay();
            try {
            if (!movementPanelInitialized) {
                try {
                    await ensureMovementPanelLoaded();
                } catch (error) {
                    tableContainer.innerHTML = `<div style="color: #fca5a5; padding: 20px; text-align: center;">Error: ${error.message}</div>`;
                    return;
                }
            }
            
            tableContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: rgba(251, 191, 36, 0.9);"><div class="loading-spinner"></div><p>Loading recent movements...</p></div>';
            
                const params = new URLSearchParams({ action: 'getZoneConfig', includeRecentMovements: 'true' });
                const result = await callAppsScript(params);
                const movements = result.movements || [];
                
                if (movements.length === 0) {
                    tableContainer.innerHTML = '<div style="color: rgba(251, 191, 36, 0.9); padding: 24px; text-align: center;"><p style="font-size: 15px;">No recent movements recorded yet.</p><p style="font-size: 13px; margin-top: 8px; opacity: 0.8;">Zone movements will appear here after pallets are moved.</p></div>';
                    return;
                }
                
                const fmt = (val) => val === undefined || val === null || val === '' ? '—' : String(val);
                const fmtDate = (val) => {
                    if (!val) return '—';
                    const d = new Date(val);
                    return isNaN(d.getTime()) ? fmt(val) : d.toLocaleString(undefined, { dateStyle: 'short', timeStyle: 'short' });
                };
                
                const cols = ['MovementID', 'PalletID', 'FromZone', 'ToZone', 'MovementDate', 'MovementTime', 'MovedBy', 'Quantity', 'OrderReference', 'Reason', 'OverrideReason', 'Notes', 'CreatedAt'];
                const labels = { MovementID: 'ID', PalletID: 'Pallet', FromZone: 'From', ToZone: 'To', MovementDate: 'Date', MovementTime: 'Time', MovedBy: 'Moved By', Quantity: 'Qty', OrderReference: 'Order Ref', Reason: 'Reason', OverrideReason: 'FIFO Override', Notes: 'Notes', CreatedAt: 'Logged At' };
                const dateCols = ['MovementDate', 'MovementTime', 'CreatedAt'];
                
                const tableHTML = `
                    <div style="margin-bottom: 16px;">
                        <h3 style="margin: 0; color: rgba(251, 191, 36, 0.95); font-size: 16px;">📋 Last 10 Zone Movements</h3>
                        <p style="margin: 8px 0 0 0; font-size: 12px; color: rgba(148, 163, 184, 0.9);">Most recent first — full details</p>
                    </div>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <thead>
                                <tr style="background: rgba(245, 158, 11, 0.2); border-bottom: 2px solid rgba(245, 158, 11, 0.5);">
                                    ${cols.map(c => `<th style="padding: 10px 12px; text-align: left; color: #fbbf24; white-space: nowrap;">${labels[c] || c}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                ${movements.map((m, i) => `
                                <tr style="border-bottom: 1px solid rgba(148, 163, 184, 0.2); background: ${i % 2 ? 'rgba(15, 23, 42, 0.3)' : 'transparent'};">
                                    ${cols.map(c => {
                                        const raw = m[c];
                                        const v = dateCols.includes(c) ? fmtDate(raw) : fmt(raw);
                                        const cellClass = c === 'FromZone' ? 'color: #fca5a5;' : (c === 'ToZone' ? 'color: #86efac; font-weight: 600;' : 'color: rgba(226,232,240,0.9);');
                                        return `<td style="padding: 10px 12px; ${cellClass}">${escapeHtml(v)}</td>`;
                                    }).join('')}
                                </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <button type="button" class="btn-reset" onclick="refreshRecentMovements()" style="margin-top: 16px;">🔽 Hide Recent Movements</button>
                `;
                tableContainer.innerHTML = tableHTML;
            } catch (error) {
                tableContainer.innerHTML = `<div style="color: #fca5a5; padding: 20px; text-align: center;">Error loading recent movements: ${escapeHtml(error.message || 'Unknown error')}</div>`;
            } finally {
                hideRetifluxLoadingOverlay();
            }
        }

        function updateMovementZoneMeta(zoneName) {
            const metaEl = document.getElementById('movementZoneMeta');
            if (!metaEl) return;
            const zone = movementZones.find(z => z.ZoneName === zoneName);
            if (!zone) {
                metaEl.textContent = '';
                return;
            }
            const fifoText = parseBooleanFlag(zone.FIFORequired) ? 'FIFO enforced' : 'FIFO not enforced';
            const splitText = parseBooleanFlag(zone.AllowsSplitting) ? 'Splitting allowed' : 'Splitting blocked';
            metaEl.textContent = `${zone.ZoneName} • Prefix ${zone.Prefix || 'N/A'} • ${fifoText} • ${splitText}`;
        }

        async function refreshMovementZone(forceFresh) {
            showRetifluxLoadingOverlay();
            try {
                if (!movementPanelInitialized) {
                    await ensureMovementPanelLoaded();
                    return;
                }
                const zoneSelect = document.getElementById('movementZoneSelect');
                if (!zoneSelect || !zoneSelect.value) {
                    setMovementListLoading('Select a zone to view pallets.');
                    return;
                }
                const zoneName = zoneSelect.value;
                updateMovementZoneMeta(zoneName);
                const statusFilter = document.getElementById('movementStatusFilter')?.value || '';
                setMovementListLoading('Loading pallets...');
                const params = new URLSearchParams({
                    action: 'getPalletsInZone',
                    zoneName: zoneName,
                    limit: 10000  // Increased limit to show ALL pallets
                });
                if (statusFilter) params.append('status', statusFilter);
                const result = await callAppsScript(params, forceFresh ? { skipCache: true } : {});
                movementLastPallets = result.pallets || [];
                renderMovementPalletList(movementLastPallets);
                showToast(`Loaded ${movementLastPallets.length} pallet(s) from ${zoneName}`, 'success', 4000);
                setMovementStatus('');
            } catch (error) {
                console.error('Failed to load pallets:', error);
                showToast(error.message || 'Failed to load pallets', 'error', 6000);
                setMovementListLoading(error.message || 'Unable to load pallets.');
                setMovementStatus('');
            } finally {
                hideRetifluxLoadingOverlay();
            }
        }

        function renderMovementPalletList(pallets) {
            const list = document.getElementById('movementPalletList');
            if (!list) return;
            if (!pallets.length) {
                list.innerHTML = '<div style="color:#94a3b8;">No pallets found for this zone.</div>';
                return;
            }
            
            // Get current zone to find its DefaultStatus and FIFO requirements
            const zoneSelect = document.getElementById('movementZoneSelect');
            const currentZoneName = zoneSelect ? zoneSelect.value : '';
            const currentZone = movementZones.find(z => z.ZoneName === currentZoneName);
            const zoneDefaultStatus = currentZone ? (currentZone.DefaultStatus || 'Active') : 'Active';
            const fifoRequired = currentZone ? parseBooleanFlag(currentZone.FIFORequired) : false;
            
            // Sort pallets: Priority pallet (should move first) at the top
            const sortedPallets = [...pallets].sort((a, b) => {
                const statusA = (a.Status || '').toLowerCase();
                const statusB = (b.Status || '').toLowerCase();
                
                // Priority 1: Outbounding status
                const aIsOutbounding = statusA.includes('outbounding');
                const bIsOutbounding = statusB.includes('outbounding');
                if (aIsOutbounding && !bIsOutbounding) return -1;
                if (!aIsOutbounding && bIsOutbounding) return 1;
                
                // Priority 2: Dispatch/Shipped status
                const aIsDispatch = statusA === 'dispatch' || statusA === 'shipped';
                const bIsDispatch = statusB === 'dispatch' || statusB === 'shipped';
                if (aIsDispatch && !bIsDispatch) return -1;
                if (!aIsDispatch && bIsDispatch) return 1;
                
                // Priority 3: FIFO - oldest first (if FIFO required)
                if (fifoRequired && pallets.length > 1) {
                    const dateA = new Date(a.CreatedAt || a.CreatedDate || 0);
                    const dateB = new Date(b.CreatedAt || b.CreatedDate || 0);
                    if (dateA.getTime() !== dateB.getTime()) {
                        return dateA - dateB; // Oldest first
                    }
                }
                
                // Otherwise maintain original order
                return 0;
            });
            
            // Identify the priority pallet (first one after sorting)
            const priorityPalletId = sortedPallets.length > 0 ? sortedPallets[0].PalletID : null;
            
            list.innerHTML = sortedPallets.map(pallet => {
                const isPriority = pallet.PalletID === priorityPalletId;
                // Use pallet Status if available, otherwise use zone's DefaultStatus
                const status = escapeHtml(pallet.Status || zoneDefaultStatus);
                const sku = escapeHtml(pallet.SKU || 'N/A');
                const qty = pallet.RemainingQuantity ?? pallet.Quantity ?? '';
                const created = formatMovementDate(pallet.CreatedAt || pallet.CreatedDate);
                const lastMoved = formatMovementDate(pallet.LastMovedAt);
                
                // Get zone's DefaultStatus for display
                const palletZone = movementZones.find(z => z.ZoneName === pallet.CurrentZone);
                const palletZoneDefaultStatus = palletZone ? (palletZone.DefaultStatus || 'Active') : 'Active';
                
                return `
                    <div class="movement-card" ${isPriority ? 'style="border: 2px solid #f59e0b; box-shadow: 0 4px 16px rgba(245, 158, 11, 0.4); background: rgba(15, 23, 42, 0.8);"' : ''}>
                        <div class="movement-card-header">
                            ${isPriority ? '<span style="color: #fbbf24; font-size: 16px; margin-right: 8px;" title="Move this pallet first">★</span>' : ''}
                            <strong>${escapeHtml(pallet.PalletID || 'Unknown ID')}</strong>
                            <span class="badge">${status}</span>
                            ${isPriority ? '<span style="background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #0f172a; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-left: 8px;">PRIORITY</span>' : ''}
                        </div>
                        <div class="movement-card-meta">
                            <div><strong>SKU:</strong> ${sku}</div>
                            <div><strong>Qty:</strong> ${qty || 'N/A'}</div>
                            <div><strong>Zone:</strong> ${escapeHtml(pallet.CurrentZone || 'N/A')}</div>
                            ${(pallet.InTransitToZone) ? `<div><span class="badge-in-transit">In Transit to ${escapeHtml(pallet.InTransitToZone)}</span></div>` : ''}
                            <div><strong>Zone Default Status:</strong> <span style="color: rgba(251, 191, 36, 0.8);">${escapeHtml(palletZoneDefaultStatus)}</span></div>
                            <div><strong>Created:</strong> ${created}</div>
                            <div><strong>Last Move:</strong> ${lastMoved}</div>
                        </div>
                        <div class="movement-card-actions">
                            <button type="button" class="btn-reset" onclick="selectMovementPallet('${escapeHtml(pallet.PalletID || '')}')">Select</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function selectMovementPallet(palletId) {
            const pallet = movementLastPallets.find(p => (p.PalletID || '').toString() === palletId);
            if (!pallet) return;
            movementSelectedPallet = pallet;
            const palletInput = document.getElementById('movementPalletId');
            const currentZoneInput = document.getElementById('movementCurrentZone');
            const reasonInput = document.getElementById('movementReason');
            if (palletInput) palletInput.value = pallet.PalletID || '';
            if (currentZoneInput) currentZoneInput.value = pallet.CurrentZone || '';
            if (reasonInput && !reasonInput.value) {
                reasonInput.value = `Move from ${pallet.CurrentZone || 'unknown zone'}`;
            }
            
            const toZoneSelect = document.getElementById('movementToZoneSelect');
            if (toZoneSelect) {
                const palletStatus = (pallet.Status || '').toLowerCase();
                
                // SPECIAL RULE: If status is "Outbounding", only allow: OUTBONDED (consumer), Rework Zone, QA Hold
                if (palletStatus.includes('outbounding')) {
                    populateMovementZoneOptions(true, null);
                    setMovementStatus(`Selected ${pallet.PalletID} (Outbounding status - can only move to: OUTBONDED, Rework Zone, or QA Hold)`);
                } else {
                    populateMovementZoneOptions(false, pallet.CurrentZone || null);
                    if (pallet.CurrentZone && toZoneSelect.value === pallet.CurrentZone) {
                        const allowed = getAllowedDestinations(pallet.CurrentZone);
                        const alternative = movementZones.find(z => allowed.includes(z.ZoneName) && z.ZoneName !== pallet.CurrentZone);
                        if (alternative) toZoneSelect.value = alternative.ZoneName;
                    }
                    setMovementStatus(`Selected ${pallet.PalletID} (currently ${pallet.CurrentZone || 'N/A'})`);
                }
            }
        }

        function resetMovementForm() {
            movementSelectedPallet = null;
            const form = document.getElementById('movementForm');
            if (form) form.reset();
            const currentZoneInput = document.getElementById('movementCurrentZone');
            if (currentZoneInput) currentZoneInput.value = '';
            if (movementPanelInitialized) {
                populateMovementZoneOptions(false, null);
            }
            autoFillMovementOperator();
            setMovementStatus('');
        }

        let isChildMode = false;

        function toggleMovementMode() {
            isChildMode = !isChildMode;
            const toggleBtn = document.getElementById('toggleChildModeBtn');
            const submitBtn = document.getElementById('movementSubmitBtn');
            const quantityWrapper = document.getElementById('movementQuantityWrapper');
            const toZoneSelect = document.getElementById('movementToZoneSelect');
            if (isChildMode) {
                toggleBtn.textContent = '↩️ Back to Full-Pallet Move';
                submitBtn.textContent = 'Create Child Pallet';
                if (quantityWrapper) {
                    quantityWrapper.querySelector('label').textContent = 'Child Quantity';
                    const input = document.getElementById('movementQuantity');
                    if (input) {
                        input.placeholder = 'Enter child pallet qty';
                        input.required = true;
                    }
                }
            } else {
                toggleBtn.textContent = '✨ Create Child Pallet';
                submitBtn.textContent = 'Move Pallet';
                if (quantityWrapper) {
                    quantityWrapper.querySelector('label').textContent = 'Quantity (optional)';
                    const input = document.getElementById('movementQuantity');
                    if (input) {
                        input.placeholder = 'Leave blank to keep full qty';
                        input.required = false;
                    }
                }
            }
        }

        async function submitMovementForm() {
            const palletId = document.getElementById('movementPalletId')?.value.trim();
            const toZone = document.getElementById('movementToZoneSelect')?.value;
            const movedBy = document.getElementById('movementMovedBy')?.value.trim();
            if (!palletId) {
                showToast('Enter pallet ID.', 'error', 5000);
                return;
            }
            if (!toZone) {
                showToast('Select destination zone.', 'error', 5000);
                return;
            }
            if (!movedBy) {
                showToast('Enter the user moving the pallet.', 'error', 5000);
                return;
            }
            
            // VALIDATE ZONE FLOW RULES - Get current zone from pallet or form
            const currentZoneInput = document.getElementById('movementCurrentZone')?.value;
            const currentZoneName = currentZoneInput || (movementSelectedPallet ? movementSelectedPallet.CurrentZone : '');
            
            if (currentZoneName && typeof getAllowedDestinations === 'function') {
                // Check if movement is allowed according to strict rules
                const allowedDestinations = getAllowedDestinations(currentZoneName);
                const toZoneLower = toZone.toLowerCase();
                const isAllowed = allowedDestinations.some(allowed => 
                    allowed.toLowerCase() === toZoneLower
                );
                
                if (!isAllowed) {
                    const allowedList = allowedDestinations.length > 0 
                        ? allowedDestinations.join(', ') 
                        : 'None (this zone cannot move pallets)';
                    showToast(`Movement not allowed! From "${currentZoneName}" you can only move to: ${allowedList}`, 'error', 6000);
                    return;
                }
                
                // Special rule: Rework Zone can ONLY receive from QAH and DSP
                if (toZoneLower.includes('rework')) {
                    const fromZoneLower = currentZoneName.toLowerCase();
                    if (!fromZoneLower.includes('qa hold') && !fromZoneLower.includes('dispatch loading area')) {
                        showToast('Rework Zone can ONLY receive pallets from QA Hold or Dispatch Loading Area!', 'error', 6000);
                        return;
                    }
                }
                
                // Special rule: DSP cannot move to itself
                if (currentZoneName.toLowerCase().includes('dispatch loading area') && 
                    toZoneLower.includes('dispatch loading area')) {
                    showToast('Dispatch Loading Area cannot move to itself!', 'error', 6000);
                    return;
                }
                
                // Special rule: OUTBONDED is final - no movement out
                if (currentZoneName.toLowerCase() === 'outbonded') {
                    showToast('OUTBONDED is a final destination - no movement allowed out!', 'error', 6000);
                    return;
                }
                
                // Special rule: Check pallet status AND current zone for Outbounding restrictions
                const palletStatus = movementSelectedPallet ? (movementSelectedPallet.Status || '').toLowerCase() : '';
                const currentZoneLower = currentZoneName.toLowerCase();
                const isOutboundingStatus = palletStatus.includes('outbounding') || palletStatus === 'shipped';
                const isOutboundingZone = currentZoneLower.includes('outbounding') && !currentZoneLower.includes('outbonded');
                
                // Apply Outbounding restrictions if status is "Outbounding" OR zone is "Outbounding"
                if (isOutboundingStatus || isOutboundingZone) {
                    // Case-insensitive matching for OUTBONDED (handles all variations)
                    const isOutbonded = toZoneLower === 'outbonded' || toZoneLower === 'outbounded';
                    const isRework = toZoneLower.includes('rework');
                    const isQAHold = toZoneLower === 'qa hold' || toZoneLower.includes('qa hold');
                    
                    if (!isOutbonded && !isRework && !isQAHold) {
                        showToast('Outbounding pallets can ONLY move to: OUTBONDED, Rework Zone, or QA Hold!', 'error', 6000);
                        return;
                    }
                }
            }
            
            const reason = document.getElementById('movementReason')?.value || '';
            const overrideReason = document.getElementById('movementOverrideReason')?.value || '';
            const quantity = document.getElementById('movementQuantity')?.value || '';
            const orderReference = document.getElementById('movementOrderRef')?.value || '';
            if (isChildMode) {
                if (!quantity || Number(quantity) <= 0) {
                    showToast('Enter child quantity greater than zero.', 'error', 5000);
                    return;
                }
            }
            const submitBtn = document.getElementById('movementSubmitBtn');
            if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = '...'; }
            try {
                setMovementStatus('Moving pallet...');
                const params = new URLSearchParams({
                    action: isChildMode ? 'createChildPallet' : 'movePallet',
                    palletId: palletId,
                    toZone: toZone,
                    movedBy: movedBy
                });
                if (reason) params.append('reason', reason);
                if (isChildMode) {
                    params.append('quantity', quantity);
                } else {
                    if (overrideReason) params.append('overrideReason', overrideReason);
                    if (quantity) params.append('quantity', quantity);
                    if (orderReference) params.append('orderReference', orderReference);
                }
                const result = await callAppsScript(params);
                clearCache('getInboundsToZone');
                clearCache('getOutboundsFromZone');
                clearCache('getPalletsInZone');
                clearCache('getZoneInventoryTotals');
                showToast(result.message || (isChildMode ? 'Child pallet created. Awaiting receipt at destination.' : 'Move initiated. Awaiting receipt at destination.'), 'success', 5000);
                if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Initiate Move'; }
                resetMovementForm();
                refreshMovementZone();
            } catch (error) {
                console.error('Move pallet error:', error);
                showToast(error.message || 'Failed to move pallet', 'error', 6000);
                setMovementStatus('');
                if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Initiate Move'; }
                if ((error.message || '').toLowerCase().includes('fifo')) {
                    document.getElementById('movementOverrideReason')?.focus();
                }
            }
        }

        const CACHEABLE_ACTIONS = ['getZoneConfig', 'getZoneInventoryTotals', 'getPalletsInZone', 'getInboundsToZone', 'getOutboundsFromZone'];
        const CACHE_TTL_ZONE_CONFIG = 2 * 60 * 1000;   // 2 min
        const CACHE_TTL_PALLET_LISTS = 45 * 1000;      // 45 sec

        async function callAppsScript(params, opts = {}) {
            const action = params.get && params.get('action');
            const skipCache = opts.skipCache || false;
            const isCacheable = action && CACHEABLE_ACTIONS.includes(action);
            let cacheKey = '';
            let cacheTtl = CACHE_TTL_PALLET_LISTS;
            if (isCacheable && !skipCache) {
                cacheKey = [...params.entries()].sort((a,b)=>a[0].localeCompare(b[0])).map(p=>p[0]+'='+p[1]).join('&');
                if (action === 'getZoneConfig') cacheTtl = CACHE_TTL_ZONE_CONFIG;
                if (action === 'getZoneInventoryTotals') cacheTtl = CACHE_TTL_PALLET_LISTS;
                const cached = getCachedRequest(cacheKey, cacheTtl);
                if (cached) return cached;
            }
            if (!GOOGLE_APPS_SCRIPT_URL) {
                throw new Error('Google Apps Script URL not configured');
            }
            const url = `${GOOGLE_APPS_SCRIPT_URL}?${params.toString()}`;
            const response = await fetch(url, {
                method: 'GET',
                headers: { 'Accept': 'application/json' }
            });
            const text = await response.text();
            let result;
            try {
                result = JSON.parse(text);
            } catch (error) {
                console.error('Apps Script raw response:', text);
                throw new Error('Invalid response from Apps Script. Please redeploy the latest backend.');
            }
            if (!result.success) {
                throw new Error(result.error || 'Apps Script call failed');
            }
            if (isCacheable && cacheKey) setCachedRequest(cacheKey, result);
            return result;
        }

        function parseBooleanFlag(value) {
            if (value === true || value === false) return value;
            if (value === undefined || value === null) return false;
            const str = value.toString().toLowerCase();
            return str === 'true' || str === 'yes' || str === '1';
        }

        function formatMovementDate(value) {
            if (!value) return 'N/A';
            const date = new Date(value);
            if (isNaN(date.getTime())) {
                return value;
            }
            return `${date.toLocaleDateString()} ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
        }

        function autoFillMovementOperator() {
            const field = document.getElementById('movementMovedBy');
            if (field && !field.value && isUserLoggedIn()) {
                field.value = loggedInUser.name || loggedInUser.id || '';
            }
        }

        function renderFilledTicket(data) {
            const previewContainer = document.getElementById('fillPreview');
            if (!previewContainer) {
                return null;
            }

            const serialDisplay = document.getElementById('fillSerialDisplay');
            if (serialDisplay) {
                serialDisplay.textContent = data.serial;
            }

            const originalHtml = createTicketHTML(data.serial, data.color, false, data, 'view');
            const duplicateHtml = createTicketHTML(data.serial, data.color, true, data, 'edit');

            previewContainer.innerHTML = `
                <div class="page single">
                    <div class="ticket-row">
                        ${originalHtml}
                        ${duplicateHtml}
                    </div>
                </div>
            `;

            return previewContainer.querySelector('.page');
        }

        async function downloadFilledTicket(pageElement, serial) {
            await ensurePrintLibs();
            const canvas = await html2canvas(pageElement, {
                scale: window.devicePixelRatio > 1 ? window.devicePixelRatio : 2,
                backgroundColor: '#ffffff',
                useCORS: true
            });
            const link = document.createElement('a');
            const safeSerial = serial.replace(/[^a-z0-9_-]+/gi, '_');
            link.download = `${safeSerial || 'ticket'}_completed.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        function setFillStatus(message) {
            const status = document.getElementById('fillStatus');
            if (status) {
                // Add loading spinner for "Saving..." or "Loading..." messages
                if (message && (message.toLowerCase().includes('saving') || message.toLowerCase().includes('loading') || message.toLowerCase().includes('generating'))) {
                    status.innerHTML = `<span class="loading-spinner"></span>${message}`;
                } else if (message && message.includes('✅')) {
                    status.innerHTML = `<span style="color: #ffffff; font-size: 20px; margin-right: 8px;">✅</span>${message.replace('✅', '')}`;
                    status.style.background = 'rgba(255, 255, 255, 0.25)';
                    status.style.borderColor = 'rgba(255, 255, 255, 0.4)';
                } else if (message && message.includes('❌')) {
                    status.innerHTML = `<span style="color: #ffffff; font-size: 20px; margin-right: 8px;">❌</span>${message.replace('❌', '')}`;
                    status.style.background = 'rgba(255, 107, 107, 0.3)';
                    status.style.borderColor = 'rgba(255, 107, 107, 0.5)';
                } else {
                    status.textContent = message || '';
                    status.style.background = 'rgba(255, 255, 255, 0.2)';
                    status.style.borderColor = 'rgba(255, 255, 255, 0.3)';
                }
            }
        }
        
        // Elegant success popup for print/download logs
        function showSuccessPopup({ title, message }) {
            // Create modal overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.85);
                backdrop-filter: blur(10px);
                z-index: 99999;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
                animation: fadeIn 0.3s ease-out;
            `;
            
            // Create popup content
            const popup = document.createElement('div');
            popup.style.cssText = `
                background: linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(30, 58, 95, 0.98));
                backdrop-filter: blur(20px);
                border-radius: 24px;
                padding: 32px;
                max-width: 500px;
                width: 100%;
                box-shadow: 
                    0 20px 80px rgba(0, 0, 0, 0.6),
                    0 8px 32px rgba(245, 158, 11, 0.3),
                    inset 0 2px 0 rgba(245, 158, 11, 0.2);
                border: 2px solid rgba(245, 158, 11, 0.5);
                animation: slideUpModal 0.4s ease-out;
                position: relative;
            `;
            
            popup.innerHTML = `
                <h2 style="
                    margin: 0 0 20px 0; 
                    background: linear-gradient(135deg, #fbbf24, #f59e0b, #fcd34d);
                    -webkit-background-clip: text;
                    -webkit-text-fill-color: transparent;
                    font-size: 26px;
                    font-weight: 800;
                    text-align: center;
                    letter-spacing: 1px;
                    text-transform: uppercase;
                ">${title}</h2>
                
                <div style="color: #fff; font-size: 14px;">
                    ${message}
                </div>
                
                <button onclick="this.closest('[style*=fixed]').remove()" style="
                    width: 100%;
                    margin-top: 24px;
                    padding: 16px;
                    background: linear-gradient(135deg, #fbbf24, #f59e0b);
                    color: #0f172a;
                    border: none;
                    border-radius: 12px;
                    font-size: 16px;
                    font-weight: 800;
                    cursor: pointer;
                    font-family: 'Cascadia Mono', monospace;
                    letter-spacing: 1.5px;
                    text-transform: uppercase;
                    box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
                    transition: all 0.3s ease;
                " onmouseover="this.style.transform='translateY(-2px) scale(1.02)'; this.style.boxShadow='0 8px 28px rgba(245, 158, 11, 0.5)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 6px 20px rgba(245, 158, 11, 0.4)'">
                    ✓ Got It!
                </button>
            `;
            
            overlay.appendChild(popup);
            document.body.appendChild(overlay);
            
            // Close on Escape key
            const closeOnEscape = (e) => {
                if (e.key === 'Escape') {
                    overlay.remove();
                    document.removeEventListener('keydown', closeOnEscape);
                }
            };
            document.addEventListener('keydown', closeOnEscape);
            
            // Close on background click
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.remove();
                }
            });
        }
        
        // Preview Modal Functions
        function openPreviewModal() {
            const modal = document.getElementById('previewModal');
            if (modal) {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden'; // Prevent background scroll
            }
        }
        
        function closePreviewModal() {
            const modal = document.getElementById('previewModal');
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = ''; // Re-enable scroll
            }
        }
        
        // SKU Modal Functions
        // Store escape handler reference for cleanup
        let skuModalEscapeHandler = null;
        
        function showSKUModal(zoneName, skuDetails) {
            // Parse skuDetails if it's a string (from onclick JSON)
            if (typeof skuDetails === 'string') {
                try {
                    skuDetails = JSON.parse(skuDetails.replace(/&quot;/g, '"'));
                } catch (e) {
                    console.error('Error parsing SKU details:', e);
                    skuDetails = [];
                }
            }
            
            // Close any existing modal first
            closeSKUModal();
            
            // Create modal element
            let modal = document.getElementById('skuModal');
            if (modal) {
                modal.remove(); // Remove existing modal to prevent duplicate event listeners
            }
            
            modal = document.createElement('div');
            modal.id = 'skuModal';
            modal.className = 'sku-modal';
            document.body.appendChild(modal);
            
            // Build table HTML
            let tableHTML = '';
            if (skuDetails && Array.isArray(skuDetails) && skuDetails.length > 0) {
                const totalQty = skuDetails.reduce((sum, item) => sum + (item.totalQty || 0), 0);
                const totalPallets = skuDetails.reduce((sum, item) => sum + (item.palletCount || 0), 0);
                
                tableHTML = `
                    <div class="sku-modal-content">
                        <div class="sku-modal-header">
                            <h3>⬥ ${escapeHtml(zoneName)} - SKU Details</h3>
                            <button class="sku-modal-close" onclick="closeSKUModal()" aria-label="Close">×</button>
                        </div>
                        <div style="margin-bottom: 16px; padding: 12px; background: rgba(245, 158, 11, 0.1); border-radius: 8px; border-left: 4px solid #f59e0b;">
                            <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 12px;">
                                <div>
                                    <strong style="color: #fbbf24; font-size: 12px;">Total SKUs:</strong>
                                    <span style="color: rgba(255, 255, 255, 0.95); font-weight: 700; margin-left: 8px;">${skuDetails.length}</span>
                                </div>
                                <div>
                                    <strong style="color: #fbbf24; font-size: 12px;">Total Quantity:</strong>
                                    <span style="color: rgba(255, 255, 255, 0.95); font-weight: 700; margin-left: 8px;">${totalQty.toLocaleString()}</span>
                                </div>
                                <div>
                                    <strong style="color: #fbbf24; font-size: 12px;">Total Pallets:</strong>
                                    <span style="color: rgba(255, 255, 255, 0.95); font-weight: 700; margin-left: 8px;">${totalPallets}</span>
                                </div>
                            </div>
                        </div>
                        <table class="sku-table">
                            <thead>
                                <tr>
                                    <th>SKU Code</th>
                                    <th style="text-align: center;">Pallets</th>
                                    <th style="text-align: right;">Total Quantity</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${skuDetails.map(item => `
                                    <tr>
                                        <td class="sku-code">${escapeHtml(item.sku || 'N/A')}</td>
                                        <td class="sku-pallets">${item.palletCount || 0}</td>
                                        <td class="sku-qty">${(item.totalQty || 0).toLocaleString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } else {
                tableHTML = `
                    <div class="sku-modal-content">
                        <div class="sku-modal-header">
                            <h3>⬥ ${escapeHtml(zoneName)} - SKU Details</h3>
                            <button class="sku-modal-close" onclick="closeSKUModal()" aria-label="Close">×</button>
                        </div>
                        <div style="text-align: center; padding: 40px; color: rgba(255, 255, 255, 0.7);">
                            <p>No SKUs found in this zone.</p>
                        </div>
                    </div>
                `;
            }
            
            modal.innerHTML = tableHTML;
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Close on background click - use once to prevent multiple listeners
            const backgroundClickHandler = function(e) {
                if (e.target === modal) {
                    e.stopPropagation();
                    closeSKUModal();
                }
            };
            modal.addEventListener('click', backgroundClickHandler, { once: true });
            
            // Close on Escape key - remove old handler first
            if (skuModalEscapeHandler) {
                document.removeEventListener('keydown', skuModalEscapeHandler);
            }
            
            skuModalEscapeHandler = function(e) {
                if (e.key === 'Escape') {
                    closeSKUModal();
                }
            };
            document.addEventListener('keydown', skuModalEscapeHandler);
        }
        
        function closeSKUModal() {
            const modal = document.getElementById('skuModal');
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = '';
                // Remove escape handler
                if (skuModalEscapeHandler) {
                    document.removeEventListener('keydown', skuModalEscapeHandler);
                    skuModalEscapeHandler = null;
                }
                // Remove modal after animation
                setTimeout(() => {
                    if (modal && modal.parentNode) {
                        modal.remove();
                    }
                }, 300);
            }
        }
        
        // Add event listener for Preview button
        document.addEventListener('DOMContentLoaded', function() {
            const previewBtn = document.getElementById('showPreviewBtn');
            if (previewBtn) {
                previewBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const form = document.getElementById('fillForm');
                    if (form) {
                        const data = collectFormData(form);
                        const pageElement = renderFilledTicket(data);
                        if (pageElement) {
                            openPreviewModal();
                        } else {
                            alert('Unable to generate preview. Please fill in the required fields.');
                        }
                    }
                });
            }
            
            // Close modal on background click
            const modal = document.getElementById('previewModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closePreviewModal();
                    }
                });
            }
            
            // Close modal on Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closePreviewModal();
                }
            });
        });
    </script>
</body>
</html>

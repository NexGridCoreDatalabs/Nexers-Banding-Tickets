<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Banding Ticket Generator</title>
    
    <!-- SECURITY FIX: Load config from external file (fallback to defaults if not found) -->
    <script src="config.js"></script>
    <script>
        // Validate config loaded, but don't block if missing (backward compatible)
        if (typeof window.BANDFLOW_CONFIG === 'undefined') {
            console.warn('⚠️ config.js not found. Using default values. For security, create config.js with your credentials.');
            window.BANDFLOW_CONFIG = {};
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cascadia+Mono:wght@400;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* Smooth scrolling for the entire page */
        html {
            scroll-behavior: smooth;
        }
        
        /* Elegant gold focus management for accessibility */
        *:focus-visible {
            outline: 3px solid #f59e0b;
            outline-offset: 2px;
            border-radius: 4px;
            box-shadow: 0 0 0 6px rgba(245, 158, 11, 0.2);
        }
        
        /* Remove default focus for mouse users */
        *:focus:not(:focus-visible) {
            outline: none;
        }

        body {
            font-family: 'Cascadia Mono', 'Courier New', monospace;
            padding: 20px;
            background: linear-gradient(135deg, #0f172a 0%, #1e3a5f 50%, #0f172a 100%);
            background-attachment: fixed;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Animated elegant gradient background */
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        body.fill-mode-active {
            background: linear-gradient(-45deg, #0f172a, #1e3a5f, #0f172a, #1e293b);
            background-size: 400% 400%;
            animation: gradientShift 20s ease infinite;
            overflow-x: hidden;
            overscroll-behavior-y: contain;
        }
        
        body.fill-mode-active .control-panel,
        body.fill-mode-active .print-container {
            display: none;
        }

        /* Elegant gold-accented control panel */
        .control-panel {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(30, 58, 95, 0.95));
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            padding: 24px;
            border-radius: 24px;
            max-width: 650px;
            margin: 0 auto 30px;
            box-shadow: 
                0 12px 48px rgba(0, 0, 0, 0.4),
                0 4px 16px rgba(245, 158, 11, 0.2),
                inset 0 1px 0 rgba(245, 158, 11, 0.15);
            border: 2px solid rgba(245, 158, 11, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            animation: fadeInUp 0.5s ease-out;
        }
        
        .control-panel:hover {
            box-shadow: 
                0 16px 64px rgba(0, 0, 0, 0.5),
                0 8px 24px rgba(245, 158, 11, 0.3),
                inset 0 1px 0 rgba(245, 158, 11, 0.2);
            border-color: rgba(245, 158, 11, 0.5);
            transform: translateY(-2px);
        }
        
        @media (min-width: 768px) {
            .control-panel {
                padding: 35px;
            }
        }

        .control-panel h1 {
            margin-bottom: 10px;
            color: #fbbf24;
            text-align: center;
            font-size: 26px;
            font-weight: 800;
            letter-spacing: 0.5px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b, #fcd34d);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(245, 158, 11, 0.3);
            text-transform: uppercase;
        }
        
        @media (min-width: 768px) {
            .control-panel h1 {
                font-size: 28px;
            }
        }

        .subtitle {
            text-align: center;
            color: #718096;
            font-size: 13px;
            margin-bottom: 30px;
            font-weight: 400;
        }

        /* Elegant gold serial display */
        .current-serial {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 50%, #f59e0b 100%);
            background-size: 200% 200%;
            color: #0f172a;
            border-radius: 14px;
            margin-bottom: 25px;
            font-size: 15px;
            font-weight: 800;
            letter-spacing: 2px;
            box-shadow: 
                0 8px 32px rgba(245, 158, 11, 0.4),
                0 4px 16px rgba(0, 0, 0, 0.3),
                inset 0 2px 0 rgba(255, 255, 255, 0.3),
                inset 0 -2px 0 rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
            animation: pulseGlow 3s ease-in-out infinite;
            border: 2px solid rgba(252, 211, 77, 0.5);
        }
        
        @keyframes pulseGlow {
            0%, 100% {
                box-shadow: 
                    0 8px 32px rgba(245, 158, 11, 0.4),
                    0 4px 16px rgba(0, 0, 0, 0.3);
            }
            50% {
                box-shadow: 
                    0 12px 48px rgba(245, 158, 11, 0.6),
                    0 6px 24px rgba(0, 0, 0, 0.4);
            }
        }
        
        .current-serial::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: rotate(45deg);
            animation: shimmer 3s linear infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .current-serial strong {
            display: block;
            font-size: 22px;
            letter-spacing: 2px;
            margin-top: 6px;
            position: relative;
            z-index: 1;
        }
        
        @media (max-width: 767px) {
            .current-serial {
                padding: 16px;
                font-size: 14px;
                margin-bottom: 20px;
            }
            
            .current-serial strong {
                font-size: 18px;
            }
        }

        .form-group {
            margin-bottom: 22px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 700;
            color: #fbbf24;
            font-size: 13px;
            letter-spacing: 0.8px;
            text-transform: uppercase;
            text-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        /* Touch-friendly control panel inputs */
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 14px 16px;
            min-height: 48px;
            border: 2px solid rgba(226, 232, 240, 0.8);
            border-radius: 12px;
            font-size: 16px; /* Prevents iOS zoom */
            font-family: 'Cascadia Mono', monospace;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @media (min-width: 768px) {
            .form-group input,
            .form-group select {
                font-size: 15px;
                padding: 12px 15px;
                min-height: 44px;
            }
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(255, 255, 255, 1);
            box-shadow: 
                0 0 0 4px rgba(102, 126, 234, 0.15),
                0 4px 12px rgba(102, 126, 234, 0.2);
            transform: translateY(-1px);
        }
        
        .form-group input:hover,
        .form-group select:hover {
            border-color: #cbd5e0;
        }

        .form-group small {
            color: rgba(251, 191, 36, 0.7);
            display: block;
            margin-top: 6px;
            font-size: 11px;
            font-weight: 500;
            letter-spacing: 0.3px;
        }

        .color-selector {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        /* Touch-friendly color selector with glassmorphism */
        .color-option {
            padding: 20px;
            min-height: 56px;
            border: 3px solid transparent;
            border-radius: 14px;
            cursor: pointer;
            text-align: center;
            font-weight: 700;
            font-size: 13px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            letter-spacing: 0.8px;
            position: relative;
            overflow: hidden;
        }
        
        .color-option::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            transform: translate(-50%, -50%);
            transition: width 0.4s, height 0.4s;
        }
        
        .color-option:active::before {
            width: 300px;
            height: 300px;
        }

        .color-option:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 20px rgba(0,0,0,0.25);
        }

        .color-option.selected {
            border-color: rgba(45, 55, 72, 0.8);
            box-shadow: 
                0 8px 25px rgba(0,0,0,0.3),
                inset 0 2px 4px rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }
        
        @media (max-width: 767px) {
            .color-selector {
                grid-template-columns: repeat(2, 1fr);
                gap: 14px;
            }
            
            .color-option {
                padding: 24px;
                min-height: 64px;
                font-size: 14px;
            }
        }

        .color-red { background: #ff6b6b; color: white; }
        .color-blue { background: #4dabf7; color: white; }
        .color-green { background: #51cf66; color: white; }
        .color-yellow { background: #ffd43b; color: #2d3748; }

        /* Elegant gold gradient buttons */
        .btn-generate {
            width: 100%;
            padding: 18px 28px;
            min-height: 56px;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #fbbf24 100%);
            background-size: 200% 200%;
            color: #0f172a;
            border: none;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'Cascadia Mono', monospace;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            box-shadow: 
                0 8px 32px rgba(245, 158, 11, 0.4),
                0 4px 16px rgba(0, 0, 0, 0.3),
                inset 0 2px 0 rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(252, 211, 77, 0.5);
        }
        
        .btn-generate::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }
        
        .btn-generate:hover::before {
            left: 100%;
        }

        .btn-generate:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 
                0 12px 48px rgba(245, 158, 11, 0.6),
                0 6px 24px rgba(0, 0, 0, 0.4),
                inset 0 2px 0 rgba(255, 255, 255, 0.4);
            background-position: 100% 0;
            border-color: rgba(252, 211, 77, 0.8);
        }

        .btn-generate:active {
            transform: translateY(0) scale(0.98);
            box-shadow: 
                0 2px 8px rgba(102, 126, 234, 0.3),
                0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .btn-generate:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-reset {
            width: 100%;
            margin-top: 12px;
            padding: 16px 24px;
            min-height: 52px;
            background: rgba(30, 58, 95, 0.6);
            backdrop-filter: blur(15px);
            color: #fbbf24;
            border: 2px solid rgba(245, 158, 11, 0.4);
            border-radius: 14px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'Cascadia Mono', monospace;
            letter-spacing: 1.2px;
            text-transform: uppercase;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
        }

        .btn-reset:hover {
            background: rgba(30, 58, 95, 0.8);
            border-color: rgba(245, 158, 11, 0.6);
            transform: translateY(-2px);
            box-shadow: 
                0 6px 24px rgba(245, 158, 11, 0.3),
                0 3px 12px rgba(0, 0, 0, 0.3);
        }
        
        .btn-reset:active {
            transform: translateY(0) scale(0.98);
        }
        
        @media (min-width: 768px) {
            .btn-generate,
            .btn-reset {
                padding: 14px 22px;
                font-size: 15px;
            }
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }
            .control-panel {
                display: none;
            }
            .print-container {
                display: block !important;
            }
        }

        .print-container {
            display: none;
        }

        @page {
            size: A4;
            margin: 5mm;
        }

        .page {
            width: 210mm;
            height: 297mm;
            page-break-after: always;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .page:last-child {
            page-break-after: auto;
        }

        .ticket-row {
            display: flex;
            flex: 1;
            min-height: 74.25mm;
            border-bottom: 1px dashed #aaa;
        }

        .ticket-row:last-child {
            border-bottom: none;
        }

        .ticket-column {
            width: 50%;
            border-right: 2px dashed #666;
            position: relative;
        }

        .ticket-column:last-child {
            border-right: none;
        }

        .ticket {
            position: relative;
            height: 100%;
            padding: 3.6mm;
            display: flex;
            flex-direction: column;
            border: 3px solid;
            font-family: 'Cascadia Mono', 'Courier New', monospace;
        }

        .ticket.red { border-color: #ff6b6b; }
        .ticket.blue { border-color: #4dabf7; }
        .ticket.green { border-color: #51cf66; }
        .ticket.yellow { border-color: #ffd43b; }

        .ticket.duplicate {
            background: rgba(45, 55, 72, 0.06);
        }

        .ticket-header {
            text-align: center;
            font-weight: 700;
            font-size: 11px;
            padding-bottom: 1.8mm;
            margin-bottom: 2.6mm;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .serial-wrapper {
            display: flex;
            align-items: stretch;
            gap: 1.6mm;
            margin-bottom: 1.8mm;
        }

        .serial-number {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            padding: 2mm 1.4mm;
            background: #edf2f7;
            border: 1.2px solid #cbd5e0;
            border-radius: 3px;
            letter-spacing: 1.3px;
            font-size: 10.5px;
        }

        .ticket-qr {
            width: 20mm;
            min-width: 20mm;
            height: 20mm;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #ffffff;
            border: 1.2px solid #cbd5e0;
            border-radius: 3px;
            padding: 1.2mm;
        }

        .ticket-qr canvas,
        .ticket-qr img {
            width: 100%;
            height: 100%;
        }

        .ticket-body {
            flex: 1;
            font-size: 8px;
            display: flex;
            flex-direction: column;
            gap: 1.6mm;
        }

        .field-row {
            display: flex;
            gap: 2mm;
            margin-bottom: 1.6mm;
        }

        .field-group {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 2mm;
        }

        .field-label {
            font-weight: 600;
            white-space: nowrap;
            color: #2d3748;
        }

        .checkbox-columns {
            display: flex;
            gap: 2mm;
            margin-top: 1mm;
        }

        .checkbox-column {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1mm;
            padding: 1.6mm;
            border-radius: 3px;
            border: 1px solid #cbd5e0;
            background: #f7fafc;
        }

        .checkbox-column.pallet {
            background: #edf2f7;
        }

        .checkbox-column.pallet .checkbox-items {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 0.8mm;
        }

        .checkbox-column-title {
            font-weight: 700;
            font-size: 7px;
            letter-spacing: 0.4px;
            text-transform: uppercase;
            color: #4a5568;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 1.2mm;
            font-weight: 500;
            font-size: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 3.4mm;
            height: 3.4mm;
        }

        .ticket-footer {
            text-align: center;
            font-size: 7.2px;
            padding: 2mm 1mm;
            color: #2d3748;
            font-weight: 600;
            letter-spacing: 0.4px;
            background: rgba(226, 232, 240, 0.95);
            border-top: 1.4px solid rgba(45, 55, 72, 0.65);
            border-bottom-left-radius: 2px;
            border-bottom-right-radius: 2px;
            margin-top: auto;
        }

        .duplicate-label {
            font-size: 8px;
            color: #e53e3e;
            font-weight: 700;
            letter-spacing: 0.8px;
            text-transform: uppercase;
        }

        .field-value {
            flex: 1;
            border-bottom: 1.3px solid #2d3748;
            min-height: 12px;
            display: flex;
            align-items: flex-end;
        }

        .field-value.filled {
            align-items: center;
            color: #1a202c;
            font-weight: 600;
        }

        .field-value.filled span {
            width: 100%;
            word-break: break-word;
        }


        /* Modern vibrant fill mode - website style */
        .fill-mode {
            display: none;
            max-width: 1400px;
            margin: 0 auto;
            padding: 16px;
            gap: 20px;
        }

        .fill-mode.visible {
            display: grid;
            grid-template-columns: 1fr;
            padding-bottom: max(80px, env(safe-area-inset-bottom));
        }

        /* Elegant dark blue cards with gold accents */
        .fill-card {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(30, 58, 95, 0.98));
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-radius: 28px;
            padding: 20px;
            box-shadow: 
                0 16px 64px rgba(0, 0, 0, 0.5),
                0 8px 32px rgba(245, 158, 11, 0.2),
                inset 0 2px 0 rgba(245, 158, 11, 0.15);
            border: 2px solid rgba(245, 158, 11, 0.4);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            animation: fadeInUp 0.5s ease-out;
            position: relative;
            overflow: hidden;
        }
        
        /* Elegant animated gold shimmer */
        .fill-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(245, 158, 11, 0.08) 0%, transparent 70%);
            animation: rotate 25s linear infinite;
        }
        
        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .fill-card > * {
            position: relative;
            z-index: 1;
        }
        
        /* Hidden preview - will be modal */
        .fill-preview {
            display: none !important;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .fill-card:hover,
        .fill-preview:hover {
            box-shadow: 
                0 12px 48px rgba(31, 38, 135, 0.2),
                0 4px 12px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.6);
            transform: translateY(-2px);
        }

        .fill-card h2,
        .fill-preview h2 {
            font-size: 28px;
            margin-bottom: 16px;
            font-weight: 800;
            background: linear-gradient(135deg, #fbbf24, #f59e0b, #fcd34d);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(245, 158, 11, 0.4);
            display: flex;
            align-items: center;
            gap: 12px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }
        
        .fill-card h2::before {
            content: '⬥';
            font-size: 24px;
            color: #fbbf24;
            animation: pulse 2s ease-in-out infinite;
            text-shadow: 0 0 20px rgba(245, 158, 11, 0.6);
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        
        /* Tablet breakpoint */
        @media (min-width: 768px) {
            .fill-mode {
                padding: 24px;
            }
            
            .fill-mode.visible {
                gap: 24px;
            }
            
            .fill-card,
            .fill-preview {
                padding: 28px;
                border-radius: 28px;
            }
            
            .fill-card h2,
            .fill-preview h2 {
                font-size: 22px;
            }
        }
        
        /* Desktop breakpoint */
        @media (min-width: 1024px) {
            .fill-mode {
                padding: 32px 24px 60px;
            }
            
            .fill-mode.visible {
                grid-template-columns: minmax(400px, 1fr) minmax(400px, 1fr);
                gap: 28px;
            }
            
            .fill-card,
            .fill-preview {
                padding: 32px;
            }
            
            .fill-card h2,
            .fill-preview h2 {
                font-size: 24px;
            }
        }

        /* Vibrant logged-in banner */
        .logged-in-banner {
            display: none;
            margin-bottom: 24px;
            padding: 20px 24px;
            border-radius: 18px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: #ffffff;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            animation: slideInDown 0.4s ease-out;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }
        
        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .logged-in-banner small {
            display: block;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
            margin-top: 4px;
            font-size: 13px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        @media (max-width: 767px) {
            .logged-in-banner {
                padding: 16px;
                font-size: 14px;
            }
        }

        /* Enhanced login status with glassmorphism */
        .login-status {
            margin-top: 14px;
            padding: 12px 16px;
            font-size: 14px;
            color: #475569;
            border-radius: 10px;
            background: rgba(148, 163, 184, 0.1);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            animation: fadeIn 0.3s ease-out;
        }

        .login-status.error {
            color: #dc2626;
            background: rgba(220, 38, 38, 0.1);
            border-left: 3px solid #dc2626;
        }

        .login-status.success {
            color: #16a34a;
            background: rgba(22, 163, 74, 0.1);
            border-left: 3px solid #16a34a;
        }
        
        .login-status:empty {
            padding: 0;
            background: transparent;
        }

        .fill-intro {
            font-size: 15px;
            color: rgba(251, 191, 36, 0.95);
            font-weight: 600;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            margin-bottom: 24px;
            line-height: 1.6;
            padding: 16px 20px;
            background: rgba(30, 58, 95, 0.4);
            border-left: 4px solid #f59e0b;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(245, 158, 11, 0.2);
        }
        
        @media (min-width: 768px) {
            .fill-intro {
                font-size: 15px;
                padding: 14px 18px;
            }
        }

        .fill-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Mobile-first form grid */
        .fill-form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
        }
        
        @media (min-width: 768px) {
            .fill-form-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 18px;
            }
        }
        
        @media (min-width: 1024px) {
            .fill-form-grid {
                grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
                gap: 20px;
            }
        }

        .fill-form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .fill-form-group label,
        .fill-group-label {
            font-size: 14px;
            font-weight: 700;
            color: #fbbf24;
            text-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
            letter-spacing: 0.8px;
            display: flex;
            align-items: center;
            gap: 6px;
            text-transform: uppercase;
            font-size: 12px;
        }

        /* Elegant gold-bordered inputs */
        .fill-form-group input[type="text"],
        .fill-form-group input[type="number"],
        .fill-form-group input[type="date"],
        .fill-form-group input[type="time"],
        .fill-form-group input[type="password"],
        .fill-form-group select,
        .fill-form-group textarea {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid rgba(245, 158, 11, 0.3);
            border-radius: 12px;
            font-size: 16px; /* Prevents iOS zoom on focus */
            font-family: 'Cascadia Mono', monospace;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-height: 48px; /* Touch-friendly */
            color: #0f172a;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        @media (min-width: 1024px) {
            .fill-form-group input[type="text"],
            .fill-form-group input[type="number"],
            .fill-form-group input[type="date"],
            .fill-form-group input[type="time"],
            .fill-form-group input[type="password"],
            .fill-form-group select,
            .fill-form-group textarea {
                font-size: 14px;
                padding: 12px 14px;
                min-height: 44px;
            }
        }

        .fill-form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .fill-form-group input:focus,
        .fill-form-group select:focus,
        .fill-form-group textarea:focus {
            outline: none;
            border-color: #f59e0b;
            background: rgba(255, 255, 255, 1);
            box-shadow: 
                0 0 0 4px rgba(245, 158, 11, 0.25),
                0 8px 24px rgba(245, 158, 11, 0.3),
                0 4px 12px rgba(0, 0, 0, 0.2);
            transform: translateY(-2px) scale(1.01);
        }
        
        .fill-form-group input:hover,
        .fill-form-group select:hover,
        .fill-form-group textarea:hover {
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-1px);
        }

        /* Elegant gold-bordered checkbox groups */
        .fill-checkbox-group {
            padding: 18px;
            border: 2px solid rgba(245, 158, 11, 0.3);
            border-radius: 16px;
            background: rgba(30, 58, 95, 0.3);
            backdrop-filter: blur(15px);
            gap: 12px;
            transition: all 0.3s ease;
        }
        
        .fill-checkbox-group:hover {
            background: rgba(30, 58, 95, 0.5);
            border-color: rgba(245, 158, 11, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(245, 158, 11, 0.2);
        }

        .fill-checkbox-group label {
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            color: rgba(251, 191, 36, 0.95);
            text-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            padding: 10px 12px;
            border-radius: 10px;
            min-height: 48px; /* Touch-friendly */
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(15, 23, 42, 0.3);
        }
        
        .fill-checkbox-group label:hover {
            background: rgba(245, 158, 11, 0.15);
            transform: translateX(4px);
            border-left: 3px solid #f59e0b;
        }
        
        .fill-checkbox-group label:active {
            transform: scale(0.98);
        }

        .fill-checkbox-group input[type="checkbox"] {
            width: 22px;
            height: 22px;
            cursor: pointer;
            accent-color: #f59e0b;
            filter: drop-shadow(0 2px 6px rgba(245, 158, 11, 0.4));
        }
        
        @media (min-width: 1024px) {
            .fill-checkbox-group input[type="checkbox"] {
                width: 18px;
                height: 18px;
            }
            
            .fill-checkbox-group label {
                font-size: 13px;
                min-height: 40px;
            }
        }

        .fill-notes-group textarea {
            min-height: 100px;
        }

        /* Responsive sticky action bar with glassmorphism */
        .fill-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 24px;
        }
        
        /* Mobile: Elegant sticky action bar */
        @media (max-width: 767px) {
            .fill-actions {
                position: sticky;
                bottom: 0;
                left: 0;
                right: 0;
                background: linear-gradient(to top, rgba(15, 23, 42, 0.98), rgba(30, 58, 95, 0.98));
                backdrop-filter: blur(20px) saturate(180%);
                -webkit-backdrop-filter: blur(20px) saturate(180%);
                padding: 16px;
                margin: 0 -20px -20px -20px;
                border-radius: 0 0 28px 28px;
                border-top: 2px solid rgba(245, 158, 11, 0.5);
                box-shadow: 
                    0 -6px 32px rgba(0, 0, 0, 0.4),
                    0 -2px 16px rgba(245, 158, 11, 0.2);
                z-index: 100;
                gap: 12px;
            }
        }
        
        /* Tablet and Desktop: Normal flow */
        @media (min-width: 768px) {
            .fill-actions {
                display: flex;
                flex-direction: row;
                gap: 16px;
                position: static;
                margin-top: 28px;
            }
            
            .fill-actions button {
                flex: 1;
            }
        }

        /* Elegant status messages */
        .fill-status {
            font-size: 15px;
            color: #fbbf24;
            font-weight: 600;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
            margin-top: 16px;
            min-height: 24px;
            padding: 14px 18px;
            border-radius: 12px;
            background: rgba(30, 58, 95, 0.5);
            backdrop-filter: blur(15px);
            border: 2px solid rgba(245, 158, 11, 0.4);
            transition: all 0.3s ease;
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .fill-status:empty {
            padding: 0;
            background: transparent;
            border: none;
        }
        
        /* Preview Modal Popup */
        .preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            z-index: 10000;
            padding: 20px;
            overflow-y: auto;
            animation: fadeIn 0.3s ease-out;
        }
        
        .preview-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .preview-modal-content {
            background: #ffffff;
            border-radius: 20px;
            padding: 30px;
            max-width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            position: relative;
            animation: slideUpModal 0.4s ease-out;
        }
        
        @keyframes slideUpModal {
            from {
                opacity: 0;
                transform: translateY(50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .preview-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, #f59e0b, #fbbf24);
            border: 2px solid rgba(252, 211, 77, 0.5);
            border-radius: 50%;
            color: #0f172a;
            font-size: 28px;
            font-weight: 900;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(245, 158, 11, 0.4);
            z-index: 10001;
        }
        
        .preview-modal-close:hover {
            transform: rotate(90deg) scale(1.15);
            box-shadow: 0 8px 28px rgba(245, 158, 11, 0.6);
            border-color: rgba(252, 211, 77, 0.8);
        }
        
        .btn-preview {
            width: 100%;
            padding: 18px 28px;
            min-height: 56px;
            background: linear-gradient(135deg, rgba(30, 58, 95, 0.7), rgba(15, 23, 42, 0.7));
            backdrop-filter: blur(15px);
            color: #fbbf24;
            border: 2px solid rgba(245, 158, 11, 0.5);
            border-radius: 14px;
            font-size: 16px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'Cascadia Mono', monospace;
            letter-spacing: 1.2px;
            text-transform: uppercase;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
            margin-top: 12px;
        }
        
        .btn-preview:hover {
            background: linear-gradient(135deg, rgba(30, 58, 95, 0.9), rgba(15, 23, 42, 0.9));
            border-color: rgba(245, 158, 11, 0.7);
            transform: translateY(-2px);
            box-shadow: 
                0 8px 32px rgba(245, 158, 11, 0.3),
                0 4px 16px rgba(0, 0, 0, 0.3);
        }
        
        /* Loading spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(102, 126, 234, 0.2);
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Loading skeleton */
        .loading-skeleton {
            background: linear-gradient(90deg, 
                rgba(203, 213, 224, 0.2) 25%, 
                rgba(203, 213, 224, 0.4) 50%, 
                rgba(203, 213, 224, 0.2) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s ease-in-out infinite;
            border-radius: 8px;
            height: 20px;
            margin-bottom: 12px;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .skeleton-text {
            height: 16px;
            margin-bottom: 8px;
        }
        
        .skeleton-title {
            height: 24px;
            width: 60%;
            margin-bottom: 16px;
        }

        .fill-preview-note {
            font-size: 13px;
            color: #4a5568;
            margin-bottom: 16px;
        }

        .fill-preview-stage {
            background: #f7fafc;
            border-radius: 14px;
            padding: 16px;
            min-height: 420px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: auto;
        }

        .fill-preview-stage .page {
            transform: scale(0.9);
            transform-origin: top left;
        }

        .movement-toggle {
            max-width: 1200px;
            margin: 30px auto 0;
            text-align: center;
        }

        /* Elegant gold & dark blue movement panel */
        .movement-panel {
            display: none;
            max-width: 1400px;
            margin: 20px auto 60px;
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(30, 58, 95, 0.98));
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-radius: 24px;
            padding: 20px;
            box-shadow: 
                0 16px 64px rgba(0, 0, 0, 0.5),
                0 8px 32px rgba(245, 158, 11, 0.2),
                inset 0 1px 0 rgba(245, 158, 11, 0.15);
            border: 2px solid rgba(245, 158, 11, 0.4);
            transition: all 0.3s ease;
            animation: fadeInUp 0.5s ease-out;
        }
        
        @media (min-width: 768px) {
            .movement-panel {
                padding: 28px;
            }
        }

        .movement-panel.active {
            display: block;
        }

        /* Responsive movement panel header */
        .movement-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 16px;
            flex-wrap: wrap;
        }

        .movement-panel-header h2 {
            margin: 0;
            font-size: 20px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b, #fcd34d);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .movement-panel-header p {
            margin: 6px 0 0;
            color: rgba(251, 191, 36, 0.8);
            font-size: 14px;
            line-height: 1.5;
            font-weight: 500;
        }
        
        @media (min-width: 768px) {
            .movement-panel-header h2 {
                font-size: 24px;
            }
        }

        /* Responsive movement grid */
        .movement-grid {
            margin-top: 25px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        
        @media (min-width: 768px) {
            .movement-grid {
                grid-template-columns: 1fr;
                gap: 24px;
            }
        }
        
        @media (min-width: 1024px) {
            .movement-grid {
                grid-template-columns: 1.2fr 1fr;
                gap: 24px;
            }
        }

        /* Elegant gold & dark blue movement columns */
        .movement-column {
            background: rgba(30, 58, 95, 0.3);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 18px;
            border: 2px solid rgba(245, 158, 11, 0.3);
            transition: all 0.3s ease;
        }
        
        .movement-column:hover {
            background: rgba(30, 58, 95, 0.4);
            box-shadow: 0 8px 24px rgba(245, 158, 11, 0.2);
            border-color: rgba(245, 158, 11, 0.5);
        }
        
        @media (min-width: 768px) {
            .movement-column {
                padding: 20px;
            }
        }

        .movement-section h3 {
            margin-top: 0;
            color: #fbbf24;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 16px;
        }

        /* Responsive movement controls */
        .movement-controls {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            align-items: end;
            margin-bottom: 16px;
        }
        
        @media (min-width: 640px) {
            .movement-controls {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (min-width: 1024px) {
            .movement-controls {
                grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            }
        }

        .movement-controls label {
            display: block;
            font-size: 12px;
            color: #fbbf24;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-weight: 600;
        }

        /* Touch-friendly movement controls with elegant styling */
        .movement-controls select,
        .movement-controls input {
            width: 100%;
            padding: 12px 14px;
            min-height: 48px;
            border: 2px solid rgba(245, 158, 11, 0.3);
            border-radius: 12px;
            font-size: 15px;
            font-family: 'Cascadia Mono', monospace;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            color: #0f172a;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .movement-controls select:focus,
        .movement-controls input:focus {
            outline: none;
            border-color: #f59e0b;
            box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.2);
            transform: translateY(-1px);
        }
        
        @media (min-width: 1024px) {
            .movement-controls select,
            .movement-controls input {
                padding: 10px 12px;
                min-height: 44px;
                font-size: 14px;
            }
        }

        .movement-zone-meta {
            font-size: 13px;
            color: rgba(251, 191, 36, 0.9);
            margin-bottom: 12px;
            border-left: 4px solid #f59e0b;
            padding-left: 10px;
            font-weight: 600;
        }

        .movement-pallet-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 520px;
            overflow-y: auto;
        }

        /* Elegant movement cards with gold accents */
        .movement-card {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 14px;
            padding: 16px;
            border: 2px solid rgba(245, 158, 11, 0.3);
            display: flex;
            flex-direction: column;
            gap: 8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .movement-card:hover {
            background: rgba(15, 23, 42, 0.8);
            border-color: #f59e0b;
            box-shadow: 
                0 8px 24px rgba(245, 158, 11, 0.25),
                0 2px 8px rgba(0, 0, 0, 0.3);
            transform: translateY(-2px);
        }
        
        .movement-card:active {
            transform: translateY(0) scale(0.99);
        }

        .movement-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }

        .movement-card-header strong {
            font-size: 16px;
            color: #fbbf24;
            font-weight: 700;
        }

        .movement-card .badge {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Responsive movement card meta */
        .movement-card-meta {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            font-size: 13px;
            color: rgba(255, 255, 255, 0.85);
            font-weight: 500;
        }
        
        @media (min-width: 640px) {
            .movement-card-meta {
                grid-template-columns: repeat(2, minmax(120px, 1fr));
            }
        }
        
        @media (min-width: 1024px) {
            .movement-card-meta {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            }
        }

        .movement-card-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 6px;
        }

        /* Responsive movement form grid */
        .movement-form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }
        
        @media (min-width: 640px) {
            .movement-form-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (min-width: 1024px) {
            .movement-form-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }

        /* Touch-friendly movement form inputs with elegant styling */
        .movement-form-grid input,
        .movement-form-grid select,
        .movement-form-grid textarea {
            width: 100%;
            padding: 14px 16px;
            min-height: 48px;
            border: 2px solid rgba(245, 158, 11, 0.3);
            border-radius: 12px;
            font-size: 16px;
            font-family: 'Cascadia Mono', monospace;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            color: #0f172a;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .movement-form-grid input:focus,
        .movement-form-grid select:focus,
        .movement-form-grid textarea:focus {
            outline: none;
            border-color: #f59e0b;
            background: rgba(255, 255, 255, 1);
            box-shadow: 
                0 0 0 4px rgba(245, 158, 11, 0.2),
                0 4px 12px rgba(245, 158, 11, 0.3);
            transform: translateY(-1px);
        }
        
        @media (min-width: 1024px) {
            .movement-form-grid input,
            .movement-form-grid select,
            .movement-form-grid textarea {
                font-size: 14px;
                padding: 10px 12px;
                min-height: 44px;
            }
        }

        .movement-form-grid textarea {
            resize: vertical;
            min-height: 100px;
        }

        .movement-form-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .movement-status {
            margin-top: 12px;
            font-size: 13px;
            font-weight: 600;
        }

        .movement-status.error {
            color: #fca5a5;
        }

        .movement-status.success {
            color: #86efac;
        }

        /* View mode responsive grids */
        .pallet-info-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }
        
        @media (min-width: 640px) {
            .pallet-info-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }
        
        /* Hide print container on mobile/tablet */
        @media (max-width: 1024px) {
            body {
                padding: 12px;
            }
            
            .control-panel h1 {
                font-size: 24px;
            }
            
            .current-serial {
                padding: 16px;
                font-size: 14px;
            }
            
            .current-serial strong {
                font-size: 18px;
            }
        }
        
        @media (max-width: 1024px) {
            .movement-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="control-panel">
        <h1>🎫 Banding Ticket Generator</h1>
        <div class="subtitle">NexGridCore DataLabs Production System</div>
        
        <div class="current-serial">
            <span>Next Serial</span>
            <strong id="nextSerial">FG-BL-00001</strong>
        </div>

        <div class="form-group">
            <label>📊 Number of Tickets (per side)</label>
            <input type="number" id="ticketCount" value="4" min="4" step="4">
            <small>Each A4 page prints 4 ticket pairs (8 total tickets)</small>
        </div>

        <div class="form-group">
            <label>🎨 Select Group Color</label>
            <div class="color-selector">
                <div class="color-option color-red" data-color="red">RED</div>
                <div class="color-option color-blue selected" data-color="blue">BLUE</div>
                <div class="color-option color-green" data-color="green">GREEN</div>
                <div class="color-option color-yellow" data-color="yellow">YELLOW</div>
            </div>
        </div>

        <button class="btn-generate" onclick="generateTickets()">
            🖨️ GENERATE & PRINT TICKETS
        </button>
        <button class="btn-generate" onclick="generateAllColorTicketsPDF()" style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); margin-top: 10px;">
            📥 DOWNLOAD PDF (52 Tickets × 4 Colors)
        </button>
        <button class="btn-reset" type="button" onclick="resetSerial()">
            ♻️ Reset Serial Number
        </button>
        
        <!-- SECURITY: Config sections hidden by default, require password to unlock -->
        <div class="form-group" style="margin-top: 25px; padding-top: 25px; border-top: 2px solid #e2e8f0;">
            <button type="button" class="btn-reset" onclick="unlockConfigSection()" id="unlockConfigBtn" style="width: 100%; background: #4c51bf; color: white; font-weight: 600;">
                🔒 Show Advanced Configuration
            </button>
            <small style="display: block; margin-top: 8px; color: #718096;">Password required to view/edit configuration</small>
        </div>
        
        <div id="configSection" style="display: none;">
            <div class="form-group" style="margin-top: 25px; padding-top: 25px; border-top: 2px solid #e2e8f0;">
                <button type="button" class="btn-reset" onclick="lockConfigSection()" id="lockConfigBtn" style="width: 100%; background: #e53e3e; color: white; font-weight: 600; margin-bottom: 15px; display: none;">
                    🔒 Lock Configuration
                </button>
                <label>⚙️ Google Sheets Configuration</label>
                <input type="text" id="googleSheetId" placeholder="Google Sheet ID (hidden)" style="margin-bottom: 10px;" readonly>
                <input type="text" id="googleApiKey" placeholder="Google API Key (hidden)" readonly>
                <button type="button" class="btn-reset" onclick="toggleConfigVisibility()" style="margin-top: 5px; width: 100%; font-size: 12px;">👁️ Show/Hide Values</button>
                <small>Get these from the setup instructions. Required for data tracking.</small>
                <button type="button" class="btn-reset" onclick="saveGoogleConfig()" style="margin-top: 10px; width: 100%;">💾 Save Configuration</button>
                <button type="button" class="btn-reset" onclick="testGoogleSheetsConnection()" style="margin-top: 10px; width: 100%; background: #667eea; color: white;">🔍 Test Connection</button>
                <div id="testResults" style="margin-top: 10px; padding: 10px; border-radius: 5px; display: none; font-size: 12px;"></div>
            </div>
            
            <div class="form-group" style="margin-top: 25px; padding-top: 25px; border-top: 2px solid #e2e8f0;">
                <label>📱 QR Code URL Configuration</label>
                <input type="text" id="scanBaseUrl" placeholder="https://nexgridcoredatalabs.github.io/Nexers-Banding-Tickets/" style="margin-bottom: 10px;">
                <small>Enter your network IP address and port (not localhost). This is what QR codes will link to. Find your IP with: ipconfig (Windows) or ifconfig (Mac/Linux)</small>
                <button type="button" class="btn-reset" onclick="saveScanUrlConfig()" style="margin-top: 10px; width: 100%;">💾 Save QR URL</button>
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
            <p style="color: #718096; font-size: 12px; font-weight: 500; letter-spacing: 0.5px;">
                Powered by <strong style="color: #667eea; font-weight: 700;">NexGridCore DataLabs</strong>
            </p>
        </div>
    </div>

    <div class="print-container" id="printContainer"></div>

    <div class="fill-mode" id="fillContainer">
        <div class="fill-card" id="viewCard" style="display: none;">
            <h2>⬥ View Ticket</h2>
            <p class="fill-intro">Viewing ticket: <strong id="viewSerialDisplay"></strong></p>
            <div id="viewContent" class="fill-form">
                <div id="viewLoading" style="text-align: center; padding: 60px 20px;">
                    <div class="loading-spinner" style="width: 40px; height: 40px; margin: 0 auto 16px;"></div>
                    <p style="color: rgba(251, 191, 36, 0.95); font-size: 15px; margin-top: 12px; font-weight: 700; text-shadow: 0 2px 8px rgba(0, 0, 0, 0.4); letter-spacing: 0.5px;">Loading ticket data...</p>
                    <div class="loading-skeleton skeleton-title" style="margin: 24px auto 0; width: 70%;"></div>
                    <div class="loading-skeleton skeleton-text" style="margin: 12px auto 0; width: 90%;"></div>
                    <div class="loading-skeleton skeleton-text" style="margin: 8px auto 0; width: 80%;"></div>
                </div>
                <div id="viewData" style="display: none;"></div>
            </div>
            <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 2px solid rgba(245, 158, 11, 0.3);">
                <p style="color: rgba(251, 191, 36, 0.8); font-size: 12px; font-weight: 600; letter-spacing: 1px;">
                    Powered by <strong style="background: linear-gradient(135deg, #fbbf24, #f59e0b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 800;">NexGridCore DataLabs</strong>
                </p>
            </div>
        </div>

        <div class="fill-card" id="loginCard" style="display: none;">
            <h2>⬥ Authorized Login</h2>
            <p class="fill-intro">Only authorized production leads can edit tickets from this workstation. Please sign in to continue.</p>
            <form id="loginForm" class="fill-form">
                <div class="fill-form-group">
                    <label for="loginUser">Select User</label>
                    <select id="loginUser" required>
                        <option value="">Loading authorized users...</option>
                    </select>
                </div>
                <div class="fill-form-group">
                    <label for="loginPasscode">Passcode</label>
                    <input type="password" id="loginPasscode" required placeholder="Enter your secure passcode">
                </div>
                <div class="fill-actions">
                    <button type="submit" class="btn-generate" id="loginSubmit">🔓 Unlock Editor</button>
                    <button type="button" class="btn-reset" id="loginResetAccess">🔄 Reset Access</button>
                </div>
                <div id="loginStatus" class="login-status"></div>
            </form>
            <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                <p style="color: #718096; font-size: 12px; font-weight: 500; letter-spacing: 0.5px;">
                    Powered by <strong style="color: #667eea; font-weight: 700;">NexGridCore DataLabs</strong>
                </p>
            </div>
        </div>
        
        <div class="fill-card" id="editCard">
            <h2>⬥ Edit Ticket</h2>
            <p class="fill-intro">Enter the captured information for serial <strong id="fillSerialDisplay" style="color: #fcd34d; font-weight: 800; letter-spacing: 1px;"></strong>. When you submit, data is saved to Google Sheets and a finished ticket downloads as a PNG.</p>
            <div class="logged-in-banner" id="loggedInUserBanner">
                <div>
                    <span id="loggedInUserText"></span>
                    <small>Session locked to this user. All edits are tracked.</small>
                </div>
                <button type="button" class="btn-reset" id="logoutUserButton">Log out</button>
            </div>
            <form id="ticketForm" class="fill-form">
                <div class="fill-form-grid">
                    <div class="fill-form-group">
                        <label for="fillSerial">Ticket Serial</label>
                        <input type="text" id="fillSerial" name="serial" required inputmode="text">
                    </div>
                    <div class="fill-form-group">
                        <label for="fillColor">Ticket Colour</label>
                        <select id="fillColor" name="color">
                            <option value="blue">Blue</option>
                            <option value="red">Red</option>
                            <option value="green">Green</option>
                            <option value="yellow">Yellow</option>
                        </select>
                    </div>
                    <div class="fill-form-group">
                        <label for="fillDate">Date</label>
                        <input type="date" id="fillDate" name="date" inputmode="none">
                    </div>
                    <div class="fill-form-group">
                        <label for="fillTime">Time</label>
                        <input type="time" id="fillTime" name="time" inputmode="none">
                    </div>
                    <div class="fill-form-group">
                        <label for="fillSku">SKU</label>
                        <select id="fillSku" name="sku" style="width: 100%; padding: 10px; border: 2px solid #cbd5e0; border-radius: 6px; font-size: 14px; background: white;">
                            <option value="">Select or type SKU...</option>
                        </select>
                        <input type="text" id="fillSkuCustom" name="skuCustom" placeholder="Or enter custom SKU..." style="width: 100%; padding: 10px; border: 2px solid #cbd5e0; border-radius: 6px; font-size: 14px; margin-top: 8px; display: none;">
                        <small style="display: block; margin-top: 5px; color: #718096; font-size: 12px;">Select from list or type custom SKU</small>
                    </div>
                    <div class="fill-form-group">
                        <label for="fillQty">Quantity</label>
                        <input type="number" id="fillQty" name="qty" min="0" step="1" inputmode="numeric">
                    </div>
                    <div class="fill-form-group">
                        <label for="fillLayers">Layers</label>
                        <input type="number" id="fillLayers" name="layers" min="0" step="1" inputmode="numeric">
                    </div>
                    <div class="fill-form-group fill-checkbox-group">
                        <span class="fill-group-label">Banding Type</span>
                        <label><input type="checkbox" name="bandingType" value="online"> Online</label>
                        <label><input type="checkbox" name="bandingType" value="offline"> Offline</label>
                    </div>
                    <div class="fill-form-group fill-checkbox-group">
                        <span class="fill-group-label">Product Type</span>
                        <label><input type="checkbox" name="productType" value="1kg"> 1kg</label>
                        <label><input type="checkbox" name="productType" value="0.5kg"> 0.5kg</label>
                    </div>
                    <div class="fill-form-group fill-checkbox-group">
                        <span class="fill-group-label">Pallet Size</span>
                        <label><input type="checkbox" name="palletSize" value="78"> 78</label>
                        <label><input type="checkbox" name="palletSize" value="105"> 105</label>
                        <label><input type="checkbox" name="palletSize" value="64"> 64</label>
                        <label><input type="checkbox" name="palletSize" value="100"> 100</label>
                    </div>
                    <div class="fill-form-group fill-notes-group">
                        <label for="fillNotes">Notes / References</label>
                        <textarea id="fillNotes" name="notes" rows="4" placeholder="Additional remarks..."></textarea>
                    </div>
                    
                    <div class="fill-form-group" style="grid-column: 1 / -1; margin-top: 10px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                        <label style="font-size: 15px; font-weight: 700; margin-bottom: 15px;">Sachet & Tablet Information</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div class="fill-form-group">
                                <label for="sachetType">Sachet Type</label>
                                <select id="sachetType" name="sachetType" style="width: 100%; padding: 10px; border: 2px solid #cbd5e0; border-radius: 6px; font-size: 14px; background: white;">
                                    <option value="">Select sachet type...</option>
                                </select>
                            </div>
                            <div class="fill-form-group">
                                <label for="tabletType">Tablet Type</label>
                                <select id="tabletType" name="tabletType" style="width: 100%; padding: 10px; border: 2px solid #cbd5e0; border-radius: 6px; font-size: 14px; background: white;">
                                    <option value="">Select tablet type...</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="fill-form-group" style="grid-column: 1 / -1; margin-top: 10px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                        <label style="font-size: 15px; font-weight: 700; margin-bottom: 15px;">Quality Issues</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div class="fill-form-group">
                                <label for="qualityIssueType">Issue Type</label>
                                <select id="qualityIssueType" name="qualityIssueType">
                                    <option value="">Select type...</option>
                                    <option value="banding">Banding Quality Frailties</option>
                                    <option value="production">Production Quality Frailties</option>
                                </select>
                            </div>
                            <div class="fill-form-group">
                                <label for="groupLeader">Group Leader</label>
                                <select id="groupLeader" name="groupLeader">
                                    <option value="">Select leader...</option>
                                </select>
                            </div>
                        </div>
                        <div class="fill-form-group">
                            <label for="qualityIssueDesc">Issue Description</label>
                            <textarea id="qualityIssueDesc" name="qualityIssueDesc" rows="3" placeholder="Describe the quality issue..."></textarea>
                        </div>
                    </div>
                    
                    <div class="fill-form-group" style="grid-column: 1 / -1; margin-top: 10px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                        <label style="font-size: 15px; font-weight: 700; margin-bottom: 15px;">Merchandise History</label>
                        <div id="merchHistoryContainer">
                            <div class="merch-history-entry" style="display: grid; grid-template-columns: 1fr; gap: 12px; margin-bottom: 12px; align-items: end; background: rgba(102, 126, 234, 0.03); padding: 16px; border-radius: 12px;">
                                <div class="fill-form-group">
                                    <label>Date</label>
                                    <input type="date" class="merch-history-date" name="merchHistoryDate[]" inputmode="none">
                                </div>
                                <div class="fill-form-group">
                                    <label>User</label>
                                    <select class="merch-history-user" name="merchHistoryUser[]">
                                        <option value="">Select user...</option>
                                    </select>
                                </div>
                                <div class="fill-form-group">
                                    <label>Note</label>
                                    <input type="text" class="merch-history-note" name="merchHistoryNote[]" placeholder="Enter note..." inputmode="text">
                                </div>
                            </div>
                        </div>
                        <style>
                            @media (min-width: 768px) {
                                .merch-history-entry {
                                    grid-template-columns: 1fr 1fr 2fr !important;
                                }
                            }
                        </style>
                        <button type="button" onclick="addMerchHistoryEntry()" class="btn-reset" style="width: 100%; margin-top: 10px;">+ Add History Entry</button>
                    </div>
                </div>
                <div class="fill-actions">
                    <button type="submit" class="btn-generate">💾 Save to Google Sheets & Download Ticket</button>
                </div>
                <div id="fillStatus" class="fill-status"></div>
            </form>
            <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                <p style="color: #718096; font-size: 12px; font-weight: 500; letter-spacing: 0.5px;">
                    Powered by <strong style="color: #667eea; font-weight: 700;">NexGridCore DataLabs</strong>
                </p>
            </div>
        </div>
        <div class="fill-preview">
            <h2>Live Preview</h2>
            <div class="fill-preview-note">Preview updates on submit before the download starts.</div>
            <div class="fill-preview-stage" id="fillPreview"></div>
            <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                <p style="color: #718096; font-size: 12px; font-weight: 500; letter-spacing: 0.5px;">
                    Powered by <strong style="color: #667eea; font-weight: 700;">NexGridCore DataLabs</strong>
                </p>
            </div>
        </div>

        <div id="movementSection" style="display: none;">
            <div class="movement-toggle">
                <button type="button" class="btn-generate" id="movementToggleBtn" onclick="toggleMovementPanel()">
                    🚚 Open Stock Movement Control
                </button>
            </div>

            <div class="movement-panel" id="movementPanel">
                <div class="movement-panel-header">
                    <div>
                        <h2>📦 Stock Movement Control</h2>
                        <p>Monitor pallets per zone, enforce FIFO, and log movements in real time.</p>
                    </div>
                    <button type="button" class="btn-reset" onclick="toggleMovementPanel(false)">Close</button>
                </div>

                <div class="movement-grid">
                    <div class="movement-column">
                        <div class="movement-section">
                            <h3>Zone Monitor</h3>
                            <div class="movement-controls">
                                <div>
                                    <label for="movementZoneSelect">Zone</label>
                                    <select id="movementZoneSelect"></select>
                                </div>
                                <div>
                                    <label for="movementStatusFilter">Status</label>
                                    <select id="movementStatusFilter">
                                        <option value="">Any status</option>
                                        <option value="Active">Active</option>
                                        <option value="Hold">Hold</option>
                                        <option value="Rework">Rework</option>
                                        <option value="Dispatch">Dispatch</option>
                                        <option value="Shipped">Shipped</option>
                                        <option value="Outbounded">Outbounded</option>
                                    </select>
                                </div>
                                <button type="button" class="btn-generate" onclick="refreshMovementZone()">🔄 Refresh</button>
                                <button type="button" class="btn-reset" onclick="refreshZoneOverview()" style="margin-top: 10px;">📊 View All Zones</button>
                            </div>
                            <div id="movementZoneMeta" class="movement-zone-meta"></div>
                            <div id="zoneOverviewTable" style="display: none; margin-top: 20px; background: rgba(15, 23, 42, 0.6); border-radius: 12px; padding: 16px; border: 2px solid rgba(245, 158, 11, 0.3);"></div>
                            <div id="movementPalletList" class="movement-pallet-list">
                                <div style="color:#94a3b8;">Select a zone to view pallets.</div>
                            </div>
                        </div>
                    </div>
                    <div class="movement-column movement-column-form">
                        <div class="movement-section">
                            <h3>Move Pallet</h3>
                            <form id="movementForm" onsubmit="event.preventDefault(); submitMovementForm();">
                                <div class="movement-form-grid">
                                    <div>
                                        <label for="movementPalletId">Pallet ID</label>
                                        <input type="text" id="movementPalletId" placeholder="FG-DET-00001" required>
                                    </div>
                                    <div>
                                        <label for="movementCurrentZone">Current Zone</label>
                                        <input type="text" id="movementCurrentZone" placeholder="Auto-detected" readonly>
                                    </div>
                                    <div>
                                        <label for="movementToZoneSelect">Move To</label>
                                        <select id="movementToZoneSelect" required></select>
                                    </div>
                                    <div>
                                        <label for="movementMovedBy">Moved By</label>
                                        <input type="text" id="movementMovedBy" placeholder="Clerk name / badge" required>
                                    </div>
                            <div id="movementQuantityWrapper">
                                <label for="movementQuantity">Quantity (optional)</label>
                                <input type="number" id="movementQuantity" min="0" step="1" placeholder="Leave blank to keep full qty">
                            </div>
                                    <div>
                                        <label for="movementOrderRef">Order Reference (optional)</label>
                                        <input type="text" id="movementOrderRef" placeholder="MT/Dispatch reference">
                                    </div>
                                    <div style="grid-column: 1 / -1;">
                                        <label for="movementReason">Reason / Notes</label>
                                        <textarea id="movementReason" rows="3" placeholder="Reason for movement, QA notes, etc."></textarea>
                                    </div>
                                    <div style="grid-column: 1 / -1;">
                                        <label for="movementOverrideReason">Override Reason (required when bypassing FIFO)</label>
                                        <textarea id="movementOverrideReason" rows="2" placeholder="Explain why FIFO is bypassed. Leave blank to enforce FIFO."></textarea>
                                    </div>
                                </div>
                        <div class="movement-form-actions">
                            <button type="button" class="btn-reset" id="toggleChildModeBtn" onclick="toggleMovementMode()">✨ Create Child Pallet</button>
                            <button type="submit" class="btn-generate" id="movementSubmitBtn">Move Pallet</button>
                            <button type="button" class_name="btn-reset" onclick="resetMovementForm()">Clear</button>
                        </div>
                                <div id="movementStatusMessage" class="movement-status"></div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>

    <script>
        const SERIES_PREFIX = 'BND';
        let selectedColor = 'blue';
        let currentSerial = 1;
        let movementPanelInitialized = false;
        let movementZones = [];
        let movementLastPallets = [];
        let movementSelectedPallet = null;
        
        // PERFORMANCE OPTIMIZATION: Request caching system
        const requestCache = new Map();
        const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes cache
        
        function getCachedRequest(key) {
            const cached = requestCache.get(key);
            if (cached && Date.now() - cached.timestamp < CACHE_DURATION) {
                return cached.data;
            }
            requestCache.delete(key);
            return null;
        }
        
        function setCachedRequest(key, data) {
            requestCache.set(key, {
                data: data,
                timestamp: Date.now()
            });
        }
        
        function clearCache(pattern = null) {
            if (pattern) {
                // Clear specific pattern
                for (const key of requestCache.keys()) {
                    if (key.includes(pattern)) {
                        requestCache.delete(key);
                    }
                }
            } else {
                // Clear all cache
                requestCache.clear();
            }
        }
        
        // PERFORMANCE OPTIMIZATION: Elegant toast notification system
        function showToast(message, type = 'info', duration = 4000) {
            // Remove existing toasts
            const existingToasts = document.querySelectorAll('.toast-notification');
            existingToasts.forEach(toast => toast.remove());
            
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.setAttribute('role', 'alert');
            
            const icons = {
                success: '✅',
                error: '❌',
                warning: '⚠️',
                info: 'ℹ️'
            };
            
            const colors = {
                success: { bg: 'rgba(34, 197, 94, 0.95)', border: '#22c55e', text: '#ffffff' },
                error: { bg: 'rgba(239, 68, 68, 0.95)', border: '#ef4444', text: '#ffffff' },
                warning: { bg: 'rgba(245, 158, 11, 0.95)', border: '#f59e0b', text: '#0f172a' },
                info: { bg: 'rgba(59, 130, 246, 0.95)', border: '#3b82f6', text: '#ffffff' }
            };
            
            const style = colors[type] || colors.info;
            
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${style.bg};
                color: ${style.text};
                padding: 16px 24px;
                border-radius: 12px;
                border: 2px solid ${style.border};
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), 0 4px 16px rgba(0, 0, 0, 0.2);
                z-index: 10000;
                font-family: 'Cascadia Mono', monospace;
                font-size: 14px;
                font-weight: 600;
                max-width: 400px;
                animation: slideInRight 0.3s ease-out;
                backdrop-filter: blur(10px);
                display: flex;
                align-items: center;
                gap: 12px;
            `;
            
            toast.innerHTML = `
                <span style="font-size: 20px;">${icons[type] || icons.info}</span>
                <span style="flex: 1;">${escapeHtml(message)}</span>
                <button onclick="this.parentElement.remove()" style="background: transparent; border: none; color: ${style.text}; cursor: pointer; font-size: 18px; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; opacity: 0.8; transition: opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">×</button>
            `;
            
            document.body.appendChild(toast);
            
            // Auto-remove after duration
            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => toast.remove(), 300);
            }, duration);
            
            // Add CSS animations if not already added
            if (!document.getElementById('toast-animations')) {
                const styleSheet = document.createElement('style');
                styleSheet.id = 'toast-animations';
                styleSheet.textContent = `
                    @keyframes slideInRight {
                        from {
                            transform: translateX(100%);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(0);
                            opacity: 1;
                        }
                    }
                    @keyframes slideOutRight {
                        from {
                            transform: translateX(0);
                            opacity: 1;
                        }
                        to {
                            transform: translateX(100%);
                            opacity: 0;
                        }
                    }
                `;
                document.head.appendChild(styleSheet);
            }
        }
        
        // HARDCODED: GitHub Pages URL - Update this with your actual GitHub Pages URL
        const DEFAULT_SCAN_BASE_URL = 'https://nexgridcoredatalabs.github.io/Nexers-Banding-Tickets/bandingtickets.html';
        
        // Load saved scan URL or use hardcoded default
        let SCAN_BASE_URL = localStorage.getItem('scanBaseUrl') || DEFAULT_SCAN_BASE_URL;
        
        // Auto-detect the current page URL if no saved URL exists
        if (!localStorage.getItem('scanBaseUrl')) {
            const { protocol, origin, pathname, hostname } = window.location;
            
            // If accessing via file:// protocol, use default URL or prompt user
            if (protocol === 'file:') {
                console.warn('⚠️ Accessing via file:// protocol. QR codes will use default URL.');
                console.warn('💡 For local testing, use a web server: python -m http.server 8000');
                console.warn('💡 Then access via: http://localhost:8000/bandingtickets.html');
                // Use default URL so QR codes still generate (user can change in config)
                SCAN_BASE_URL = DEFAULT_SCAN_BASE_URL;
                localStorage.setItem('scanBaseUrl', SCAN_BASE_URL);
            } else if (hostname === 'localhost' || hostname === '127.0.0.1') {
                // Local server - use it but warn about phone access
                SCAN_BASE_URL = `${origin}${pathname}`;
                localStorage.setItem('scanBaseUrl', SCAN_BASE_URL);
                console.warn('⚠️ Using localhost URL. QR codes will only work if phone is on same network.');
                console.warn('💡 For phone access, use your computer IP: http://YOUR-IP:PORT/bandingtickets.html');
            } else {
                // Web server (GitHub Pages, etc.) - use current URL
                SCAN_BASE_URL = `${origin}${pathname}`;
                localStorage.setItem('scanBaseUrl', SCAN_BASE_URL);
                console.log('✅ Auto-detected URL:', SCAN_BASE_URL);
            }
        }
        
        // Load saved config into input field
        if (document.getElementById('scanBaseUrl')) {
            document.getElementById('scanBaseUrl').value = SCAN_BASE_URL;
        }
        
        function saveScanUrlConfig() {
            const url = document.getElementById('scanBaseUrl').value.trim();
            if (url) {
                // Basic validation
                if (!url.startsWith('http://') && !url.startsWith('https://')) {
                    showToast('URL must start with http:// or https://', 'error');
                    return;
                }
                if (url.includes('localhost') || url.includes('127.0.0.1')) {
                    if (!confirm('Warning: Using localhost will not work when scanning from phones. Continue anyway?')) {
                        return;
                    }
                }
                SCAN_BASE_URL = url;
                localStorage.setItem('scanBaseUrl', url);
                showToast('QR URL saved! Regenerate tickets for the new URL to take effect.', 'success');
            } else {
                showToast('Please enter a URL', 'warning');
            }
        }
        const urlParams = new URLSearchParams(window.location.search);
        const currentMode = urlParams.get('mode');
        const initialSerialParam = urlParams.get('serial');
        const urlColorParam = urlParams.get('color');

        const savedSerial = localStorage.getItem('bandingSerial');
        if (savedSerial) {
            currentSerial = parseInt(savedSerial, 10);
        }
        updateSerialDisplay();

        const loginFormEl = document.getElementById('loginForm');
        if (loginFormEl) {
            loginFormEl.addEventListener('submit', handleLoginSubmit);
        }

        const loginResetButton = document.getElementById('loginResetAccess');
        if (loginResetButton) {
            loginResetButton.addEventListener('click', () => {
                clearLoggedInUserSession();
                localStorage.removeItem(GENERATOR_ACCESS_TOKEN);
                localStorage.removeItem(USER_SESSION_KEY);
                alert('Access has been reset. Please reload the page and authenticate again.');
                showLoginCard();
            });
        }

        const logoutButton = document.getElementById('logoutUserButton');
        if (logoutButton) {
            logoutButton.addEventListener('click', () => {
                clearLoggedInUserSession();
                showLoginCard();
            });
        }

        function escapeHtml(value) {
            if (value === null || value === undefined) {
                return '';
            }
            return String(value).replace(/[&<>"']/g, (char) => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[char]));
        }

        document.querySelectorAll('.color-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.color-option').forEach(opt => 
                    opt.classList.remove('selected'));
                this.classList.add('selected');
                selectedColor = this.dataset.color;
                updateSerialDisplay();
            });
        });

        // SECURITY FIX: Load from config.js (fallback to defaults for backward compatibility)
        const CONFIG = window.BANDFLOW_CONFIG || {};
        const DEFAULT_GOOGLE_SHEET_ID = CONFIG.GOOGLE_SHEET_ID || '1QXkL2K5hAfyvHKQ6mCFckmIu73lLw_XyENKSuqyFQgE';
        const DEFAULT_GOOGLE_API_KEY = CONFIG.GOOGLE_API_KEY || 'AIzaSyBUSYg78PSD47OWJkzEa4kMQknjROGulLI';
        const DEFAULT_GOOGLE_APPS_SCRIPT_URL = CONFIG.GOOGLE_APPS_SCRIPT_URL || 'https://script.google.com/macros/s/AKfycbxbujRsVW-vVwt34GVCOlCm145mjgp4uV11-YhSy1CQtXPKiqdlPycfTj7q8GvIHg0a0g/exec';
        
        const USER_SESSION_KEY = 'bandingUserSession';
        let loggedInUser = getStoredUser();
        
        function getStoredUser() {
            try {
                return JSON.parse(localStorage.getItem(USER_SESSION_KEY)) || null;
            } catch (error) {
                return null;
            }
        }
        
        function isUserLoggedIn() {
            return !!(loggedInUser && loggedInUser.id);
        }
        
        function setLoggedInUser(user) {
            loggedInUser = user;
            localStorage.setItem(USER_SESSION_KEY, JSON.stringify(user));
            updateLoggedInUserBanner();
        }
        
        function clearLoggedInUserSession() {
            loggedInUser = null;
            localStorage.removeItem(USER_SESSION_KEY);
            updateLoggedInUserBanner();
        }
        
        function updateLoggedInUserBanner() {
            const banner = document.getElementById('loggedInUserBanner');
            const text = document.getElementById('loggedInUserText');
            if (!banner || !text) return;
            if (isUserLoggedIn()) {
                banner.style.display = 'flex';
                text.textContent = `Signed in as ${loggedInUser.name || loggedInUser.id}`;
            } else {
                banner.style.display = 'none';
                text.textContent = '';
            }
            const movementMovedByInput = document.getElementById('movementMovedBy');
            if (movementMovedByInput && isUserLoggedIn() && !movementMovedByInput.value) {
                movementMovedByInput.value = loggedInUser.name || loggedInUser.id || '';
            }
        }

        updateLoggedInUserBanner();
        
        // Load configuration: Use hardcoded defaults, or localStorage override, or user input
        let GOOGLE_SHEET_ID = DEFAULT_GOOGLE_SHEET_ID || localStorage.getItem('googleSheetId') || '';
        let GOOGLE_API_KEY = DEFAULT_GOOGLE_API_KEY || localStorage.getItem('googleApiKey') || '';
        let GOOGLE_APPS_SCRIPT_URL = DEFAULT_GOOGLE_APPS_SCRIPT_URL || localStorage.getItem('googleAppsScriptUrl') || '';
        
        // Auto-save hardcoded values to localStorage if they exist
        if (DEFAULT_GOOGLE_SHEET_ID && DEFAULT_GOOGLE_API_KEY) {
            localStorage.setItem('googleSheetId', DEFAULT_GOOGLE_SHEET_ID);
            localStorage.setItem('googleApiKey', DEFAULT_GOOGLE_API_KEY);
            GOOGLE_SHEET_ID = DEFAULT_GOOGLE_SHEET_ID;
            GOOGLE_API_KEY = DEFAULT_GOOGLE_API_KEY;
        }
        if (DEFAULT_GOOGLE_APPS_SCRIPT_URL) {
            localStorage.setItem('googleAppsScriptUrl', DEFAULT_GOOGLE_APPS_SCRIPT_URL);
            GOOGLE_APPS_SCRIPT_URL = DEFAULT_GOOGLE_APPS_SCRIPT_URL;
        }
        
        // SECURITY: Config section password protection
        const CONFIG_UNLOCK_TOKEN = 'config_section_unlocked';
        let configValuesVisible = false;
        
        function unlockConfigSection() {
            const password = prompt('🔐 Advanced Configuration Access\n\nEnter password to view/edit configuration:');
            if (password === GENERATOR_PASSWORD) {
                localStorage.setItem(CONFIG_UNLOCK_TOKEN, 'true');
                showConfigSection();
            } else if (password !== null) {
                alert('❌ Incorrect password. Access denied.');
            }
        }
        
        function showConfigSection() {
            const configSection = document.getElementById('configSection');
            const unlockBtn = document.getElementById('unlockConfigBtn');
            const lockBtn = document.getElementById('lockConfigBtn');
            if (configSection && unlockBtn) {
                configSection.style.display = 'block';
                unlockBtn.style.display = 'none';
                if (lockBtn) {
                    lockBtn.style.display = 'block';
                }
                // Load config values (masked)
                loadConfigValues();
            }
        }
        
        function lockConfigSection() {
            const configSection = document.getElementById('configSection');
            const unlockBtn = document.getElementById('unlockConfigBtn');
            const lockBtn = document.getElementById('lockConfigBtn');
            
            if (configSection && unlockBtn) {
                // Hide config section
                configSection.style.display = 'none';
                unlockBtn.style.display = 'block';
                if (lockBtn) {
                    lockBtn.style.display = 'none';
                }
                // Clear unlock token (force password on next unlock)
                localStorage.removeItem(CONFIG_UNLOCK_TOKEN);
                // Reset visibility state
                configValuesVisible = false;
                // Clear any visible values
                if (document.getElementById('googleSheetId')) {
                    document.getElementById('googleSheetId').value = '';
                    document.getElementById('googleSheetId').readOnly = true;
                }
                if (document.getElementById('googleApiKey')) {
                    document.getElementById('googleApiKey').value = '';
                    document.getElementById('googleApiKey').readOnly = true;
                }
            }
        }
        
        function loadConfigValues() {
            // Load values but mask them initially
            if (document.getElementById('googleSheetId')) {
                const sheetIdInput = document.getElementById('googleSheetId');
                const sheetId = GOOGLE_SHEET_ID || '';
                sheetIdInput.dataset.realValue = sheetId; // Store real value
                sheetIdInput.value = configValuesVisible ? sheetId : '•'.repeat(Math.max(sheetId.length, 20));
                sheetIdInput.readOnly = !configValuesVisible;
            }
            if (document.getElementById('googleApiKey')) {
                const apiKeyInput = document.getElementById('googleApiKey');
                const apiKey = GOOGLE_API_KEY || '';
                apiKeyInput.dataset.realValue = apiKey; // Store real value
                apiKeyInput.value = configValuesVisible ? apiKey : '•'.repeat(Math.max(apiKey.length, 20));
                apiKeyInput.readOnly = !configValuesVisible;
            }
        }
        
        function toggleConfigVisibility() {
            configValuesVisible = !configValuesVisible;
            const sheetIdInput = document.getElementById('googleSheetId');
            const apiKeyInput = document.getElementById('googleApiKey');
            
            
            if (sheetIdInput) {
                const realValue = GOOGLE_SHEET_ID || '';
                // Store real value in data attribute if not already stored
                if (!sheetIdInput.dataset.realValue) {
                    sheetIdInput.dataset.realValue = realValue;
                }
                sheetIdInput.value = configValuesVisible ? sheetIdInput.dataset.realValue : '•'.repeat(Math.max(sheetIdInput.dataset.realValue.length, 20));
                sheetIdInput.readOnly = !configValuesVisible;
            }
            
            if (apiKeyInput) {
                const realValue = GOOGLE_API_KEY || '';
                // Store real value in data attribute if not already stored
                if (!apiKeyInput.dataset.realValue) {
                    apiKeyInput.dataset.realValue = realValue;
                }
                apiKeyInput.value = configValuesVisible ? apiKeyInput.dataset.realValue : '•'.repeat(Math.max(apiKeyInput.dataset.realValue.length, 20));
                apiKeyInput.readOnly = !configValuesVisible;
            }
        }
        
        // Check if config section was previously unlocked
        if (localStorage.getItem(CONFIG_UNLOCK_TOKEN) === 'true') {
            showConfigSection();
        }
        
        // Load saved config into input fields (for display/override) - only if unlocked
        if (document.getElementById('googleSheetId') && localStorage.getItem(CONFIG_UNLOCK_TOKEN) === 'true') {
            loadConfigValues();
        }
        if (document.getElementById('googleApiKey') && localStorage.getItem(CONFIG_UNLOCK_TOKEN) === 'true') {
            // Already handled in loadConfigValues()
        }
        
        function saveGoogleConfig() {
            // Require password to save config
            const password = prompt('🔐 Save Configuration - Password Required\n\nEnter password to save configuration:');
            if (password !== GENERATOR_PASSWORD) {
                if (password !== null) {
                    alert('❌ Incorrect password. Configuration not saved.');
                }
                return;
            }
            
            const sheetIdInput = document.getElementById('googleSheetId');
            const apiKeyInput = document.getElementById('googleApiKey');
            
            // Get real values from data attributes or input
            let sheetId = sheetIdInput ? (sheetIdInput.dataset.realValue || sheetIdInput.value.trim().replace(/•/g, '')) : '';
            let apiKey = apiKeyInput ? (apiKeyInput.dataset.realValue || apiKeyInput.value.trim().replace(/•/g, '')) : '';
            
            // Fallback to existing values if empty
            if (!sheetId || sheetId.match(/^•+$/)) {
                sheetId = GOOGLE_SHEET_ID || '';
            }
            if (!apiKey || apiKey.match(/^•+$/)) {
                apiKey = GOOGLE_API_KEY || '';
            }
            
            if (sheetId && apiKey) {
                GOOGLE_SHEET_ID = sheetId;
                GOOGLE_API_KEY = apiKey;
                localStorage.setItem('googleSheetId', sheetId);
                localStorage.setItem('googleApiKey', apiKey);
                alert('✅ Configuration saved successfully!');
                // Reload to show updated values
                loadConfigValues();
            } else {
                alert('❌ Please enter both Sheet ID and API Key');
            }
        }
        
        // Generator access control - only accessible from this PC
        const GENERATOR_ACCESS_TOKEN = 'generator_access_granted';
        const GENERATOR_PASSWORD = CONFIG.GENERATOR_PASSWORD || 'NEXGRID2025'; // SECURITY: Load from config.js
        
        function checkGeneratorAccess() {
            const accessGranted = localStorage.getItem(GENERATOR_ACCESS_TOKEN);
            if (accessGranted === 'true') {
                return true;
            }
            
            // Show password prompt
            const password = prompt('🔐 Generator Access Required\n\nEnter password to access ticket generator:');
            if (password === GENERATOR_PASSWORD) {
                localStorage.setItem(GENERATOR_ACCESS_TOKEN, 'true');
                return true;
            } else if (password !== null) {
                alert('❌ Incorrect password. Access denied.');
            }
            return false;
        }
        
        // Protect main generator page - only allow access via QR codes (mode=view or mode=fill/edit) OR with password
        if (!currentMode) {
            // No mode parameter means direct access to generator - require password
            if (!checkGeneratorAccess()) {
                document.body.innerHTML = `
                    <div style="display: flex; justify-content: center; align-items: center; min-height: 100vh; background: #f7fafc; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                        <div style="text-align: center; padding: 40px; background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 500px;">
                            <h1 style="color: #e53e3e; margin-bottom: 20px;">⚠️ Access Denied</h1>
                            <p style="color: #4a5568; font-size: 16px; line-height: 1.6;">
                                Generator access is restricted to authorized devices only. Please scan a ticket QR code to view or edit ticket details.
                            </p>
                            <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                                <p style="color: #718096; font-size: 12px; font-weight: 500; letter-spacing: 0.5px;">
                                    Powered by <strong style="color: #667eea; font-weight: 700;">NexGridCore DataLabs</strong>
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            }
            // If access granted, continue with normal page load (generator will show)
        } else if (currentMode === 'view') {
            initViewMode(initialSerialParam);
        } else if (currentMode === 'edit' || currentMode === 'fill') {
            initFillMode(initialSerialParam);
        }

        function formatSerial(serialNumber) {
            return `FG-${SERIES_PREFIX}-${String(serialNumber).padStart(5, '0')}`;
        }

        function updateSerialDisplay() {
            const formatted = formatSerial(currentSerial);
            const nextSerialEl = document.getElementById('nextSerial');
            if (nextSerialEl) {
                nextSerialEl.textContent = formatted;
            }
        }

        function resetSerial() {
            // Require password validation
            const password = prompt('🔐 Serial Reset - Password Required\n\nEnter password to reset serial number:');
            if (password !== GENERATOR_PASSWORD) {
                if (password !== null) {
                    alert('❌ Incorrect password. Reset cancelled.');
                }
                return;
            }

            // Prompt for new serial number
            const newSerialInput = prompt(`🔢 Reset Serial Number\n\nCurrent serial: ${formatSerial(currentSerial)}\n\nEnter the serial number to reset to (e.g., 1085):`);
            
            if (newSerialInput === null) {
                // User cancelled
                return;
            }

            // Validate input
            const newSerial = parseInt(newSerialInput, 10);
            if (isNaN(newSerial) || newSerial < 1) {
                alert('❌ Invalid serial number. Please enter a positive number.');
                return;
            }

            // Confirm reset
            const confirmReset = confirm(`⚠️ Confirm Serial Reset\n\nCurrent: ${formatSerial(currentSerial)}\nNew: ${formatSerial(newSerial)}\n\nThis action cannot be undone. Continue?`);
            
            if (!confirmReset) {
                return;
            }

            // Perform reset
            currentSerial = newSerial;
            localStorage.setItem('bandingSerial', currentSerial);
            updateSerialDisplay();
            
            alert(`✅ Serial number reset successfully!\n\nNew serial: ${formatSerial(currentSerial)}`);
        }

        function generateTickets() {
            const ticketCount = parseInt(document.getElementById('ticketCount').value, 10);
            
            if (ticketCount % 4 !== 0) {
                showToast('Number of tickets must be a multiple of 4', 'warning');
                return;
            }

            const container = document.getElementById('printContainer');
            const generateBtn = document.querySelector('.btn-generate[onclick="generateTickets()"]');
            const originalBtnText = generateBtn ? generateBtn.innerHTML : '';
            
            // Show loading state on button only (not in container to avoid breaking layout)
            if (generateBtn) {
                generateBtn.disabled = true;
                generateBtn.innerHTML = '⏳ Generating Tickets...';
                generateBtn.style.opacity = '0.7';
            }
            
            // Clear container immediately without loading message (to maintain 8 tickets per page)
            container.innerHTML = '';

            const ticketsPerPage = 4;
            const pages = Math.ceil(ticketCount / ticketsPerPage);

            for (let page = 0; page < pages; page++) {
                const pageDiv = document.createElement('div');
                pageDiv.className = 'page';

                const ticketsOnThisPage = Math.min(ticketsPerPage, ticketCount - (page * ticketsPerPage));
                
                for (let i = 0; i < ticketsOnThisPage; i++) {
                    const serialNum = currentSerial + (page * ticketsPerPage) + i;

                    const rowDiv = document.createElement('div');
                    rowDiv.className = 'ticket-row';

                    rowDiv.innerHTML += createTicketHTML(serialNum, selectedColor, false, {}, 'view');
                    rowDiv.innerHTML += createTicketHTML(serialNum, selectedColor, true, {}, 'edit');

                    pageDiv.appendChild(rowDiv);
                }

                container.appendChild(pageDiv);
            }

            // Restore button state
            if (generateBtn) {
                generateBtn.disabled = false;
                generateBtn.innerHTML = originalBtnText;
                generateBtn.style.opacity = '1';
            }
            
            renderTicketQRCodes(container);

            // Show print dialog
            setTimeout(() => {
                window.print();
                
                // Increment serial AFTER print dialog is shown
                setTimeout(() => {
                    const confirmPrint = confirm('Did you complete printing the tickets?\n\nClick OK if you printed successfully.\nClick Cancel if you cancelled the print (serial will not increment).');
                    
                    if (confirmPrint) {
                        const startSerial = formatSerial(currentSerial);
                        const endSerial = formatSerial(currentSerial + ticketCount - 1);
                        
                        currentSerial += ticketCount;
                        localStorage.setItem('bandingSerial', currentSerial);
                        updateSerialDisplay();
                        
                        // Show elegant success popup
                        showSuccessPopup({
                            title: '✅ Print Successful!',
                            message: `
                                <div style="text-align: left; line-height: 1.8;">
                                    <div style="margin-bottom: 16px; padding: 14px; background: rgba(245, 158, 11, 0.1); border-radius: 10px; border-left: 4px solid #f59e0b;">
                                        <strong style="color: #fbbf24; font-size: 16px;">📊 Print Summary</strong>
                                    </div>
                                    
                                    <div style="margin-bottom: 12px;">
                                        <strong style="color: #fbbf24;">Tickets Printed:</strong> 
                                        <span style="color: #fff; font-size: 18px; font-weight: 700;">${ticketCount} tickets</span>
                                    </div>
                                    
                                    <div style="margin-bottom: 12px;">
                                        <strong style="color: #fbbf24;">Color:</strong> 
                                        <span style="color: #fff; font-weight: 600; text-transform: uppercase;">${selectedColor}</span>
                                    </div>
                                    
                                    <div style="margin-bottom: 12px;">
                                        <strong style="color: #fbbf24;">Serial Range:</strong> 
                                        <span style="color: #fff; font-family: 'Courier New', monospace; font-weight: 600;">${startSerial} → ${endSerial}</span>
                                    </div>
                                    
                                    <div style="margin-top: 20px; padding: 16px; background: rgba(245, 158, 11, 0.15); border-radius: 10px; border: 2px solid rgba(245, 158, 11, 0.4);">
                                        <strong style="color: #fbbf24; font-size: 15px;">🎯 Next Serial Number:</strong><br>
                                        <span style="color: #fcd34d; font-size: 24px; font-weight: 800; font-family: 'Courier New', monospace; letter-spacing: 2px;">${formatSerial(currentSerial)}</span>
                                    </div>
                                </div>
                            `
                        });
                    } else {
                        showToast('Print cancelled. Serial counter NOT updated. Current serial: ' + formatSerial(currentSerial), 'warning', 5000);
                    }
                }, 500);
            }, 100);
        }

        async function generateAllColorTicketsPDF() {
            if (typeof html2canvas === 'undefined' || typeof window.jspdf === 'undefined') {
                showToast('PDF libraries not loaded. Please refresh the page.', 'error');
                return;
            }

            const ticketCount = 52;
            const colors = ['red', 'blue', 'green', 'yellow'];
            const ticketsPerPage = 4; // 4 ticket pairs per page (8 tickets total)
            
            // Show loading message
            const originalButton = event.target;
            const originalText = originalButton.innerHTML;
            originalButton.innerHTML = '⏳ Generating PDF...';
            originalButton.disabled = true;

            try {
                const container = document.getElementById('printContainer');
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: rgba(251, 191, 36, 0.9);"><div class="loading-spinner"></div><p style="margin-top: 20px; font-weight: 600;">Generating PDF tickets...</p><p style="margin-top: 10px; font-size: 13px; opacity: 0.8;">This may take a moment for large batches</p></div>';
                container.style.display = 'block';

                // Generate all tickets: 52 serials per color × 4 colors = 208 unique serials total
                // Serial 1-52: RED
                // Serial 53-104: GREEN
                // Serial 105-156: BLUE
                // Serial 157-208: YELLOW
                let allTicketPairs = [];
                
                // Generate 52 serials for each color (208 total unique serials)
                colors.forEach((color, colorIndex) => {
                    for (let ticketNum = 0; ticketNum < ticketCount; ticketNum++) {
                        const serialNum = currentSerial + (colorIndex * ticketCount) + ticketNum;
                        allTicketPairs.push({
                            serial: serialNum,
                            color: color
                        });
                    }
                });

                // Group into pages: 4 ticket pairs per page (each pair = view + edit)
                const pairsPerPage = 4;
                const totalPagesCount = Math.ceil(allTicketPairs.length / pairsPerPage);

                // Create pages in the container
                for (let pageIdx = 0; pageIdx < totalPagesCount; pageIdx++) {
                    const pageDiv = document.createElement('div');
                    pageDiv.className = 'page';
                    pageDiv.style.width = '210mm';
                    pageDiv.style.height = '297mm';
                    pageDiv.style.pageBreakAfter = 'always';

                    const startIdx = pageIdx * pairsPerPage;
                    const endIdx = Math.min(startIdx + pairsPerPage, allTicketPairs.length);
                    const pairsOnPage = allTicketPairs.slice(startIdx, endIdx);

                    // Create a row for each ticket pair (view + edit)
                    pairsOnPage.forEach(ticket => {
                        const rowDiv = document.createElement('div');
                        rowDiv.className = 'ticket-row';
                        rowDiv.innerHTML += createTicketHTML(ticket.serial, ticket.color, false, {}, 'view');
                        rowDiv.innerHTML += createTicketHTML(ticket.serial, ticket.color, true, {}, 'edit');
                        pageDiv.appendChild(rowDiv);
                    });

                    container.appendChild(pageDiv);
                }

                // Render QR codes
                await new Promise((resolve) => {
                    renderTicketQRCodes(container);
                    // Wait for QR codes to render (they're async)
                    setTimeout(resolve, 2000);
                });

                // Initialize PDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                const pageWidth = 210; // A4 width in mm
                const pageHeight = 297; // A4 height in mm

                // Get all pages
                const pages = Array.from(container.querySelectorAll('.page'));
                const totalPages = pages.length;
                
                // Optimized: Process and add pages incrementally to avoid memory issues
                const BATCH_SIZE = 2; // Process 2 pages at a time to reduce memory usage
                
                originalButton.innerHTML = `⏳ Rendering ${totalPages} pages (optimized)...`;

                // Process pages in batches and add to PDF incrementally
                for (let batchStart = 0; batchStart < totalPages; batchStart += BATCH_SIZE) {
                    const batchEnd = Math.min(batchStart + BATCH_SIZE, totalPages);
                    const batch = pages.slice(batchStart, batchEnd);
                    
                    // Update progress
                    originalButton.innerHTML = `⏳ Rendering pages ${batchStart + 1}-${batchEnd} of ${totalPages}...`;
                    
                    // Process batch in parallel
                    const batchPromises = batch.map((pageElement, batchIdx) => {
                        return html2canvas(pageElement, {
                            scale: 1.2, // Reduced scale to prevent memory issues
                            backgroundColor: '#ffffff',
                            useCORS: true,
                            logging: false,
                            width: pageElement.scrollWidth,
                            height: pageElement.scrollHeight,
                            removeContainer: false,
                            allowTaint: false
                        }).then(canvas => {
                            // Use JPEG with compression instead of PNG to reduce size
                            const imgData = canvas.toDataURL('image/jpeg', 0.85); // JPEG at 85% quality
                            return {
                                index: batchStart + batchIdx,
                                data: imgData,
                                width: pageWidth,
                                height: (canvas.height * pageWidth) / canvas.width
                            };
                        });
                    });
                    
                    // Wait for batch to complete
                    const batchResults = await Promise.all(batchPromises);
                    
                    // Sort batch by index
                    batchResults.sort((a, b) => a.index - b.index);
                    
                    // Add pages to PDF immediately (incremental approach)
                    originalButton.innerHTML = `⏳ Adding pages ${batchStart + 1}-${batchEnd} to PDF...`;
                    batchResults.forEach((pageImg, batchIdx) => {
                        const pageIndex = batchStart + batchIdx;
                        if (pageIndex > 0) {
                            pdf.addPage();
                        }
                        // Use JPEG format
                        pdf.addImage(pageImg.data, 'JPEG', 0, 0, pageImg.width, pageImg.height, undefined, 'FAST');
                    });
                    
                    // Clear batch results from memory
                    batchResults.length = 0;
                }

                // Download PDF
                const fileName = `Banding_Tickets_${ticketCount}_AllColors_${new Date().toISOString().split('T')[0]}.pdf`;
                pdf.save(fileName);

                // Increment serial AFTER successful PDF download
                setTimeout(() => {
                    const confirmDownload = confirm('Did the PDF download successfully?\n\nClick OK if you received the PDF.\nClick Cancel if the download failed (serial will not increment).');
                    
                    if (confirmDownload) {
                        const totalTickets = ticketCount * colors.length;
                        const startSerial = formatSerial(currentSerial);
                        const endSerial = formatSerial(currentSerial + totalTickets - 1);
                        
                        // Update serial number (ticketCount × 4 colors = total unique serials used)
                        currentSerial += totalTickets;
                        localStorage.setItem('bandingSerial', currentSerial);
                        updateSerialDisplay();
                        
                        // Show elegant success popup
                        showSuccessPopup({
                            title: '✅ PDF Download Successful!',
                            message: `
                                <div style="text-align: left; line-height: 1.8;">
                                    <div style="margin-bottom: 16px; padding: 14px; background: rgba(245, 158, 11, 0.1); border-radius: 10px; border-left: 4px solid #f59e0b;">
                                        <strong style="color: #fbbf24; font-size: 16px;">📊 Download Summary</strong>
                                    </div>
                                    
                                    <div style="margin-bottom: 12px;">
                                        <strong style="color: #fbbf24;">Total Tickets:</strong> 
                                        <span style="color: #fff; font-size: 18px; font-weight: 700;">${totalTickets} tickets</span>
                                    </div>
                                    
                                    <div style="margin-bottom: 12px;">
                                        <strong style="color: #fbbf24;">Breakdown:</strong> 
                                        <span style="color: #fff; font-weight: 600;">${ticketCount} × 4 colors (RED, GREEN, BLUE, YELLOW)</span>
                                    </div>
                                    
                                    <div style="margin-bottom: 12px;">
                                        <strong style="color: #fbbf24;">Serial Range:</strong> 
                                        <span style="color: #fff; font-family: 'Courier New', monospace; font-weight: 600;">${startSerial} → ${endSerial}</span>
                                    </div>
                                    
                                    <div style="margin-bottom: 12px;">
                                        <strong style="color: #fbbf24;">File Name:</strong> 
                                        <span style="color: #fff; font-size: 13px; font-weight: 500;">${fileName}</span>
                                    </div>
                                    
                                    <div style="margin-top: 20px; padding: 16px; background: rgba(245, 158, 11, 0.15); border-radius: 10px; border: 2px solid rgba(245, 158, 11, 0.4);">
                                        <strong style="color: #fbbf24; font-size: 15px;">🎯 Next Serial Number:</strong><br>
                                        <span style="color: #fcd34d; font-size: 24px; font-weight: 800; font-family: 'Courier New', monospace; letter-spacing: 2px;">${formatSerial(currentSerial)}</span>
                                    </div>
                                </div>
                            `
                        });
                    } else {
                        showToast('Download failed. Serial counter NOT updated. Current serial: ' + formatSerial(currentSerial), 'warning', 5000);
                    }
                }, 500);

                // Hide container
                container.style.display = 'none';
                container.innerHTML = '';

                originalButton.innerHTML = originalText;
                originalButton.disabled = false;

                const firstSerial = formatSerial(currentSerial - (ticketCount * colors.length));
                const lastSerial = formatSerial(currentSerial - 1);
                alert(`✅ PDF generated successfully!\n\n${ticketCount} serials per color × 4 colors = ${allTicketPairs.length} unique serials total\n${totalPages} pages generated\n\nSerial ranges:\n• ${firstSerial} to ${formatSerial(currentSerial - (ticketCount * 3) - 1)}: RED\n• ${formatSerial(currentSerial - (ticketCount * 3))} to ${formatSerial(currentSerial - (ticketCount * 2) - 1)}: GREEN\n• ${formatSerial(currentSerial - (ticketCount * 2))} to ${formatSerial(currentSerial - ticketCount - 1)}: BLUE\n• ${formatSerial(currentSerial - ticketCount)} to ${lastSerial}: YELLOW\n\nFile: ${fileName}`);
            } catch (error) {
                console.error('Error generating PDF:', error);
                showToast('Error generating PDF: ' + error.message, 'error', 6000);
                originalButton.innerHTML = originalText;
                originalButton.disabled = false;
            }
        }

        function buildScanUrl(serial, mode = 'edit', color = 'blue') {
            // Ensure SCAN_BASE_URL is always set
            if (!SCAN_BASE_URL || SCAN_BASE_URL === '') {
                const { protocol, origin, pathname } = window.location;
                // If file:// protocol, use default URL
                if (protocol === 'file:') {
                    SCAN_BASE_URL = DEFAULT_SCAN_BASE_URL;
                } else {
                    SCAN_BASE_URL = `${origin}${pathname}`;
                }
            }
            // Remove any existing query parameters from base URL
            const baseUrl = SCAN_BASE_URL.split('?')[0];
            const url = `${baseUrl}?mode=${mode}&serial=${encodeURIComponent(serial)}&color=${encodeURIComponent(color)}`;
            console.log(`🔗 Generated QR URL for ${serial}: ${url}`);
            return url;
        }
        
        function formatTimestamp(timestampStr) {
            if (!timestampStr) return '';
            try {
                const date = new Date(timestampStr);
                if (isNaN(date.getTime())) return timestampStr;
                
                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                
                const dayName = days[date.getDay()];
                const day = date.getDate();
                const month = months[date.getMonth()];
                const year = date.getFullYear();
                
                // Get ordinal suffix (1st, 2nd, 3rd, 4th, etc.)
                const getOrdinal = (n) => {
                    const s = ['th', 'st', 'nd', 'rd'];
                    const v = n % 100;
                    return n + (s[(v - 20) % 10] || s[v] || s[0]);
                };
                
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                
                return `${dayName} ${getOrdinal(day)} ${month}, ${year} ${hours}${minutes}HRS`;
            } catch (e) {
                return timestampStr;
            }
        }
        
        function formatDateAndTime(dateStr, timeStr) {
            if (!dateStr) return 'N/A';
            try {
                // Handle time - could be Date object, string in various formats
                let normalizedTime = '';
                let hours = 0;
                let minutes = 0;
                let hasValidTime = false;
                
                if (timeStr) {
                    // If it's a Date object, extract hours and minutes
                    if (timeStr instanceof Date) {
                        hours = timeStr.getHours();
                        minutes = timeStr.getMinutes();
                        hasValidTime = hours !== 0 || minutes !== 0;
                        normalizedTime = String(hours).padStart(2, '0') + ':' + String(minutes).padStart(2, '0');
                    } else {
                        // It's a string - normalize it
                        normalizedTime = (timeStr || '').toString().trim();
                        
                        // Handle 24-hour format: could be "0024", "00:24", "14:30", "1430", etc.
                        if (normalizedTime.length === 4 && !normalizedTime.includes(':')) {
                            // Format: "0024" (4 digits, no colon)
                            hours = parseInt(normalizedTime.substring(0, 2), 10) || 0;
                            minutes = parseInt(normalizedTime.substring(2, 4), 10) || 0;
                            normalizedTime = String(hours).padStart(2, '0') + ':' + String(minutes).padStart(2, '0');
                        } else if (normalizedTime.includes(':')) {
                            // Format: "00:24" or "14:30"
                            const timeParts = normalizedTime.split(':');
                            hours = parseInt(timeParts[0], 10) || 0;
                            minutes = parseInt(timeParts[1], 10) || 0;
                        } else {
                            // Try to parse as number or other format
                            const numTime = parseInt(normalizedTime, 10);
                            if (!isNaN(numTime) && numTime >= 0 && numTime < 2400) {
                                hours = Math.floor(numTime / 100);
                                minutes = numTime % 100;
                                normalizedTime = String(hours).padStart(2, '0') + ':' + String(minutes).padStart(2, '0');
                            }
                        }
                        
                        // Check if time is valid (not midnight)
                        hasValidTime = normalizedTime !== '' && 
                                      normalizedTime !== '00:00' && 
                                      normalizedTime !== '0:00' && 
                                      (hours !== 0 || minutes !== 0);
                    }
                }
                
                // Try to parse date (could be YYYY-MM-DD or other formats)
                let date;
                
                // First, try to parse as YYYY-MM-DD format explicitly (most common from Google Sheets)
                if (typeof dateStr === 'string' && dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    // Explicit YYYY-MM-DD format - parse directly to avoid timezone issues
                    const dateParts = dateStr.split('-');
                    const year = parseInt(dateParts[0], 10);
                    const month = parseInt(dateParts[1], 10) - 1; // Month is 0-indexed
                    const day = parseInt(dateParts[2], 10);
                    
                    if (hasValidTime) {
                        date = new Date(year, month, day, hours, minutes);
                    } else {
                        date = new Date(year, month, day);
                    }
                } else if (dateStr instanceof Date) {
                    date = new Date(dateStr);
                    if (hasValidTime) {
                        date.setHours(hours, minutes, 0, 0);
                    }
                } else if (typeof dateStr === 'string' && (dateStr.includes('T') || dateStr.includes(' '))) {
                    // ISO format or date-time string - be careful with timezone
                    // Try to extract YYYY-MM-DD part first
                    const dateMatch = dateStr.match(/^(\d{4}-\d{2}-\d{2})/);
                    if (dateMatch) {
                        const dateParts = dateMatch[1].split('-');
                        const year = parseInt(dateParts[0], 10);
                        const month = parseInt(dateParts[1], 10) - 1;
                        const day = parseInt(dateParts[2], 10);
                        
                        if (hasValidTime) {
                            date = new Date(year, month, day, hours, minutes);
                        } else {
                            date = new Date(year, month, day);
                        }
                    } else {
                        // Fallback to Date constructor
                        date = new Date(dateStr);
                        if (hasValidTime && !isNaN(date.getTime())) {
                            date.setHours(hours, minutes, 0, 0);
                        }
                    }
                } else if (typeof dateStr === 'string') {
                    // Try to parse as YYYY-MM-DD format
                    const dateParts = dateStr.split('-');
                    if (dateParts.length === 3) {
                        const year = parseInt(dateParts[0], 10);
                        const month = parseInt(dateParts[1], 10) - 1;
                        const day = parseInt(dateParts[2], 10);
                        
                        if (!isNaN(year) && !isNaN(month) && !isNaN(day)) {
                            if (hasValidTime) {
                                date = new Date(year, month, day, hours, minutes);
                            } else {
                                date = new Date(year, month, day);
                            }
                        } else {
                            // Fallback
                            date = new Date(dateStr);
                        }
                    } else {
                        // Fallback
                        date = new Date(dateStr);
                    }
                } else {
                    // Fallback
                    date = new Date(dateStr);
                }
                
                if (isNaN(date.getTime())) {
                    // If parsing failed, return formatted date string if possible
                    if (dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                        const [year, month, day] = dateStr.split('-').map(Number);
                        const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                        const tempDate = new Date(year, month - 1, day);
                        if (!isNaN(tempDate.getTime())) {
                            const dayName = days[tempDate.getDay()];
                            const getOrdinal = (n) => {
                                const s = ['th', 'st', 'nd', 'rd'];
                                const v = n % 100;
                                return n + (s[(v - 20) % 10] || s[v] || s[0]);
                            };
                            return `${dayName} ${getOrdinal(day)} ${months[month - 1]}, ${year}`;
                        }
                    }
                    return dateStr + (hasValidTime ? ' ' + normalizedTime : '');
                }
                
                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                
                const dayName = days[date.getDay()];
                const day = date.getDate();
                const month = months[date.getMonth()];
                const year = date.getFullYear();
                
                const getOrdinal = (n) => {
                    const s = ['th', 'st', 'nd', 'rd'];
                    const v = n % 100;
                    return n + (s[(v - 20) % 10] || s[v] || s[0]);
                };
                
                // Only show time if it's valid and not midnight (00:00)
                if (hasValidTime && date.getHours() !== 0 || date.getMinutes() !== 0) {
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    return `${dayName} ${getOrdinal(day)} ${month}, ${year} ${hours}${minutes}HRS`;
                } else {
                    // Just show date without time
                    return `${dayName} ${getOrdinal(day)} ${month}, ${year}`;
                }
            } catch (e) {
                console.error('Error formatting date/time:', e, 'dateStr:', dateStr, 'timeStr:', timeStr);
                const normalizedTime = (timeStr || '').toString().trim();
                const hasValidTime = normalizedTime !== '' && normalizedTime !== '00:00' && normalizedTime !== '0:00';
                return dateStr + (hasValidTime ? ' ' + normalizedTime : '');
            }
        }
        
        function formatChangeHistory(changeHistory) {
            if (!changeHistory) return '';
            // Change history format: "2025-10-11T10:24:00Z - User: Updated ticket\n..." or "2025-10-11T10:24:00.000Z - User: Updated ticket\n..."
            const lines = changeHistory.split('\n');
            return lines.map(line => {
                if (!line.trim()) return line;
                
                // Try multiple timestamp patterns
                // Pattern 1: ISO with milliseconds: 2025-10-11T10:24:00.000Z
                let timestampMatch = line.match(/(\d{4}-\d{2}-\d{2}[T ]\d{2}:\d{2}:\d{2}\.\d{3}Z?)/);
                if (timestampMatch) {
                    const timestamp = timestampMatch[1];
                    const formatted = formatTimestamp(timestamp);
                    return line.replace(timestamp, formatted);
                }
                
                // Pattern 2: ISO without milliseconds: 2025-10-11T10:24:00Z
                timestampMatch = line.match(/(\d{4}-\d{2}-\d{2}[T ]\d{2}:\d{2}:\d{2}Z?)/);
                if (timestampMatch) {
                    const timestamp = timestampMatch[1];
                    const formatted = formatTimestamp(timestamp);
                    return line.replace(timestamp, formatted);
                }
                
                // Pattern 3: Date only: 2025-10-11
                timestampMatch = line.match(/(\d{4}-\d{2}-\d{2})(?![T ])/);
                if (timestampMatch) {
                    const dateStr = timestampMatch[1];
                    // Try to format as date
                    try {
                        const [year, month, day] = dateStr.split('-').map(Number);
                        const date = new Date(year, month - 1, day);
                        if (!isNaN(date.getTime())) {
                            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                            const dayName = days[date.getDay()];
                            const getOrdinal = (n) => {
                                const s = ['th', 'st', 'nd', 'rd'];
                                const v = n % 100;
                                return n + (s[(v - 20) % 10] || s[v] || s[0]);
                            };
                            const formatted = `${dayName} ${getOrdinal(day)} ${months[month - 1]}, ${year}`;
                            return line.replace(dateStr, formatted);
                        }
                    } catch (e) {
                        // If formatting fails, return line as-is
                    }
                }
                
                return line;
            }).join('\n');
        }

        // OPTIMIZED: Batch QR code rendering for better performance
        function renderTicketQRCodes(rootElement = document) {
            if (typeof QRCode === 'undefined') {
                console.error('❌ QRCode library not loaded!');
                return;
            }
            const elements = Array.from(rootElement.querySelectorAll('.ticket-qr'));
            const totalElements = elements.length;
            console.log(`📱 Rendering ${totalElements} QR codes (batched for performance)...`);
            
            if (totalElements === 0) return;
            
            // Show loading indicator
            elements.forEach(container => {
                if (!container.querySelector('.qr-loading')) {
                    const loadingDiv = document.createElement('div');
                    loadingDiv.className = 'qr-loading';
                    loadingDiv.style.cssText = 'display: flex; align-items: center; justify-content: center; height: 100%; color: rgba(251, 191, 36, 0.6); font-size: 10px;';
                    loadingDiv.textContent = '⏳';
                    container.innerHTML = '';
                    container.appendChild(loadingDiv);
                }
            });
            
            // Batch processing configuration
            const BATCH_SIZE = 10; // Process 10 QR codes per frame
            let currentIndex = 0;
            let completedCount = 0;
            
            function processBatch() {
                const batchEnd = Math.min(currentIndex + BATCH_SIZE, totalElements);
                const batch = elements.slice(currentIndex, batchEnd);
                
                batch.forEach(container => {
                    const serial = container.dataset.serial;
                    const isDuplicate = container.dataset.duplicate === 'true';
                    const ticketColor = container.dataset.color || 'blue';
                    
                    if (!serial) {
                        console.warn('⚠️ Missing serial number for QR code');
                        container.innerHTML = '<span style="color: #fca5a5; font-size: 10px;">ERROR</span>';
                        completedCount++;
                        return;
                    }
                    
                    const mode = container.dataset.mode || (isDuplicate ? 'edit' : 'view');
                    const link = buildScanUrl(serial, mode, ticketColor);
                    
                    if (!link || link === '') {
                        console.error(`❌ Failed to generate URL for serial ${serial}`);
                        container.innerHTML = '<span style="color: #fca5a5; font-size: 10px;">QR ERROR</span>';
                        completedCount++;
                        return;
                    }
                    
                    const canvas = document.createElement('canvas');
                    QRCode.toCanvas(canvas, link, {
                        width: 140,
                        margin: 0,
                        color: {
                            dark: '#1a202c',
                            light: '#ffffff'
                        }
                    }, (error) => {
                        completedCount++;
                        if (error) {
                            console.error(`❌ QR code generation failed for ${serial}:`, error);
                            container.innerHTML = '<span style="color: #fca5a5; font-size: 10px;">ERROR</span>';
                            return;
                        }
                        canvas.style.width = '100%';
                        canvas.style.height = '100%';
                        container.innerHTML = '';
                        container.appendChild(canvas);
                        container.title = `Scan to ${mode === 'view' ? 'view' : 'edit'} ${serial}`;
                    });
                });
                
                currentIndex = batchEnd;
                
                // Continue with next batch if there are more elements
                if (currentIndex < totalElements) {
                    requestAnimationFrame(processBatch);
                } else if (completedCount === totalElements) {
                    console.log(`✅ All ${totalElements} QR codes rendered successfully`);
                }
            }
            
            // Start batch processing
            requestAnimationFrame(processBatch);
        }

        function createTicketHTML(serialNum, color, isDuplicate, data = {}, qrMode = 'edit') {
            const serialValue = typeof serialNum === 'number' ? formatSerial(serialNum) : (serialNum || '');
            const ticketColor = data.color || color;
            const duplicateBadge = isDuplicate ? '<span class="duplicate-label">DUPLICATE</span>' : '';
            const bandingSelections = new Set((data.bandingType || []).map(value => value.toLowerCase()));
            const productSelections = new Set((data.productType || []).map(value => value.toLowerCase()));
            const palletSelections = new Set((data.palletSize || []).map(value => value.toLowerCase()));

            const renderFieldValue = (value) => {
                const content = value !== undefined && value !== null && value !== ''
                    ? escapeHtml(String(value))
                    : '';
                const filledClass = content ? ' filled' : '';
                return `<span class="field-value${filledClass}">${content ? `<span>${content}</span>` : ''}</span>`;
            };

            return `
                <div class="ticket-column">
                    <div class="ticket ${ticketColor} ${isDuplicate ? 'duplicate' : ''}">
                            <div class="ticket-header">Promotion Items · Finished Goods</div>
                        <div class="serial-wrapper">
                            <div class="serial-number">
                                <span>${serialValue}</span>
                                ${duplicateBadge}
                        </div>
                            <div class="ticket-qr" data-serial="${serialValue}" data-duplicate="${isDuplicate}" data-mode="${qrMode}" data-color="${ticketColor}"></div>
                        </div>
                        <div class="ticket-body">
                            <div class="field-row">
                                <div class="field-group">
                                    <span class="field-label">Date:</span>
                                    ${renderFieldValue(data.date)}
                                </div>
                                <div class="field-group">
                                    <span class="field-label">Time:</span>
                                    ${renderFieldValue(data.time)}
                                </div>
                            </div>
                            
                            <div class="field-row">
                                <div class="field-group">
                                    <span class="field-label">SKU:</span>
                                    ${renderFieldValue(data.sku)}
                                </div>
                            </div>
                            
                            <div class="field-row">
                                <div class="field-group">
                                    <span class="field-label">Qty:</span>
                                    ${renderFieldValue(data.qty)}
                                </div>
                                <div class="field-group">
                                    <span class="field-label">Layers:</span>
                                    ${renderFieldValue(data.layers)}
                                </div>
                            </div>
                            <div class="checkbox-columns">
                                <div class="checkbox-column">
                                    <div class="checkbox-column-title">Banding Type</div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="online_${serialNum}_${isDuplicate}" ${bandingSelections.has('online') ? 'checked' : ''}>
                                        <label for="online_${serialNum}_${isDuplicate}">Online</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="offline_${serialNum}_${isDuplicate}" ${bandingSelections.has('offline') ? 'checked' : ''}>
                                        <label for="offline_${serialNum}_${isDuplicate}">Offline</label>
                                    </div>
                                </div>
                                <div class="checkbox-column">
                                    <div class="checkbox-column-title">Product Type</div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="fg1_${serialNum}_${isDuplicate}" ${productSelections.has('1kg') ? 'checked' : ''}>
                                        <label for="fg1_${serialNum}_${isDuplicate}">1kg</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="fg05_${serialNum}_${isDuplicate}" ${productSelections.has('0.5kg') || productSelections.has('05kg') ? 'checked' : ''}>
                                        <label for="fg05_${serialNum}_${isDuplicate}">0.5kg</label>
                                    </div>
                                </div>
                                <div class="checkbox-column pallet">
                                    <div class="checkbox-column-title">Pallet Size</div>
                                    <div class="checkbox-items">
                                    <div class="checkbox-item">
                                            <input type="checkbox" id="p78_${serialNum}_${isDuplicate}" ${palletSelections.has('78') ? 'checked' : ''}>
                                        <label for="p78_${serialNum}_${isDuplicate}">78</label>
                                    </div>
                                    <div class="checkbox-item">
                                            <input type="checkbox" id="p105_${serialNum}_${isDuplicate}" ${palletSelections.has('105') ? 'checked' : ''}>
                                        <label for="p105_${serialNum}_${isDuplicate}">105</label>
                                    </div>
                                    <div class="checkbox-item">
                                            <input type="checkbox" id="p64_${serialNum}_${isDuplicate}" ${palletSelections.has('64') ? 'checked' : ''}>
                                        <label for="p64_${serialNum}_${isDuplicate}">64</label>
                                    </div>
                                    <div class="checkbox-item">
                                            <input type="checkbox" id="p100_${serialNum}_${isDuplicate}" ${palletSelections.has('100') ? 'checked' : ''}>
                                        <label for="p100_${serialNum}_${isDuplicate}">100</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="ticket-footer">Powered by NexGridCore DataLabs</div>
                    </div>
                </div>
            `;
        }

        // Google Sheets API Functions - Using Apps Script with CACHING
        async function readTicketFromSheet(serial, useCache = true) {
            if (!GOOGLE_APPS_SCRIPT_URL) {
                throw new Error('Google Apps Script URL not configured');
            }
            
            // Check cache first
            const cacheKey = `ticket_${serial}`;
            if (useCache) {
                const cached = getCachedRequest(cacheKey);
                if (cached !== null) {
                    console.log(`📦 Cache hit for ticket: ${serial}`);
                    return cached;
                }
            }
            
            try {
                const url = `${GOOGLE_APPS_SCRIPT_URL}?action=read&serial=${encodeURIComponent(serial)}`;
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Failed to read ticket: ${response.statusText}`);
                }
                const result = await response.json();
                if (!result.success) {
                    // If ticket not found, return null instead of throwing error
                    if (result.error && result.error.includes('not found')) {
                        return null;
                    }
                    throw new Error(result.error || 'Failed to read ticket');
                }
                if (!result.data) {
                    return null;
                }
                
                const ticket = result.data;
                if (result.pallet) {
                    ticket.pallet = result.pallet;
                }
                
                // Normalize field names - handle case variations and ensure Date/Time are correctly mapped
                // Google Sheets might return headers with different casing
                const normalizedTicket = {};
                
                // First, copy all original fields
                Object.keys(ticket).forEach(key => {
                    normalizedTicket[key] = ticket[key];
                });
                
                // Then normalize specific fields we need
                Object.keys(ticket).forEach(key => {
                    const normalizedKey = key.toLowerCase().trim();
                    
                    // Map Date field (column B) - try all variations
                    if (normalizedKey === 'date') {
                        normalizedTicket.Date = ticket[key];
                    }
                    // Map Time field (column C) - try all variations
                    else if (normalizedKey === 'time') {
                        normalizedTicket.Time = ticket[key];
                    }
                    // Map SachetType and TabletType
                    else if (normalizedKey === 'sachettype' || normalizedKey === 'sachet type') {
                        normalizedTicket.SachetType = ticket[key];
                    } else if (normalizedKey === 'tablettype' || normalizedKey === 'tablet type') {
                        normalizedTicket.TabletType = ticket[key];
                    }
                });
                
                // Ensure Date and Time are accessible with multiple fallbacks
                // Try direct access first, then normalized
                if (!normalizedTicket.Date) {
                    normalizedTicket.Date = ticket.Date || ticket['Date'] || ticket.date || ticket.DATE || '';
                }
                if (!normalizedTicket.Time) {
                    normalizedTicket.Time = ticket.Time || ticket['Time'] || ticket.time || ticket.TIME || '';
                }
                
                // Convert Date and Time from ISO strings to proper format
                // Date comes as ISO string like "2025-11-14T21:00:00.000Z" - extract just the date part
                // Time comes as ISO string like "1899-12-30T18:50:44.000Z" - extract just the time part
                // (1899-12-30 is Excel/Sheets epoch for time-only values)
                if (normalizedTicket.Date) {
                    try {
                        const dateObj = new Date(normalizedTicket.Date);
                        if (!isNaN(dateObj.getTime())) {
                            // Extract YYYY-MM-DD format
                            const year = dateObj.getFullYear();
                            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                            const day = String(dateObj.getDate()).padStart(2, '0');
                            normalizedTicket.Date = `${year}-${month}-${day}`;
                        }
                    } catch (e) {
                        // Silently handle date parsing errors
                    }
                }
                
                if (normalizedTicket.Time) {
                    try {
                        const timeObj = new Date(normalizedTicket.Time);
                        if (!isNaN(timeObj.getTime())) {
                            // Extract HH:MM format (24-hour)
                            const hours = String(timeObj.getHours()).padStart(2, '0');
                            const minutes = String(timeObj.getMinutes()).padStart(2, '0');
                            normalizedTicket.Time = `${hours}:${minutes}`;
                        }
                    } catch (e) {
                        // Silently handle time parsing errors
                    }
                }
                
                // Ensure SachetType and TabletType are accessible
                if (ticket.SachetType !== undefined) normalizedTicket.SachetType = ticket.SachetType;
                if (ticket['Sachet Type'] !== undefined) normalizedTicket.SachetType = ticket['Sachet Type'];
                if (ticket.TabletType !== undefined) normalizedTicket.TabletType = ticket.TabletType;
                if (ticket['Tablet Type'] !== undefined) normalizedTicket.TabletType = ticket['Tablet Type'];
                
                // Parse JSON fields
                if (normalizedTicket.MerchHistory) {
                    try {
                        normalizedTicket.MerchHistory = typeof normalizedTicket.MerchHistory === 'string' ? JSON.parse(normalizedTicket.MerchHistory) : normalizedTicket.MerchHistory;
                    } catch (e) {
                        normalizedTicket.MerchHistory = [];
                    }
                }
                
                // Merge normalized fields back
                Object.assign(ticket, normalizedTicket);
                
                // Cache the result
                if (useCache) {
                    setCachedRequest(cacheKey, ticket);
                    console.log(`💾 Cached ticket: ${serial}`);
                }
                
                return ticket;
            } catch (error) {
                throw error;
            }
        }
        
        async function saveTicketToSheet(ticketData, isUpdate = false, existingTicket = null) {
            if (!GOOGLE_APPS_SCRIPT_URL) {
                throw new Error('Google Apps Script URL not configured');
            }
            
            // Clear cache for this ticket after save
            const serial = ticketData.serial;
            if (serial) {
                clearCache(`ticket_${serial}`);
            }
            
            const timestamp = new Date().toISOString();
            const changeEntry = `${timestamp} - ${ticketData.modifiedBy || 'System'}: ${isUpdate ? 'Updated ticket' : 'Created ticket'}`;
            
            // Fix timestamps: CreatedAt, FirstModified, LastModified should be different
            let createdAt, firstModified, lastModified;
            if (isUpdate && existingTicket) {
                // Update: preserve original timestamps, update lastModified
                createdAt = existingTicket.CreatedAt || timestamp;
                // If FirstModified is empty or same as CreatedAt, set it now (first update)
                if (!existingTicket.FirstModified || existingTicket.FirstModified === existingTicket.CreatedAt) {
                    firstModified = timestamp; // First modification
                } else {
                    firstModified = existingTicket.FirstModified; // Preserve original first modification
                }
                lastModified = timestamp; // Always update last modified
            } else {
                // New ticket: all timestamps are the same initially
                createdAt = timestamp;
                firstModified = timestamp; // Will be updated on first modification
                lastModified = timestamp;
            }
            
            const row = [
                ticketData.serial,
                ticketData.date || '',
                ticketData.time || '',
                ticketData.sku || '',
                ticketData.qty || '',
                ticketData.layers || '',
                (ticketData.bandingType || []).join(','),
                (ticketData.productType || []).join(','),
                (ticketData.palletSize || []).join(','),
                ticketData.notes || '',
                ticketData.qualityIssueType || '',
                ticketData.qualityIssueDesc || '',
                ticketData.groupLeader || '',
                ticketData.sachetType || '',
                ticketData.tabletType || '',
                JSON.stringify(ticketData.merchHistory || []),
                createdAt,
                firstModified,
                lastModified,
                isUpdate ? (existingTicket?.ChangeHistory || '') + '\n' + changeEntry : changeEntry,
                ticketData.modifiedBy || 'System'
            ];
            
            try {
                // Use GET requests instead of POST to avoid CORS issues
                // Since GET works, we'll use it for writes too
                const serial = ticketData.serial;
                
                // Build query parameters - include productType and oldQty for calculations
                const oldQty = isUpdate && existingTicket ? (existingTicket.Qty || '0') : '0';
                const productType = (ticketData.productType || []).join(',');
                
                const params = new URLSearchParams({
                    action: isUpdate ? 'update' : 'append',
                    serial: serial,
                    values: JSON.stringify(row),
                    sku: ticketData.sku || '',
                    qty: ticketData.qty || '',
                    oldQty: oldQty,
                    productType: productType
                });
                
                const url = `${GOOGLE_APPS_SCRIPT_URL}?${params.toString()}`;
                console.log('Calling Apps Script with GET:', url.substring(0, 200) + '...');
                
                let response;
                try {
                    response = await fetch(url, {
                        method: 'GET',
                        headers: { 'Accept': 'application/json' }
                    });
                } catch (fetchError) {
                    console.error('Fetch error:', fetchError);
                    throw new Error(`Failed to connect to Apps Script: ${fetchError.message}. Please check:\n1. Apps Script URL is correct\n2. Apps Script is deployed with "Anyone" access\n3. Your internet connection is stable`);
                }
                
                if (!response.ok) {
                    const errorText = await response.text().catch(() => 'Unknown error');
                    throw new Error(`Failed to save: ${response.status} ${response.statusText}. Response: ${errorText.substring(0, 200)}`);
                }
                
                // Get response as text first, then parse
                const responseText = await response.text();
                console.log('Raw response from Apps Script:', responseText);
                console.log('Response length:', responseText.length);
                console.log('Response starts with:', responseText.substring(0, 50));
                
                // Check if Apps Script returned the raw form data (indicates it didn't process)
                if (responseText.startsWith('data=') || responseText.includes('%7B')) {
                    console.error('Apps Script appears to be returning raw request data instead of processing it');
                    throw new Error(`Apps Script error: The script is not processing the request correctly. It returned: "${responseText.substring(0, 100)}". Please check:\n1. Apps Script is deployed as a Web App (not API Executable)\n2. The doPost function exists in your Apps Script\n3. You've updated the Apps Script with the latest code\n4. Check Apps Script execution logs for errors`);
                }
                
                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (parseError) {
                    // If parsing fails, the response might be the form data itself
                    console.error('Failed to parse response as JSON:', parseError);
                    console.error('Full response text:', responseText);
                    throw new Error(`Invalid response from Apps Script. Expected JSON but got: "${responseText.substring(0, 200)}". Please check your Apps Script deployment and code.`);
                }
                
                if (!result.success) {
                    throw new Error(result.error || 'Failed to save ticket');
                }
                
                console.log('Successfully saved to sheet:', result);
                return result;
            } catch (error) {
                console.error('Error saving ticket:', error);
                // Provide more helpful error message
                if (error.message.includes('fetch') || error.message.includes('Failed to fetch')) {
                    throw new Error(`Network error: Failed to connect to Google Apps Script.\n\nPlease check:\n1. Apps Script is deployed with "Anyone, even anonymous" access\n2. The Apps Script URL is correct\n3. Your internet connection is stable\n\nOriginal error: ${error.message}`);
                }
                throw error;
            }
        }
        
        async function testGoogleSheetsConnection() {
            // SECURITY: Require password to test connection
            const password = prompt('🔐 Test Connection - Password Required\n\nEnter password to test Google Sheets connection:');
            if (password !== GENERATOR_PASSWORD) {
                if (password !== null) {
                    alert('❌ Incorrect password. Access denied.');
                }
                return;
            }
            
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = '<div style="color: #667eea;">🔄 Testing connection...</div>';
            
            const tests = [];
            
            // Test 1: Read headers
            try {
                const readUrl = `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_SHEET_ID}/values/Tickets!A1:S1?key=${GOOGLE_API_KEY}`;
                const readResponse = await fetch(readUrl);
                if (readResponse.ok) {
                    const data = await readResponse.json();
                    tests.push({ name: '✅ Read Headers', status: 'success', details: `Found ${data.values?.[0]?.length || 0} columns` });
                } else {
                    const error = await readResponse.json().catch(() => ({}));
                    tests.push({ name: '❌ Read Headers', status: 'error', details: error.error?.message || readResponse.statusText });
                }
            } catch (e) {
                tests.push({ name: '❌ Read Headers', status: 'error', details: e.message });
            }
            
            // Test 2: Write test (append a test row)
            try {
                const testRow = [['TEST-' + Date.now(), new Date().toISOString().split('T')[0], '00:00', 'TEST-SKU', '1', '1', 'online', '1kg', '78', 'Test entry - can be deleted', '', '', '', '[]', new Date().toISOString(), new Date().toISOString(), new Date().toISOString(), 'Test', 'System']];
                const appendUrl = `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_SHEET_ID}/values/Tickets!A2:append?valueInputOption=RAW&insertDataOption=INSERT_ROWS&key=${GOOGLE_API_KEY}`;
                const appendResponse = await fetch(appendUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ values: testRow })
                });
                
                if (appendResponse.ok) {
                    tests.push({ name: '✅ Write Test', status: 'success', details: 'Successfully wrote test row to sheet!' });
                } else {
                    const error = await appendResponse.json().catch(() => ({}));
                    const errorMsg = error.error?.message || appendResponse.statusText;
                    tests.push({ name: '❌ Write Test', status: 'error', details: errorMsg });
                }
            } catch (e) {
                tests.push({ name: '❌ Write Test', status: 'error', details: e.message });
            }
            
            // Test 3: Check sheet sharing
            try {
                const metaUrl = `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_SHEET_ID}?key=${GOOGLE_API_KEY}`;
                const metaResponse = await fetch(metaUrl);
                if (metaResponse.ok) {
                    const meta = await metaResponse.json();
                    tests.push({ name: '✅ Sheet Access', status: 'success', details: `Sheet: "${meta.properties?.title || 'Unknown'}"` });
                } else {
                    tests.push({ name: '❌ Sheet Access', status: 'error', details: 'Cannot access sheet metadata' });
                }
            } catch (e) {
                tests.push({ name: '❌ Sheet Access', status: 'error', details: e.message });
            }
            
            // Display results
            const allPassed = tests.every(t => t.status === 'success');
            resultsDiv.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 10px; color: ${allPassed ? '#10b981' : '#ef4444'};">
                    ${allPassed ? '✅ All Tests Passed!' : '❌ Some Tests Failed'}
                </div>
                ${tests.map(t => `
                    <div style="margin: 5px 0; padding: 8px; background: ${t.status === 'success' ? '#f0fdf4' : '#fef2f2'}; border-left: 3px solid ${t.status === 'success' ? '#10b981' : '#ef4444'};">
                        <strong>${t.name}</strong><br>
                        <small style="color: #666;">${t.details}</small>
                    </div>
                `).join('')}
                ${!allPassed ? `
                    <div style="margin-top: 15px; padding: 10px; background: #fef3c7; border-radius: 5px; font-size: 11px;">
                        <strong>💡 Troubleshooting Tips:</strong><br>
                        1. Configure OAuth consent screen in Google Cloud Console<br>
                        2. Share sheet: "Anyone with the link" → "Editor"<br>
                        3. Enable Google Sheets API in Google Cloud Console<br>
                        4. Check API key restrictions include Google Sheets API
                    </div>
                ` : ''}
            `;
        }
        
        async function loadAuthorizedUsers() {
            if (!GOOGLE_APPS_SCRIPT_URL) return { users: [], skus: [], sachetTypes: [], tabletTypes: [] };
            try {
                const url = `${GOOGLE_APPS_SCRIPT_URL}?action=users`;
                const response = await fetch(url);
                if (!response.ok) return { users: [], skus: [], sachetTypes: [], tabletTypes: [] };
                const result = await response.json();
                if (!result.success) return { users: [], skus: [], sachetTypes: [], tabletTypes: [] };
                return {
                    users: result.data || [],
                    skus: result.skus || [],
                    sachetTypes: result.sachetTypes || [],
                    tabletTypes: result.tabletTypes || []
                };
            } catch (error) {
                console.error('Error loading users:', error);
                return { users: [], skus: [], sachetTypes: [], tabletTypes: [] };
            }
        }
        
        function populateDropdown(selectId, options, placeholder = 'Select...') {
            const select = document.getElementById(selectId);
            if (!select) return;
            select.innerHTML = `<option value="">${placeholder}</option>`;
            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                select.appendChild(option);
            });
        }
        
        function populateSKUDropdown(skus) {
            const skuSelect = document.getElementById('fillSku');
            const skuCustom = document.getElementById('fillSkuCustom');
            
            if (!skuSelect) return;
            
            // Clear existing options except the first one
            skuSelect.innerHTML = '<option value="">Select or type SKU...</option>';
            
            // Add SKUs from the list
            skus.forEach(sku => {
                const option = document.createElement('option');
                option.value = sku;
                option.textContent = sku;
                skuSelect.appendChild(option);
            });
            
            // Add "Custom..." option
            const customOption = document.createElement('option');
            customOption.value = '__custom__';
            customOption.textContent = '--- Enter Custom SKU ---';
            skuSelect.appendChild(customOption);
            
            // Handle selection change
            skuSelect.addEventListener('change', function() {
                if (this.value === '__custom__') {
                    this.style.display = 'none';
                    if (skuCustom) {
                        skuCustom.style.display = 'block';
                        skuCustom.focus();
                    }
                } else if (this.value) {
                    if (skuCustom) {
                        skuCustom.style.display = 'none';
                        skuCustom.value = '';
                    }
                }
            });
            
            // Handle custom input
            if (skuCustom) {
                skuCustom.addEventListener('input', function() {
                    if (this.value) {
                        skuSelect.value = '';
                    }
                });
                
                skuCustom.addEventListener('blur', function() {
                    if (!this.value) {
                        this.style.display = 'none';
                        skuSelect.style.display = 'block';
                    }
                });
            }
        }

        function populateAuthorizedUserSelects(users) {
            const loginSelect = document.getElementById('loginUser');
            if (loginSelect) {
                loginSelect.innerHTML = '<option value="">Select authorized user...</option>' +
                    users.map(u => `<option value="${u.id}">${u.name}</option>`).join('');
            }
        }

        async function authenticateUser(userId, passcode) {
            if (!GOOGLE_APPS_SCRIPT_URL) {
                throw new Error('Apps Script URL not configured');
            }
            const url = `${GOOGLE_APPS_SCRIPT_URL}?action=login&userId=${encodeURIComponent(userId)}&passcode=${encodeURIComponent(passcode)}`;
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`Login failed: ${response.statusText}`);
            }
            const result = await response.json();
            if (!result.success) {
                throw new Error(result.error || 'Invalid credentials');
            }
            return result.data;
        }

        function showLoginCard() {
            const loginCard = document.getElementById('loginCard');
            const editCard = document.getElementById('editCard');
            if (loginCard) loginCard.style.display = 'block';
            if (editCard) editCard.style.display = 'none';
            // Preview is now in modal - no longer needed here
            const banner = document.getElementById('loggedInUserBanner');
            if (banner) banner.style.display = 'none';
        }

        function showEditCard() {
            const loginCard = document.getElementById('loginCard');
            const editCard = document.getElementById('editCard');
            if (loginCard) loginCard.style.display = 'none';
            if (editCard) editCard.style.display = 'block';
            updateLoggedInUserBanner();
        }

        async function handleLoginSubmit(event) {
            event.preventDefault();
            const loginStatus = document.getElementById('loginStatus');
            if (loginStatus) {
                loginStatus.textContent = '🔐 Verifying credentials...';
                loginStatus.classList.remove('error', 'success');
            }
            const userId = document.getElementById('loginUser')?.value;
            const passcode = document.getElementById('loginPasscode')?.value;
            if (!userId || !passcode) {
                if (loginStatus) {
                    loginStatus.textContent = '❌ Select a user and enter the passcode.';
                    loginStatus.classList.add('error');
                }
                return;
            }
            try {
                const userData = await authenticateUser(userId, passcode);
                setLoggedInUser({
                    id: userData.id || userId,
                    name: userData.name || userId,
                    loginAt: new Date().toISOString()
                });
                document.getElementById('loginPasscode').value = '';
                showEditCard();
                updateLoggedInUserBanner();
                if (loginStatus) {
                    loginStatus.textContent = '✅ Login successful. Editor unlocked.';
                    loginStatus.classList.add('success');
                }
            } catch (error) {
                if (loginStatus) {
                    loginStatus.textContent = `❌ ${error.message}`;
                    loginStatus.classList.add('error');
                }
            }
        }
        
        // SKU Calculations are now handled automatically by Apps Script
        async function updateSKUCalculations(sku, qty) {
            // This function is kept for compatibility but calculations are handled by Apps Script
            // when saving tickets (see saveTicketToSheet function)
            console.log('SKU calculations handled by Apps Script');
        }
        
        // View Mode Functions
        async function initViewMode(serial) {
            document.body.classList.add('fill-mode-active');
            const fillContainer = document.getElementById('fillContainer');
            if (fillContainer) {
                fillContainer.classList.add('visible');
            }
            const movementSection = document.getElementById('movementSection');
            if (movementSection) {
                movementSection.style.display = 'block';
            }
            
            const viewCard = document.getElementById('viewCard');
            const editCard = document.getElementById('editCard');
            if (viewCard) viewCard.style.display = 'block';
            if (editCard) editCard.style.display = 'none';
            // Preview is now in modal - no longer needed here
            
            const serialValue = serial ? decodeURIComponent(serial) : formatSerial(currentSerial);
            const viewSerialDisplay = document.getElementById('viewSerialDisplay');
            if (viewSerialDisplay) {
                viewSerialDisplay.textContent = serialValue;
            }
            
            // Prevent back navigation - replace current history entry
            window.history.replaceState(null, '', window.location.href);
            
            // Block back button/swipe back
            window.addEventListener('popstate', (e) => {
                // Prevent going back to generator page
                window.history.pushState(null, '', window.location.href);
            });
            
            // Push a state to prevent back navigation
            window.history.pushState(null, '', window.location.href);
            
            const viewLoading = document.getElementById('viewLoading');
            const viewData = document.getElementById('viewData');
            
            try {
                const ticket = await readTicketFromSheet(serialValue);
                if (viewLoading) viewLoading.style.display = 'none';
                if (viewData) {
                    viewData.style.display = 'block';
                    if (!ticket) {
                        viewData.innerHTML = '<p style="text-align: center; padding: 40px; color: #718096;">No data found for this ticket.</p>';
                    } else {
                        viewData.innerHTML = renderViewMode(ticket);
                    }
                }
            } catch (error) {
                if (viewLoading) viewLoading.style.display = 'none';
                if (viewData) {
                    viewData.style.display = 'block';
                    viewData.innerHTML = `<p style="text-align: center; padding: 40px; color: #e53e3e;">Error loading ticket: ${error.message}</p>`;
                }
            }
        }
        
        function renderViewMode(ticket) {
            const merchHistory = ticket.MerchHistory ? (typeof ticket.MerchHistory === 'string' ? JSON.parse(ticket.MerchHistory) : ticket.MerchHistory) : [];
            
            // Detect color from serial number
            const serial = ticket.Serial || '';
            const ticketColor = serial.includes('-BL-') ? 'blue' :
                              serial.includes('-RD-') ? 'red' :
                              serial.includes('-GN-') ? 'green' :
                              serial.includes('-YL-') ? 'yellow' : 'blue';
            
            // Elegant gold and dark blue color scheme
            const colorMap = {
                blue: { bg: 'rgba(30, 58, 95, 0.3)', border: '#f59e0b', text: '#fbbf24', accent: '#fcd34d' },
                red: { bg: 'rgba(30, 58, 95, 0.3)', border: '#f59e0b', text: '#fbbf24', accent: '#fcd34d' },
                green: { bg: 'rgba(30, 58, 95, 0.3)', border: '#f59e0b', text: '#fbbf24', accent: '#fcd34d' },
                yellow: { bg: 'rgba(30, 58, 95, 0.3)', border: '#f59e0b', text: '#fbbf24', accent: '#fcd34d' }
            };
            const colors = colorMap[ticketColor] || colorMap.blue;
            
            // Format timestamps
            const createdAt = formatTimestamp(ticket.CreatedAt);
            const firstModified = formatTimestamp(ticket.FirstModified);
            const lastModified = formatTimestamp(ticket.LastModified);
            
            // Format Date and Time - ensure we're reading from the correct fields
            // Date is column B, Time is column C
            const dateValue = ticket.Date || ticket['Date'] || '';
            const timeValue = ticket.Time || ticket['Time'] || '';
            const formattedDateTime = formatDateAndTime(dateValue, timeValue);
            const palletInfo = ticket.pallet || ticket.PalletInfo || ticket._pallet || null;
            const originalQty = (() => {
                if (palletInfo && palletInfo.Quantity != null && palletInfo.Quantity !== '') {
                    const value = Number(palletInfo.Quantity);
                    if (!isNaN(value)) return value;
                }
                return parseFloat(ticket.Qty || 0) || 0;
            })();
            const remainingQty = (() => {
                if (palletInfo && palletInfo.RemainingQuantity != null && palletInfo.RemainingQuantity !== '') {
                    const value = Number(palletInfo.RemainingQuantity);
                    if (!isNaN(value)) return value;
                }
                return originalQty;
            })();
            const palletZone = palletInfo && palletInfo.CurrentZone ? palletInfo.CurrentZone : 'Receiving Area';
            const palletStatus = palletInfo && palletInfo.Status ? palletInfo.Status : 'Received';
            const palletRemaining = palletInfo && (palletInfo.RemainingQuantity ?? palletInfo.Quantity) ? (palletInfo.RemainingQuantity ?? palletInfo.Quantity) : '—';
            const palletLastMove = palletInfo && palletInfo.LastMovedAt ? formatMovementDate(palletInfo.LastMovedAt) : 'Not moved yet';
            const palletCreated = palletInfo && palletInfo.CreatedAt ? formatMovementDate(palletInfo.CreatedAt) : 'Pending';
            const palletInfoCard = `
                <div style="background: ${colors.bg}; padding: 24px; border-radius: 16px; border: 2px solid ${colors.border}; backdrop-filter: blur(10px);">
                    <h3 style="margin: 0 0 18px 0; color: ${colors.text}; font-size: 18px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);">⬥ Pallet Location</h3>
                    <div class="pallet-info-grid" style="display: grid; grid-template-columns: 1fr; gap: 14px;">
                        <div><strong style="color: ${colors.text}; font-weight: 600;">Current Zone:</strong> <span style="color: rgba(255, 255, 255, 0.95); font-weight: 500;">${escapeHtml(palletZone)}</span></div>
                        <div><strong style="color: ${colors.text}; font-weight: 600;">Status:</strong> <span style="color: rgba(255, 255, 255, 0.95); font-weight: 500;">${escapeHtml(palletStatus)}</span></div>
                        <div><strong style="color: ${colors.text}; font-weight: 600;">Original Qty:</strong> <span style="color: rgba(255, 255, 255, 0.95); font-weight: 500;">${escapeHtml(originalQty.toString())}</span></div>
                        <div><strong style="color: ${colors.text}; font-weight: 600;">Remaining Qty:</strong> <span style="color: rgba(255, 255, 255, 0.95); font-weight: 500;">${escapeHtml(remainingQty.toString())}</span></div>
                        <div><strong style="color: ${colors.text}; font-weight: 600;">Last Movement:</strong> <span style="color: rgba(255, 255, 255, 0.9); font-weight: 500;">${escapeHtml(palletLastMove)}</span></div>
                        <div><strong style="color: ${colors.text}; font-weight: 600;">Pallet Created:</strong> <span style="color: rgba(255, 255, 255, 0.9); font-weight: 500;">${escapeHtml(palletCreated)}</span></div>
                    </div>
                    ${!palletInfo ? `<div style="margin-top: 14px; padding: 12px; background: rgba(245, 158, 11, 0.1); border-radius: 8px; color: rgba(251, 191, 36, 0.9); font-size: 13px; border: 1px solid rgba(245, 158, 11, 0.3);">No pallet movement recorded yet. Submit this ticket via the Stock Movement panel to update.</div>` : ''}
                </div>
            `;
            
            // Parse Product Type to check for 1KG or 0.5KG
            const productType = (ticket.ProductType || '').toLowerCase();
            const has1KG = productType.includes('1kg') || productType.includes('1 kg');
            const has05KG = productType.includes('0.5kg') || productType.includes('0.5 kg') || productType.includes('0,5kg');
            const qty = remainingQty;
            let pieces = 0;
            let tabletSachetInfo = '';
            
            // Show tablet/sachet info if product type is 1KG or 0.5KG, regardless of quantity
            if (has1KG) {
                pieces = qty * 6;
                tabletSachetInfo = '1KG';
            } else if (has05KG) {
                pieces = qty * 12;
                tabletSachetInfo = '0.5KG';
            }
            
            // Calculate layers based on pallet size and quantity
            const palletConfig = {
                '100': { layers: 5, cartonsPerLayer: 20 },   // 100 / 5 = 20
                '105': { layers: 7, cartonsPerLayer: 15 },   // 105 / 7 = 15
                '78': { layers: 6, cartonsPerLayer: 13 },    // 78 / 6 = 13
                '64': { layers: 4, cartonsPerLayer: 16 }     // 64 / 4 = 16
            };
            
            let layersInfo = null;
            const palletSizeStr = (ticket.PalletSize || '').toString().trim();
            
            const computeLayerInfo = (quantityValue) => {
                if (!palletSizeStr || quantityValue <= 0) return null;
                const palletSizes = palletSizeStr.split(',').map(ps => ps.trim()).filter(ps => ps !== '');
                if (!palletSizes.length) return null;
                    const palletSize = palletSizes[0];
                    const config = palletConfig[palletSize];
                if (!config) return null;
                const cartonsPerLayer = config.cartonsPerLayer;
                const calculatedLayers = Math.ceil(quantityValue / cartonsPerLayer);
                const fullLayers = Math.floor(quantityValue / cartonsPerLayer);
                const remainderUnits = quantityValue % cartonsPerLayer;
                return {
                    palletSize,
                    cartonsPerLayer,
                    calculatedLayers,
                    fullLayers,
                    remainderUnits
                };
            };

            layersInfo = computeLayerInfo(remainingQty);
            const layersInfoOriginal = originalQty !== remainingQty ? computeLayerInfo(originalQty) : null;
            
            return `
                <div style="max-width: 900px; margin: 0 auto; padding: 30px; background: linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(30, 58, 95, 0.98)); border-radius: 20px; box-shadow: 0 16px 64px rgba(0, 0, 0, 0.5), 0 8px 32px rgba(245, 158, 11, 0.2); border: 2px solid rgba(245, 158, 11, 0.4); backdrop-filter: blur(20px);">
                    <div style="border-left: 6px solid ${colors.border}; padding-left: 20px; margin-bottom: 30px;">
                        <h2 style="margin: 0 0 5px 0; background: linear-gradient(135deg, #fbbf24, #f59e0b, #fcd34d); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 28px; font-weight: 800; letter-spacing: 1px; text-transform: uppercase;">${escapeHtml(serial)}</h2>
                    </div>
                    
                    <div style="display: grid; gap: 20px; margin-bottom: 30px;">
                        <div style="background: ${colors.bg}; padding: 24px; border-radius: 16px; border: 2px solid ${colors.border}; backdrop-filter: blur(10px);">
                            <h3 style="margin: 0 0 18px 0; color: ${colors.text}; font-size: 18px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);">⬥ Basic Information</h3>
                            <div class="pallet-info-grid" style="display: grid; gap: 14px;">
                                <div><strong style="color: ${colors.text}; font-weight: 600;">Serial:</strong> <span style="color: rgba(255, 255, 255, 0.95); font-weight: 500;">${escapeHtml(serial)}</span></div>
                                <div><strong style="color: ${colors.text}; font-weight: 600;">Date & Time:</strong> <span style="color: rgba(255, 255, 255, 0.9); font-family: 'Courier New', monospace; font-weight: 500;">${escapeHtml(formattedDateTime || 'N/A')}</span></div>
                                <div><strong style="color: ${colors.text}; font-weight: 600;">SKU:</strong> <span style="color: rgba(255, 255, 255, 0.95); font-weight: 500;">${escapeHtml(ticket.SKU || '')}</span></div>
                                <div>
                                    <strong style="color: ${colors.text};">Quantity (Original):</strong>
                                    <span style="color: rgba(255, 255, 255, 0.95); font-weight: 500;">${escapeHtml(originalQty.toString())}</span>
                                </div>
                                <div>
                                    <strong style="color: ${colors.text};">Quantity (Remaining):</strong>
                                    <span style="color: rgba(255, 255, 255, 0.95); font-weight: 500;">${escapeHtml(remainingQty.toString())}</span>
                                </div>
                                <div><strong style="color: ${colors.text};">Layers:</strong> 
                                    <span style="color: rgba(255, 255, 255, 0.95); font-weight: 500;">
                                        ${layersInfo ? escapeHtml(layersInfo.calculatedLayers.toString()) : escapeHtml(ticket.Layers || '')}
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        ${palletInfoCard}
                        
                        <div style="background: ${colors.bg}; padding: 24px; border-radius: 16px; border: 2px solid ${colors.border}; backdrop-filter: blur(10px);">
                            <h3 style="margin: 0 0 18px 0; color: ${colors.text}; font-size: 18px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);">⬥ Product Details</h3>
                            <div style="display: grid; gap: 14px;">
                                <div><strong style="color: ${colors.text}; font-weight: 600;">Banding Type:</strong> <span style="color: rgba(255, 255, 255, 0.95); text-transform: uppercase; font-weight: 500;">${escapeHtml((ticket.BandingType || '').toUpperCase())}</span></div>
                                <div><strong style="color: ${colors.text}; font-weight: 600;">Product Type:</strong> <span style="color: rgba(255, 255, 255, 0.95); text-transform: uppercase; font-weight: 500;">${escapeHtml((ticket.ProductType || '').toUpperCase())}</span></div>
                                <div><strong style="color: ${colors.text}; font-weight: 600;">Pallet Size:</strong> <span style="color: rgba(255, 255, 255, 0.95); font-weight: 500;">${escapeHtml(ticket.PalletSize || '')}</span></div>
                            </div>
                        </div>
                        
                        ${layersInfo ? `
                        <div style="background: ${colors.bg}; padding: 20px; border-radius: 8px; border-left: 4px solid ${colors.border};">
                            <h3 style="margin: 0 0 15px 0; color: ${colors.text}; font-size: 18px; font-weight: 600;">📊 Layer Calculations</h3>
                            <div style="display: grid; gap: 10px;">
                                <div><strong style="color: ${colors.text};">Pallet Size:</strong> <span style="color: rgba(255, 255, 255, 0.95); font-weight: 500;">${escapeHtml(layersInfo.palletSize)} cartons</span></div>
                                <div><strong style="color: ${colors.text};">Cartons per Layer:</strong> <span style="color: rgba(255, 255, 255, 0.95); font-weight: 600;">${escapeHtml(layersInfo.cartonsPerLayer.toString())} cartons/layer</span></div>
                                <div style="padding-top: 8px; border-top: 1px solid ${colors.accent}40; margin-top: 8px;">
                                    <div style="margin-bottom: 8px;"><strong style="color: ${colors.text};">Remaining Quantity:</strong> <span style="color: rgba(255, 255, 255, 0.95); font-weight: 600;">${escapeHtml(remainingQty.toString())} cartons</span></div>
                                    <div style="margin-bottom: 8px;"><strong style="color: ${colors.text};">Calculated Layers:</strong> <span style="color: rgba(255, 255, 255, 0.95); font-weight: 700; font-size: 16px;">${escapeHtml(layersInfo.calculatedLayers.toString())} layers</span></div>
                                    ${layersInfo.fullLayers > 0 || layersInfo.remainderUnits > 0 ? `
                                        <div style="margin-bottom: 5px; padding-top: 8px; border-top: 1px solid ${colors.accent}20;">
                                            <div style="margin-bottom: 5px;"><strong style="color: ${colors.text};">Breakdown:</strong></div>
                                            <div style="color: rgba(255, 255, 255, 0.85); font-size: 14px; margin-left: 10px; font-weight: 500;">
                                                ${layersInfo.fullLayers > 0 ? `${escapeHtml(layersInfo.fullLayers.toString())} full layer(s)` : ''}
                                                ${layersInfo.remainderUnits > 0 ? (layersInfo.fullLayers > 0 ? ` + ${escapeHtml(layersInfo.remainderUnits.toString())} units` : `${escapeHtml(layersInfo.remainderUnits.toString())} units`) : ''}
                                                ${layersInfo.remainderUnits > 0 && layersInfo.fullLayers > 0 ? (() => {
                                                    const nextLayer = layersInfo.fullLayers + 1;
                                                    let suffix = 'th';
                                                    if (nextLayer === 1) suffix = 'st';
                                                    else if (nextLayer === 2) suffix = 'nd';
                                                    else if (nextLayer === 3) suffix = 'rd';
                                                    return ` (${nextLayer}${suffix} layer is not full)`;
                                                })() : ''}
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                                ${layersInfoOriginal ? `
                                <div style="padding-top: 8px; border-top: 1px dashed ${colors.accent}40; margin-top: 12px; font-size: 13px; color: rgba(255, 255, 255, 0.85); font-weight: 500;">
                                    <strong>Original Quantity:</strong> ${escapeHtml(originalQty.toString())} cartons •
                                    <strong>Original Layers:</strong> ${escapeHtml(layersInfoOriginal.calculatedLayers.toString())}
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        ` : ''}
                        
                        ${tabletSachetInfo ? `
                        <div style="background: ${colors.bg}; padding: 24px; border-radius: 16px; border: 2px solid ${colors.border}; backdrop-filter: blur(10px);">
                            <h3 style="margin: 0 0 18px 0; color: ${colors.text}; font-size: 18px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);">⬥ Tablet & Sachet Info</h3>
                            <div style="display: grid; gap: 14px;">
                                <div><strong style="color: ${colors.text}; font-weight: 600;">Product Type:</strong> <span style="color: rgba(255, 255, 255, 0.95); font-weight: 500;">${escapeHtml(tabletSachetInfo)}</span></div>
                                <div><strong style="color: ${colors.text}; font-weight: 600;">Quantity Remaining (Cartons):</strong> <span style="color: rgba(255, 255, 255, 0.95); font-weight: 500;">${escapeHtml(remainingQty.toString())} Cartons</span></div>
                                ${originalQty !== remainingQty ? `<div><strong style="color: ${colors.text}; font-weight: 600;">Original Quantity:</strong> <span style="color: rgba(255, 255, 255, 0.95); font-weight: 500;">${escapeHtml(originalQty.toString())} Cartons</span></div>` : ''}
                                ${ticket.SachetType ? `<div><strong style="color: ${colors.text}; font-weight: 600;">Sachet Type:</strong> <span style="color: rgba(255, 255, 255, 0.95); font-weight: 500;">${escapeHtml(ticket.SachetType)}</span></div>` : ''}
                                ${ticket.TabletType ? `<div><strong style="color: ${colors.text}; font-weight: 600;">Tablet Type:</strong> <span style="color: rgba(255, 255, 255, 0.95); font-weight: 500;">${escapeHtml(ticket.TabletType)}</span></div>` : ''}
                                <div style="padding-top: 8px; border-top: 1px solid ${colors.accent}40;">
                                    <div style="margin-bottom: 5px;"><strong style="color: ${colors.text};">Conversion:</strong> <span style="color: rgba(255, 255, 255, 0.85); font-size: 14px; font-weight: 500;">${escapeHtml(remainingQty.toString())} Cartons × ${has1KG ? '6' : '12'} = </span></div>
                                    <div><strong style="color: ${colors.text};">Total Pieces Remaining:</strong> <span style="color: rgba(255, 255, 255, 0.95); font-weight: 700; font-size: 18px;">${pieces.toLocaleString()} Pieces</span></div>
                                    ${originalQty !== remainingQty ? `<div style="margin-top: 6px; color: rgba(255, 255, 255, 0.75); font-size: 13px; font-weight: 500;">Original pieces: ${( (originalQty) * (has1KG ? 6 : 12)).toLocaleString()}</div>` : ''}
                                </div>
                                <div style="padding-top: 8px; border-top: 1px solid ${colors.accent}40; margin-top: 8px;">
                                    <div style="margin-bottom: 8px;"><strong style="color: ${colors.text};">Carton to Sachet/Tablet Conversion:</strong></div>
                                    ${has1KG ? `
                                    <div style="margin-bottom: 5px; color: rgba(255, 255, 255, 0.85); font-size: 14px; font-weight: 500;">1 Carton = 6 Sachets + 6 Tablet Pieces</div>
                                    <div style="margin-bottom: 5px; color: rgba(255, 255, 255, 0.85); font-size: 14px; font-weight: 500;">100 Cartons = 600 Sachets + 600 Tablet Pieces</div>
                                    ` : `
                                    <div style="margin-bottom: 5px; color: rgba(255, 255, 255, 0.85); font-size: 14px; font-weight: 500;">1 Carton = 12 Sachets + 12 Tablet Pieces</div>
                                    <div style="margin-bottom: 5px; color: rgba(255, 255, 255, 0.85); font-size: 14px; font-weight: 500;">100 Cartons = 1,200 Sachets + 1,200 Tablet Pieces</div>
                                    `}
                                    ${(ticket.SachetType || ticket.TabletType) ? `
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                                        ${ticket.SachetType ? `
                                        <div>
                                            <div style="font-size: 12px; color: rgba(251, 191, 36, 0.8); margin-bottom: 3px; font-weight: 600;">Sachets</div>
                                            <div style="color: rgba(255, 255, 255, 0.95); font-weight: 700; font-size: 16px;">${(remainingQty * (has1KG ? 6 : 12)).toLocaleString()}</div>
                                        </div>
                                        ` : ''}
                                        ${ticket.TabletType ? `
                                        <div>
                                            <div style="font-size: 12px; color: rgba(251, 191, 36, 0.8); margin-bottom: 3px; font-weight: 600;">Tablet Pieces</div>
                                            <div style="color: rgba(255, 255, 255, 0.95); font-weight: 700; font-size: 16px;">${(remainingQty * (has1KG ? 6 : 12)).toLocaleString()}</div>
                                        </div>
                                        ` : ''}
                                    </div>
                                    ` : `
                                    <div style="margin-top: 10px; padding: 10px; background: rgba(30, 58, 95, 0.4); border-radius: 6px; border: 1px solid rgba(245, 158, 11, 0.3);">
                                        <div style="color: rgba(255, 255, 255, 0.75); font-size: 13px; font-weight: 500;">Sachet Type and Tablet Type not specified</div>
                                    </div>
                                    `}
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${ticket.QualityIssueType ? `
                        <div style="background: rgba(220, 38, 38, 0.15); padding: 24px; border-radius: 16px; border: 2px solid rgba(220, 38, 38, 0.5); backdrop-filter: blur(10px);">
                            <h3 style="margin: 0 0 18px 0; color: #fbbf24; font-size: 18px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);">⚠️ Quality Issues</h3>
                            <div style="display: grid; gap: 14px;">
                                <div><strong style="color: #fbbf24; font-weight: 600;">Type:</strong> <span style="color: rgba(255, 255, 255, 0.95); font-weight: 500;">${escapeHtml(ticket.QualityIssueType === 'banding' ? 'Banding Quality Frailties' : 'Production Quality Frailties')}</span></div>
                                <div><strong style="color: #fbbf24; font-weight: 600;">Group Leader:</strong> <span style="color: rgba(255, 255, 255, 0.95); font-weight: 500;">${escapeHtml(ticket.GroupLeader || '')}</span></div>
                                <div><strong style="color: #fbbf24; font-weight: 600;">Description:</strong> <span style="color: rgba(255, 255, 255, 0.95); font-weight: 500;">${escapeHtml(ticket.QualityIssueDesc || '')}</span></div>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${merchHistory.length > 0 ? `
                        <div style="background: ${colors.bg}; padding: 24px; border-radius: 16px; border: 2px solid ${colors.border}; backdrop-filter: blur(10px);">
                            <h3 style="margin: 0 0 18px 0; color: ${colors.text}; font-size: 18px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);">⬥ Merchandise History</h3>
                            ${merchHistory.map(entry => `
                                <div style="padding: 16px; margin-bottom: 12px; background: rgba(15, 23, 42, 0.4); border-radius: 10px; border: 1px solid rgba(245, 158, 11, 0.3); backdrop-filter: blur(5px);">
                                    <div style="font-weight: 700; color: ${colors.text}; margin-bottom: 6px; font-size: 14px;">${escapeHtml(entry.date || '')} - ${escapeHtml(entry.user || '')}</div>
                                    <div style="color: rgba(255, 255, 255, 0.9); font-size: 14px; font-weight: 500;">${escapeHtml(entry.note || '')}</div>
                                </div>
                            `).join('')}
                        </div>
                        ` : ''}
                        
                        <div style="background: rgba(30, 58, 95, 0.2); padding: 24px; border-radius: 16px; border: 2px solid rgba(245, 158, 11, 0.3); backdrop-filter: blur(10px);">
                            <h3 style="margin: 0 0 18px 0; color: #fbbf24; font-size: 18px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);">⬥ Timestamps</h3>
                            <div style="display: grid; gap: 14px;">
                                <div><strong style="color: #fbbf24; font-weight: 600;">Created At:</strong> <span style="color: rgba(255, 255, 255, 0.9); font-family: 'Courier New', monospace; font-weight: 500;">${escapeHtml(createdAt)}</span></div>
                                <div><strong style="color: #fbbf24; font-weight: 600;">First Modified:</strong> <span style="color: rgba(255, 255, 255, 0.9); font-family: 'Courier New', monospace; font-weight: 500;">${escapeHtml(firstModified)}</span></div>
                                <div><strong style="color: #fbbf24; font-weight: 600;">Last Modified:</strong> <span style="color: rgba(255, 255, 255, 0.9); font-family: 'Courier New', monospace; font-weight: 500;">${escapeHtml(lastModified)}</span></div>
                            </div>
                        </div>
                        
                        ${ticket.ChangeHistory ? `
                        <div style="background: rgba(30, 58, 95, 0.2); padding: 24px; border-radius: 16px; border: 2px solid rgba(245, 158, 11, 0.3); backdrop-filter: blur(10px);">
                            <h3 style="margin: 0 0 18px 0; color: #fbbf24; font-size: 18px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);">⬥ Change History</h3>
                            <pre style="white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 13px; color: rgba(255, 255, 255, 0.9); margin: 0; background: rgba(15, 23, 42, 0.5); padding: 18px; border-radius: 10px; border: 1px solid rgba(245, 158, 11, 0.2); font-weight: 500;">${escapeHtml(formatChangeHistory(ticket.ChangeHistory))}</pre>
                        </div>
                        ` : ''}
                        
                        ${ticket.Notes ? `
                        <div style="background: ${colors.bg}; padding: 24px; border-radius: 16px; border: 2px solid ${colors.border}; backdrop-filter: blur(10px);">
                            <h3 style="margin: 0 0 18px 0; color: ${colors.text}; font-size: 18px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);">⬥ Notes</h3>
                            <p style="margin: 0; color: rgba(255, 255, 255, 0.95); line-height: 1.7; font-weight: 500;">${escapeHtml(ticket.Notes)}</p>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }
        
        function addMerchHistoryEntry() {
            const container = document.getElementById('merchHistoryContainer');
            if (!container) return;
            const users = Array.from(document.querySelectorAll('#groupLeader option')).map(opt => ({ value: opt.value, text: opt.textContent }));
            const entry = document.createElement('div');
            entry.className = 'merch-history-entry';
            entry.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr 2fr auto; gap: 10px; margin-bottom: 10px; align-items: end;';
            entry.innerHTML = `
                <div class="fill-form-group">
                    <label>Date</label>
                    <input type="date" class="merch-history-date" name="merchHistoryDate[]">
                </div>
                <div class="fill-form-group">
                    <label>User</label>
                    <select class="merch-history-user" name="merchHistoryUser[]">
                        <option value="">Select user...</option>
                        ${users.filter(u => u.value).map(u => `<option value="${u.value}">${u.text}</option>`).join('')}
                    </select>
                </div>
                <div class="fill-form-group">
                    <label>Note</label>
                    <input type="text" class="merch-history-note" name="merchHistoryNote[]" placeholder="Enter note...">
                </div>
                <button type="button" onclick="this.parentElement.remove()" class="btn-reset" style="padding: 10px;">×</button>
            `;
            container.appendChild(entry);
        }
        
        async function initFillMode(serial) {
            // Prevent back navigation - replace current history entry
            window.history.replaceState(null, '', window.location.href);
            
            // Block back button/swipe back
            window.addEventListener('popstate', (e) => {
                // Prevent going back to generator page
                window.history.pushState(null, '', window.location.href);
            });
            
            // Push a state to prevent back navigation
            window.history.pushState(null, '', window.location.href);
            
            document.body.classList.add('fill-mode-active');

            const movementSection = document.getElementById('movementSection');
            if (movementSection) {
                movementSection.style.display = 'block';
            }

            const fillContainer = document.getElementById('fillContainer');
            if (fillContainer) {
                fillContainer.classList.add('visible');
            }
            
            const viewCard = document.getElementById('viewCard');
            const editCard = document.getElementById('editCard');
            if (viewCard) viewCard.style.display = 'none';
            if (isUserLoggedIn()) {
                showEditCard();
            } else {
                showLoginCard();
            }
            updateLoggedInUserBanner();

            const defaultSerial = serial ? decodeURIComponent(serial) : formatSerial(currentSerial);
            const serialInput = document.getElementById('fillSerial');
            const serialDisplay = document.getElementById('fillSerialDisplay');
            if (serialInput) {
                serialInput.value = defaultSerial;
            }
            if (serialDisplay) {
                serialDisplay.textContent = defaultSerial;
            }

            const movementPalletInput = document.getElementById('movementPalletId');
            if (movementPalletInput) {
                movementPalletInput.value = defaultSerial;
            }
            const movementCurrentZone = document.getElementById('movementCurrentZone');
            if (movementCurrentZone) {
                movementCurrentZone.value = '';
            }

            // Priority: URL color param > serial detection > default
            let detectedColour = urlColorParam || 
                (defaultSerial.includes('-BL-') ? 'blue' :
                 defaultSerial.includes('-RD-') ? 'red' :
                 defaultSerial.includes('-GN-') ? 'green' :
                 defaultSerial.includes('-YL-') ? 'yellow' : selectedColor);

            const fillColorSelect = document.getElementById('fillColor');
            if (fillColorSelect) {
                fillColorSelect.value = detectedColour;
                // Disable color selection - it cannot be changed during input
                fillColorSelect.disabled = true;
                fillColorSelect.style.backgroundColor = '#f7fafc';
                fillColorSelect.style.cursor = 'not-allowed';
            }
            
            // Load authorized users
            const { users, skus, sachetTypes, tabletTypes } = await loadAuthorizedUsers();
            populateAuthorizedUserSelects(users);
            populateSKUDropdown(skus);
            populateDropdown('sachetType', sachetTypes, 'Select sachet type...');
            populateDropdown('tabletType', tabletTypes, 'Select tablet type...');
            
            const groupLeaderSelect = document.getElementById('groupLeader');
            const merchHistoryUsers = document.querySelectorAll('.merch-history-user');
            if (groupLeaderSelect) {
                groupLeaderSelect.innerHTML = '<option value="">Select leader...</option>' + 
                    users.map(u => `<option value="${u.id}">${u.name}</option>`).join('');
            }
            merchHistoryUsers.forEach(select => {
                select.innerHTML = '<option value="">Select user...</option>' + 
                    users.map(u => `<option value="${u.id}">${u.name}</option>`).join('');
            });
            
            // Load existing ticket data if editing
            try {
                const existingTicket = await readTicketFromSheet(defaultSerial);
                if (existingTicket) {
                    populateFormFromTicket(existingTicket);
                }
            } catch (error) {
                console.log('No existing ticket or error loading:', error);
            }


            const form = document.getElementById('ticketForm');
            if (form) {
                form.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    
                    if (!isUserLoggedIn()) {
                        setFillStatus('❌ Please log in before editing tickets.');
                        showLoginCard();
                        return;
                    }
                    
                    setFillStatus('💾 Saving to Google Sheets...');
                    try {
                        const data = collectFormData(form);
                        let existingTicket = null;
                        try {
                            existingTicket = await readTicketFromSheet(data.serial);
                            // Check if ticket actually exists (has data, not just headers)
                            if (existingTicket && (!existingTicket.Serial || existingTicket.Serial !== data.serial)) {
                                existingTicket = null;
                            }
                        } catch (e) {
                            // Ticket doesn't exist, that's fine
                            existingTicket = null;
                        }
                        const isUpdate = !!(existingTicket && existingTicket.Serial === data.serial);
                        
                        // Save to Google Sheets (pass existingTicket for timestamp handling)
                        const saveResult = await saveTicketToSheet(data, isUpdate, existingTicket);
                        console.log('Save result:', saveResult);
                        
                        // Update SKU calculations
                        if (data.sku && data.qty) {
                            await updateSKUCalculations(data.sku, data.qty);
                        }
                        
                        setFillStatus('📄 Generating ticket preview...');
                        const pageElement = renderFilledTicket(data);
                        if (!pageElement) {
                            setFillStatus('Could not render preview.');
                            return;
                        }
                        await new Promise(resolve => setTimeout(resolve, 50));
                        renderTicketQRCodes(pageElement);
                        await new Promise(resolve => setTimeout(resolve, 50));
                        await downloadFilledTicket(pageElement, data.serial);
                        setFillStatus('✅ Saved to Google Sheets and download complete!');
                        showToast('Ticket saved successfully!', 'success');
                    } catch (error) {
                        setFillStatus(`❌ Error: ${error.message}`);
                        console.error('Save error:', error);
                        showToast(`Error saving to Google Sheets: ${error.message}`, 'error', 6000);
                        
                        // Restore button state on error
                        const submitBtn = document.getElementById('movementSubmitBtn') || document.querySelector('#ticketForm button[type="submit"]');
                        if (submitBtn) {
                            submitBtn.disabled = false;
                        }
                    }
                });
            }
        }
        
        function populateFormFromTicket(ticket) {
            if (ticket.Date) document.getElementById('fillDate').value = ticket.Date;
            if (ticket.Time) document.getElementById('fillTime').value = ticket.Time;
            // Set SKU - check if it exists in dropdown, otherwise use custom input
            if (ticket.SKU) {
                const skuSelect = document.getElementById('fillSku');
                const skuCustom = document.getElementById('fillSkuCustom');
                if (skuSelect) {
                    // Check if SKU exists in dropdown options
                    const optionExists = Array.from(skuSelect.options).some(opt => opt.value === ticket.SKU);
                    if (optionExists) {
                        skuSelect.value = ticket.SKU;
                        if (skuCustom) skuCustom.style.display = 'none';
                    } else {
                        // SKU not in dropdown, use custom input
                        skuSelect.value = '';
                        if (skuCustom) {
                            skuCustom.value = ticket.SKU;
                            skuCustom.style.display = 'block';
                            skuSelect.style.display = 'none';
                        }
                    }
                }
            }
            if (ticket.Qty) document.getElementById('fillQty').value = ticket.Qty;
            if (ticket.Layers) document.getElementById('fillLayers').value = ticket.Layers;
            if (ticket.Notes) document.getElementById('fillNotes').value = ticket.Notes;
            if (ticket.QualityIssueType) document.getElementById('qualityIssueType').value = ticket.QualityIssueType;
            if (ticket.QualityIssueDesc) document.getElementById('qualityIssueDesc').value = ticket.QualityIssueDesc;
            if (ticket.GroupLeader) document.getElementById('groupLeader').value = ticket.GroupLeader;
            if (ticket.SachetType) document.getElementById('sachetType').value = ticket.SachetType;
            if (ticket.TabletType) document.getElementById('tabletType').value = ticket.TabletType;
            
            // Populate checkboxes
            (ticket.BandingType || '').split(',').forEach(val => {
                const checkbox = document.querySelector(`input[name="bandingType"][value="${val.trim()}"]`);
                if (checkbox) checkbox.checked = true;
            });
            (ticket.ProductType || '').split(',').forEach(val => {
                const checkbox = document.querySelector(`input[name="productType"][value="${val.trim()}"]`);
                if (checkbox) checkbox.checked = true;
            });
            (ticket.PalletSize || '').split(',').forEach(val => {
                const checkbox = document.querySelector(`input[name="palletSize"][value="${val.trim()}"]`);
                if (checkbox) checkbox.checked = true;
            });
            
            // Populate merch history
            const merchHistory = ticket.MerchHistory ? (typeof ticket.MerchHistory === 'string' ? JSON.parse(ticket.MerchHistory) : ticket.MerchHistory) : [];
            const container = document.getElementById('merchHistoryContainer');
            if (container && merchHistory.length > 0) {
                container.innerHTML = '';
                merchHistory.forEach(entry => {
                    addMerchHistoryEntry();
                    const entries = container.querySelectorAll('.merch-history-entry');
                    const lastEntry = entries[entries.length - 1];
                    if (lastEntry) {
                        lastEntry.querySelector('.merch-history-date').value = entry.date || '';
                        lastEntry.querySelector('.merch-history-user').value = entry.user || '';
                        lastEntry.querySelector('.merch-history-note').value = entry.note || '';
                    }
                });
            }
        }

        function collectFormData(form) {
            if (!isUserLoggedIn()) {
                throw new Error('Session expired. Please log in again.');
            }
            const formData = new FormData(form);
            
            const collectChecked = (name) =>
                Array.from(form.querySelectorAll(`input[name="${name}"]:checked`))
                    .map(input => input.value.toLowerCase());
            
            // Get SKU from either dropdown or custom input
            const skuSelect = document.getElementById('fillSku');
            const skuCustom = document.getElementById('fillSkuCustom');
            let sku = '';
            if (skuSelect && skuSelect.value && skuSelect.value !== '__custom__') {
                sku = skuSelect.value;
            } else if (skuCustom && skuCustom.value) {
                sku = skuCustom.value.trim();
            } else {
                sku = formData.get('sku') || '';
            }
            
            // Validate pallet size vs quantity
            const qty = parseInt(formData.get('qty') || '0', 10);
            const palletSizes = collectChecked('palletSize').map(ps => parseInt(ps, 10)).filter(ps => !isNaN(ps));
            
            if (qty > 0 && palletSizes.length > 0) {
                const maxPalletSize = Math.max(...palletSizes);
                if (qty > maxPalletSize) {
                    throw new Error(`Quantity (${qty}) cannot exceed the selected pallet size (${maxPalletSize}). Please reduce quantity or select a larger pallet size.`);
                }
            }
            
            const merchHistoryEntries = [];
            document.querySelectorAll('.merch-history-entry').forEach(entry => {
                const date = entry.querySelector('.merch-history-date')?.value || '';
                const user = entry.querySelector('.merch-history-user')?.value || '';
                const note = entry.querySelector('.merch-history-note')?.value || '';
                if (date || user || note) {
                    merchHistoryEntries.push({ date, user, note });
                }
            });

            return {
                serial: formData.get('serial') || formatSerial(currentSerial),
                color: formData.get('color') || selectedColor,
                date: formData.get('date') || '',
                time: formData.get('time') || '',
                sku: sku, // Use the SKU from dropdown or custom input
                qty: formData.get('qty') || '',
                layers: formData.get('layers') || '',
                notes: formData.get('notes') || '',
                bandingType: collectChecked('bandingType'),
                productType: collectChecked('productType'),
                palletSize: collectChecked('palletSize'),
                qualityIssueType: formData.get('qualityIssueType') || '',
                qualityIssueDesc: formData.get('qualityIssueDesc') || '',
                groupLeader: formData.get('groupLeader') || '',
                sachetType: formData.get('sachetType') || '',
                tabletType: formData.get('tabletType') || '',
                merchHistory: merchHistoryEntries,
                modifiedBy: loggedInUser?.name || loggedInUser?.id || 'Unknown User',
                status: 'Received'
            };
        }

        // --- Stock Movement Interface ---

        function setMovementStatus(message, type = 'info') {
            const statusEl = document.getElementById('movementStatusMessage');
            if (!statusEl) return;
            statusEl.textContent = message || '';
            statusEl.classList.remove('error', 'success');
            if (type === 'error') {
                statusEl.classList.add('error');
            } else if (type === 'success') {
                statusEl.classList.add('success');
            }
        }

        function setMovementListLoading(message) {
            const list = document.getElementById('movementPalletList');
            if (!list) return;
            list.innerHTML = `<div style="color:#475569;">${message}</div>`;
        }

        function toggleMovementPanel(forceOpen) {
            if (!isUserLoggedIn()) {
                alert('🔐 Please log in before using stock movement controls.');
                showLoginCard();
                return;
            }
            const panel = document.getElementById('movementPanel');
            const toggleBtn = document.getElementById('movementToggleBtn');
            if (!panel || !toggleBtn) return;
            const shouldOpen = forceOpen !== undefined ? forceOpen : !panel.classList.contains('active');
            if (shouldOpen) {
                panel.classList.add('active');
                toggleBtn.textContent = '🚫 Close Stock Movement Control';
                ensureMovementPanelLoaded();
            } else {
                panel.classList.remove('active');
                toggleBtn.textContent = '🚚 Open Stock Movement Control';
            }
        }

        async function ensureMovementPanelLoaded() {
            if (movementPanelInitialized) {
                autoFillMovementOperator();
                return;
            }
            try {
                setMovementStatus('Loading zones...');
                const result = await callAppsScript(new URLSearchParams({ action: 'getZoneConfig' }));
                movementZones = (result.zones || []).filter(zone => zone.ZoneName);
                populateMovementZoneOptions();
                movementPanelInitialized = true;
                setMovementStatus('');
                await refreshMovementZone();
            } catch (error) {
                console.error('Movement init error:', error);
                setMovementStatus(error.message || 'Failed to load zones', 'error');
            }
        }

        function populateMovementZoneOptions() {
            const zoneSelect = document.getElementById('movementZoneSelect');
            const toZoneSelect = document.getElementById('movementToZoneSelect');
            if (!zoneSelect || !toZoneSelect) return;
            
            // Ensure OUTBOUNDED zone exists
            const hasOutbounded = movementZones.some(z => z.ZoneName === 'Outbounded');
            if (!hasOutbounded) {
                movementZones.push({
                    ZoneName: 'Outbounded',
                    Prefix: 'OUT',
                    FIFORequired: false,
                    AllowsSplitting: false
                });
            }
            
            movementZones.sort((a, b) => (a.ZoneName || '').localeCompare(b.ZoneName || ''));
            zoneSelect.innerHTML = '';
            toZoneSelect.innerHTML = '';
            movementZones.forEach(zone => {
                const option = document.createElement('option');
                option.value = zone.ZoneName;
                option.textContent = `${zone.ZoneName} (${zone.Prefix || 'N/A'})`;
                zoneSelect.appendChild(option.cloneNode(true));
                toZoneSelect.appendChild(option);
            });
            if (!zoneSelect.value && movementZones.length) {
                zoneSelect.value = movementZones[0].ZoneName;
            }
            if (!toZoneSelect.value && movementZones.length) {
                toZoneSelect.value = movementZones[0].ZoneName;
            }
            updateMovementZoneMeta(zoneSelect.value);
            autoFillMovementOperator();
        }
        
        // NEW: Comprehensive zone overview table with FIFO indicators
        async function refreshZoneOverview() {
            const tableContainer = document.getElementById('zoneOverviewTable');
            const palletList = document.getElementById('movementPalletList');
            
            if (!tableContainer) {
                showToast('Zone overview table not found', 'error');
                return;
            }
            
            // Toggle visibility
            const isVisible = tableContainer.style.display !== 'none';
            tableContainer.style.display = isVisible ? 'none' : 'block';
            if (palletList) palletList.style.display = isVisible ? 'flex' : 'none';
            
            if (isVisible) return; // Hide table
            
            // Ensure zones are loaded first
            if (!movementPanelInitialized || !movementZones || movementZones.length === 0) {
                tableContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: rgba(251, 191, 36, 0.9);"><p>Loading zones...</p></div>';
                try {
                    await ensureMovementPanelLoaded();
                } catch (error) {
                    tableContainer.innerHTML = `<div style="color: #fca5a5; padding: 20px; text-align: center;">Error loading zones: ${error.message}</div>`;
                    return;
                }
            }
            
            if (!movementZones || movementZones.length === 0) {
                tableContainer.innerHTML = '<div style="color: #fca5a5; padding: 20px; text-align: center;">No zones found. Please configure zones first.</div>';
                return;
            }
            
            tableContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: rgba(251, 191, 36, 0.9);"><div class="loading-spinner"></div><p>Loading zone overview...</p><p style="font-size: 12px; margin-top: 8px; opacity: 0.7;">This may take a moment</p></div>';
            
            try {
                // OPTIMIZED: Load all zones in parallel instead of sequentially
                const totalZones = movementZones.length;
                
                // Create all zone loading promises at once
                const zonePromises = movementZones.map(async (zone) => {
                    try {
                        const params = new URLSearchParams({
                            action: 'getPalletsInZone',
                            zoneName: zone.ZoneName,
                            limit: 10000
                        });
                        
                        // Reduced timeout since we're loading in parallel
                        const timeoutPromise = new Promise((_, reject) => 
                            setTimeout(() => reject(new Error(`Timeout`)), 5000)
                        );
                        
                        const result = await Promise.race([
                            callAppsScript(params),
                            timeoutPromise
                        ]);
                        
                        const pallets = result.pallets || [];
                        
                        // Sort by CreatedAt for FIFO (oldest first)
                        pallets.sort((a, b) => {
                            const dateA = new Date(a.CreatedAt || a.CreatedDate || 0);
                            const dateB = new Date(b.CreatedAt || b.CreatedDate || 0);
                            return dateA - dateB;
                        });
                        
                        return {
                            zone: zone,
                            pallets: pallets,
                            totalQty: pallets.reduce((sum, p) => sum + (parseFloat(p.RemainingQuantity ?? p.Quantity ?? 0) || 0), 0),
                            oldestPallet: pallets[0] || null,
                            needsMovement: pallets.length > 0 && parseBooleanFlag(zone.FIFORequired) && pallets.length > 1,
                            error: null
                        };
                    } catch (error) {
                        console.error(`Error loading zone ${zone.ZoneName}:`, error);
                        return {
                            zone: zone,
                            pallets: [],
                            totalQty: 0,
                            oldestPallet: null,
                            needsMovement: false,
                            error: error.message
                        };
                    }
                });
                
                // Show loading state
                tableContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: rgba(251, 191, 36, 0.9);"><div class="loading-spinner"></div><p>Loading zone overview...</p><p style="font-size: 12px; margin-top: 8px; opacity: 0.7;">Loading all zones in parallel...</p></div>';
                
                // Wait for all zones to load in parallel
                const allZonesData = await Promise.all(zonePromises);
                
                // Helper function to recommend destination zone based on forward movement flow
                const recommendDestination = (currentZone, palletStatus) => {
                    // If status is "Outbounding", "Dispatch", or "Shipped" -> move to Outbounded
                    if (palletStatus && (palletStatus.toLowerCase().includes('outbound') || 
                        palletStatus.toLowerCase() === 'dispatch' || 
                        palletStatus.toLowerCase() === 'shipped')) {
                        return 'Outbounded';
                    }
                    
                    // Forward movement flow (can be customized based on your warehouse flow)
                    // Example: Receiving Area -> Cold Storage -> Ambient Zone -> Dispatch -> Outbounded
                    const forwardFlow = {
                        'Receiving Area': ['Cold Storage', 'Ambient Zone'],
                        'Cold Storage': ['Ambient Zone', 'Dispatch'],
                        'Ambient Zone': ['Dispatch'],
                        'Dispatch': ['Outbounded'],
                        'Shipped': ['Outbounded']
                    };
                    
                    const zoneName = currentZone.ZoneName || currentZone;
                    const nextZones = forwardFlow[zoneName];
                    
                    if (nextZones && nextZones.length > 0) {
                        // Find first available next zone
                        for (const nextZone of nextZones) {
                            const zoneExists = movementZones.some(z => z.ZoneName === nextZone);
                            if (zoneExists) {
                                return nextZone;
                            }
                        }
                    }
                    
                    // Default: if no forward flow defined, suggest Outbounded for dispatch status
                    if (palletStatus && palletStatus.toLowerCase().includes('dispatch')) {
                        return 'Outbounded';
                    }
                    
                    // If Outbounded exists and current zone is not Outbounded, suggest it
                    const outboundedExists = movementZones.some(z => z.ZoneName === 'Outbounded');
                    if (outboundedExists && zoneName !== 'Outbounded') {
                        return 'Outbounded';
                    }
                    
                    return null; // No recommendation
                };
                
                // Build comprehensive table
                let tableHTML = `
                    <h3 style="color: #fbbf24; margin: 0 0 16px 0; font-size: 18px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">⬥ Zone Overview & FIFO Status</h3>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                            <thead>
                                <tr style="background: rgba(245, 158, 11, 0.2); border-bottom: 2px solid rgba(245, 158, 11, 0.4);">
                                    <th style="padding: 12px; text-align: left; color: #fbbf24; font-weight: 700; text-transform: uppercase;">Zone</th>
                                    <th style="padding: 12px; text-align: center; color: #fbbf24; font-weight: 700; text-transform: uppercase;">Pallets</th>
                                    <th style="padding: 12px; text-align: center; color: #fbbf24; font-weight: 700; text-transform: uppercase;">Total Qty</th>
                                    <th style="padding: 12px; text-align: left; color: #fbbf24; font-weight: 700; text-transform: uppercase;">Oldest Pallet</th>
                                    <th style="padding: 12px; text-align: center; color: #fbbf24; font-weight: 700; text-transform: uppercase;">FIFO</th>
                                    <th style="padding: 12px; text-align: center; color: #fbbf24; font-weight: 700; text-transform: uppercase;">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                allZonesData.forEach((zoneData, index) => {
                    const zone = zoneData.zone;
                    const fifoRequired = parseBooleanFlag(zone.FIFORequired);
                    const oldestDate = zoneData.oldestPallet ? formatMovementDate(zoneData.oldestPallet.CreatedAt || zoneData.oldestPallet.CreatedDate) : 'N/A';
                    const oldestId = zoneData.oldestPallet ? (zoneData.oldestPallet.PalletID || 'N/A') : 'N/A';
                    const hasError = zoneData.error;
                    
                    // Determine action recommendation
                    let actionHTML = '<span style="color: rgba(255, 255, 255, 0.5);">—</span>';
                    
                    if (!hasError && zoneData.pallets.length > 0) {
                        // Find pallets that need movement (forward flow)
                        const palletsNeedingMovement = zoneData.pallets.filter(p => {
                            const status = (p.Status || '').toLowerCase();
                            // Outbounding, Dispatch, Shipped should go to Outbounded
                            if (status.includes('outbound') || status === 'dispatch' || status === 'shipped') {
                                return p.CurrentZone !== 'Outbounded';
                            }
                            // FIFO zones with multiple pallets - oldest should move
                            if (fifoRequired && zoneData.pallets.length > 1) {
                                return p.PalletID === oldestId;
                            }
                            return false;
                        });
                        
                        if (palletsNeedingMovement.length > 0) {
                            // Get the priority pallet (oldest if FIFO, or first outbounding)
                            const priorityPallet = palletsNeedingMovement.find(p => 
                                (p.Status || '').toLowerCase().includes('outbound') || 
                                (p.Status || '').toLowerCase() === 'dispatch' ||
                                (p.Status || '').toLowerCase() === 'shipped'
                            ) || palletsNeedingMovement[0];
                            
                            const palletId = priorityPallet.PalletID || 'N/A';
                            const palletStatus = priorityPallet.Status || '';
                            const recommendedDest = recommendDestination(zone, palletStatus);
                            
                            if (recommendedDest) {
                                actionHTML = `
                                    <div style="text-align: left; font-size: 11px; line-height: 1.6;">
                                        <div style="margin-bottom: 4px;">
                                            <strong style="color: #fbbf24;">Move First:</strong><br>
                                            <span style="color: rgba(255, 255, 255, 0.95); font-family: 'Courier New', monospace; font-weight: 600;">${escapeHtml(palletId)}</span>
                                        </div>
                                        <div>
                                            <strong style="color: #fbbf24;">→ To:</strong><br>
                                            <span style="color: rgba(255, 255, 255, 0.95); font-weight: 600;">${escapeHtml(recommendedDest)}</span>
                                        </div>
                                    </div>
                                `;
                            } else if (zoneData.needsMovement) {
                                actionHTML = `
                                    <div style="text-align: left; font-size: 11px;">
                                        <strong style="color: #fbbf24;">Move First:</strong><br>
                                        <span style="color: rgba(255, 255, 255, 0.95); font-family: 'Courier New', monospace; font-weight: 600;">${escapeHtml(oldestId)}</span><br>
                                        <small style="color: rgba(251, 191, 36, 0.7);">(FIFO - oldest first)</small>
                                    </div>
                                `;
                            }
                        }
                    }
                    
                    tableHTML += `
                        <tr style="border-bottom: 1px solid rgba(245, 158, 11, 0.2); ${index % 2 === 0 ? 'background: rgba(15, 23, 42, 0.3);' : ''}">
                            <td style="padding: 12px; color: rgba(255, 255, 255, 0.95); font-weight: 600;">
                                ${escapeHtml(zone.ZoneName)}<br>
                                <small style="color: rgba(251, 191, 36, 0.7); font-size: 11px;">Prefix: ${zone.Prefix || 'N/A'}</small>
                                ${hasError ? `<br><small style="color: #fca5a5; font-size: 10px;">⚠️ ${escapeHtml(zoneData.error)}</small>` : ''}
                            </td>
                            <td style="padding: 12px; text-align: center; color: rgba(255, 255, 255, 0.95); font-weight: 600;">${hasError ? '—' : zoneData.pallets.length}</td>
                            <td style="padding: 12px; text-align: center; color: rgba(255, 255, 255, 0.95); font-weight: 600;">${hasError ? '—' : zoneData.totalQty.toLocaleString()}</td>
                            <td style="padding: 12px; color: rgba(255, 255, 255, 0.85); font-size: 12px;">
                                ${hasError ? '—' : escapeHtml(oldestId)}<br>
                                ${!hasError ? `<small style="color: rgba(251, 191, 36, 0.6);">${oldestDate}</small>` : ''}
                            </td>
                            <td style="padding: 12px; text-align: center;">
                                ${hasError ? '<span style="color: rgba(255, 255, 255, 0.5);">—</span>' : 
                                    (fifoRequired ? 
                                        `<span style="color: #fbbf24; font-weight: 700;">✓ Enforced</span>` : 
                                        `<span style="color: rgba(255, 255, 255, 0.5);">—</span>`
                                    )
                                }
                            </td>
                            <td style="padding: 12px; text-align: left; min-width: 180px;">
                                ${actionHTML}
                            </td>
                        </tr>
                    `;
                });
                
                tableHTML += `
                            </tbody>
                        </table>
                    </div>
                    <div style="margin-top: 16px; padding: 12px; background: rgba(245, 158, 11, 0.1); border-radius: 8px; border-left: 4px solid #f59e0b;">
                        <p style="margin: 0; color: rgba(251, 191, 36, 0.9); font-size: 12px; line-height: 1.6;">
                            <strong>📋 Action Column:</strong> Shows which pallet ID to move first and recommended destination zone.<br>
                            <strong>⚠️ FIFO Zones:</strong> Oldest pallets (by creation date) should be moved first.<br>
                            <strong>🚚 Outbounding/Dispatch:</strong> Automatically recommends moving to "Outbounded" zone.<br>
                            <strong>➡️ Forward Flow:</strong> Receiving → Storage → Dispatch → Outbounded
                        </p>
                    </div>
                `;
                
                tableContainer.innerHTML = tableHTML;
            } catch (error) {
                console.error('Error loading zone overview:', error);
                tableContainer.innerHTML = `<div style="color: #fca5a5; padding: 20px; text-align: center;">Error loading zone overview: ${error.message}</div>`;
            }
        }

        function updateMovementZoneMeta(zoneName) {
            const metaEl = document.getElementById('movementZoneMeta');
            if (!metaEl) return;
            const zone = movementZones.find(z => z.ZoneName === zoneName);
            if (!zone) {
                metaEl.textContent = '';
                return;
            }
            const fifoText = parseBooleanFlag(zone.FIFORequired) ? 'FIFO enforced' : 'FIFO not enforced';
            const splitText = parseBooleanFlag(zone.AllowsSplitting) ? 'Splitting allowed' : 'Splitting blocked';
            metaEl.textContent = `${zone.ZoneName} • Prefix ${zone.Prefix || 'N/A'} • ${fifoText} • ${splitText}`;
        }

        async function refreshMovementZone() {
            if (!movementPanelInitialized) {
                await ensureMovementPanelLoaded();
                return;
            }
            const zoneSelect = document.getElementById('movementZoneSelect');
            if (!zoneSelect || !zoneSelect.value) {
                setMovementListLoading('Select a zone to view pallets.');
                return;
            }
            const zoneName = zoneSelect.value;
            updateMovementZoneMeta(zoneName);
            const statusFilter = document.getElementById('movementStatusFilter')?.value || '';
            setMovementListLoading('Loading pallets...');
            try {
                const params = new URLSearchParams({
                    action: 'getPalletsInZone',
                    zoneName: zoneName,
                    limit: 10000  // Increased limit to show ALL pallets
                });
                if (statusFilter) params.append('status', statusFilter);
                const result = await callAppsScript(params);
                movementLastPallets = result.pallets || [];
                renderMovementPalletList(movementLastPallets);
                setMovementStatus(`Loaded ${movementLastPallets.length} pallet(s) from ${zoneName}`, 'success');
            } catch (error) {
                console.error('Failed to load pallets:', error);
                setMovementStatus(error.message || 'Failed to load pallets', 'error');
                setMovementListLoading(error.message || 'Unable to load pallets.');
            }
        }

        function renderMovementPalletList(pallets) {
            const list = document.getElementById('movementPalletList');
            if (!list) return;
            if (!pallets.length) {
                list.innerHTML = '<div style="color:#94a3b8;">No pallets found for this zone.</div>';
                return;
            }
            list.innerHTML = pallets.map(pallet => {
                const status = escapeHtml(pallet.Status || 'Active');
                const sku = escapeHtml(pallet.SKU || 'N/A');
                const qty = pallet.RemainingQuantity ?? pallet.Quantity ?? '';
                const created = formatMovementDate(pallet.CreatedAt || pallet.CreatedDate);
                const lastMoved = formatMovementDate(pallet.LastMovedAt);
                return `
                    <div class="movement-card">
                        <div class="movement-card-header">
                            <strong>${escapeHtml(pallet.PalletID || 'Unknown ID')}</strong>
                            <span class="badge">${status}</span>
                        </div>
                        <div class="movement-card-meta">
                            <div><strong>SKU:</strong> ${sku}</div>
                            <div><strong>Qty:</strong> ${qty || 'N/A'}</div>
                            <div><strong>Zone:</strong> ${escapeHtml(pallet.CurrentZone || 'N/A')}</div>
                            <div><strong>Created:</strong> ${created}</div>
                            <div><strong>Last Move:</strong> ${lastMoved}</div>
                        </div>
                        <div class="movement-card-actions">
                            <button type="button" class="btn-reset" onclick="selectMovementPallet('${escapeHtml(pallet.PalletID || '')}')">Select</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function selectMovementPallet(palletId) {
            const pallet = movementLastPallets.find(p => (p.PalletID || '').toString() === palletId);
            if (!pallet) return;
            movementSelectedPallet = pallet;
            const palletInput = document.getElementById('movementPalletId');
            const currentZoneInput = document.getElementById('movementCurrentZone');
            const reasonInput = document.getElementById('movementReason');
            if (palletInput) palletInput.value = pallet.PalletID || '';
            if (currentZoneInput) currentZoneInput.value = pallet.CurrentZone || '';
            if (reasonInput && !reasonInput.value) {
                reasonInput.value = `Move from ${pallet.CurrentZone || 'unknown zone'}`;
            }
            const toZoneSelect = document.getElementById('movementToZoneSelect');
            if (toZoneSelect && pallet.CurrentZone && toZoneSelect.value === pallet.CurrentZone) {
                const alternative = movementZones.find(zone => zone.ZoneName !== pallet.CurrentZone);
                if (alternative) {
                    toZoneSelect.value = alternative.ZoneName;
                }
            }
            setMovementStatus(`Selected ${pallet.PalletID} (currently ${pallet.CurrentZone || 'N/A'})`);
        }

        function resetMovementForm() {
            movementSelectedPallet = null;
            const form = document.getElementById('movementForm');
            if (form) form.reset();
            const currentZoneInput = document.getElementById('movementCurrentZone');
            if (currentZoneInput) currentZoneInput.value = '';
            autoFillMovementOperator();
            setMovementStatus('');
        }

        let isChildMode = false;

        function toggleMovementMode() {
            isChildMode = !isChildMode;
            const toggleBtn = document.getElementById('toggleChildModeBtn');
            const submitBtn = document.getElementById('movementSubmitBtn');
            const quantityWrapper = document.getElementById('movementQuantityWrapper');
            const toZoneSelect = document.getElementById('movementToZoneSelect');
            if (isChildMode) {
                toggleBtn.textContent = '↩️ Back to Full-Pallet Move';
                submitBtn.textContent = 'Create Child Pallet';
                if (quantityWrapper) {
                    quantityWrapper.querySelector('label').textContent = 'Child Quantity';
                    const input = document.getElementById('movementQuantity');
                    if (input) {
                        input.placeholder = 'Enter child pallet qty';
                        input.required = true;
                    }
                }
            } else {
                toggleBtn.textContent = '✨ Create Child Pallet';
                submitBtn.textContent = 'Move Pallet';
                if (quantityWrapper) {
                    quantityWrapper.querySelector('label').textContent = 'Quantity (optional)';
                    const input = document.getElementById('movementQuantity');
                    if (input) {
                        input.placeholder = 'Leave blank to keep full qty';
                        input.required = false;
                    }
                }
            }
        }

        async function submitMovementForm() {
            const palletId = document.getElementById('movementPalletId')?.value.trim();
            const toZone = document.getElementById('movementToZoneSelect')?.value;
            const movedBy = document.getElementById('movementMovedBy')?.value.trim();
            if (!palletId) {
                setMovementStatus('Enter pallet ID.', 'error');
                return;
            }
            if (!toZone) {
                setMovementStatus('Select destination zone.', 'error');
                return;
            }
            if (!movedBy) {
                setMovementStatus('Enter the user moving the pallet.', 'error');
                return;
            }
            const reason = document.getElementById('movementReason')?.value || '';
            const overrideReason = document.getElementById('movementOverrideReason')?.value || '';
            const quantity = document.getElementById('movementQuantity')?.value || '';
            const orderReference = document.getElementById('movementOrderRef')?.value || '';
            if (isChildMode) {
                if (!quantity || Number(quantity) <= 0) {
                    setMovementStatus('Enter child quantity greater than zero.', 'error');
                    return;
                }
            }
            try {
                setMovementStatus('Moving pallet...');
                const params = new URLSearchParams({
                    action: isChildMode ? 'createChildPallet' : 'movePallet',
                    palletId: palletId,
                    toZone: toZone,
                    movedBy: movedBy
                });
                if (reason) params.append('reason', reason);
                if (isChildMode) {
                    params.append('quantity', quantity);
                } else {
                    if (overrideReason) params.append('overrideReason', overrideReason);
                    if (quantity) params.append('quantity', quantity);
                    if (orderReference) params.append('orderReference', orderReference);
                }
                const result = await callAppsScript(params);
                if (isChildMode) {
                    setMovementStatus(result.message || 'Child pallet created successfully', 'success');
                } else {
                    setMovementStatus(result.message || 'Pallet moved successfully', 'success');
                }
                resetMovementForm();
                refreshMovementZone();
            } catch (error) {
                console.error('Move pallet error:', error);
                setMovementStatus(error.message || 'Failed to move pallet', 'error');
                if ((error.message || '').toLowerCase().includes('fifo')) {
                    document.getElementById('movementOverrideReason')?.focus();
                }
            }
        }

        async function callAppsScript(params) {
            if (!GOOGLE_APPS_SCRIPT_URL) {
                throw new Error('Google Apps Script URL not configured');
            }
            const url = `${GOOGLE_APPS_SCRIPT_URL}?${params.toString()}`;
            const response = await fetch(url, {
                method: 'GET',
                headers: { 'Accept': 'application/json' }
            });
            const text = await response.text();
            let result;
            try {
                result = JSON.parse(text);
            } catch (error) {
                console.error('Apps Script raw response:', text);
                throw new Error('Invalid response from Apps Script. Please redeploy the latest backend.');
            }
            if (!result.success) {
                throw new Error(result.error || 'Apps Script call failed');
            }
            return result;
        }

        function parseBooleanFlag(value) {
            if (value === true || value === false) return value;
            if (value === undefined || value === null) return false;
            const str = value.toString().toLowerCase();
            return str === 'true' || str === 'yes' || str === '1';
        }

        function formatMovementDate(value) {
            if (!value) return 'N/A';
            const date = new Date(value);
            if (isNaN(date.getTime())) {
                return value;
            }
            return `${date.toLocaleDateString()} ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
        }

        function autoFillMovementOperator() {
            const field = document.getElementById('movementMovedBy');
            if (field && !field.value && isUserLoggedIn()) {
                field.value = loggedInUser.name || loggedInUser.id || '';
            }
        }

        function renderFilledTicket(data) {
            const previewContainer = document.getElementById('fillPreview');
            if (!previewContainer) {
                return null;
            }

            const serialDisplay = document.getElementById('fillSerialDisplay');
            if (serialDisplay) {
                serialDisplay.textContent = data.serial;
            }

            const originalHtml = createTicketHTML(data.serial, data.color, false, data, 'view');
            const duplicateHtml = createTicketHTML(data.serial, data.color, true, data, 'edit');

            previewContainer.innerHTML = `
                <div class="page single">
                    <div class="ticket-row">
                        ${originalHtml}
                        ${duplicateHtml}
                    </div>
                </div>
            `;

            return previewContainer.querySelector('.page');
        }

        async function downloadFilledTicket(pageElement, serial) {
            if (typeof html2canvas === 'undefined') {
                alert('Download library not loaded.');
                return;
            }

            const canvas = await html2canvas(pageElement, {
                scale: window.devicePixelRatio > 1 ? window.devicePixelRatio : 2,
                backgroundColor: '#ffffff',
                useCORS: true
            });
            const link = document.createElement('a');
            const safeSerial = serial.replace(/[^a-z0-9_-]+/gi, '_');
            link.download = `${safeSerial || 'ticket'}_completed.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        function setFillStatus(message) {
            const status = document.getElementById('fillStatus');
            if (status) {
                // Add loading spinner for "Saving..." or "Loading..." messages
                if (message && (message.toLowerCase().includes('saving') || message.toLowerCase().includes('loading') || message.toLowerCase().includes('generating'))) {
                    status.innerHTML = `<span class="loading-spinner"></span>${message}`;
                } else if (message && message.includes('✅')) {
                    status.innerHTML = `<span style="color: #ffffff; font-size: 20px; margin-right: 8px;">✅</span>${message.replace('✅', '')}`;
                    status.style.background = 'rgba(255, 255, 255, 0.25)';
                    status.style.borderColor = 'rgba(255, 255, 255, 0.4)';
                } else if (message && message.includes('❌')) {
                    status.innerHTML = `<span style="color: #ffffff; font-size: 20px; margin-right: 8px;">❌</span>${message.replace('❌', '')}`;
                    status.style.background = 'rgba(255, 107, 107, 0.3)';
                    status.style.borderColor = 'rgba(255, 107, 107, 0.5)';
                } else {
                    status.textContent = message || '';
                    status.style.background = 'rgba(255, 255, 255, 0.2)';
                    status.style.borderColor = 'rgba(255, 255, 255, 0.3)';
                }
            }
        }
        
        // Elegant success popup for print/download logs
        function showSuccessPopup({ title, message }) {
            // Create modal overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.85);
                backdrop-filter: blur(10px);
                z-index: 99999;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
                animation: fadeIn 0.3s ease-out;
            `;
            
            // Create popup content
            const popup = document.createElement('div');
            popup.style.cssText = `
                background: linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(30, 58, 95, 0.98));
                backdrop-filter: blur(20px);
                border-radius: 24px;
                padding: 32px;
                max-width: 500px;
                width: 100%;
                box-shadow: 
                    0 20px 80px rgba(0, 0, 0, 0.6),
                    0 8px 32px rgba(245, 158, 11, 0.3),
                    inset 0 2px 0 rgba(245, 158, 11, 0.2);
                border: 2px solid rgba(245, 158, 11, 0.5);
                animation: slideUpModal 0.4s ease-out;
                position: relative;
            `;
            
            popup.innerHTML = `
                <h2 style="
                    margin: 0 0 20px 0; 
                    background: linear-gradient(135deg, #fbbf24, #f59e0b, #fcd34d);
                    -webkit-background-clip: text;
                    -webkit-text-fill-color: transparent;
                    font-size: 26px;
                    font-weight: 800;
                    text-align: center;
                    letter-spacing: 1px;
                    text-transform: uppercase;
                ">${title}</h2>
                
                <div style="color: #fff; font-size: 14px;">
                    ${message}
                </div>
                
                <button onclick="this.closest('[style*=fixed]').remove()" style="
                    width: 100%;
                    margin-top: 24px;
                    padding: 16px;
                    background: linear-gradient(135deg, #fbbf24, #f59e0b);
                    color: #0f172a;
                    border: none;
                    border-radius: 12px;
                    font-size: 16px;
                    font-weight: 800;
                    cursor: pointer;
                    font-family: 'Cascadia Mono', monospace;
                    letter-spacing: 1.5px;
                    text-transform: uppercase;
                    box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
                    transition: all 0.3s ease;
                " onmouseover="this.style.transform='translateY(-2px) scale(1.02)'; this.style.boxShadow='0 8px 28px rgba(245, 158, 11, 0.5)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 6px 20px rgba(245, 158, 11, 0.4)'">
                    ✓ Got It!
                </button>
            `;
            
            overlay.appendChild(popup);
            document.body.appendChild(overlay);
            
            // Close on Escape key
            const closeOnEscape = (e) => {
                if (e.key === 'Escape') {
                    overlay.remove();
                    document.removeEventListener('keydown', closeOnEscape);
                }
            };
            document.addEventListener('keydown', closeOnEscape);
            
            // Close on background click
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.remove();
                }
            });
        }
        
        // Preview Modal Functions
        function openPreviewModal() {
            const modal = document.getElementById('previewModal');
            if (modal) {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden'; // Prevent background scroll
            }
        }
        
        function closePreviewModal() {
            const modal = document.getElementById('previewModal');
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = ''; // Re-enable scroll
            }
        }
        
        // Add event listener for Preview button
        document.addEventListener('DOMContentLoaded', function() {
            const previewBtn = document.getElementById('showPreviewBtn');
            if (previewBtn) {
                previewBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const form = document.getElementById('fillForm');
                    if (form) {
                        const data = collectFormData(form);
                        const pageElement = renderFilledTicket(data);
                        if (pageElement) {
                            openPreviewModal();
                        } else {
                            alert('Unable to generate preview. Please fill in the required fields.');
                        }
                    }
                });
            }
            
            // Close modal on background click
            const modal = document.getElementById('previewModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closePreviewModal();
                    }
                });
            }
            
            // Close modal on Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closePreviewModal();
                }
            });
        });
    </script>
</body>
</html>

/**
 * Evaluate SKU-to-zone eligibility using SKUZoneMapping sheet
 * @param {Object} config
 *  - sku {string}
 *  - toZone {string}
 *  - palletType {string}
 */
function checkZoneEligibility(config) {
  if (!config || !config.toZone) {
    return { allowed: false, message: 'Target zone required' };
  }
  const toZone = config.toZone.trim();
  const toZoneUpper = toZone.toUpperCase();
  // OUTBONDED is the final consumer destination - accepts all SKUs from Outbounding
  if (toZoneUpper === 'OUTBONDED' || toZoneUpper === 'OUTBOUNDED') {
    return {
      allowed: true,
      targetStatus: 'Outbounded',
      info: 'OUTBONDED is final destination - accepts all pallets.'
    };
  }
  if (toZone === 'Outbounding') {
    return {
      allowed: true,
      targetStatus: 'Shipped',
      info: 'Outbounding treated as final shipping zone.'
    };
  }
  const zoneConfigMap = getZoneConfigMap();
  const zoneSettings = zoneConfigMap[toZone] || {};
  const defaultStatus = zoneSettings.DefaultStatus || 'Active';
  const result = {
    allowed: true,
    targetStatus: defaultStatus
  };
  const sku = (config.sku || '').toString().trim();
  if (!sku) {
    result.info = 'No SKU specified; allowing by default.';
    return result;
  }
  const skuMapping = findSkuZoneEntry(sku);
  if (!skuMapping) {
    result.info = 'SKU not yet mapped; allowing by default.';
    return result;
  }
  if (skuMapping.requiresBanding && (config.palletType || '').toLowerCase() !== 'banded') {
    return {
      allowed: false,
      message: 'SKU ' + sku + ' requires banded pallets only.'
    };
  }
  if (skuMapping.allowedZones.length > 0) {
    const zoneNameNormalized = toZone.toUpperCase();
    const allowed = skuMapping.allowedZones.some(function(zone) {
      return zone.toUpperCase() === zoneNameNormalized;
    });
    if (!allowed) {
      return {
        allowed: false,
        message: 'SKU ' + sku + ' not allowed in ' + toZone + '. Allowed zones: ' + skuMapping.allowedZones.join(', ')
      };
    }
  }
  if (skuMapping.shelfLifeDays) {
    result.shelfLifeDays = skuMapping.shelfLifeDays;
  }
  return result;
}
